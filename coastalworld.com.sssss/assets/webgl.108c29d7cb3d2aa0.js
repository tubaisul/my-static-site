//  Merci-Michel [R]
//  https://www.merci-michel.com/
//  Build 20221103-110025

var t=Object.defineProperty,e=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i,r=(t,e)=>{for(var s in e||(e={}))o.call(e,s)&&n(t,s,e[s]);if(i)for(var s of i(e))a.call(e,s)&&n(t,s,e[s]);return t},l=(t,i)=>e(t,s(i));import{aN as c,aO as h,aP as d,aQ as u,aR as p,aS as m,aT as f,aU as g,aV as b,aW as y,au as v,aX as w,aY as x,aZ as S,a_ as _,a$ as P,b0 as M,af as T,b1 as A,b2 as C,b3 as D,b4 as I,b5 as k,b6 as O,b7 as R,b8 as L,b9 as E,ba as F,bb as z,bc as B,bd as U,c as j,be as N,bf as V,bg as W,bh as q,e as H,bi as G,w as Y,az as X,at as Q,bj as $,bk as K,bl as Z,bm as J,bn as tt,bo as et,i as st,bp as it,bq as ot,s as at,br as nt,b as rt,bs as lt,bt as ct,ab as ht,bu as dt,a6 as ut,bv as pt,aw as mt,ac as ft,bw as gt,bx as bt,by as yt,bz as vt,bA as wt,bB as xt,bC as St,bD as _t,bE as Pt,bF as Mt,bG as Tt,bH as At,bI as Ct,bJ as Dt,bK as It,bL as kt,bM as Ot,bN as Rt,bO as Lt,bP as Et,aC as Ft,m as zt,bQ as Bt,bR as Ut,bS as jt,bT as Nt,bU as Vt,P as Wt,bV as qt,bW as Ht,bX as Gt,bY as Yt,bZ as Xt,b_ as Qt,d as $t,b$ as Kt,c0 as Zt,c1 as Jt,c2 as te,c3 as ee,aI as se,c4 as ie,c5 as oe,c6 as ae,c7 as ne,c8 as re,c9 as le,ca as ce,cb as he,cc as de,cd as ue,ce as pe,cf as me,cg as fe,ch as ge,ci as be,cj as ye,ck as ve,cl as we,cm as xe,cn as Se,co as _e,cp as Pe,cq as Me,cr as Te,cs as Ae,ct as Ce,cu as De,cv as Ie,cw as ke,cx as Oe,cy as Re,cz as Le,cA as Ee,cB as Fe,cC as ze,cD as Be,cE as Ue,cF as je,cG as Ne,cH as Ve,l as We,cI as qe,cJ as He,cK as Ge,a5 as Ye,ax as Xe,cL as Qe,cM as $e,a7 as Ke,cN as Ze,cO as Je,cP as ts,cQ as es,cR as ss,cS as is,cT as os,cU as as}from"./vendor.acd73705cb3d2aa0.js";import{p as ns}from"./main.6cab1659cb3d2aa0.js";c();const rs={global:{res:{value:new h(0,0)}},pixelRatio:{value:1},time:{value:0},playerPosition:{value:new d(0,0,0)},grass:{current:{value:new u(0,0,0,0)},delayed:{value:new h(0,0)}},water:{waterProgress:{value:0}},bigShadow:{bigShadowFalloff:{value:1/30},bigShadowMatrix:{value:new p},bigShadowMap:{type:"t",value:null},bigShadowData:{value:new u},bigShadowDynamicChunks:{value:0},bigShadow:{value:{mapSize:new h,bias:0,radius:0}}},transitions:{road:{value:0},sea:{value:0},games:{value:0},maskRadius:{value:0}},dirShadow:{dirShadowMatrix:{value:new p},dirShadowMap:{type:"t",value:null},dirShadowData:{value:new u},dirShadow:{value:{mapSize:new h,bias:0,radius:0,normalBias:0}}},bounds:{min:{value:new d},max:{value:new d}},uIslandDepth:{value:null}};class ls extends m{get mixins(){return["reactivity"]}init(){this.base=new f,this.ambilight=this.addObject3D(new g(16777215,.65));const t=this.dirLight=this.addObject3D(new b(16777215,.45));this.addObject3D(t.target),this.dirLightPos=this.webgl.store.islands.lights.directional.target,t.position.copy(this.dirLightPos),t.castShadow=!0,t.shadow.camera.far=100,t.shadow.normalBias=.1,this.webgl.store.dynamicShadowSize.watchImmediate(this.setShadowSize,this)}attached(){this.base.manualMatrixUpdate=!0,this.base.updateMatrixWorld(!0)}setShadowSize(t=128){const e=this.dirLight;e.shadow.mapSize.width!==t&&(e.shadow.mapSize.width=t,e.shadow.mapSize.height=t,t>=2048?this.shadowSize=30:t>=1024?this.shadowSize=26:t>=512?this.shadowSize=20:t>=256?this.shadowSize=15:t>=128&&(this.shadowSize=12),rs.bigShadow.bigShadowFalloff.value=1/this.shadowSize,rs.bigShadow.bigShadowFalloff.needsUpdate=!0,e.shadow.camera.top=this.shadowSize,e.shadow.camera.bottom=-this.shadowSize,e.shadow.camera.left=this.shadowSize,e.shadow.camera.right=-this.shadowSize,e.shadow.map&&(e.shadow.map.dispose(),e.shadow.map=null))}beforeUpdate(){const t=this.scene.getCurrentCamera().base.position;this.dirLight.target.position.copy(t);const e=d.get().copy(this.dirLightPos).multiplyScalar(20);this.dirLight.position.copy(t).add(e),this.dirLight.updateMatrixWorld(),this.dirLight.target.updateMatrixWorld(),e.release()}update(){this.dirLight.shadow.map&&function(t){const{dirShadow:e,dirShadowData:s,dirShadowMatrix:i,dirShadowMap:o}=rs.dirShadow,a=s.value;a.copy(t.shadowSize),e.value.mapSize.copy(t.shadowSize),e.value.bias=a.z=t.shadowBias,e.value.radius=a.w=t.shadowRadius,e.value.normalBias=a.w=t.shadowNormalBias,o.value=t.texture,i.value.copy(t.matrix)}({texture:this.dirLight.shadow.map.texture,matrix:this.dirLight.shadow.matrix,shadowBias:this.dirLight.shadow.bias,shadowSize:this.dirLight.shadow.mapSize,shadowRadius:this.dirLight.shadow.radius,shadowNormalBias:this.dirLight.shadow.normalBias})}beforeDestroy(){this.dirLight.shadow.map.dispose(),this.webgl.store.dynamicShadowSize.unwatch(this.setShadowSize,this)}}let cs=new y;const hs=t=>(Number.isInteger(t)?t+".":t)+"",ds=(...t)=>t.map(hs).join(","),us=(t,e)=>{t.r?cs.copy(t):cs.set(t);const s=cs.r.toFixed(3),i=cs.g.toFixed(3),o=cs.b.toFixed(3);return null!=e?"vec4("+ds(s,i,o,e)+")":((t,e,s)=>"vec3("+ds(t,e,s)+")")(s,i,o)};let ps=null;function ms(){return ps||(ps={SKY_TOP_COLOR:us(new y("#3fdefa").offsetHSL(0,0,0)),SKY_BOTTOM_COLOR:us(new y("#cafced").offsetHSL(0,0,0)),WATER_TOP_COLOR:us(new y("#A9D6FB").offsetHSL(-.02,.2,-.2)),WATER_COLOR:us(new y("#6DAFE5").offsetHSL(-.01,0,0)),WATER_BASE_LEVEL:hs(.2),WATER_MAX_DEPTH:hs(-4),WATER_FOAM_HEIGHT:hs(.1),BASE_TRANSITION_COLOR:us(new y(.222,.222,.467)),ROAD_GROUND_COLOR:us(new y(203/255,237/255,229/255)),GAMES_TRANSITION_COLOR:us(new y(200/255,184/255,217/255))},v.app.$device.type.mobile&&(ps.IS_MOBILE=!0),ps)}var fs=w("varying vec2 vUv;const vec3 skyBottom=SKY_BOTTOM_COLOR;const vec3 skyTop=SKY_TOP_COLOR;const vec3 waterColor=WATER_COLOR;uniform float time;uniform sampler2D clouds;void main(){float skyProgress=smoothstep(0.,1.,(vUv.y*2.-1.)*4.)*1.5;vec3 skyColor=mix(skyBottom,skyTop,skyProgress);float waterProgress=1.-smoothstep(0.502,0.5,vUv.y);vec3 watColor=mix(waterColor,SKY_BOTTOM_COLOR,smoothstep(0.49,0.502,vUv.y)*0.5);skyColor=mix(watColor,skyColor,waterProgress);vec2 cuv=vec2(0.);cuv.y=1.-clamp(max(0.,vUv.y-0.5)*18.,0.,1.);cuv.x=vUv.x*4.-time*0.002;vec4 c=texture2D(clouds,cuv).rgba;c.rgb/=(c.a+0.001);float alpha=smoothstep(0.4+cuv.y*0.5,0.9,c.a);skyColor=mix(skyColor,c.rgb,alpha*waterProgress*step(0.01,cuv.y)*0.75*(1.-cuv.y));gl_FragColor=vec4(skyColor,1.);}","fragmentShader");var gs=w("varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let bs=null;class ys extends x{constructor(){super({depthTest:!0,depthWrite:!1,defines:r({},ms())}),this.uniforms={time:rs.time,clouds:{value:v.resources.textures.clouds}},fs.use(this),gs.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}ys.use=function(){return bs=bs||new ys,bs},ys.unuse=function(){};const vs=new _(1,32,32).scale(-1,1,1);class ws extends m{init(){this.base=new f,this.sky=new S(vs,ys.use()),this.sky.scale.setScalar(800),this.sky.renderOrder=this.webgl.store.renderOrder.skybox,this.addObject3D(this.sky),this.base.manualMatrixUpdate=!0,this.static=!0}attached(){const t=this.scene.center;this.base.position.x=t.x,this.base.position.z=t.z,this.base.updateMatrixWorld(!0)}detached(){this.removeFromParent()}}let xs;ws.use=()=>xs=xs||new ws;class Ss extends x{constructor(t={}){Ss.prototype.lineWidth=1,super(t),this.type="ShaderMaterial",this.vertexShader="varying vec2 vUv;uniform mat3 uvTransform;attribute float count;attribute float progress;attribute float data;attribute vec3 previous;attribute vec3 next;attribute float side;attribute float counters;uniform float lineWidth;uniform float elapsedTime;vec3 getExtrusion(){vec3 T=normalize(next-position);vec3 B=normalize(cross(T,next+position));vec3 N=normalize(cross(B,T));return normalize(B+N);}void main(){vUv=(vec3(uv,1)).xy;\n#include <begin_vertex>\nvec3 extrusion=vec3(.0,1.,.0);transformed+=extrusion*lineWidth*.5*side;\n#include <project_vertex>\n}",this.fragmentShader="uniform float elapsedTime;uniform float opacity;varying vec2 vUv;varying float vData;void main(){float progress=elapsedTime;float alpha=1.-clamp(abs(progress-vUv.x)*5.,.0,1.);alpha=(1.-step(sin(vUv.x*3.14)*vUv.y,.5))*alpha;float border=1.-abs(vUv.x*2.-1.)*1.;gl_FragColor=vec4(vec3(1.),alpha*.5*border);}",this.uniforms=Object.assign({elapsedTime:{value:0},lineWidth:{value:t.lineWidth||1}})}}class _s extends P{constructor(t){super(),this.vertices=[],this.positions=[],this.previous=[],this.next=[],this.widths=[],this.sides=[],this.indices=[],this.uvs=[],this.counters=[],this.lineDistances=[],this.thicknesses=[];for(let e=0,s=t.length;e<s;e++){const s=e/t.length;this.vertices.push(t[e]),this.counters.push(s,s)}this.process(),this.update()}setWidth(t){const e=1/this.vertices.length;for(let s=0,i=this.vertices.length;s<i;s++)this.widths[2*s]=this.widths[2*s+1]=t(s*e)}update(){for(let t=0,e=this.vertices.length;t<e;t++){const e=this.vertices[t],s=this.vertices[t-1]||e,i=this.vertices[t+1]||e;this.positions[6*t+0]=this.positions[6*t+3]=e.x,this.positions[6*t+1]=this.positions[6*t+4]=e.y,this.positions[6*t+2]=this.positions[6*t+5]=e.z,this.previous[6*t+0]=this.previous[6*t+3]=s.x,this.previous[6*t+1]=this.previous[6*t+4]=s.y,this.previous[6*t+2]=this.previous[6*t+5]=s.z,this.next[6*t+0]=this.next[6*t+3]=i.x,this.next[6*t+1]=this.next[6*t+4]=i.y,this.next[6*t+2]=this.next[6*t+5]=i.z}this.attributes.position?(this.attributes.position.copyArray(this.positions),this.attributes.previous.copyArray(this.previous),this.attributes.next.copyArray(this.next),this.attributes.width.copyArray(this.widths),this.attributes.position.needsUpdate=!0,this.attributes.previous.needsUpdate=!0,this.attributes.next.needsUpdate=!0,this.attributes.width.needsUpdate=!0):(this.setAttribute("position",this.getBufferAttribute(this.positions,3)),this.setAttribute("previous",this.getBufferAttribute(this.previous,3)),this.setAttribute("next",this.getBufferAttribute(this.next,3)))}getTotalLineDistance(){return this.lineDistances[this.lineDistances.length-1]}getBufferAttribute(t,e){return new M(new Float32Array(t),e)}process(){const t=1/this.vertices.length;for(let e=0,s=this.vertices.length;e<s;e++)this.sides.push(1,-1),this.widths.push(1,1),this.uvs.push(e*t,0,e*t,1);for(let e=0;e<this.vertices.length-1;e++){const t=2*e;this.indices.push(t,t+1,t+2),this.indices.push(t+2,t+1,t+3)}this.setAttribute("side",this.getBufferAttribute(this.sides,1)),this.setAttribute("width",this.getBufferAttribute(this.widths,1)),this.setAttribute("uv",this.getBufferAttribute(this.uvs,2)),this.setAttribute("counters",this.getBufferAttribute(this.counters,1)),this.setIndex(new M(new Uint16Array(this.indices),1))}}class Ps extends m{get mixins(){return["reactivity"]}init(){this.base=new f;for(let t=0;t<4;t++){const t=[],e=5,s=50,i=s/e;for(let l=0,c=e;l<c;l++){const e=.5*-s+l*i,o=T.randomFloat(0,2.5),a=T.randomFloat(-2.5,2.5),n=new d(e,o,a);t.push(n)}const o=new A(t),a=new _s(o.getPoints(500)),n=new Ss({lineWidth:.2,depthTest:!1,side:C,transparent:!0}),r=new S(a,n);r.position.x=T.randomFloat(-100,100),r.position.z=T.randomFloat(-100,100),r.timeOffset=Math.random(),r.speed=T.randomFloat(.45,.65),this.addObject3D(r)}this.watchSignal(this.webgl.store.windVisible,(t=>this.base.visible=t),this,!0),this.base.manualMatrixUpdate=!0}attached(){this.base.updateMatrixWorld(!0)}update(){if(!this.base.visible)return;const t=this.webgl.time.elapsed/1e3;for(let e=0,s=this.base.children.length;e<s;e++){const s=this.base.children[e],i=s.position,o=s.material,a=s.timeOffset,n=s.speed,r=D((t+a)*n,1);o.opacity=.35,o.uniforms.elapsedTime.value=r,r<.01&&(i.copy(this.scene.getCurrentCamera().cam.position),i.x+=T.randomFloat(-25,25),i.y-=4,i.z+=T.randomFloat(-25,25),s.updateMatrixWorld())}}detached(){this.removeFromParent()}}let Ms;Ps.use=()=>Ms=Ms||new Ps;var Ts=w("precision highp float;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <luma>\n#include <blend_modes>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\nfloat getShadowHard(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord){float shadow=1.0;shadowCoord.xyz/=shadowCoord.w;shadowCoord.z+=shadowBias;bvec4 inFrustumVec=bvec4(shadowCoord.x>=0.0,shadowCoord.x<=1.0,shadowCoord.y>=0.0,shadowCoord.y<=1.0);bool inFrustum=all(inFrustumVec);bvec2 frustumTestVec=bvec2(inFrustum,shadowCoord.z<=1.0);bool frustumTest=all(frustumTestVec);if(frustumTest)shadow=texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);return shadow;}varying float vY;varying float vFade;uniform float time;uniform sampler2D noise;uniform float uHalfBoxSize;const vec3 bottomColor=vec3(0.515,0.965,0.482)*0.72;const vec3 topColor=vec3(0.663,0.85,0.557)*0.97;void main(){vec3 color=mix(bottomColor,topColor,smoothstep(0.2,1.,vY));vec4 diffuseColor=vec4(color,1.);vec3 bigShadowDist=(cameraPosition-vWorldPos.xyz)*bigShadowFalloff;float bigShadowLen=dot(bigShadowDist,bigShadowDist);float bigShadowWeight=clamp(bigShadowLen*bigShadowLen*bigShadowLen*bigShadowLen,.0,1.);DirectionalLightShadow directionalLightShadow;directionalLightShadow=directionalLightShadows[0];float invBigShadowDynamicChunks=(1.-bigShadowDynamicChunks);float shadow=bigShadowWeight<0.999?getShadow(directionalShadowMap[0],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[0]):1.0;float shadowBig=bigShadowWeight>(0.001-invBigShadowDynamicChunks)?getShadowHard(bigShadowMap,bigShadow.mapSize,bigShadow.bias,bigShadow.radius,vBigShadowDirectionalCoords):1.;float shadowFade=1.-bigShadowWeight*invBigShadowDynamicChunks;shadow=1.-(1.-smoothstep(0.4,0.5,shadow))*shadowFade;shadowBig=1.-(1.-smoothstep(0.4,0.92,shadowBig))*1.;vec3 shadowColor=mix(vec3(0.,.1,.55),vec3(1.),shadow);vec3 shadowBigColor=mix(vec3(0.,.1,.55),vec3(1.),shadowBig);vec3 allDynColor=mix(shadowColor,shadowBigColor,bigShadowWeight);vec3 nonDynColor=min(shadowColor,shadowBigColor);vec3 shadowT=mix(nonDynColor,allDynColor,bigShadowDynamicChunks);diffuseColor.rgb-=(1.-shadowT)*(0.318309886*diffuseColor.rgb);\n#include <clouds>\ngl_FragColor=vec4(diffuseColor.rgb,smoothstep(.1,.4,vY)*vFade);}","fragmentShader");var As=w("precision highp float;\n#include <common>\n#include <packing>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <linear_step>\n#include <get_instance_matrix>\n#include <big_shadow_pars>\nattribute vec3 instance;uniform float uTime;uniform float uHalfBoxSize;uniform float uHalfBoxSizeSq;uniform vec3 uBoxPosition;uniform vec3 uBoundsMin;uniform vec3 uBoundsMax;uniform sampler2D uIslandDepth;varying float vY;varying float vFade;const float DURATION=100.;uniform vec4 camQuat;varying float vShadow;varying float vShadowBig;uniform mat4 bigShadowMatrix;uniform vec4 pPos;uniform vec2 pPosDelayed;\n#include <world_pos_pars>\nvoid main(){vec3 pos=vec3(position.x,position.y+0.05,0.);float uvy=position.y;pos*=0.3;vec3 instancePos=vec3(instance.x,0.,instance.y);float instanceID=instance.z;float boxSize=uHalfBoxSize*2.;vec3 boxPos=uBoxPosition;vec3 translation=boxPos-mod(instancePos+boxPos,boxSize)+uHalfBoxSize;float x=linearstep(uBoundsMin.x,uBoundsMax.x,translation.x);float y=1.-linearstep(uBoundsMin.z,uBoundsMax.z,translation.z);float canBend=step(0.6,uvy);float loop=sin(uTime*(5.+instanceID)*0.0003+instanceID*2.)*0.1;pos.x+=canBend*loop;float fade=1.;vec2 distLen=boxPos.xz-translation.xz;float dist=dot(distLen,distLen);fade=clamp(1.-dist/uHalfBoxSizeSq,0.,1.);float grassText=texture2D(uIslandDepth,vec2(x,y)).r;translation.y=grassText*(uBoundsMax.y+abs(uBoundsMin.y))-abs(uBoundsMin.y);fade*=1.-step(grassText,0.03);vec2 wPosT=pos.xz+translation.xz;vec2 pLen=pPos.xy-wPosT;vec2 pLenDelayed=pPosDelayed.xy-wPosT;float pDist=dot(pLen,pLen)*3.2;\n#ifndef IS_MOBILE\nfloat pDistDelayed=dot(pLenDelayed,pLenDelayed)*4.;pDist=min(pDist,pDistDelayed);\n#endif\nfloat pInf=smoothstep(2.8,0.,pDist);float pInf2=smoothstep(8.,-1.,pDist);translation.y-=pInf*0.23*canBend;translation.xz+=pPos.zw*pInf2*canBend;if(fade<0.01)pos.xyz=vec3(100000.);vec3 scaleMat=vec3(0.6,1.35+instanceID*0.1,1.);mat4 instanceMatrix=getInstanceMatrix(translation,camQuat,scaleMat);vec4 worldPosition=modelMatrix*instanceMatrix*vec4(pos.x,0.2,pos.z,1.0);vec3 transformedNormal=vec3(0.,0.,1.);vec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=worldPosition+vec4(bigShadowWorldNormal*0.05,0.);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <shadowmap_vertex>\nvFade=smoothstep(0.,0.3,fade);vY=uvy;vWorldPos=worldPosition;gl_Position=projectionMatrix*modelViewMatrix*instanceMatrix*vec4(pos,1.);}","vertexShader");let Cs;class Ds extends x{constructor(t={}){super(t);const e=v.resources.textures;this.uniforms=l(r(l(r(r(r(l(r({},I.merge([k.common,k.specularmap,k.fog,k.lights])),{uBoxPosition:{value:new d},uHalfBoxSize:{value:5},uHalfBoxSizeSq:{value:25},uTime:{value:0},uColor:{value:new y(16777215)},uBoundsMin:{value:rs.bounds.min.value},uBoundsMax:{value:rs.bounds.max.value},uIslandDepth:r({},rs.uIslandDepth),sphereDirection:{value:new h},camQuat:{value:new O}}),rs.bigShadow),rs.dirShadow),rs.global),{pPos:rs.grass.current,pPosDelayed:rs.grass.delayed,time:rs.time}),rs.global),{noise:{value:e.noise}}),this.defines||(this.defines={}),ms().IS_MOBILE&&(this.defines.IS_MOBILE=!0),this.transparent=!0,this.uniforms.uIslandDepth.needsUpdate=!0,this.uniforms.uIslandDepth.value.needsUpdate=!0,this.lights=!0,this.fog=!0,Ts.use(this),As.use(this)}}Ds.get=t=>Cs=Cs||new Ds(t);let Is,ks=184e3,Os=72,Rs=Math.PI;new F;const Ls=new O,Es=new z;class Fs extends m{get mixins(){return["reactivity"]}init(){Is=this.webgl,this.material=Ds.get();Is.app.$device.type.mobile&&(ks*=.5,Os*=.5),ks=Math.floor(ks),Os=Math.floor(Os),this.initGeometry(ks),this.base=new S(this.geo,this.material),this.base.renderOrder=Is.store.renderOrder.grass,this.base.frustumCulled=!1,this.position=new d;let t=!1;Is.hooks.beforePrerender.watchOnce((()=>{t=this.base.visible,this.base.visible=!0})),Is.hooks.afterPrerender.watchOnce((()=>{this.base.visible=t})),this.circleLastPos=new h}attached(){this.base.manualMatrixUpdate=!0,this.base.updateMatrixWorld(!0)}initGeometry(t){if(t===this.count)return;this.count=t,this.geo&&this.geo.dispose(),this.geo=new R;const e=new P;e.setIndex([2,1,0,3,3,3]),e.setAttribute("position",new L([-1,0,0,1,1,0,1,-1],2)),this.geo.index=e.index,this.geo.attributes.position=e.attributes.position;const s=Math.sqrt(ks/Os),i=Math.cos(Math.PI/4)*s,o=[];let a=0;for(let l=0;l<this.count;l++){let t=Math.random();const e=Math.sqrt(l/Os),s=Math.cos(t*Math.PI*2)*e,n=Math.sin(t*Math.PI*2)*e;s>i||n>i||n<-i||s<-i||(a++,Es.y=Math.PI,Ls.setFromEuler(Es),o.push(s,n,T.randomFloat(-Rs,Rs)))}this.buffer=new Float32Array(o.length);const n=new E(this.buffer,3,!1);this.geo.setAttribute("instance",n);const r=this.buffer;for(let l=0;l<a;l++)r[3*l]=o[3*l],r[3*l+1]=o[3*l+1],r[3*l+2]=o[3*l+2];this.realCount=a,this.setGrassRadius(this.webgl.store.grass.radius),n.needsUpdate=!0,this.base&&(this.base.geometry=this.geo,this.base.needsUpdate=!0)}setGrassRadius(t=1){this.geo.instanceCount=this.realCount*t;let e=Math.sqrt(this.geo.instanceCount/Os);e=Math.cos(Math.PI/4)*e,this.material.uniforms.uHalfBoxSize.value=e,this.material.uniforms.uHalfBoxSizeSq.value=e*e,this.material.uniforms.uHalfBoxSize.needsUpdate=this.material.uniforms.uHalfBoxSizeSq.needsUpdate=!0}update(){this.material.uniforms.uTime.value=Is.time.elapsed;const t=this.material.uniforms.uBoxPosition.value;let e=this.scene.getCurrentCamera();const s=d.get();e.grassDummy?e.grassDummy.getWorldPosition(s):s.copy(e.base.position),this.material.uniforms.camQuat.value.copy(e.base.quaternion),this.base.visible=!0;const i=h.get().set(s.x,s.z);this.base.visible&&(t.copy(s),i.sub(this.circleLastPos).normalize(),this.material.uniforms.sphereDirection.value.copy(i),this.setGrassRadius(this.webgl.store.grass.radius),i.release(),this.circleLastPos.set(s.x,s.z),s.release())}detached(){this.removeFromParent()}}let zs;Fs.use=()=>zs=zs||new Fs;var Bs=w("#define PHONG\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\nuniform float time;uniform float waterProgress;const vec3 waterColor=WATER_COLOR;const vec3 waterTopColor=WATER_TOP_COLOR;uniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform sampler2D terrain;uniform sampler2D noise;const vec3 darkerBaseTerrain=vec3(0.51,0.9,0.62);const vec3 grassColor=vec3(0.476,0.678,0.365);const vec3 paveColor=vec3(0.663,0.639,0.659);const vec3 sandLight=vec3(1.,0.976,0.78);const vec3 sandDark=vec3(0.99,0.836,0.45);const vec3 roadLight=vec3(0.843,0.82,0.812)*0.98;const float roadLighter=0.05;const vec3 roadDark=roadLight*0.91;uniform vec3 playerPos;void main(){vec4 diffuseColor=vec4(diffuse,1.);vec4 splatting=texture2D(map,vUv);float mPavement=splatting.r;float mGrass=splatting.g;float mRoad=splatting.b;float mSand=1.-splatting.a;vec3 patterns=texture2D(terrain,vWorldPos.xz*0.223).rgb;float tint=texture2D(noise,vWorldPos.xz*0.004).r;float pattern=patterns.b;float pattern2=patterns.g;float pattern3=patterns.r;tint+=smoothstep(3.2,-1.,vWorldPos.y)*3.+smoothstep(1.6,-0.5,vWorldPos.y)*4.2;float tint2=1.-smoothstep(0.,0.67,tint);diffuseColor.rgb=mix(diffuse.rgb,diffuse.rgb*darkerBaseTerrain,tint2*0.7);float sand=smoothstep(0.1,0.87,mSand);float sand2=step(pattern2,smoothstep(0.5,0.8,mSand));float sandPattern=smoothstep(0.1,0.9,pattern2*sand);vec3 sandColor=mix(sandLight,sandDark,tint*0.2);diffuseColor.rgb=mix(diffuseColor.rgb,sandColor-sandPattern*0.064,sand*sand2);float grass=smoothstep(0.1,0.88,mGrass);float grass2=step(pattern,smoothstep(0.1,1.,mGrass));float grassPattern=smoothstep(0.2,1.,pattern*grass);diffuseColor.rgb=mix(diffuseColor.rgb,grassColor+grassPattern*0.1,grass*grass2);float pave=smoothstep(0.61,0.62,mPavement);float pave2=step(pattern3,smoothstep(0.6,0.9,mPavement));float pavePattern=smoothstep(0.1,1.,pattern3*pave);diffuseColor.rgb=mix(diffuseColor.rgb,paveColor+pavePattern*0.075-tint*0.1,pave*pave2);vec3 roadColor=mix(roadLight,roadDark,tint2);float road=smoothstep(0.4,0.41,smoothstep(0.2,0.8,mRoad));vec3 roadPattern2=(smoothstep(0.,pattern,smoothstep(0.69,0.4,mRoad))*0.05+smoothstep(0.5,0.49,mRoad)*0.023)*vec3(1.,1.,0.6);float roadPattern=smoothstep(0.,pattern,smoothstep(0.6,1.1,mRoad))*roadLighter;diffuseColor.rgb=mix(diffuseColor.rgb,roadColor+roadPattern*2.-roadPattern2,road);vec3 pLen=playerPos-vWorldPos.xyz;float pFalloff=smoothstep(0.5,0.2,abs(pLen.y));float pDist=dot(pLen,pLen)*2.;float pS=smoothstep(1.4,-1.,pDist)*1.1+smoothstep(0.6,-1.8,pDist)*8.;diffuseColor.rgb=mix(diffuseColor.rgb,(diffuseColor.rgb-0.1)*0.6,diffuseColor.rgb*pS*0.08*vec3(1.8,1.8,1.1)*pFalloff);\n#include <clouds>\n#include <normal_fragment_begin>\nfloat specularStrength=0.0;vec3 totalEmissiveRadiance=emissive;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.indirectSpecular+totalEmissiveRadiance;gl_FragColor=vec4(outgoingLight,diffuseColor.a);\n#include <bg_fog>\n#include <water_depth_frag>\n}","fragmentShader");var Us=w("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\nvarying vec4 vBigShadowDirectionalCoords;uniform mat4 bigShadowMatrix;\n#include <world_pos_pars>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <world_pos>\nvec4 worldPosition=vWorldPos;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\nvec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=modelMatrix*vec4(transformed,1.)+vec4(bigShadowWorldNormal*0.05,0);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <fog_vertex>\n}","vertexShader");let js=null;class Ns extends x{constructor(){super();const t=v.resources.textures,e=this.uniforms=l(r(r(r(l(r({},I.merge([k.common,k.specularmap,k.fog,k.lights])),{time:rs.time}),rs.water),rs.bigShadow),rs.global),{map:{value:new B},terrain:{value:t.splattingPatterns},noise:{value:t.noise},playerPos:rs.playerPosition,diffuse:{value:new y(10150503).offsetHSL(0,-.3,.02)},emissive:{value:new y(0)},specular:{value:new y(1118481)},shininess:{value:0}});this.defines=r({},ms()),Bs.use(this),Us.use(this),this.map=e.map.value,this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0}}Ns.use=function(){return js=js||new Ns,js},Ns.unuse=function(){};var Vs=w("#define PHONG\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <luma>\n#include <blend_modes>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\nuniform float pixelRatio;uniform vec3 specular;uniform float shininess;uniform float time;varying vec2 vData;varying vec2 vGradient;uniform float waterProgress;const vec3 waterColor=WATER_COLOR;const vec3 waterTopColor=WATER_TOP_COLOR;uniform sampler2D noise;uniform float effectMult;uniform vec3 playerPos;void main(){\n#include <depth_dither>\nvec4 diffuseColor=vec4(1.);vec3 diffuseTexel=texture2D(map,vUv*vec2(0.5,1.)).rgb;diffuseColor.rgb*=diffuseTexel;vec3 pLen=playerPos-vWorldPos.xyz;float pFalloff=smoothstep(0.5,0.2,abs(pLen.y));float pDist=dot(pLen,pLen)*2.;float pS=smoothstep(1.0,-2.5,pDist)*8.2;diffuseColor.rgb=mix(diffuseColor.rgb,(diffuseColor.rgb-0.2)*0.5,diffuseColor.rgb*pS*0.08*vec3(1.8,1.8,1.1)*pFalloff);\n#include <clouds>\n#include <normal_fragment_begin>\nfloat rimLightPower=1.6;float rimLightStrength=.19;vec3 rimColor=vec3(1.,0.,0.);float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=vec3(rightLight*rimLightStrength)*vec3(0.9,1.,0.4);vec3 totalEmissiveRadiance=diffuseTexel*vData.g;float specularStrength=1.0;ReflectedLight reflectedLight=ReflectedLight(vec3(.0),vec3(.0),vec3(.0),vec3(.0));\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 color=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#ifndef HAS_WEBXR\nif(vData.r>0.1875){vec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 matcapUV=vec2(dot(x,normal),dot(y,normal))*0.499+0.5;matcapUV.y=1.-matcapUV.y;matcapUV.x=matcapUV.x*0.5+0.5;vec3 matcap=texture2D(map,matcapUV).rgb;vec3 lMatcapColor=matcap*smoothstep(0.,0.1,(luma(reflectedLight.directDiffuse)));vec3 shadeMatcapColor=mix(lMatcapColor,matcap,0.4+0.4*smoothstep(0.,0.4,luma(matcap)))+reflectedLight.directSpecular;color=mix(color,shadeMatcapColor,0.30);color+=(0.+smoothstep(0.99,0.995,cos(vGradient.x))+smoothstep(0.8,0.81,cos(vGradient.x-1.1))+smoothstep(0.93,0.94,cos(vGradient.x+3.)))*vGradient.y*2.1*smoothstep(1.,0.7,matcap.r)*step(0.32,vData.r)*effectMult;}\n#endif\ngl_FragColor=vec4(color,diffuseColor.a);\n#include <bg_fog>\n#include <water_depth_frag>\n}","fragmentShader");var Ws=w("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <world_pos_pars>\nuniform float time;uniform sampler2D data;varying vec2 vData;varying vec4 vBigShadowDirectionalCoords;uniform mat4 bigShadowMatrix;varying vec2 vGradient;uniform float effectMult;uniform float noLight;void main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\nvec3 dataTexel=texture2D(data,vUv).rgb;vData=dataTexel.rg;vec3 offset;if(dataTexel.b>0.2){float mult2=smoothstep(0.05,0.46,dataTexel.b);float flagmult=mix(1.,8.,smoothstep(0.5,1.,dataTexel.b));float mult=effectMult;offset.xyz=vec3(cos(time*3.+transformed.x*0.4+transformed.y*0.3)*0.06*mult2*flagmult,0.,sin(time*0.8+transformed.z*-3.+transformed.x*0.6)*-0.04)*mult;transformed+=offset;}else if(dataTexel.b>0.1){transformed.y+=sin(time)*0.08+0.08;}\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;vWorldPos=modelMatrix*vec4(transformed-offset,1.);vec4 worldPosition=vWorldPos;vec3 UP=vec3(0.,1.,0.);vec3 N=normal;vec3 T=normalize(cross(UP,normal));vec3 B=cross(normal,UP);mat3 tsb=mat3(normalize(T),normalize(B),normalize(N));vec4 t=vec4(10.,10.,10.,1.)*viewMatrix;vec3 absCam=abs(cameraPosition);float m=0.25;vGradient.x=(position*tsb).r+worldPosition.y+length(worldPosition.xyz-cameraPosition)*-0.2*m+(t.x+t.y+t.z)*0.2*m+(max(absCam.x,max(absCam.y,absCam.z)))*0.3*m;vGradient.y=smoothstep(50.,5.,length(worldPosition.xyz-cameraPosition))*0.06*vNormal.z;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\nvec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=worldPosition+vec4(bigShadowWorldNormal*0.05,0);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <fog_vertex>\n}","vertexShader");let qs=null;class Hs extends x{constructor(){super();const t=v.resources.textures,e=this.uniforms=l(r(r(r(r({},I.merge([k.common,k.specularmap,k.fog,k.lights])),rs.water),rs.bigShadow),rs.global),{time:rs.time,pixelRatio:rs.pixelRatio,playerPos:rs.playerPosition,effectMult:{value:1},map:{value:t.assetsGradients},data:{value:t.assetsData},noise:{value:t.noise},diffuse:{value:new y(16777215)},emissive:{value:new y(0)},specular:{value:new y(1118481)},shininess:{value:10}});this.defines=r({},ms()),this.map=e.map.value,Vs.use(this),Ws.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0,this.isAssetMaterial=!0,v.hooks.beforeUpdate.watch(this.udpate,this)}pauseEffects(t){this.pausedEffectID=t,this.uniforms.effectMult.value=0}resumeEffects(t){t&&t!==this.pausedEffectID||(this.pausedEffectID=null)}udpate(){if(!this.pausedEffectID){const t=this.uniforms.effectMult;t.value=U(t.value,1,.07,.001)}}}Hs.use=function(){return qs=qs||new Hs,qs},Hs.unuse=function(){};class Gs extends m{constructor(t){super(t),this.sceneID=t.sceneID,this.uid=t.uid,this.store={}}triggerInit(){super.triggerInit(),this.initDynamicProps&&this.initDynamicProps()}getSavestate(t={}){const e=t.sceneID||this.sceneID,s=t.uid||this.uid,i=!!s&&this.webgl.savestate.getActorData(e,s);if(i)return i;if(t.forceTrueWhenFinished){let i=t.forceTrueWhenFinished;const o=this.webgl.app.$quests;let a=o.getFromItem(i);if(a){let t=a.id,e=t.slice(0,-4)+"Side";t.endsWith("Main")&&o.list[e]&&(t=e),i=t}if(a=o.list[i],a&&a.completed)return this.webgl.savestate.updateActorData(e,s,!0),!0}return i}updateSavestate(t){this.webgl.savestate.updateActorData(this.sceneID,this.uid,t)}setupMainQuestExclamation(t){const e=this.webgl.app.$quests.getFromItem(t);if(!e)return;const s=e.item,i=this.webgl.savestate.getVariable(s.variable),o=e.completed&&i,a=this.interactionZone;a&&(o||(a.iconCollapsed="bubble_collapsed_exclam",this.unwatchQuest=j((()=>e.completed),(t=>{if(!t)return;const e=this.interactionZone;e&&!e.destroyed&&(e.iconCollapsed="bubble_collapsed_alt"),this.unwatchQuest()}))))}beforeDestroy(){this.unwatchQuest&&this.unwatchQuest(),super.beforeDestroy&&super.beforeDestroy()}get mixins(){const t=this.props.dynamicProps,e=["timers","reactivity","actorInteractive"];return t&&Object.keys(t).length&&e.push("actorDynamicProps","actorPropsTransition"),e}init(){}}class Ys extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"screwdriver"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:()=>{this.onInteractionDone()},onStart:()=>{this.webgl.audio.playSound("sfx_quest_bridge_repair"),this.scene.player.playEmote("Gain"),this.webgl.store.frozenPlayerDelay=500}}),this.setupInteraction({item:"screwdriver",buttonMode:"hold",sound:"sfx_quest_screwdriver_interact_loop",iconPosition:new d(.6,2,0),zone:{center:new d(.7,0,0),radius:5},cameraTarget:new d(0,1.5,0),cameraDistance:2,cameraHeight:2}))}onInteractionDone(){this.webgl.savestate.setVariable("isBridgeRepaired",!0),this.updateSavestate(!0)}}Ys.prepare=()=>({staticColliders:[{asset:"BridgeOn"}],dynamicProps:{off:{asset:"BridgeOff",collider:"BridgeOff",default:1,castFarShadow:0},on:{asset:"BridgeOn",castFarShadow:1}}});var Xs=Object.freeze(Object.defineProperty({__proto__:null,default:Ys},Symbol.toStringTag,{value:"Module"}));class Qs extends Gs{init(){this.chestPoints=this.chestPoints||ns.chestNormal,this.iconY=this.iconY||2;const t=this.getSavestate(),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8,rotateZ:-2},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:this.onInteractionDone,onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix),e=new h(5,5);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(30,40),position:t.add(new d(0,-1.2,0)),baseRadius:.3,scale:e,velDrag:.9,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:.3}),this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(60,60),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_chest_open")}}),this.setupInteraction({buttonIcon:"interactions-yes",buttonMode:"hold",icon:"bubble_quest",sound:"sfx_quest_chest_lockpick_loop",iconPosition:new d(.05,this.iconY,0),zone:{center:new d(1.3,0,0),radius:3.7},cameraTarget:new d(0,2,0),cameraDistance:1,cameraHeight:3}))}onInteractionDone(){this.webgl.savestate.incrementVariable("chestOpenCount"),this.isBigChest?this.webgl.savestate.incrementVariable("chestBigOpenCount"):this.webgl.savestate.incrementVariable("chestNormalOpenCount"),this.updateSavestate(!0);const t=this.chestPoints;this.webgl.app.$notifications.add("ChestOpen",{points:t}),this.webgl.app.$notifications.displayHint("register"),this.webgl.savestate.game.coastalPoints+=t,this.webgl.app.$analytics.event({event_category:"coreGame",event_action:"chestOpened",event_value:this.webgl.savestate.game.vars.chestOpenCount})}}Qs.prepare=()=>({staticColliders:[{asset:"Chest"}],dynamicProps:{off:{asset:"Chest",default:1,castFarShadow:0},on:{asset:"ChestOn",castFarShadow:1}}});var $s=Object.freeze(Object.defineProperty({__proto__:null,default:Qs},Symbol.toStringTag,{value:"Module"}));class Ks extends Qs{init(){this.isBigChest=!0,this.chestPoints=ns.chestBig,this.iconY=3,super.init()}}Ks.prepare=()=>({staticColliders:[{asset:"ChestBig"}],dynamicProps:{off:{asset:"ChestBig",default:1,castFarShadow:0},on:{asset:"ChestBigOn",castFarShadow:1}}});var Zs=Object.freeze(Object.defineProperty({__proto__:null,default:Ks},Symbol.toStringTag,{value:"Module"}));class Js extends Gs{init(){if(this.static=!0,!this.scene||!this.scene.fintechHalos)return;const t=this.props.fintech,e=this.webgl.app.$fintechs.list[t];e&&e.isInterest&&this.scene.fintechHalos.addHalo(e,this.props.transformMatrix)}}Js.prepare=()=>({staticProps:[{asset:"underStand"}]});var ti=Object.freeze(Object.defineProperty({__proto__:null,default:Js},Symbol.toStringTag,{value:"Module"}));class ei extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"flag"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.1,bounceVertical:1.5,rotateX:.15,rotateZ:.15},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:()=>{this.onInteractionDone()},onStart:()=>{const t=d.get().set(0,.4,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Gain"),this.webgl.store.frozenPlayerDelay=500;const e=new h(6.5,6.5);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(20,30),position:t.add(new d(0,0,0)),baseRadius:0,scale:e,velDrag:.91,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,velocityY:.08,power:.25}),t.y+=2,this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(200,200),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_plant_grow")}}),this.setupInteraction({item:"flag",buttonMode:"hold",sound:"sfx_quest_compas_interact_loop",iconPosition:new d(0,4,0),zone:{center:new d(0,0,0),radius:4.5},cameraTarget:new d(0,5,0),cameraDistance:6.5,cameraHeight:2.5}))}onInteractionDone(){this.webgl.savestate.incrementVariable("raisedFlagCount"),this.updateSavestate(!0)}}ei.prepare=()=>({staticColliders:[{asset:"FlagOff"}],dynamicProps:{off:{asset:"FlagOff",default:1,castFarShadow:0},on:{asset:"FlagOn",castFarShadow:1}}});var si=Object.freeze(Object.defineProperty({__proto__:null,default:ei},Symbol.toStringTag,{value:"Module"}));class ii extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"wateringcan"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8,rotateX:2,rotateZ:2},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:()=>{this.onInteractionDone()},onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Gain"),this.webgl.store.frozenPlayerDelay=500;const e=new h(40,100);this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e,duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(30,40),position:t.add(new d(0,-4,0)),scale:e.set(3,3),duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:.2}),t.release(),this.webgl.audio.playSound("sfx_quest_plant_grow")}}),this.setupInteraction({item:"wateringcan",buttonMode:"hold",sound:"sfx_quest_plant_interact_watering_loop",iconPosition:new d(0,1.25,0),zone:{center:new d(0,0,0),radius:1.9},cameraTarget:new d(0,1.5,0),cameraDistance:2,cameraHeight:2}))}onInteractionDone(){this.webgl.savestate.incrementVariable("grownTreeCount"),this.updateSavestate(!0)}}ii.prepare=()=>({staticColliders:[{asset:"GrowableTreeSmall"}],dynamicProps:{off:{asset:"GrowableTreeSmall",default:1,castFarShadow:0},on:{asset:"GrowableTreeLarge",castFarShadow:1}}});var oi=Object.freeze(Object.defineProperty({__proto__:null,default:ii},Symbol.toStringTag,{value:"Module"}));class ai extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"hammer"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8,rotateZ:2},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:()=>{this.onInteractionDone()},onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Gain"),this.webgl.store.frozenPlayerDelay=500;const e=new h(12,12);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(40,50),position:t.add(new d(0,0,0)),baseRadius:5,scale:e,velDrag:.9,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:1}),t.y+=2,this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(300,300),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_house_build")}}),this.setupInteraction({item:"hammer",sound:"sfx_quest_hammerImpact",buttonMode:"tap",iconPosition:new d(4.6,3,0),zones:[{center:new d(3.5,0,-1.4),radius:4.85},{center:new d(3.5,0,1.4),radius:4.85}],cameraTarget:new d(0,1.5,0),cameraDistance:5,cameraHeight:3}))}onInteractionDone(){this.webgl.savestate.incrementVariable("builtHouseCount"),this.updateSavestate(!0)}}ai.prepare=()=>({preloadAssets:[],staticProps:[],staticColliders:[{asset:"AvenHouseOff"}],dynamicProps:{off:{asset:"AvenHouseOff",default:!0,castFarShadow:!0},on:{asset:"AvenHouseON",castFarShadow:!1}}});var ni=Object.freeze(Object.defineProperty({__proto__:null,default:ai},Symbol.toStringTag,{value:"Module"}));class ri extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"scissor"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off&&this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8,rotateX:1},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:()=>this.onTransitionDone(),onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix),e=new h(12,12);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(40,50),position:t.add(new d(5,0,5)),baseRadius:7,scale:e,velDrag:.9,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:1}),t.y+=7,this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(300,300),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release()}})}onTransitionDone(){this.webgl.savestate.setVariable("isCoffeeShopOpen",!0),this.updateSavestate(!0)}get mixins(){return["reactivity","actorDynamicProps","actorPropsTransition"]}}ri.prepare=()=>({staticColliders:[{asset:"CoffeeShopOn"}],dynamicProps:{off:{asset:"CoffeeShopOff",default:!0,castFarShadow:0},on:{asset:"CoffeeShopOn",castFarShadow:0}}});var li=Object.freeze(Object.defineProperty({__proto__:null,default:ri},Symbol.toStringTag,{value:"Module"}));class ci extends Gs{init(){const t=this.getHouseName(),e=this.getSavestate({forceTrueWhenFinished:"scissor",uid:t}),s=this.dynamicPropsState;s.off=!e,s.on=!!e,s.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:0,bounceVertical:.04,rotateZ:1.5},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onStart:()=>{this.webgl.audio.playSound("sfx_quest_inauguration"),this.scene.player.playEmote("Victory"),this.webgl.store.frozenPlayerDelay=800}}),this.setupInteraction({item:"scissor",buttonMode:"tap",sound:"sfx_quest_scissors_interact",iconPosition:new d(0,1,1),zone:{center:new d(0,0,1.4),radius:2.5},cameraTarget:new d(1.6,1,-6),cameraDistance:5,cameraHeight:3,onDone:()=>{this.actor=this.scene.actors[this.houseActorName],this.actor&&this.actor.startPropsTransition(),this.startPropsTransition()}}))}getHouseName(){if(this.houseActorName)return this.houseActorName;const t=this.scene.manifest.actors;let e=this.props.houseActor,s=t[e];if(!s){const i=this.props.houseActor.split("."),o=i.shift(),a=0|i.pop();for(let n=1;n<10;n++){if(e=o+"."+(""+(a+n)).padStart(3,0),s=t[e],s)break}}return s&&(this.houseActorName=e),this.houseActorName}}ci.prepare=()=>({dynamicProps:{off:{asset:"BlueVineRibbonOff",collider:"BlueVineRibbonOff",default:1,castFarShadow:0},on:{asset:"BlueVineRibbonOn",castFarShadow:0}}});var hi=Object.freeze(Object.defineProperty({__proto__:null,default:ci},Symbol.toStringTag,{value:"Module"}));const di=function(){};class ui{constructor({atlas:t,id:e,group:s,sequence:i,loop:o,autoplay:a,frame:n,onUpdate:r,onEnd:l,onEndOnce:c,frameDuration:h,category:d}){this.frames=[],this.onUpdate=r||di,this.onEndOnce=c||di,this.onEnd=l||di,this.id=void 0!==e?e:s+"/"+i,this.group="",this.sequence="",this.loop=!!o,this.autoplay=!!a,this.frame=n||0,this.frameCount=0,this.frameDuration=h||48,this.frameTimer=60*Math.random(),this.currentFrameIndex=0,this.paused=!1,this.ended=!1,this.category=d||"atlas",this.atlas=t,t&&(this.setAtlas(t),this.change({id:this.id,frameDuration:this.frameDuration,autoplay:this.autoplay,loop:this.loop,frame:this.frame}))}setAtlas(t){t&&(this.sprites=t.sprites||t)}change({id:t="circle",group:e,sequence:s,frame:i,frameDuration:o,autoplay:a,loop:n}){if(this.sprites[t]){if(void 0!==t){this.id=t;const e=this.id.split("/");this.sequence=e.pop(),this.group=e.join("/")}else void 0!==s&&(void 0!==e&&(this.group=e),this.sequence=s,this.id=this.group+"/"+this.sequence);this.frames=this.sprites[this.id],this.frameCount=this.frames.length,this.currentFrameIndex=Math.min(i||0,this.frameCount-1),this.frame=this.frames[this.currentFrameIndex],this.loop=!!n,this.autoplay=!!a,this.frameDuration=o||48,this.paused=!this.autoplay,this.frameCount<2?this.end():this.ended=!1,this.onUpdate(this.frame)}}end(){this.ended=!0,this.onEndOnce(this.frame),this.onEndOnce=di,this.onEnd(this.frame)}play(){this.paused=!1,this.isBackwards=!1,this.ended=!1}playBackwards(){this.paused=!1,this.isBackwards=!0,this.ended=!1}reset(){this.ended=!1,this.paused=!1,this.currentFrameIndex=0}resetFrame(){this.currentFrameIndex=0,this.frame=this.frames[this.currentFrameIndex]}pause(){this.paused=!0}nextFrame(){let t=this.currentFrameIndex+1;if(t>=this.frameCount){if(!this.loop)return void this.end();t=0}t!==this.currentFrameIndex&&(this.currentFrameIndex=t,this.frame=this.frames[this.currentFrameIndex],!this.loop&&t+1>=this.frameCount&&this.end())}previousFrame(){let t=this.currentFrameIndex-1;if(t<0){if(!this.loop)return void this.end();t=this.frameCount}t!==this.currentFrameIndex&&(this.currentFrameIndex=t,this.frame=this.frames[this.currentFrameIndex],!this.loop&&t-1<0&&this.end())}update(t){this.ended||this.paused||(this.frameTimer<=0&&(this.frameTimer=Math.max(0,this.frameDuration+this.frameTimer),this.isBackwards?this.previousFrame():this.nextFrame()),this.frameTimer-=t)}destroy(){this.sprites=this.frames=this.frame=this.onUpdate=null}}const pi=new N;let mi;class fi{constructor(t){mi||(mi=c()),this.isComponent=!0,t.batcher&&(this.batcher="string"==typeof t.batcher?mi.particles.batchers[t.batcher]:t.batcher,t.atlas=this.batcher.atlas,t.batcher=null),this.dummy=pi,this.position=new d,this.scale=new h(1,1),this.quaternion=new O,this.color=new y(16777215),t.rotation?(this.useEuler=!0,this.rotation=new z,this.rotation.copy(t.rotation)):t.useEuler&&(this.useEuler=!0,this.rotation=new z),this.alpha=null!=t.alpha?t.alpha:1,this.initialAlpha=this.alpha,this.visible=!0,this.parent=t.parent||null,this.textured=!!t.textured,this.billboard=!!t.billboard,this.angle=t.angle||0,t.position&&this.position.copy(t.position),null!=t.color&&("number"==typeof t.color?this.color.set(t.color):this.color.copy(t.color)),t.scale&&("number"==typeof t.scale?this.scale.setScalar(t.scale):this.scale.copy(t.scale)),t.quaternion&&this.quaternion.copy(t.quaternion),this.sprite=new ui(l(r({},t),{id:t.sprite||t.id})),this.batcher&&this.batcher.addInstance(this),this.init(t),this.sprite.update(1)}init(){}update(){const t=mi.time.stableDt;this.sprite.update(t)}destroy(){this.batcher&&this.batcher.removeInstance(this),this.parentComponent&&this.parentComponent.removeComponent(this),this.sprite.destroy(),this.sprite=this.batcher=null,this.props=null}}new d;const gi=new h;class bi extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"lightbulb"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.on?this.setLights():e.off&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:1.1,delayAfter:1400},transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onStart:()=>{this.isTransitionActive=!0,this.scene.player.playEmote("Victory"),this.webgl.store.frozenPlayerDelay=800,this.webgl.audio.playSound("sfx_quest_lighthouse_build");const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix),e=new h(8,8);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(40,50),position:t,baseRadius:3,scale:e,velDrag:.85,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:1}),t.y+=7,this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(300,300),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.setLights()},onDone:()=>{this.isTransitionActive=!1,this.onInteractionDone()}}),this.setupInteraction({item:"lightbulb",buttonMode:"hold",sound:"sfx_quest_lighthouse_interact_loop",iconPosition:new d(4.6,3,0),zone:{center:new d(3.3,0,0),radius:7.3},cameraTarget:new d(0,11,0),cameraDistance:19.5,cameraHeight:12.5,posEase:.07,lookAtEase:.08}))}setLights(){if(this.haloSprite)return;const t=new d(0,21.3,0).applyMatrix4(this.props.transformMatrix);this.defaultY=t.y;const e={batcher:"emissive",sprite:"lighthouse_halo",scale:20,angle:Math.PI,position:t,useEuler:!0,billboard:!1,color:5587968,sortable:!0};this.haloSprite=new fi(r({},e)),this.haloSprite2=new fi(l(r({},e),{scale:gi.set(e.scale,-e.scale)})),this.haloSprite.rotation=new z(0,Math.PI/3,0),this.haloSprite2.position=this.haloSprite.position,this.haloSprite2.rotation=this.haloSprite.rotation,this.haloSphere=new V(t,15)}update(){if(!this.haloSprite)return;const t=this.scene.frustum,e=this.webgl.time.dt;this.isTransitionActive&&(this.haloSprite2.position.y=this.defaultY*this.springY.value,this.haloSprite.scale.y=20*this.springY.value,this.haloSprite2.scale.y=-this.haloSprite.scale.y),this.haloSprite.rotation.y+=.001*e;const s=t.intersectsSphere(this.haloSphere);this.haloSprite.visible=this.haloSprite2.visible=s}onInteractionDone(){this.webgl.savestate.incrementVariable("enlightedLighthouseCount"),this.updateSavestate(!0)}beforeDestroy(){this.haloSprite&&this.haloSprite.destroy(),this.haloSprite2&&this.haloSprite2.destroy()}}bi.prepare=()=>({preloadAssets:[],staticColliders:[{asset:"BuildingFOff"}],dynamicProps:{off:{asset:"BuildingFOff",default:1,castFarShadow:1},on:{asset:"BuildingF",castFarShadow:0}}});var yi=Object.freeze(Object.defineProperty({__proto__:null,default:bi},Symbol.toStringTag,{value:"Module"}));const vi={default:"ShopRamen",ramen:"ShopRamen",kite:"ShopKite",clothes:"ShopClothes"};class wi extends Gs{init(){let t=this.getSavestate({forceTrueWhenFinished:"compass"});if(!t){this.webgl.savestate.game.saveVersion>3&&(this.updateSavestate(!0),t=!0)}const e=this.dynamicPropsState;e.offBase=e.offDetail=!t,e.on=!!t,e.offBase&&(this.setupPropsTransition({preset:"Bounce",presetOpts:{bounceHorizontal:.8,rotateZ:2},transitionAsset:this.dynamicProps.on.asset,stateAfter:{offBase:!1,offDetail:!1,on:!0},onDone:()=>{this.onInteractionDone()},onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Gain"),this.webgl.store.frozenPlayerDelay=500;const e=new h(12,12);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(40,50),position:t.add(new d(0,-1.3,-1)),baseRadius:2.2,scale:e,velDrag:.88,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:1}),t.y+=2,this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(300,300),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_shop_open")}}),this.setupInteraction({item:"compass",buttonMode:"hold",sound:"sfx_quest_compas_interact_loop",iconPosition:new d(4,1.6,-2.96),zones:[{center:new d(4.1,0,-1.6),radius:4},{center:new d(4.3,0,0),radius:4}],cameraTarget:new d(0,1.5,0),cameraDistance:5,cameraHeight:3}))}onInteractionDone(){this.webgl.savestate.incrementVariable("soldShopCount"),this.updateSavestate(!0)}}wi.prepare=({actor:t,savedata:e})=>{const s=(t.params.ShopType||"").toLowerCase(),i=vi[s]||vi.default,o=v.app.$device.type.mobile;return{staticColliders:[{asset:"ShopForSaleBase"}],dynamicProps:{offBase:{asset:"ShopForSaleBase",default:1,castFarShadow:!e},offDetail:{asset:"ShopForSaleDetails",default:1,castFarShadow:!e&&!o},on:{asset:i,castFarShadow:!!e}}}};var xi=Object.freeze(Object.defineProperty({__proto__:null,default:wi},Symbol.toStringTag,{value:"Module"}));const Si=new d,_i=new d;const Pi=0,Mi=1,Ti=256;new N,new O,new h,new h,new d,new d,new d,new W;const Ai={timer:0,angle:0,target:0,disabled:!0,delay:1300},Ci={curveLoop:{min:2,max:3},curvePingPong:{min:2,max:3},points:{min:1,max:3},area:{min:1,max:3}},Di=new d,Ii=t=>("string"==typeof t&&(t=t.trim().replace(",",".")),t=parseFloat(t),isNaN(t)?0:t);class ki extends Gs{constructor(t){super(t),this.keepUpright=!0,this.isNPC=!0,this.inInteraction=!1,this.inFOV=!1,this.canLookPlayer=!0,this.npcID=this.props.subtype,this.script=this.props.npcConfig.script,this.args=this.props.npcConfig.scriptArgs||{},this.hasPhysic=!0,this.closableDialog=!0,this.lastInteractionPosition=new d}beforeInit(){this.moveInstructions=this.parseMove(this.props.move),this.isMoving=!!this.moveInstructions,this.canRun=this.moveInstructions&&this.moveInstructions.isRunning,this.canMove=!!this.isMoving}parseMove(t){if(!t||!t.length)return;const e=t.split(","),s={};for(let o=0,a=e.length;o<a;o++){const t=e[o];if(0===t.length)continue;const[i,a]=t.split("=");if(i)switch(i.trim().toUpperCase()){case"CURVE":const t=a.trim();let e=this.scene.getCurve(t);e&&(s.curve=e=e.raw,"POLY"===e.type?s.type="points":s.type=e.closed?"curveLoop":"curvePingPong");break;case"RADIUS":s.type="area",s.radius=Ii(a.trim());break;case"PAUSEMIN":s.pauseMin=Ii(a.trim());break;case"PAUSEMAX":s.pauseMax=Ii(a.trim());break;case"VELOCITY":case"SPEED":s.velocity=Ii(a.trim());break;case"RUN":case"RUNNING":s.isRunning=!0;break;case"NOSKIPS":case"NOSKIP":s.noSkips=!0}}if(!s.type)return;const i=Ci[s.type];return null==s.pauseMax&&(s.pauseMax=s.pauseMin||i.max),null==s.pauseMin&&(s.pauseMin=Math.max(0,s.pauseMax-(i.max-i.min))),null==s.velocity&&(s.velocity=s.isRunning?6:2.3),s}afterInit(){if(this.prevPosition=this.base.position.clone(),this.basePosition=this.base.position.clone(),this.baseQuaternion=this.base.quaternion.clone(),this.isBodyReady=!1,this.firstUpdates=10,this.hasPhysic){const t=this.scene.physics;if(this.body=new V(this.base.position.clone(),1.25),this.body.isCulled=null,this.body.cull=t=>{this.body.isCulled!==t&&(this.body.isCulled=!!t,this.scene.physics.cullSphere(this.uid,!!t))},this.moveInstructions){this.body.isStopped=null,this.body.stop=t=>{this.body.isStopped!==t&&(this.body.isStopped=!!t,this.scene.physics.stopSphere(this.uid,!!t))};const t=this.moveInstructions.type;"curveLoop"!==t&&"curvePingPong"!==t&&"points"!==t||(this.body.center.x=this.moveInstructions.curve.points[0][0],this.body.center.z=this.moveInstructions.curve.points[0][2])}Promise.all([t.readyPromise,t.addSphere({id:this.uid,sphere:this.body,mode:Ti,moveToFloor:!0,move:this.moveInstructions})]).then((()=>new Promise((t=>requestAnimationFrame(t))))).then((()=>{this.destroyed||(this.isBodyReady=!0,this.firstUpdates=50)}))}else this.isBodyReady=!0;this.playerLookAt=r({},Ai),this.outfit={},this.base.manualMatrixUpdate=!0,this.updateChatInteraction=this.bind("updateChatInteraction"),this.updateChatInteraction(),this.args.animation&&this.forceIdle(this.args.animation)}beforeUpdate(){if(this.hasPhysic){const t=this.shouldUpdateSkeleton();this.body.cull(!t),this.base.position.copy(this.body.center),this.base.position.y+=.0135+this.shoesOffset-this.body.radius,this.isMoving&&(this.speed>.006&&t&&(Di.copy(this.base.position),this.base.position.copy(this.lastPos),this.base.position.y=Di.y,this.base.lookAt(Di),this.base.position.copy(Di),this.needsInstantLookAt?this.baseQuaternion.copy(this.base.quaternion):this.baseQuaternion.slerp(this.base.quaternion,this.canRun?.13:.07)),this.needsInstantLookAt=!t)}else this.base.position.copy(this.basePosition);this.base.quaternion.copy(this.baseQuaternion),this.interactionZone&&!this.lastInteractionPosition.equals(this.base.position)&&(this.lastInteractionPosition.copy(this.base.position),this.interactionZone.updatePosition(this.base.position),this.needsInteractionZoneUpdate=!1),this.isMoving&&this.scene.player&&this.scene.player.canMove&&this.body.stop(this.inInteraction||!this.canMove)}shouldUpdateSkeleton(){return this.charMesh.visible}updatePlayerLookAt(){const t=this.webgl.time.dt,e=this.playerLookAt;if(this.scene.player&&this.scene.player.canMove&&e.timer<e.delay&&(e.timer+=t),this.inInteraction){const t=this.scene.player.base.position,s=function(t,e){const s=Si.copy(e).sub(t.position).normalize(),i=_i.set(0,0,1).applyQuaternion(t.quaternion);return Math.atan2(i.z,i.x)-Math.atan2(s.z,s.x)}(this.base,t);this.inFOV=this.isMoving?this.speed<.005:Math.abs(s)<1.65,(this.inFOV||this.isTalking)&&(e.target=s,e.timer=0)}if(0===e.angle&&e.timer>0)return;const s=e.timer>=e.delay,i=s?0:e.target;e.angle=q(e.angle,i,s?.04:.1),Math.abs(e.angle-i)<.01&&(e.angle=i),this.base.rotateY(e.angle)}afterUpdate(){this.isBodyReady&&this.firstUpdates>0&&this.firstUpdates--,this.inInteraction=this.interactionZone&&this.interactionZone.enabled,this.canLookPlayer&&this.updatePlayerLookAt(),this.isTalking&&this.scene.player.rotateAt(this.base.position)}hasTalkedWith(){return!!this.getSavestate()}getCurrentDialog(){}onDialogExit(){this.getSavestate()||(this.updateSavestate(!0),this.webgl.savestate.incrementVariable("npcEncounteredCount"))}updateChatInteraction(){if(this.destroyed)return;const t=this.getCurrentDialog();if(!t)return;this.interactionZone&&(this.interactionZone.destroy(),this.interactionZone=null);const e={onExit:()=>{this.setIdleAnimation(),setTimeout(this.updateChatInteraction,800)}};this.args&&this.args.fintech&&(e.fintech=this.args.fintech),this.closableDialog&&(e.closable=!0);let s="bubble_talk",i="bubble_collapsed";this.hasTalkedWith()&&(i="bubble_collapsed_talked",s="bubble_talked");const o=new p;o.compose(this.base.position,this.base.quaternion,Di.setFromMatrixScale(this.props.transformMatrix)),this.lastInteractionPosition.copy(this.base.position),this.setupInteraction({buttonIcon:"interactions-chat",buttonMode:"click",audioEnabled:"sfx_UI_notif_NPCcall",icon:this.dialogIcon||s,iconCollapsed:this.dialogIconCollapsed||i,iconPosition:new d(0,2.7,0),zone:{center:new d(0,0,0),radius:4.5},matrix:o,onDone:()=>{this.webgl.audio.playSound("sfx_UI_dialog_opendialog"),this.startDialog(t,e)}})}get mixins(){return[...super.mixins,"character","characterAnimations","dialog"]}}ki.isNPC=!0;var Oi=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{init(){this.firstTimeDone=this.hasTalkedWith(),this.firstTimeID=this.npcID+"_FirstTime",this.comeBackID=this.npcID+"_ComeBack",this.fintechID=this.args.fintech,this.metVar=this.fintechID&&"hasMet"+H(this.fintechID)+"Ambassador",super.init()}getCurrentDialog(){const t=this.webgl.app.$fintechs.list[this.fintechID];return t&&t.isInterest?this.dialogIconCollapsed="bubble_collapsed_star":this.dialogIconCollapsed=void 0,this.firstTimeDone?this.comeBackID:this.firstTimeID}analyticsEvent(){this.webgl.app.$analytics.pageview({title:`Coastal World - Talk with ${this.fintechID}'s Ambassador`,path:"/quest-ambassador-"+this.fintechID})}onDialogStart(){this.analyticsEvent()}onDialogExit(){super.onDialogExit(),this.firstTimeDone=!0;const t=this.webgl.savestate.game.vars;this.metVar&&!t[this.metVar]&&(t[this.metVar]=!0)}}},Symbol.toStringTag,{value:"Module"}));const Ri=new d;new O;var Li=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{beforeInit(){this.hasPhysic=!1,this.keepUpright=!1}init(){super.init(),this.scene.npcIntro=this,this.lastPlayEmote=0,this.lookQt=new O,this.registerDialogMethod("CP_START",this.analyticsLaunchQuestion.bind(this)),this.registerDialogMethod("CP_QUESTION_1",this.analyticsAnswerA.bind(this)),this.registerDialogMethod("CP_QUESTION_2",this.analyticsAnswerB.bind(this)),this.watchSignal(this.webgl.store.intro.ctaHover,this.onCtaHover),this.watchSignal(this.webgl.store.intro.descentDone,this.onDescentDone)}onDescentDone(t){t&&this.throttlePlayEmote("Hello")}throttlePlayEmote(t="Gain"){const e=this.webgl.time.elapsed;e-this.lastPlayEmote<1500||(this.lastPlayEmote=e,this.playEmote(t))}onCtaHover(){this.throttlePlayEmote("Gain")}beforeUpdate(){const t=this.scene.boat;t&&(t.npcPt.getWorldPosition(this.basePosition),t.npcPt.getWorldQuaternion(this.baseQuaternion),super.beforeUpdate())}analyticsLaunchQuestion(){this.webgl.app.$analytics.event({event_category:"customPath",event_action:"launchQuestions",event_value:""})}analyticsAnswerA(t){this.webgl.app.$analytics.event({event_category:"customPath",event_action:"question1",event_value:t[0]})}analyticsAnswerB(t){this.webgl.app.$analytics.event({event_category:"customPath",event_action:"question2",event_value:t[0]})}update(){this.scene.getCurrentCamera().cam.getWorldPosition(Ri),Ri.y=this.base.position.y,this.base.lookAt(Ri)}}},Symbol.toStringTag,{value:"Module"}));class Ei extends ki{init(){const t=(this.npcID.split("_").shift()||"").toLowerCase();if(!this.questPrefix){const e=this.webgl.app.$fintechs.list[t];if(e&&e.quest){const t=e.quest,s=t.id.replace(/(Main|Side)$/i,""),i=t.item;this.questPrefix=s,this.item=i}}this.questPrefix=this.questPrefix||"__",this.fintechID=this.questPrefix.toLowerCase(),this.beforeID=this.beforeID||this.npcID+"_Before",this.startedID=this.startedID||this.npcID+"_Started",this.completedID=this.completedID||this.npcID+"_Completed",this.sideCompletedID=this.sideQuestCompletedID||this.npcID+"_SideCompleted",super.init(),this.mainQuestCompleted=!1,this.sideQuestCompleted=!1;const e=this.webgl.app.$quests[this.questPrefix+"Main"],s=this.webgl.app.$quests[this.questPrefix+"Side"];this.hasSideQuest=!!s,e&&(e.completed?this.onMainQuestCompleted(!0):this.unwatchMainQuest=j((()=>e.completed),(t=>this.onMainQuestCompleted(t)))),s&&(s.completed?this.onSideQuestCompleted(!0):this.unwatchSideQuest=j((()=>s.completed),(t=>this.onSideQuestCompleted(t)))),this.registerDialogMethod("GIVE_QUEST_ITEM",this.giveQuestItem.bind(this))}onMainQuestCompleted(t){t&&(this.mainQuestCompleted=!0,this.unwatchMainQuest&&this.unwatchMainQuest(),this.unwatchMainQuest=null,this.updateChatInteraction())}onSideQuestCompleted(t){t&&(this.sideQuestCompleted=!0,this.unwatchSideQuest&&this.unwatchSideQuest(),this.unwatchSideQuest=null,this.updateChatInteraction())}giveQuestItem(){if(this.item)return new Promise((t=>{this.webgl.app.$stores.itemNotification={variable:this.item.variable,image:this.item.image,onDone:t}}))}getCurrentDialog(){let t=this.beforeID,e="bubble_quest",s="bubble_collapsed_exclam";return this.item&&this.webgl.savestate.getVariable(this.item.variable)&&(t=this.startedID,e=s=null),this.mainQuestCompleted&&(t=this.completedID,e=s=null),this.sideQuestCompleted&&(t=this.sideCompletedID,e=s=null),this.dialogIcon=e,this.dialogIconCollapsed=s,t}analyticsEvent(){this.webgl.app.$analytics.pageview({title:`Coastal World - Talk with ${this.fintechID}'s Quest Giver`,path:"/quest-giver-"+this.fintechID})}onDialogStart(){this.analyticsEvent()}beforeDestroy(){this.unwatchMainQuest&&this.unwatchMainQuest(),this.unwatchSideQuest&&this.unwatchSideQuest(),this.unwatchMainQuest=this.unwatchSideQuest=null,super.beforeDestroy&&super.beforeDestroy()}}var Fi=Object.freeze(Object.defineProperty({__proto__:null,default:Ei},Symbol.toStringTag,{value:"Module"}));const zi={one:"One",prosper:"Prosper",coastal:"Coastal",brigit:"Brigit"};var Bi=Object.freeze(Object.defineProperty({__proto__:null,default:class extends Ei{init(){const t=(this.npcID.split("_").shift()||"").toLowerCase();this.questPrefix=zi[t]||"__",this.firstTimeDone=!1,this.firstTimeID=this.npcID+"_FirstTime",this.comeBackID=this.npcID+"_ComeBack",this.beforeSideID=this.npcID+"_BeforeSide",this.sideCompletedID=this.npcID+"_SideCompleted",super.init()}getCurrentDialog(){if(this.travelling)return;let t=this.firstTimeID,e="bubble_quest",s="bubble_collapsed_exclam";return this.firstTimeDone&&(e="bubble_quest",s="bubble_collapsed_exclam",t=this.comeBackID),this.mainQuestCompleted&&(this.hasQuest=this.hasSideQuest,e=this.hasQuest?"bubble_quest":null,s=this.hasQuest?"bubble_collapsed_alt":null,this.useQuestMark=!1,t=this.beforeSideID),this.sideQuestCompleted&&(e=null,s=null,t=this.sideCompletedID),this.dialogIcon=e,this.dialogIconCollapsed=s,t}onDialogStart(){this.analyticsEvent()}onDialogDone(t,e){const s="yes"===e.AskPlay||"Yes"===e.AskPlay;if(this.firstTimeDone=!0,!s)return;const i=this.args.scene;i&&(this.travelling=!0,this.webgl.scenes.teleportTo(i,{delay:800}))}}},Symbol.toStringTag,{value:"Module"}));const Ui={Swimming:{hasPhysic:!1,keepUpright:!1,floating:!0,timeScale:.5},Seating:{hasPhysic:!1,keepUpright:!1},Towel:{hasPhysic:!1,keepUpright:!1}};var ji=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{beforeInit(){super.beforeInit();const t=this.passiveAnim=this.args.animation,e=this.animPreset=Ui[t]||{};null!=e.hasPhysic&&(this.hasPhysic=e.hasPhysic),null!=e.keepUpright&&(this.keepUpright=e.keepUpright)}init(){super.init(),this.animPreset.floating&&(this.base.position.y=-1.35),this.time=0}afterInit(){super.afterInit();const t=this.passiveAnim,e=this.animPreset;if(!this.allAnims[t])return;const s={time:Math.random()};e.timeScale&&(s.timeScale=e.timeScale),this.setAnimation(this.passiveAnim,s)}updateFloating(){const t=this.time+=.001*this.webgl.time.dt,e=this.scene.water;this.base.position.y+=e.base.position.y,this.base.translateZ(.2*Math.cos(.5*t)),this.base.rotation.y+=.4*Math.sin(.7*t);this.base.translateY(1.2),this.base.rotateX(.15*Math.sin(1.4*t)-.1),this.base.rotateZ(.02*Math.cos(3*t+.2)),this.base.translateY(-1.2)}update(){this.animPreset.floating&&this.updateFloating()}getCurrentDialog(){}}},Symbol.toStringTag,{value:"Module"}));var Ni=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{init(){this.dialogIcon="bubble_boat",this.dialogIconCollapsed="bubble_collapsed_boat",this.firstTimeDone=this.hasTalkedWith(),this.firstTimeID=this.npcID+"_FirstTime",this.comeBackID=this.npcID+"_ComeBack",super.init()}getCurrentDialog(){if(!this.travelling)return this.firstTimeDone?this.comeBackID:this.firstTimeID}async onDialogDone(t,e){if(t.id===this.firstTimeID&&(this.firstTimeDone=!0),"yes"!==e.Travel)return;this.travelling=!0;const s=this.args.scene||"IslandWest",i=this.args.point||"Spawn";this.webgl.scenes.teleportTo(s,{point:i,delay:800})}}},Symbol.toStringTag,{value:"Module"}));var Vi=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{getCurrentDialog(){if(this.webgl.app.$dialogs.list[this.npcID])return this.npcID}}},Symbol.toStringTag,{value:"Module"}));const Wi=new h;var qi=Object.freeze(Object.defineProperty({__proto__:null,default:class extends ki{init(){this.registerDialogMethod("HEAL",this.healAnimation.bind(this)),this.healed=this.getSavestate({forceTrueWhenFinished:"stethoscope"}),this.canMove=this.isMoving&&this.healed,this.healed?this.setHealedIdle():(this.setupInteraction({item:"stethoscope",buttonMode:"hold",sound:"sfx_quest_healing_interact_loop",iconPosition:new d(0,2.5,0),zone:{center:new d(0,0,0),radius:4},cameraTarget:new d(0,1,0),cameraDistance:2,cameraHeight:2,playerActionPreset:"None",onDone:this.heal.bind(this)}),this.setAnimation("Sick",{loop:!0,time:Math.random()}))}async heal(){this.webgl.audio.playSound("sfx_quest_healing_done",{delay:50}),this.startDialog("Zenda_Healed",{onDone:this.onHealed.bind(this)})}async healAnimation(){if(await this.wait(90),this.fakeHealed=!0,this.setAnimation("Healed",{loop:G}),await this.wait(300),this.healed)return;const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix),e=new h(5,5);this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(30,30),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release()}setHealedIdle(){}getCurrentDialog(){if(this.healed||this.getSavestate())return"Zenda_Healed"}async onHealed(){this.webgl.savestate.incrementVariable("healedCitizenCount"),this.healed=!0,this.canMove=this.isMoving&&this.healed,await Y(800),this.destroyed||this.updateChatInteraction()}update(){const t=this.interactionZone;if(t&&t.isHidden&&!this.fakeHealed&&this.webgl.time.frameNum%23==0){const t=d.get().copy(this.base.position);t.y+=2.2,this.webgl.particles.emit("healing",{amount:T.randomInt(1,1),position:t,scale:Wi.set(2,2),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,sprite:"smoke2",power:7}),t.release()}}}},Symbol.toStringTag,{value:"Module"}));class Hi extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"shears"}),e=this.dynamicPropsState;e.off=!t,e.off&&(this.setupPropsTransition({preset:"Tween",presetOpts:{delayAfter:100,scaleY:{easing:"inOutQuint",duration:900,from:1,to:.3},positionY:{easing:"inOutQuint",duration:750,from:0,to:-2.5}},transitionAsset:this.dynamicProps.off.asset,stateAfter:{off:!1},onDone:this.onInteractionDone,onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Victory");const e=new h(270,220);this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e,duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(30,40),position:t.add(new d(-5,0,0)),scale:e.set(10,10),duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_Skatepark_cleaned")}}),this.setupInteraction({item:"shears",buttonMode:"hold",sound:"sfx_quest_Skatepark_interact_loop",iconPosition:new d(-11,2,-6),zone:{center:new d(-9,0,-4),radius:9.4},cameraTarget:new d(-3,2,-3),cameraDistance:4,cameraHeight:5}))}onInteractionDone(){this.webgl.savestate.setVariable("isSkateparkCleaned",!0),this.updateSavestate(!0)}}Hi.prepare=()=>({dynamicProps:{off:{asset:"SkateparkOvergrowth",collider:"SkateparkOvergrowth",default:1,castFarShadow:0}}});var Gi=Object.freeze(Object.defineProperty({__proto__:null,default:Hi},Symbol.toStringTag,{value:"Module"}));const Yi=$([0,.52,.285,.98]),Xi=$([.885,.055,.5,1.005]);new K(1,2);let Qi=[];class $i extends m{get mixins(){return["reactivity"]}init(){const t=this.props;this.canDuck=!!t.duck,this.canMute=!!t.mute,this.sampleID=t.sample||"sfx_quest_sono_loop",this.sample=null,this.enabled=!1,this.fade=0,this.volume=0,this.minVolume=null!=t.minVolume?t.minVolume:.3,this.maxVolume=null!=t.maxVolume?t.maxVolume:1,this.radius=t.radius||5,this.sqRadius=this.radius*this.radius,this.position=new d,this.basePosition=new d,t.position&&this.basePosition.copy(t.position),t.matrix&&this.applyMatrix4(t.matrix),Qi.push(this),this.watchSignalImmediate(this.webgl.audio.unlocked,this.onAudioUnlock),this.watchSignal(this.webgl.store.isTransitionActive,this.onTransition)}applyMatrix4(t){this.position.copy(this.basePosition).applyMatrix4(t)}stopSound(){this.sample&&this.sample.stop(),this.sample=null}playSound(){if(!this.enabled||!this.webgl.audio.unlocked.value)return;this.stopSound();const t=this.webgl.audio.list[this.sampleID];if(!t)return;const e=.001*this.webgl.time.elapsed%t.duration,s=t.start,i=t.end;this.sample=this.webgl.audio.playSound(this.sampleID,{loop:!0,start:s+e,volume:this.volume,loopStart:s,loopEnd:i})}onTransition(t){this.forceDisabled=t}onAudioUnlock(t){this.log(t),t?this.playSound():this.stopSound()}onEnabled(){this.enabled=!0,this.playSound(),this.log("enabled")}onDisabled(){this.enabled=!1,this.log("disabled")}update(){if(!this.scene.player.isBodyReady)return;if(this.destroying||this.destroyed)return;const t=this.webgl.time.dt,e=this.scene.player.base.position.distanceToSquared(this.position),s=!this.forceDisabled&&e<=this.sqRadius;if(s&&!this.enabled?this.onEnabled():!s&&this.enabled&&this.onDisabled(),!this.sample)return;this.fade=X(this.fade,s?1:0,s?.04:.068,t,.001);const i=this.fade>=.001?Xi(this.fade):0,o=Q(e,this.sqRadius,this.sqRadius/6,this.minVolume,this.maxVolume);this.volume=i*o,this.sample.volume=this.volume,!s&&this.volume<=0&&this.stopSound()}beforeDestroy(){this.forceDisabled=!0,this.stopSound();const t=Qi.indexOf(this);t>=0&&Qi.splice(t,1)}}$i.getMuteStrength=function(){let t=0;for(let e=0;e<Qi.length;e++){const s=Qi[e],i=s.face<=.001?0:Yi(s.fade);i>t&&(t=i)}return 1-t};const Ki=[new d(0,3,0),new d(1.5,2.5,0),new d(-1.5,2.5),new d(.6,.9,-.9)];class Zi extends Gs{init(){const t=this.getSavestate({forceTrueWhenFinished:"disk"}),e=this.dynamicPropsState;e.off=!t,e.on=!!t,e.off?(this.setupPropsTransition({preset:"Bounce",transitionAsset:this.dynamicProps.on.asset,stateAfter:{off:!1,on:!0},onDone:this.onInteractionDone,onStart:()=>{const t=d.get().set(0,2,0).applyMatrix4(this.props.transformMatrix);this.scene.player.playEmote("Victory"),this.webgl.store.frozenPlayerDelay=800;const e=new h(10,10);this.webgl.particles.emit("circleSmoke",{amount:T.randomInt(30,40),position:t.add(new d(0,-1.4,0)),baseRadius:2.2,scale:e,velDrag:.9,duration:1200,billboard:!0,batcherID:"normal",sprite:"smoke",speed:0,power:.3}),this.webgl.particles.emit("flash",{amount:T.randomInt(1,1),position:t,scale:e.set(60,60),duration:1200,billboard:!0,batcherID:"noDepthEmissive",sprite:"halo",speed:0}),t.release(),this.webgl.audio.playSound("sfx_quest_sono_turnedOn")}}),this.setupInteraction({item:"disk",buttonMode:"hold",sound:"sfx_quest_sono_interact_loop",iconPosition:new d(0,2.5,-1.5),zone:{center:new d(0,0,-1.5),radius:4},cameraTarget:new d(0,2.5,-.5),cameraDistance:5,cameraHeight:2})):this.initSpatialAudio()}afterUpdate(){if(!this.spatialAudio)return;if(this.spatialAudio.volume<.02)return;if(this.webgl.time.frameNum%20!=0)return;const t=Math.floor(T.randomFloat(0,4)),e=Ki[t],s=d.get().copy(e).applyMatrix4(this.props.transformMatrix),i=d.get().set(e.x+T.randomFloat(-.2,.2),e.y+T.randomFloat(-.2,.2),e.z-T.randomFloat(.5,.7)).applyMatrix4(this.props.transformMatrix).sub(s),o=h.get(),a=T.randomFloat(2,3);o.set(a,a),this.webgl.particles.emit("speakers",{amount:T.randomInt(1,1),position:s,scale:o,velDrag:.9,duration:1200,billboard:!0,batcherID:"normal",vel:i,speed:0,power:.3}),s.release(),i.release(),o.release()}initSpatialAudio(){this.spatialAudio||(this.spatialAudio=this.add($i,{matrix:this.props.transformMatrix,position:new d(0,0,-1.7),radius:14.5,minVolume:.23,maxVolume:.93}))}onInteractionDone(){this.webgl.savestate.incrementVariable("activeSpeakersCount"),this.updateSavestate(!0),this.initSpatialAudio()}}Zi.prepare=()=>({staticColliders:[{asset:"Speakers"}],dynamicProps:{off:{asset:"Speakers",default:1,castFarShadow:1},on:{asset:"SpeakersOn",castFarShadow:0}}});var Ji=Object.freeze(Object.defineProperty({__proto__:null,default:Zi},Symbol.toStringTag,{value:"Module"}));class to extends Gs{init(){if(!this.props.targetPosition)return;if(!this.props.targetLookAt)return;const t=this.props.targetPosition.split(",").map((t=>+t)),e=this.props.targetLookAt.split(",").map((t=>+t));this.targetPosition=(new d).fromArray(t),this.targetLookAt=(new d).fromArray(e),this.setupInteraction({buttonIcon:"interactions-telescope",buttonMode:"hold-infinite",icon:"bubble_eye",iconCollapsed:"eye",playerActionPreset:"None",iconPosition:new d(0,3,0),zone:{center:new d(0,0,1),radius:3},onAnimStart:()=>this.onAnimStart(),onAnimStop:()=>this.onAnimStop()})}onAnimStart(){const t=this.scene.playerCam;this.webgl.app.$stores.isTelescopeActive=!0,this.webgl.audio.playSound("sfx_telescope_cameraMovement"),t.setTarget({id:this.uid,lockPlayer:!0,position:this.targetPosition,lookAt:this.targetLookAt,posEase:.05,lookAtEase:.07,isAction:!0})}onAnimStop(){const t=this.scene.playerCam;this.webgl.app.$stores.isTelescopeActive=!1,this.webgl.audio.playSound("sfx_UI_Dialog_CameraMove_Out"),t.removeTarget(this.uid)}}to.prepare=()=>({staticProps:[{asset:"Telescope"}]});var eo=Object.freeze(Object.defineProperty({__proto__:null,default:to},Symbol.toStringTag,{value:"Module"}));class so extends Gs{init(){this.setupInteraction({buttonIcon:"interactions-tamtam",buttonMode:"hold-infinite",icon:"bubble_quest",playerActionPreset:"Tamtam",iconPosition:new d(0,3.5,0),zone:{center:new d(0,0,0),radius:3.65},sound:"sfx_secret_interact_tamtam_loop",cameraTarget:new d(-.4,1,-.1),onAnimStart:()=>this.webgl.store.isMutingBgm.set(!0),onAnimStop:()=>this.webgl.store.isMutingBgm.set(!1),cameraDistance:1.5,cameraHeight:3})}}so.prepare=()=>({staticProps:[{asset:"Tamtam"}]});const io={"./BrokenBridge/BrokenBridgeActor.js":Xs,"./Chest/ChestActor.js":$s,"./Chest/ChestBigActor.js":Zs,"./FintechStandGround/FintechStandGroundActor.js":ti,"./FlagPole/FlagPoleActor.js":si,"./GrowableTrees/GrowableTreeActor.js":oi,"./Houses/AvenHouseActor.js":ni,"./Houses/BlueVineHouseActor.js":li,"./Houses/BlueVineRibbonActor.js":hi,"./Houses/LighthouseActor.js":yi,"./Houses/ShopForSaleActor.js":xi,"./NPC/NPCAmbassadorActor.js":Oi,"./NPC/NPCIntroActor.js":Li,"./NPC/NPCMiniGameActor.js":Bi,"./NPC/NPCPassiveCitizenActor.js":ji,"./NPC/NPCQuestActor.js":Fi,"./NPC/NPCSailorActor.js":Ni,"./NPC/NPCTalkingCitizenActor.js":Vi,"./NPC/NPCZendaSickActor.js":qi,"./SkateparkOvergrowth/SkateparkOvergrowthActor.js":Gi,"./Speakers/SpeakersActor.js":Ji,"./Telescope/TelescopeActor.js":eo,"./tamtam/TamtamActor.js":Object.freeze(Object.defineProperty({__proto__:null,default:so},Symbol.toStringTag,{value:"Module"}))},oo={};for(let Fm in io){oo[Fm.split("/").pop().slice(0,-8)]=io[Fm].default}var ao=oo;const no=new d,ro=new d;let lo=0;class co{constructor(t,{debug:e,position:s,radius:i,refreshDelay:o}={},a){this.refreshDelay=o||200,this.lastRefresh=0,this.broadphase=a,this.debug=!1,this.mainCell=null,this.activeCells=new Set,this.cellsMap=new Map(a.cells.map((t=>[t,!1]))),this.element=t,this.box=new et;const n=s||(t.base?t.base.position:t.possition)||new d;this.sphere=new V(n,i||2),this.radius=this.sphere.radius,this.position=this.sphere.center,this.prevPosition=new d,this.update(!1,!0);let r=this;this.gatherNeighborItems=function(t){r.gatherNeighborItems(t)}}updateBox(t){this.box.min.set(t.x-this.radius,t.z-this.radius),this.box.max.set(t.x+this.radius,t.z+this.radius)}getNeighbourhood(t,e){t&&(t.length=0),this.gatherer=t||[],this.gathererFilter=e,this.activeCells.forEach(this.gatherNeighborItems),this.gatherer=this.gathererFilter=null}gatherNeighborItems(){}update(t,e=!1){if(this.destroyed||this.broadphase.destroyed)return;t&&this.position.copy(t);const s=this.prevPosition.distanceToSquared(this.position);if(!e&&s<.05)return;const i=performance.now(),o=i-this.lastRefresh;if(!e&&o<this.refreshDelay)return;this.lastRefresh=i,lo=lo+1|0,this.updateBox(this.position),this.prevPosition.copy(this.position);const a=this.broadphase.getCell(this.position),n=a!==this.mainCell;this.forceAll=n&&a&&!a.neighbors.includes(this.mainCell),this.mainCell=a,a&&this.updateCell(a,!0),this.forceAll=!1}updateCell(t,e=!1){const s=e||t.box.intersectsBox(this.box);let i=!1;if((this.forceAll||this.cellsMap.get(t)!==s)&&(this.cellsMap.set(t,s),s?t.addItem(this):t.removeItem(this),i=!0),t.iterationIdx=lo,i||s)for(let o=0,a=t.neighbors.length;o<a;o++){const e=t.neighbors[o];e.iterationIdx!==lo&&this.updateCell(e)}}destroy(){for(let t=0,e=this.broadphase.cells.length;t<e;t++){this.broadphase.cells[t].removeItem(this)}this.destroyed=!0,this.cellsMap.clear(),this.activeCells.clear(),this.broadphase=null,this.element=null}}class ho{constructor({row:t,col:e,broadphase:s,scene:i,bounds:o}={}){this.row=t,this.col=e,this.broadphase=s,this.scene=i,this.iterationIdx=lo,this.neighbors=[],this.items=[],this.box=new et(new h(o.min.x,o.min.y),new h(o.max.x,o.max.y))}addItem(t){t.activeCells.has(this)||(t.cellsMap.set(this,!0),t.activeCells.add(this),this.items.push(t),this.broadphase.callOnChange())}removeItem(t){if(t.activeCells.has(this)){t.cellsMap.set(this,!1),t.activeCells.delete(this);const e=this.items.indexOf(t);this.items.splice(e,1),this.broadphase.callOnChange()}}destroy(){this.items.length=this.neighbors.length=0,this.helper&&this.helper.removeFromParent()}}var uo=class extends m{init(){const t=this.scene;this.onChange=this.props.onChange;const e=this.props.bounds||this.scene.bbox||this.scene.bounds,s=e.min,i=e.max;this.bounds=new et(new h(s.x,s.z),new h(i.x,i.z)),this.size=this.bounds.getSize(new d),this.width=this.size.x,this.height=this.size.y;const o=this.cellCountWidth=this.props.cellCountWidth||5,a=this.cellCountHeight=this.props.cellCountHeight||5;this.cellStepWidth=this.width/o,this.cellStepHeight=this.height/a,this.cells=[],this.rows=[];for(let r=0;r<o;r++){const e=[];this.rows.push(e);for(let s=0;s<a;s++){const i=new et;i.min=new h(this.bounds.min.x+this.cellStepWidth*r,this.bounds.min.y+this.cellStepHeight*s),i.max.set(i.min.x+this.cellStepWidth,i.min.y+this.cellStepHeight);const o=new ho({row:r,col:s,bounds:i,scene:t,broadphase:this});e.push(o),this.cells.push(o)}}for(let r=0,l=this.cells.length;r<l;r++){const t=this.cells[r],e=t.row,s=t.col,i=t.neighbors;let o;(o=this.getAbsCell(e-1,s))&&i.push(o),(o=this.getAbsCell(e,s-1))&&i.push(o),(o=this.getAbsCell(e,s+1))&&i.push(o),(o=this.getAbsCell(e+1,s))&&i.push(o)}const n=this;this.changedCalled=!1,this.defferedCallChanged=function(){n.changedCalled=!1,n.onChange&&n.onChange()},this.static=!0}callOnChange(){this.changedCalled||(this.changedCalled=!0,requestAnimationFrame(this.defferedCallChanged))}getAbsCell(t,e){if(this.rows[t])return this.rows[t][e]}getCell(t,e){null!=t.z?(e=t.z,t=t.x):null!=t.y&&(e=t.y,t=t.x);const s=this.bounds.min;let i=Math.floor((t-s.x)/this.cellStepWidth),o=Math.floor((e-s.y)/this.cellStepHeight);return i=st(i,0,this.cellCountWidth-1),o=st(o,0,this.cellCountHeight-1),this.rows[i][o]}add(t,e={}){return new co(t,e,this)}remove(t){if(this.foreachCells("removeItem",t),!t.dynamic)return;const e=this.dynamicItems.indexOf(t);e>-1&&this.dynamicItems.splice(e,1)}foreachCells(t,e){for(let s=0,i=this.cells.length;s<i;s++)this.cells[s][t](e)}destroy(){this.destroyed=!0,this.foreachCells("destroy"),this.scene=null,this.items=null,this.cells.length=0,this.rows.length=0,super.destroy()}};const po={Main:{sampleID:"sfx_amb_main_loop",maxVolume:1},Beach:{sampleID:"sfx_amb_beach_loop",maxVolume:1},Forest:{sampleID:"sfx_amb_forestBird_loop",maxVolume:1.1}};class mo extends m{get mixins(){return["reactivity"]}init(){this.updateDelay=0,this.broadphase=this.add(uo,{debug:!1}),this.ambiances={};for(let t in po)this.ambiances[t]={sampleID:po[t].sampleID,maxVolume:.82*po[t].maxVolume,id:t,active:!1,volume:0,sample:null},this.addArea(t);this.currentAmbiance=null,this.defaultAmbiance=this.ambiances[this.props.defaultAmbiance||"Main"],this.ambiancesArr=Object.values(this.ambiances),this.watchSignal(this.webgl.store.isTransitionActive,this.stopAllAmbiances),this.watchSignalImmediate(this.webgl.quality.current,this.onQualityChange)}addArea(t){const e=this.scene.getAreas("Ambiance"+t);for(let s=0;s<e.length;s++){const i=e[s],o=this.ambiances[t];this.broadphase.add({ambiance:o,x:i.center.x,z:i.center.z,sqRadius:i.radius*i.radius},{position:i.center,radius:i.radius,debug:1})}}playAmbiance(t){t.sample&&t.sample.stop(),this.webgl.audio.unlocked.value&&(t.sample=this.webgl.audio.playSound(t.sampleID,{loop:!0,volume:t.volume,fadein:1e3,fadeout:500}))}onQualityChange(t){t<2&&this.stopAllAmbiances()}stopAllAmbiances(t){for(let e=0,s=this.ambiancesArr.length;e<s;e++){const s=this.ambiancesArr[e];s.sample&&(t?s.sample.realstop():s.sample.stop(),s.sample=null)}}onNewAmbianceActive(t){this.updateDelay=1500,this.currentAmbiance=t;for(let e=0,s=this.ambiancesArr.length;e<s;e++){const t=this.ambiancesArr[e];t.active=t===this.currentAmbiance}}update(){if(this.scene.player&&!this.scene.player.isBodyReady||this.webgl.store.isTransitionActive.value||this.webgl.quality.current<2)return;const t=this.webgl.time.dt;for(let i=0,o=this.ambiancesArr.length;i<o;i++){const e=this.ambiancesArr[i];e.active&&!e.sample&&this.playAmbiance(e),e.volume=X(e.volume,e.active?e.maxVolume:0,.025,t,.01),e.sample&&(e.sample.volume=e.volume,!e.active&&e.volume<=0&&(e.sample.realstop(),e.sample=null))}if(this.updateDelay-=t,this.updateDelay>0)return;this.updateDelay=200;const e=this.getCurrentArea();if(e===this.currentArea)return;this.currentArea=e;const s=e?e.ambiance:this.defaultAmbiance;s!==this.currentAmbiance&&this.onNewAmbianceActive(s)}getCurrentArea(){const t=this.scene.player?this.scene.player.base.position:this.scene.getCurrentCamera().base.position,e=t.x,s=t.z;if(this.currentArea){const t=this.currentArea,i=e-t.x,o=s-t.z;if(i*i+o*o<t.sqRadius)return t}const i=this.broadphase.getCell(t);for(let o=0,a=i.items.length;o<a;o++){const t=i.items[o].element,a=e-t.x,n=s-t.z;if(a*a+n*n<t.sqRadius)return t}return null}beforeDestroy(){this.stopAllAmbiances(!0)}}const fo={cam:new dt(120,1,1,3e3),isCamera:!0,base:{position:new d,quaternion:new O},used:()=>{},unused:()=>{}};class go extends it{constructor(t){super(t),this.id=t.id,this.manifest=this.webgl.resources.manifest.scenes[this.id]||{},this.resources=this.webgl.resources.scenes[this.id]||{},this.points=this.resources.points||{},this.areas=this.resources.areas||{},this.curves=this.resources.curves||{};const e=this.manifest.bounds;this.bbox=new ot((new d).fromArray(e[0]),(new d).fromArray(e[1])),this.recomputeCenter(),this.hooks={beforePrerender:at(),afterPrerender:at()},this.frustum=new nt,this.frustumMat=new p,this.sortChunks=this.bind("sortChunks",2),this.webgl.app.$stores.sceneState=100,this.visitedFlagDone=!1!==this.props.alreadyVisited,this.alreadyVisited=this.props.alreadyVisited}get mixins(){return["reactivity","debugCamera"]}async load(){this.log("load",this.props.id),await this.initPhysics()}recomputeCenter(){const t=this.bbox.getSize(new d);this.center=this.bbox.getCenter(new d),this.radius=Math.max(t.x,t.y,t.z)}async initPhysics(){performance.now();const t=this.getCurve("circuit"),e=class{constructor(t,e=200,s=5,i=-5){Object.assign(this,{divisions:e,forward:s,backward:i,closestIndex:0,curve:new Z});for(let o=0;o<t.length;o+=12)this.curve.add(new J((new d).fromArray(t,o+0),(new d).fromArray(t,o+3),(new d).fromArray(t,o+6),(new d).fromArray(t,o+9)));this.points=this.curve.getSpacedPoints(e).map((t=>({point:t})));for(let o=0;o<this.points.length;o++){const t=this.points[o],e=this.points[this.getOffsetIndex(o,-1)],s=this.points[this.getOffsetIndex(o,1)];this.points[o].lineFromPrevious=new tt(e.point,t.point),this.points[o].lineToNext=new tt(t.point,s.point)}}getOffsetIndex(t,e,s=this.points.length){return((t+e)%s+s)%s}getClosestProgress(t,e=0){const{length:s}=this.points;let i=Infinity,o=0;for(let d=0;d<s;d++){const e=this.points[d],s=t.distanceTo(e.point);s<i&&(i=s,o=d)}const a=this.points[o],n=a.lineFromPrevious.closestPointToPointParameter(t,!0),r=a.lineToNext.closestPointToPointParameter(t,!0);let l=0,c=0;n<1?(l=n,c=this.getOffsetIndex(o,-1)):(l=r,c=o);const h=1/this.divisions;return this.getOffsetIndex(h*c+h*l,e,1)}getPoint(t,e){return this.curve.getPointAt(t,e)}getDirection(t,e=1e-5,s){return this.getPoint(Math.max(0,t),no),this.getPoint(Math.min(1,t+e),ro),s.copy(ro.sub(no))}static generateTransferable(t){const e=t?t.curves.length:0,s=new Float32Array(4*e*3);for(let i=0;i<e;i++){const e=t.curves[i];"CubicBezierCurve3"===e.type?(s[4*i*3+0]=e.v0.x,s[4*i*3+1]=e.v0.y,s[4*i*3+2]=e.v0.z,s[4*i*3+3]=e.v1.x,s[4*i*3+4]=e.v1.y,s[4*i*3+5]=e.v1.z,s[4*i*3+6]=e.v2.x,s[4*i*3+7]=e.v2.y,s[4*i*3+8]=e.v2.z,s[4*i*3+9]=e.v3.x,s[4*i*3+10]=e.v3.y,s[4*i*3+11]=e.v3.z):"LineCurve"===e.type&&(s[4*i*3+0]=e.v1.x,s[4*i*3+1]=e.v1.y,s[4*i*3+2]=e.v1.z,s[4*i*3+3]=e.v1.x,s[4*i*3+4]=e.v1.y,s[4*i*3+5]=e.v1.z,s[4*i*3+6]=e.v2.x,s[4*i*3+7]=e.v2.y,s[4*i*3+8]=e.v2.z,s[4*i*3+9]=e.v2.x,s[4*i*3+10]=e.v2.y,s[4*i*3+11]=e.v2.z)}return s}}.generateTransferable(t);return this.physics=await this.resources.physicsInstancePromise,this.physics.readyPromise=rt(),this.physics.isReady=!1,t&&this.physics.addCurve("progress",e,200),this.resources.physicsBatchPromise.then((()=>{if(!this.destroyed)return this.physics.run()})).then((()=>Y(10))).then((()=>{this.destroyed||(this.physics.isReady=!0,this.physics.readyPromise.resolve())})),this.unwatchPhysicsIgnoring=j((()=>this.webgl.app.$stores.phone.isReady||this.webgl.app.$stores.isCustomizeOpen||this.webgl.app.$stores.isMenuOpen||this.webgl.app.$stores.isFormOpen),(t=>this.togglePhysics(t)),{immediate:!0}),this.physics.readyPromise}togglePhysics(t){t?this.physics.stop():this.physics.run()}updateFrustum(){const t=this.getCurrentCamera().cam;this.frustumMat.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this.frustum.setFromProjectionMatrix(this.frustumMat)}markSceneVisited(){this.visitedFlagDone=!0;const t="hasVisited"+this.id;this.webgl.savestate.getVariable(t)||(this.webgl.savestate.setVariable(t,!0),this.webgl.savestate.incrementVariable("visitedIslandCount"))}beforeUpdate(){this.updateFrustum(),this.time+=.001*this.webgl.time.dt,rs.time.value=this.time,!this.visitedFlagDone&&this.time>5&&this.markSceneVisited()}init(){if(this.base.matrixAutoUpdate=!1,this.time=rs.time.value=0,function(t){const{bigShadow:e,bigShadowData:s,bigShadowMatrix:i,bigShadowMap:o}=rs.bigShadow,a=s.value;a.copy(t.shadowSize),e.value.mapSize.copy(t.shadowSize),e.value.bias=a.z=t.shadowBias,e.value.radius=a.w=t.shadowRadius,o.value=t.texture,i.value.copy(t.matrix)}(this.resources.bigShadowData),this.resources.base){const t=this.webgl.resources.use(this.resources.base),e=Ns.use();this.resources.textures.terrainSplatting&&(e.uniforms.map.value=this.resources.textures.terrainSplatting),this.main=new S(t,Ns.use()),this.main.frustumCulled=!1,this.main.receiveShadow=!0,this.main.renderOrder=this.webgl.store.renderOrder.islandBase,this.main.matrixAutoUpdate=!1,this.main.manualMatrixUpdate=!0,this.main.updateMatrixWorld(),this.addObject3D(this.main)}this.fog=this.base.fog=new lt,this.fog.near=Math.max(0,20),this.fog.far=200,this.chunks=[],this.sortedChunks=[];for(let t=0,e=this.resources.chunks.length;t<e;t++){const e=this.webgl.resources.use(this.resources.chunks[t]),s=new S(e,Hs.use()),i=this.addObject3D(s);this.chunks.push(i),this.sortedChunks.push(i),s.castShadow=!0,s.receiveShadow=!0,s.matrixAutoUpdate=!1,s.manualMatrixUpdate=!0}for(let t=0,e=this.chunks.length;t<e;t++){const e=this.chunks[t].geometry.boundingBox;this.bbox.union(e)}this.recomputeCenter(),this.sky=this.add(ws.use()),this.lights=this.add(ls),this.wind=this.add(Ps.use()),this.grass=this.add(Fs.use())}afterInit(){this.initActors(),this.watchSignal(this.webgl.store.chunksCastShadow,(t=>{for(let e=0,s=this.chunks.length;e<s;e++)this.chunks[e].castShadow=!!t}),this,!0),this.webgl.particles.addTo(this.base)}initActors(){const t=this.manifest.actors;this.actors={};for(let e in t){const s=t[e],i=ao[s.className];if(!i)continue;const o=Object.assign({},s.params,{transformMatrix:s.transformMatrix,type:s.type,id:s.uid,uid:s.uid,sceneID:this.id});i.isNPC?o.npcConfig=s.npcConfig:(o.states=s.states,o.dynamicProps=s.dynamicProps),this.actors[s.uid]=this.add(i,o)}}update(){}beforeRender(){if(this.chunks.length>1&&this.webgl.time.frameNum%15==0){this.__camPos=this.getCurrentCamera().cam.position,this.sortedChunks.sort(this.sortChunks);const t=this.webgl.store.renderOrder.islandChunks;for(let e=0,s=this.sortedChunks.length;e<s;e++)this.sortedChunks[e].renderOrder=t+e;this.__camPos=null}}afterRender(){}async triggerPrerender(){const t=this.webgl.threeRenderer;this.prerendering=!0,this.hooks.beforePrerender.emit(),this.webgl.state.prerendering=!0,this.triggerUpdate();const e=this.overrideCamera;this.overrideCamera=fo,fo.cam.position.copy(this.center),fo.cam.position.y=600,fo.cam.lookAt(new d(0,0,0));let s=t.getRenderTarget();t.setRenderTarget(this.webgl.noopRenderTarget),this.triggerRender(),t.setRenderTarget(s),this.overrideCamera=e,this.hooks.afterPrerender.emit(),this.webgl.state.prerendering=!1,this.prerendering=!1,await ct.promise({timeout:50})}rerenderBigShadow(){}getMinDistance(t){const e=this.__camPos,s=t.geometry.boundingSphere.center,i=t.geometry.boundingBox.min,o=t.geometry.boundingBox.min;let a=Math.min(ht(e.x,e.z,s.x,s.z),ht(e.x,e.z,i.x,i.z),ht(e.x,e.z,o.x,i.z),ht(e.x,e.z,i.x,o.z),ht(e.x,e.z,o.x,o.z));return t.geometry.boundingBox.containsPoint(e)&&(a-=1e7),a}sortChunks(t,e){return this.getMinDistance(t)-this.getMinDistance(e)}getPoint(t,e=!1){return bo(this.points,t,e)}getPoints(t){return yo(this.points,t)}getCurve(t,e=!1){return bo(this.curves,t,e)}getCurves(t){return yo(this.curves,t)}getArea(t,e=!1){return bo(this.areas,t,e)}getAreas(t){return yo(this.areas,t)}beforeDestroy(){this.unwatchPhysicsIgnoring(),this.physics.destroy();for(const t in this.resources.textures)this.resources.textures[t]&&this.resources.textures[t].dispose();if(this.webgl.resources.scenes[this.id]=null,this.main&&this.main.geometry&&this.webgl.resources.unuse(this.main.geometry),this.chunks)for(let t=0,e=this.chunks.length;t<e;t++){const e=this.chunks[t],s=e&&e.geometry;s&&this.webgl.resources.unuse(s)}this.webgl.particles.removeFromParent()}}function bo(t,e,s=!1){if(null!=e){if(t[e])return t[e];if(!s){e=e.toLowerCase();for(let s in t)if(s.toLowerCase().match(e))return t[s]}}}function yo(t,e){const s=[];e=e.toLowerCase();for(let i in t)i.toLowerCase().match(e)&&s.push(t[i]);return s}var vo=w("uniform sampler2D noise;varying vec2 vUv;uniform float time;void main(){float globalNoise=texture2D(noise,vUv*.32+vec2(time*0.0034,0.)).r;float camDist=smoothstep(-0.02,0.055,gl_FragCoord.w);vec3 color=WATER_TOP_COLOR+0.2;float alpha=0.;if(camDist>0.001){float tex=texture2D(noise,vUv*80.+time*0.01).r;float tex2=texture2D(noise,vUv*vec2(10.,90.)-time*0.012).r;float whiteStains=smoothstep(0.45,.5,tex*tex2);color=mix(color,vec3(1.),whiteStains*camDist);alpha+=whiteStains;\n#ifndef IS_MOBILE\nfloat gn=texture2D(noise,vUv*12.+time*0.002).r;gn=smoothstep(.4,.9,gn+globalNoise*0.3);gn=smoothstep(0.45,0.46,smoothstep(0.7,0.5,gn)*gn)*camDist;color+=gn*0.08;alpha+=gn*0.3;\n#endif\n}alpha=max(alpha,globalNoise*0.9);vec2 foLen=vUv-vec2(0.5);float foDist=1.-dot(foLen,foLen)*5.;alpha*=foDist;gl_FragColor=vec4(color,alpha);}","fragmentShader");var wo=w("varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let xo=null;class So extends x{constructor(){super({transparent:!0,depthWrite:!1,opacity:.7}),this.userData.forceOpaque=!0,this.uniforms={noise:{value:v.resources.textures.noise},time:{value:0}},this.defines=r({},ms()),vo.use(this),wo.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}So.use=function(){return xo=xo||new So,xo},So.unuse=function(){};let _o,Po=new d,Mo=new d;class To extends m{get mixins(){return["reactivity"]}init(){this.base=new S(this.webgl.resources.geometries.plane,So.use()),this.base.renderOrder=this.webgl.store.renderOrder.water,this.base.rotation.x=-Math.PI/2,this.uProgress=rs.water.waterProgress,this.baseLevel=parseFloat(ms().WATER_BASE_LEVEL),this.base.position.y=this.baseLevel,this.base.manualMatrixUpdate=!0,this.watchSignal(this.webgl.store.waterVisible,(t=>this.base.visible=t),this,!0)}attached(){const t=this.scene.bbox,e=t.getCenter(Po),s=t.getSize(Mo);this.base.position.set(e.x,0,e.z),this.base.scale.set(s.x+1e3,s.z+1e3,1),this.base.updateMatrixWorld()}detached(){this.removeFromParent()}update(){const t=rs.time.value,e=.5*Math.sin(t)+.5;this.uProgress.value=.2*e,this.base.position.y=this.baseLevel+this.uProgress.value,this.base.material.uniforms.time.value=t,this.base.updateMatrixWorld()}}To.use=()=>_o=_o||new To;const Ao=new h;class Co extends m{constructor(t){super(t),this.isPlayer=!0}init(){this.prevGrassPos=new h;const t={tension:.07,friction:.055};this.grassVelX=ut(t),this.grassVelY=ut(t),rs.playerPosition.value.setScalar(-1e4),rs.grass.current.value.set(1e4,1e4,0,0),rs.grass.delayed.value.set(1e4,1e4),this.firstUpdates=55,this.base=this.base||new f,this.bodyPosition=new d,this.bodyRotation=new z,this.bodyQuaternion=new O,this.joystick={active:!1,lerp:!1,center:new d,direction:new d,directionTarget:new d,min:20,max:50,autoForward:!1},this.initialSpawn=new d,this.initialRotation=new z;const e=this.scene.props.spawnPoint||"Spawn",s=this.scene.getPoint(e);s&&(this.initialSpawn.copy(s.position),this.initialRotation.setFromQuaternion(s.quaternion,"YXZ"));const i=this.initialSpawn.clone(),o=this.initialRotation.clone();!this.scene.props.spawnPoint&&this.loadPlayerPosition&&this.loadPlayerPosition(i,o),this.options={spawnPosition:i,spawnRotation:o,forceLerp:!1,radius:.5,mass:1,speed:1,bounce:!1,drift:!1,driftFactor:.01,absoluteMove:!0,stearingSpeed:1,reverseBackwardStearing:!1,alignOnNormal:!1,teleportIfOutOfBounds:!1,laps:1},this.cameraOptions={mode:Pi,distance:5.5,elevation:2.5,offset:new d(0,1,0),slideFactor:.005,lerpFactor:.1,curveFocus:.5,curveLookAhead:.01,intersectGround:!1,intersectObjects:!1},this.keyboardActive=!1,this.lastPos=new d,this.easedSpeed=0,this.speed=0,this.easedDir=new d}afterInit(){const t=this.scene.physics;this.isBodyReady=!1,t.readyPromise.then((()=>!this.detroyed&&t.setPlayerOptions(this.options))).then((()=>!this.detroyed&&t.setCameraOptions(this.cameraOptions))).then((()=>!this.detroyed&&t.respawnPlayer(!0,!0,!0))).then((()=>this.isBodyReady=!0))}setMesh(t){this.base.remove(...this.base.children),this.base.add(t)}updateOptions(t={},e={}){for(const s in t)void 0!==this.options[s]&&(this.options[s]=t[s]);for(const s in e)void 0!==this.cameraOptions[s]&&(this.cameraOptions[s]=e[s]);this.scene.physics.setPlayerOptions(this.options),this.scene.physics.setCameraOptions(this.cameraOptions)}testCanMove(){return this.scene.getCurrentCamera().playerCanMove&&this.scene.physics.isReady}updatePlayerPosUniforms(){const t=this.webgl.time.dt,e=this.base.position,s=this.firstUpdates>0;s&&this.firstUpdates--,rs.playerPosition.value.copy(e),v.store.playerPosition.copy(e);const i=rs.grass,o=i.current.value,a=i.delayed.value,n=s?1:.3,r=s?1:.09;o.x=pt(o.x,e.x,n,t),o.y=pt(o.y,e.z,n,t),a.x=pt(a.x,e.x,r,t),a.y=pt(a.y,e.z,r,t),s&&this.prevGrassPos.copy(o);const l=Ao.copy(o).sub(this.prevGrassPos).multiplyScalar(.45);this.prevGrassPos.copy(a),s&&(this.grassVelX.setValue(l.x),this.grassVelY.setValue(l.y)),this.grassVelX.setTarget(l.x),this.grassVelY.setTarget(l.y),this.grassVelX.update(t),this.grassVelY.update(t),o.z=this.grassVelX.value,o.w=this.grassVelY.value}update(){const{direction:t,directionTarget:e,lerp:s}=this.joystick;t.lerp(e,s);const i=this.scene.physics;this.isBodyReady&&(this.base.position.copy(i.playerPosition),this.base.rotation.copy(i.playerRotation),this.bodyPosition.copy(this.base.position),this.bodyRotation.copy(this.base.rotation),this.bodyQuaternion.copy(this.base.quaternion),this.optionsNeedsUpdate&&(this.optionsNeedsUpdate=!1,this.updateOptions({absoluteMove:!0,mass:1,speed:this.OptSpeed||9.1,forceLerp:this.OptForceLerp||!1,bounce:!1,stearingSpeed:1,stearingDelay:0,reverseBackwardStearing:!1,alignOnNormal:!1,teleportIfOutOfBounds:!1},{mode:Mi,tiltOnRotate:0,intersectObjects:!1,intersectGround:!0,lerpFactor:.4,slideFactor:.0025,slideOffset:0,elevation:3.7,distance:9,offset:new d(0,1.6,0)})),i.playerPosition.y<-15&&this.teleportToPoint("Spawn"))}async teleportToPoint(t){const e=this.scene.getPoint(t||"Spawn");e&&(this.options.spawnPosition.copy(e.position),this.options.spawnRotation.setFromQuaternion(e.quaternion,"YXZ"),await this.updateOptions(),await this.scene.physics.respawnPlayer(!0,!0,!0))}}class Do{constructor(t={}){this.props=t,this.player=this.props.player,this.scene=this.player.scene,this.webgl=this.player.webgl,this.isActive=!1,this.priority=0,this.physicsSpeed=9.1,this.physicsLerp=!1,this.actionAnimation="Action",this.init()}init(){}update(){}setActive(t){this.isActive!==t&&(this.isActive=t,this.isActive?this.activated():this.deactivated())}activated(){}deactivated(){}beforeDestroy(){}destroy(){this.beforeDestroy(),this.player=this.scene=this.webgl=null}}const Io=new d,ko=new d,Oo=new h;class Ro extends Do{init(){this.priority=3,this.physicsSpeed=11,this.physicsLerp=.01,this.isFloating=!0,this.floatingInfluence=0,this.customizeDemult=0,this.isFirstUpdate=!0,this.sound=null,this.soundRate=1,this.soundVolume=0}startSound(){this.stopSound(),this.webgl.audio.unlocked.value&&(this.sound=this.webgl.audio.playSound("sfx_player_jetpack_loop",{volume:0}))}stopSound(){this.sound&&this.sound.stop(),this.sound=null}update(){const t=this.webgl,e=this.player,s=e.mesh,i=.001*t.time.elapsed,o=e.base.visible&&e.charMesh.opacity>.8;if(this.isMainEffect&&!this.sound?this.startSound():!this.isMainEffect&&this.sound&&this.stopSound(),this.sound){const t=Q(e.easedSpeed,.1,.15,.45,1);this.soundRate=ft(this.soundRate,t,.07),this.sound.setPlaybackRate(this.soundRate);const s=this.webgl.store.isTransitionActive.value?0:1,i=Q(e.easedSpeed,.1,.15,.2,.45);this.soundVolume=ft(this.soundVolume,i*s,.1),this.sound.volume=this.soundVolume*e.charMesh.opacity}const a=e.jetpackAnim,n=this.isFirstUpdate;this.isFirstUpdate=!1;const r=this.isMainEffect&&(!this.player.actionPreset||"Tamtam"!==this.player.actionPreset.id);this.customizeDemult=ft(this.customizeDemult,this.webgl.store.isInCustomize.value?.4:1,n?1:.1),this.floatingInfluence=ft(this.floatingInfluence,r?1:0,n?1:.1);const l=this.isMainEffect&&(!e.actionPreset||!e.actionPreset.floatingAnim);a.currentWeight=l?1:0,a.weight=ft(a.weight,a.currentWeight,n?1:.1);a[a.weight<.01?"stop":"play"](),s.rotation.x=st(2*e.easedSpeed*this.floatingInfluence+Math.PI/2,Math.PI/2,Math.PI/2+1),s.rotation.z=.08*Math.sin(1.25*i)*this.floatingInfluence,s.rotation.y=.06*Math.sin(.84*i)*this.floatingInfluence,s.position.y=(30*this.floatingInfluence+20*(Math.sin(i)+1)*this.floatingInfluence)*this.customizeDemult,this.isMainEffect&&o&&this.updateThrusters()}updateThrusters(){const t=this.webgl,e=this.player.mesh,s=e.localToWorld(Io.set(20,-40,-110)),i=e.localToWorld(ko.set(-21,-40,-110));t.particles.emit("burst",{amount:T.randomInt(1,1),position:s,scale:Oo.set(4+Math.random(),4+Math.random()),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2",speed:this.player.easedSpeed}),t.particles.emit("burst",{amount:T.randomInt(1,1),position:i,scale:Oo.set(4+Math.random(),4+Math.random()),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2",speed:this.player.easedSpeed}),Math.random()>.7&&(t.particles.emit("burstSmoke",{amount:T.randomInt(1,1),position:s,scale:Oo.set(2+Math.random(),2+Math.random()),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke"}),t.particles.emit("burstSmoke",{amount:T.randomInt(1,1),position:i,scale:Oo.set(2+Math.random(),2+Math.random()),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke"}))}beforeDestroy(){this.stopSound()}}const Lo=new h,Eo=new d,Fo=new d;class zo extends Do{init(){this.priority=2,this.physicsSpeed=9.15,this.physicsLerp=!1}update(){if(!this.isMainEffect)return;const t=this.player,e=t.base.position.y+.03<=this.scene.water.base.position.y,s=t.base.visible&&t.charMesh.opacity>.8;!e&&s&&this.updateThrusters()}updateThrusters(){const t=this.webgl,e=this.player.mesh,s=this.player.easedSpeed,i=e.Chara_Low_RigGameSkeletonToes_L.children[0].getWorldPosition(Eo),o=e.Chara_Low_RigGameSkeletonToes_R.children[0].getWorldPosition(Fo);t.particles.emit("burstShoes",{amount:T.randomInt(3,5),position:i,scale:Lo.set(10*s+2.4,10*s+2.4),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2",speed:s}),t.particles.emit("burstShoes",{amount:T.randomInt(3,5),position:o,scale:Lo.set(10*s+2.4,10*s+2.4),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2",speed:s})}}const Bo=new h,Uo=new d;class jo extends Do{init(){this.priority=1,this.physicsSpeed=9.1,this.physicsLerp=!1,this.playerY=0,this.prevRunTime=0,this.prevWalkTime=0,this.lastStep=0}update(){const t=this.player,e=this.player.mainEffect.isFloating,s=this.player.effects.jetpack.isMainEffect;this.playerY=t.base.position.y+(e?.25:0);const i=this.scene.water.base.position.y,o=this.playerY<=i,a=this.scene.physics.playerVelocity;if(!s&&a>.02){const t=this.player.moveAnims,e=t.Run.weight>t.Walk.weight,s=this.prevRunTime,a=this.prevRunTime=t.Run.time,n=this.prevWalkTime,r=this.prevWalkTime=t.Walk.time;let l,c,h,d;if(e?(l=.35,c=.75,h=s,d=a):(l=.29,c=.69,h=n,d=r),d>l&&h<=l||d>c&&h<=c){const t=this.webgl.time.elapsed,e=this.player.easedSpeed,s=.93*st(gt(e,.008,.148),0,1);if(t-this.lastStep>300&&this.webgl.audio.unlocked.value){if(o){const t=Q(this.playerY-i,-1.5,0,.85,1.05);this.webgl.audio.playSound("sfx_player_footsteps_water",{volume:s,playbackRate:t})}else this.webgl.audio.playSound("sfx_player_footsteps",{volume:s});this.lastStep=t}}}!e&&t.easedSpeed>.095&&!o?this.smokeParticles():t.easedSpeed>.02&&o&&this.waterParticles()}smokeParticles(){if(this.webgl.time.frameNum%12!=0)return;const t=this.webgl,e=this.player.mesh,s=Uo.set(0,4,-20);e.localToWorld(s),s.x+=.5*Math.random()-.25,s.y+=.05*Math.random()+.02,s.z+=.5*Math.random()-.25;const i=2*Math.random();t.particles.emit("walk",{amount:T.randomInt(4,5),position:s,scale:Bo.set(4+i,4+i),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2"})}waterParticles(){if(this.webgl.time.frameNum%11!=0)return;const t=this.webgl,e=this.player,s=e.easedSpeed,i=this.scene.water.base.position.y,o=this.scene.physics.playerVelocity,a=Math.abs(this.playerY-i)<.6,n=Uo.set(0,0,0);e.base.localToWorld(n),n.y=i,t.particles.emit("waterRipples",{amount:1,position:n,scale:Bo.set(1,1),duration:1200,scaleTo:20,opacity:1,batcherID:"normal",speed:s,power:2.3}),o>.05&&a&&t.particles.emit("waterConstantSplash",{amount:T.randomInt(5,10),position:n,scale:Bo.set(1.7,1.9),duration:1500,billboard:!0,parent:null,opacity:.3,batcherID:"normal",sprite:"smoke2"})}}const No=["head","body","bottom"];const Vo=new h,Wo=new d,qo=0,Ho=1,Go=2,Yo=3,Xo=4,Qo=new N;const $o=new O,Ko=new h,Zo=new h,Jo=new h,ta=new d,ea=new d,sa=function(t){let e=!1,s=0,i=0;return function(o){if(e){if(s===o)return i;s=o}else e=!0;const a=t[0],n=t[t.length-1];if(o<=a[0])return i=a[1];if(o>=n[0])return i=n[1];for(let e=0;e<t.length;e++){const s=t[e],a=t[e+1];if(o>=s[0]&&o<a[0])return i=mt(o,s[0],a[0],s[1],a[1])}}}([[.4,.1],[.6,.2],[.85,.3],[1,.35],[1.1,.37],[1.3,.4],[1.5,.45],[1.7,.55],[2,.8],[2.5,.95]]),ia={None:{fx:!1,anim:!1,floatingAnim:!1},Default:{fx:!0,anim:"Action",floatingAnim:"JetpackAction"},Tamtam:{fx:!1,anim:"Action",floatingAnim:"Action"}};for(let Fm in ia)ia[Fm].id=Fm;const oa=[function(t){Object.assign(t.prototype,{initOutfitAnim:function(){this.lastOutfitAnim=0,this.lastOutfitEmote=0,this.prevState={color:null,head:null,body:null,bottom:null},this.backOutfitOffset=0,this.backOutfitActive=!1,this.outfitSpringV=ut({initial:1,mass:1.8,tension:.6,friction:.32}),this.outfitSpringH=ut({initial:1,mass:1.3,friction:.19}),this.outfitBaseScale=this.base.scale.clone(),this.outfitInactiveDelay=1e3,this.getOutfitChangeType()},onOutfitChanged:function(){if(!this.isBodyReady)return;this.outfitAnimInitialized=!0;const t=performance.now(),e=this.getOutfitChangeType();if(t-this.lastOutfitAnim<100)return;if(this.webgl.store.outfitDebounce>0)return;if(!e)return;this.lastOutfitAnim=t,this.backOutfitActive=!1;const s=t-this.lastOutfitEmote,i=this.webgl.savestate.game.player;let o="noDepth",a=6,n=1,r=T.randomInt(10,14);const l=this.scene.getCurrentCamera();Qo.scale.set(.009,1,.009),this.mesh.getWorldPosition(Qo.position),l&&Qo.lookAt(l.cam.position);Qo.rotateX(Math.PI/2),Qo.updateMatrixWorld();const c=Wo,h=Vo.setScalar(2);switch(e){case Ho:a=20,c.set(-5,1.6,-120),h.setScalar(2.1),n=1.3,this.outfitSpringV.setValue(.85),this.outfitSpringH.setValue(.8),!this.mainEffect.isFloating&&s>3500&&Math.random()>.4&&(this.lastOutfitEmote=t,this.playEmote("Gain"));break;case Go:a=10,c.set(-9,1.4,-172),n=.95,r=T.randomInt(9,12),this.outfitSpringV.setValue(.95),this.outfitSpringH.setValue(.85);break;case Yo:const e=this.webgl.app.$items.body[i.body],l=e&&e.back;a=15,o="normal",n=.7,r=T.randomInt(9,12),l&&(this.backOutfitActive=!0),c.set(-9,1.6,-80),l&&(c.x+=40,c.z-=18),"Body-Wings"===e.id&&(c.z-=5),this.outfitSpringV.setValue(.95),this.outfitSpringH.setValue(.85);break;case Xo:a=8,c.set(0,1.4,-10),n=.6,r=T.randomInt(8,11),this.outfitSpringV.setValue(.98),this.outfitSpringH.setValue(.9),!this.mainEffect.isFloating&&s>2500&&Math.random()>.5&&(this.lastOutfitEmote=t,this.playEmote("Gain"))}this.webgl.particles.emit("linePop",{amount:r,position:c,scale:h,billboard:!0,parent:Qo,opacity:.3,radius:a,batcherID:o,speed:0,velocity:n})},getOutfitChangeType:function(){const t=this.webgl.savestate.game.player,e=this.prevState;let s,i,o,a,n=0;e.head!==t.head&&(s=++n);e.body!==t.body&&(i=++n);e.bottom!==t.bottom&&(o=++n);e.color!==t.color&&(a=++n);for(let r in e)e[r]=t[r];if(a||n>1)return Ho;if(s)return Go;if(i)return Yo;if(o)return Xo;return qo},updateOutfitSpring:function(){const t=this.webgl.time.dt,e=this.webgl.store;if(e.isInCustomize.value)this.outfitInactiveDelay=1e3,e.outfitDebounce>0&&(e.outfitDebounce-=t);else{if(this.outfitInactiveDelay<0)return;this.backOutfitActive=!1,this.outfitInactiveDelay-=t}this.backOutfitOffset=ft(this.backOutfitOffset,this.backOutfitActive?-2:0,.3),this.base.rotateY(this.backOutfitOffset),this.outfitSpringV.update(t),this.outfitSpringH.update(t);const s=this.outfitBaseScale,i=this.outfitSpringH.value,o=this.outfitSpringV.value;this.base.scale.set(s.x*i,s.y*o,s.z*i)}})},function(t){function e(t){const e=this.webgl.app.$items;this.mainEffect=this.effects.feet,this.mainEffect._willBeUsed=!0;for(let s=0;s<No.length;s++){const i=No[s],o=e[i][t[i]];if(!o)continue;const a=this.effects[o.effect];a&&(a._willBeUsed=!0,a.priority>=this.mainEffect.priority&&(this.mainEffect=a))}for(let s in this.effects){const t=this.effects[s];t.isMainEffect=t===this.mainEffect,t.setActive(t._willBeUsed),t._willBeUsed=null,t.isMainEffect&&(this.optionsNeedsUpdate=!0,null!=t.physicsSpeed&&(this.OptSpeed=t.physicsSpeed),null!=t.physicsLerp&&(this.OptForceLerp=t.physicsLerp))}}Object.assign(t.prototype,{initEffects:function(){const t={player:this};this.effects={},this.effects.jetpack=new Ro(r({},t)),this.effects.feet=new jo(r({},t)),this.effects.fastShoes=new zo(r({},t)),this.mainEffect=this.effects.feet,this.unwatchSavestate=j(this.webgl.savestate.game.player,e.bind(this),{immediate:!0})},updateEffects:function(){for(let t in this.effects)this.effects[t].update()},destroyEffects:function(){this.unwatchSavestate();for(let t in this.effects)this.effects[t].destroy();this.effects=null}})}];class aa extends Co{get mixins(){return[...super.mixins||["timers"],"character","characterAnimations"]}init(){super.init(),this.updateOptions({absoluteMove:!0,mass:1,speed:9.1,bounce:!1,stearingSpeed:1,stearingDelay:0,reverseBackwardStearing:!1,alignOnNormal:!1,teleportIfOutOfBounds:!1},{mode:Mi,tiltOnRotate:0,intersectObjects:!1,intersectGround:!0,lerpFactor:.4,slideFactor:.0025,slideOffset:0,elevation:3.7,distance:9,offset:new d(0,1.6,0)}),this.canMove=!1,this.canRun=!0,this.body={position:new d,rotation:new z},this.hasMoved=!1,this.rotateAtState={influence:0,vec:new d,qt:new O,tqt:new O,enabled:!1,delay:1300},this.time=0,this.lastSavedPositionTime=0,this.lerpedPosition=new d,this.lastSavedPosition=new d,this.lastSavedRotation=new z,this.initEffects(),this.initOutfitAnim()}actionStart(t="Default"){const e=ia[t]||ia.Default,s=this.mainEffect;if(e.anim){let t=e.anim;s.isFloating&&e.floatingAnim&&(t=e.floatingAnim),t&&this.setAnimation(t)}this.actionPreset=e}actionDone(){this.setIdleAnimation(),this.actionPreset=null}testCanMove(){const t=this.scene.getCurrentCamera(),e=this.webgl.app,s=e.$notifs.isOverlayActive.value;if(this.webgl.store.frozenPlayerDelay>0){const t=this.webgl.time.dt;return this.webgl.store.frozenPlayerDelay-=t,!1}return!this.hidden&&t.playerCanMove&&this.isBodyReady&&!this.webgl.store.isInCustomize.value&&this.scene.physics.isReady&&!this.webgl.store.isTransitionActive.value&&!s&&!e.$stores.itemNotification&&!e.$stores.isOverlayVisible&&!e.$stores.isApiErrorVisible&&this.scene.state>=this.scene.STATES.Tutorial}updateImmobile(){const t=this.joystick;t.active=!1,t.directionTarget.setScalar(0),t.lerp=1,this.webgl.store.joystickVisible.set(!1)}updateKeyboard(){const t=this.joystick,e=this.webgl.input.keyboard.pressedKeys,s=e.KeyW||e.ArrowUp,i=e.KeyA||e.ArrowLeft,o=e.KeyS||e.ArrowDown,a=e.KeyD||e.ArrowRight,n=Zo.set(-i+a,-s+o).normalize();t.active=!0,t.directionTarget.set(n.x,0,n.y),t.lerp=.07,this.webgl.store.joystickVisible.set(!1)}updateJoystick(){const t=this.joystick,e=this.webgl.input.touch.value,s=Zo.copy(e.relativePos),i=st(gt(s.length(),t.min,t.max),0,1),o=s.normalize().multiplyScalar(i);t.active=!0,t.directionTarget.set(o.x,0,o.y),t.lerp=1,this.webgl.store.joystickVisible.set(!0)}updateRaycast(){const t=this.joystick,e=this.webgl.input.touch.value,s=this.scene.getCurrentCamera().cam,i=this.base.position,o=ta.copy(i).project(s);!isNaN(o.x)&&isFinite(o.x)||(o.x=0),!isNaN(o.y)&&isFinite(o.y)||(o.y=0);const a=e.normalizePos,n=this.webgl.viewport,r=Zo.copy(a).sub(o),l=Jo.copy(Zo).multiplyScalar(.5).multiply(n.size.value),c=r.angle(),h=st(gt(Math.abs(c-1.5*Math.PI),0,.7),0,1),d=ft(90,130,h),u=l.length();let p=st(gt(u,5,d),0,1);const m=n.ratio.value,f=sa(m),g=r;g.x*=f,g.normalize().multiplyScalar(p),t.active=!0,t.directionTarget.set(g.x,0,-g.y),t.lerp=.14,this.webgl.store.joystickVisible.set(!1)}updateControls(){const t=this.webgl.input,e=this.canMove=this.testCanMove(),s=t.keyboard.pressedCount>0,i=t.touch.value.pressed&&t.touch.value.useTouch,o=t.touch.value.pressed&&!i;this.hasMoved=e&&(s||i||o),this.webgl.app.$stores.isMovingWithMouse=!(!e||!o),e?s?this.updateKeyboard():i?this.updateJoystick():o?this.updateRaycast():this.updateImmobile():this.updateImmobile()}update(){if(super.update(),!this.isBodyReady)return;this.time+=this.webgl.time.dt,this.hidden=this.webgl.store.inDialog.value||this.lookingAtPhone;const t=this.webgl.time.dt;this.hidden&&this.charMesh.opacity>0?(this.charMesh.opacity=X(this.charMesh.opacity,0,.4,t,.001),this.base.visible=this.charMesh.opacity>.04):!this.hidden&&this.charMesh.opacity<1&&(this.charMesh.opacity=X(this.charMesh.opacity,1,.3,t,.001),this.base.visible=this.charMesh.opacity>.001),this.updateControls(),this.isPlayerReady=!0,this.webgl.store.playerOrientation=this.base.rotation.y}updateRotateAt(){const t=this.rotateAtState,e=this.base,s=this.webgl.time.dt;this.hasMoved&&(t.enabled=!1);const i=t.influence;if(t.influence=X(t.influence,t.enabled?1:0,.13,s,.01),0===t.influence){if(t.qt.copy(e.quaternion),0===i)return}else t.qt.slerp(t.tqt,.16);e.quaternion.slerp(t.qt,t.influence)}rotateAt(t){const e=this.rotateAtState,s=this.base;if(e.enabled&&t.equals(e.vec))return;e.vec.copy(t);const i=ta.set(t.x,s.position.y,t.z);$o.copy(s.quaternion),s.lookAt(i),e.tqt.copy(s.quaternion),s.quaternion.copy($o),e.enabled=!0}afterUpdate(){const t=this.scene.physics;this.isBodyReady&&(t.movePlayer(this.joystick.direction),this.hidden||(this.body.position.copy(t.playerPosition),this.body.rotation.set(0,t.playerRotation.y,0)),this.base.position.copy(this.body.position),this.base.rotation.copy(this.body.rotation),this.savePlayerPosition(),this.base.position.y+=-.485+this.shoesOffset,this.base.rotation.y+=Math.PI,this.updateRotateAt(),this.updatePlayerPosUniforms(),this.updateOutfitSpring(),this.updateEffects(),this.actionPreset&&this.actionPreset.fx&&this.updateActionFX())}updateActionFX(){if(this.webgl.time.frameNum%20==0){const t=T.randomFloat(-10,10),e=T.randomFloat(-2,10),s=T.randomFloat(7,11),i=this.mainEffect.isFloating?-5:-25,o=this.mesh.localToWorld(ea.set(i+t,90,-170+e));this.webgl.particles.emit("actionSmoke",{amount:T.randomInt(1,5),position:o,scale:Ko.setScalar(s),duration:600,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke",speed:0});const a=2*Math.random();this.webgl.particles.emit("actionPop",{amount:T.randomInt(3,4),position:o,scale:Ko.set(a+1,a+1),duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"normal",sprite:"smoke2",speed:0})}}loadPlayerPosition(t,e){let s=localStorage.getItem("player_position");if(null==s||!s.length)return;if(s=s.split("|"),7!==s.length)return;if(s[0]!==this.scene.id)return;const i=parseFloat(s[1]),o=parseFloat(s[2]),a=parseFloat(s[3]);if(isNaN(i)||isNaN(o)||isNaN(a))return;t.set(i,o+.2,a);const n=parseFloat(s[4]),r=parseFloat(s[5]),l=parseFloat(s[6]);isNaN(n)||isNaN(r)||isNaN(l)||e.set(n,r,l)}savePlayerPosition(){if(!this.isBodyReady)return;if(window.isNiceWindowReloading)return;const t=this.base.position.distanceToSquared(this.lastSavedPosition),e=this.time-this.lastSavedPositionTime;if(t<30)return;if(e<1e3)return;this.lastSavedPositionTime=this.time;const s=this.base.position,i=this.base.rotation;this.lastSavedPosition.copy(s),this.lastSavedRotation.copy(i),localStorage.setItem("player_position",[this.scene.id,s.x,s.y,s.z,i.x,i.y,i.z].join("|"))}beforeDestroy(){this.webgl.app.$stores.isMovingWithMouse=!1,this.webgl.store.joystickVisible.set(!1),this.destroyEffects()}}oa.forEach((t=>t(aa)));var na=w("precision highp float;uniform mat3 normalMatrix;varying vec2 vUv;varying float vY;varying vec3 vViewPosition;varying vec3 vNormal;varying float vFar;varying float vAlpha;uniform float time;uniform sampler2D noise;\n#include <fog_pars_fragment>\nconst vec3 fogCol=vec3(0.8,1.0,1.0);void main(){vec2 uv=vUv;float isGround=step(vY,GROUND_MAX+0.05);float radius=mix(RAY_RADIUS,GROUND_RADIUS,isGround);vec2 noiseUV=mix(vec2(vUv.x*3.+time*0.1,vY*0.03+time*0.1),vec2(vUv.x+time*0.2,vY*2.0-time*0.7),isGround);vec2 n=texture2D(noise,noiseUV).gb;float ground=0.;ground=smoothstep(GROUND_HEIGHT,0.,vY*1.5);float fade=mix(0.,cos(time*4.)*0.5+0.5,isGround)*0.5;ground=min(1.,smoothstep(0.6,0.7,n.y)+smoothstep(GROUND_MIN+0.3,GROUND_MIN,vY))*smoothstep(GROUND_MAX,GROUND_MAX-0.3,vY);vec3 rimColor=vec3(1.2,1.,0.6);float rimLightPower=0.32;float rimLightStrength=1.0;float rimLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)))*rimLightStrength;rimLight=smoothstep(0.1,0.4,rimLight);float ray=0.;ray=(smoothstep(RAY_MIN+RAY_HEIGHT*0.01,RAY_MIN+RAY_HEIGHT*0.2,vY)*smoothstep(RAY_MAX,RAY_MAX-RAY_HEIGHT*0.5,vY)*rimLight*0.7)+(1.*smoothstep(mix(0.3,0.43,vFar),0.,n.x)*14.*smoothstep(RAY_MIN+0.4,RAY_MIN+RAY_HEIGHT*0.1,vY)*smoothstep(RAY_MAX,RAY_MAX-RAY_HEIGHT*0.3,vY));float alpha=mix(ray,ground,isGround)*vAlpha;vec3 color=vec3(1.0,0.875,0.247)*1.2;gl_FragColor=vec4(color,alpha);float fogFactor=smoothstep(fogNear,fogFar,vFogDepth);gl_FragColor.rgb=mix(gl_FragColor.rgb,fogCol,clamp(fogFactor*0.65,0.,1.));}","fragmentShader");var ra=w("precision highp float;attribute vec3 pos;attribute vec4 qt;attribute vec3 scale;attribute float alpha;varying vec2 vUv;varying float vY;varying vec3 vViewPosition;varying vec3 vNormal;varying float vFar;varying float vAlpha;uniform float time;\n#include <fog_pars_vertex>\n#include <get_instance_matrix>\nvoid main(){mat4 instanceMatrix=getInstanceMatrix(pos,qt,scale);vec3 transformed=position;vUv=uv;vY=transformed.y;vAlpha=alpha;float isRay=step(GROUND_MAX+0.05,vY);vec3 transformedNormal=vec3(normal);mat3 m=mat3(instanceMatrix);transformedNormal/=vec3(dot(m[0],m[0]),dot(m[1],m[1]),dot(m[2],m[2]));transformedNormal=m*transformedNormal;float dist=distance(cameraPosition,pos);vFar=smoothstep(20.,100.,dist);float r=mix(0.,0.2,smoothstep(20.,60.,dist));float r2=mix(-0.3,0.4,vFar);transformed+=((cos(time*-2.+vY*1.)*0.5+0.5)*transformedNormal*r+transformedNormal*r2)*isRay;transformedNormal=normalMatrix*transformedNormal;vNormal=normalize(transformedNormal).rgb;vec4 mvPosition=modelViewMatrix*instanceMatrix*vec4(transformed,1.);vViewPosition=-mvPosition.xyz;\n#include <fog_vertex>\ngl_Position=projectionMatrix*mvPosition;}","vertexShader");let la=new d,ca=new d,ha=new O,da=new p;function ua({attributes:t}={}){t||(t=["position","normal","uv"]);let e=null,s=0;const i=[],o=new V,a=new ot,n={};return t.forEach((t=>{n[t]={length:0,arrays:[]}})),{add:function(t,{transforms:e,matrix:r}={}){r?(t=t.clone()).applyMatrix4(r):e&&(t=t.clone(),la.fromArray(e,0),ca.fromArray(e,3),ha.fromArray(e,6),da.compose(la,ha,ca),t.applyMatrix4(da));t.boundingSphere&&o.union(t.boundingSphere);t.boundingBox&&a.union(t.boundingBox);for(let s in n){const e=t.attributes[s].array,i=n[s];i.arrays.push(e),i.length+=e.length}const l=t.index;for(let o=0;o<l.count;++o)i.push(l.getX(o)+s);s+=t.attributes.position.count},merge:function(){if(e)return e;if(e=new P,n.position){const t=r("position"),s=new M(t,3,!1);e.setAttribute("position",s)}if(n.normal){const t=r("normal"),s=new M(t,3,!1);e.setAttribute("normal",s)}if(n.uv){const t=r("uv"),s=new M(t,2,!1);e.setAttribute("uv",s)}return e.setIndex(i),e.boundingBox=a.clone(),e.boundingSphere=o.clone(),e},getPositionLength:function(){return n.position.length},getIndexLength:function(){return i.length}};function r(t){const e=n[t],s=new Float32Array(e.length);let i=0;for(let o=0,a=e.arrays.length;o<a;o++)s.set(e.arrays[o],i),i+=e.arrays[o].length;return s}}let pa=null;class ma extends x{constructor(){super();const t=v.resources.textures;this.uniforms=l(r(l(r({},I.merge([k.fog])),{time:rs.time}),rs.global),{noise:{value:t.noise}}),this.defines=l(r({},ms()),{RAY_MIN:hs(4),RAY_MAX:hs(34),RAY_HEIGHT:hs(30),RAY_RADIUS:hs(.6),GROUND_MIN:hs(.15),GROUND_MAX:hs(.8),GROUND_HEIGHT:hs(.65),GROUND_RADIUS:hs(3.9)}),na.use(this),ra.use(this),this.blending=yt,this.depthTest=!0,this.depthWrite=!1,this.fog=!0,this.transparent=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0}}ma.use=function(){return pa=pa||new ma,pa},ma.unuse=function(){};const fa=new function(){const t=ua();let e;return e=new bt(1.1,1,.65,32,1,!0),e.scale(-3.9-.01,1,3.89),e.translate(0,.475,0),t.add(e),e=new bt(1.1,1,.65,32,1,!0),e.scale(3.9,1,3.9),e.translate(0,.475,0),t.add(e),e=new bt(1,1,30,8,20,!0),e.scale(-.61,1,.59),e.translate(0,19,0),t.add(e),e=new bt(1,1,30,8,20,!0),e.scale(.6,1,.6),e.translate(0,19,0),t.add(e),e=t.merge(),e},ga=new d,ba=new d,ya=new O;class va{constructor(t,e){this.matrix=e,this.fintech=t,this.alpha=1;const s="hasMet"+H(t.id)+"Ambassador",i=H(t.id)+"Main",o=v.savestate.game;if(this.updateAlpha([o.vars[s],o.quests[i]]),0===this.alpha)return this.dispose();this.unwatchVue=j([()=>o.vars[s],()=>o.quests[i]],(t=>this.updateAlpha(t)))}updateAlpha([t,e]){this.alpha=t&&e?0:1}dispose(){this.unwatchVue&&this.unwatchVue(),this.destroyed=!0,this.unwatchVue=null}}class wa extends m{init(){this.base=new f,this.count=0,this.halos=[]}addInstancedAttribute(t,e=1,s){this.buffers||(this.buffers={});const i=this.buffers[t]=new Float32Array(this.count*e),o=new E(i,e,!1);s&&o.setUsage(s),this.geo.setAttribute(t,o)}buildGeometry(){const t=this.halos;if(this.count=t.length,0===this.count)return void(this.base.visible=!1);const e=this.geo=new R;e.index=fa.index,e.attributes.position=fa.attributes.position,e.attributes.uv=fa.attributes.uv,e.attributes.normal=fa.attributes.normal,this.addInstancedAttribute("pos",3,vt),this.addInstancedAttribute("qt",4,vt),this.addInstancedAttribute("scale",3,vt),this.addInstancedAttribute("alpha",1,vt);const{pos:s,qt:i,scale:o,alpha:a}=this.buffers;for(let r=0;r<t.length;r++){const e=t[r];e.matrix.decompose(ga,ya,ba),ga.toArray(s,3*r),ya.toArray(i,4*r),ba.toArray(o,3*r),a[r]=e.smoothAlpha=e.alpha}const n=this.mesh=this.addObject3D(new S(e,ma.use()));n.frustumCulled=!1,n.renderOrder=this.webgl.store.renderOrder.fintechHalos,e.needsUpdate=!0}attached(){this.base.manualMatrixUpdate=!0,this.base.updateMatrixWorld(!0),this.mesh&&(this.mesh.manualMatrixUpdate=!0,this.mesh.updateMatrixWorld(!0))}update(){if(!this.base.visible)return;const t=this.webgl.time.dt;let e=!1;for(let s=0;s<this.halos.length;s++){const i=this.halos[s];i.destroyed||i.smoothAlpha===i.alpha||(e=!0,i.smoothAlpha=X(i.smoothAlpha,i.alpha,.07,t,.004),this.buffers.alpha[s]=i.smoothAlpha,0===i.smoothAlpha&&i.dispose())}e&&(this.geo.attributes.alpha.needsUpdate=!0)}addHalo(t,e){const s=new va(t,e);s.destroyed||this.halos.push(s)}}class xa extends wt{constructor(t){super(t),this.isIslandCamera=!0,this.playerCanMove=!0}init(){this.base=this.cam=new dt(50,window.innerWidth/window.innerHeight),this.grassDummy=this.addObject3D(new N),this.baseDummyPos=-30,this.base.rotation.order="YXZ"}beforeUpdate(){const t=this.scene.physics;t.isReady&&(this.base.position.copy(t.cameraPosition),this.base.rotation.copy(t.cameraRotation))}afterUpdate(){this.grassDummy.position.z=this.baseDummyPos*Math.sqrt(this.webgl.store.grass.radius)}beforeDestroy(){}}const Sa=St();class _a extends xt{created(){this.base.shakeState={shaking:!1,maxDuration:0,maxAmplitude:0,currentDuration:0,currentAmplitude:0,freqMult:1,value:[0,0],pos:[0,0],speed:[.006,1e-4]},this.base.shake=Ma.bind(this.base),this.base.updateShake=Pa.bind(this.base)}}function Pa(){const t=this.shakeState;if(!t.shaking)return;const e=this.webgl.time.dt,s=1-t.currentDuration/t.maxDuration;let i=ft(t.speed[0],t.speed[1],s);i*=t.freqMult,t.currentAmplitude=ft(t.maxAmplitude,0,s),t.pos[0]+=e*i,t.pos[1]+=e*i,t.value[0]=Math.cos(9*t.pos[0])*t.currentAmplitude*.6,t.value[1]=Sa(10,t.pos[1])*t.currentAmplitude;const o=.9*t.value[0],a=.3*t.value[1],n=t.vertical?a:o,r=t.vertical?o:a;this.base.translateY(r),this.base.translateX(n),this.base.rotateZ(.5*r),this.base.rotateY(.5*n),t.currentDuration=Math.max(0,t.currentDuration-e),0===t.currentDuration&&(t.maxAmplitude=0,t.maxDuration=0,t.shaking=!1)}function Ma(t=500,e=.1,s=!1,i=!1,o=1){const a=this.shakeState;e*=1.07,a.vertical=s,(i||!a.shaking||t>a.maxDuration)&&(a.maxDuration=t,a.currentDuration=t),(i||!a.shaking||e>a.maxAmplitude)&&(a.maxAmplitude=e,a.currentAmplitude=e,a.freqMult=o),(t||e)&&(a.shaking=!0),a.pos[0]=200*Math.PI,a.pos[1]=500*Math.random()}const Ta=new O;new O;class Aa extends xt{created(){this.base.targetState={posSmooth:new d,posTarget:new d,posActive:!1,posProgress:0,posEase:.07,lookAtSmooth:new O,lookAtTarget:new d,lookAtActive:!1,lookAtProgress:0,lookAtEase:.07,needsInstant:!1},this.base.setTarget=Ia.bind(this.base),this.base.updateTarget=Ca.bind(this.base),this.base.removeTarget=Da.bind(this.base)}}function Ca(){this.webgl.time.dt;const t=this.targetState,e=t.needsInstant;if(t.needsInstant=!1,t.posProgress=U(t.posProgress,t.posActive?1:0,t.posEase,5e-4),t.posProgress>0){const s=ft(1,t.posEase,t.posProgress);t.posSmooth.lerp(t.posTarget,e?1:s),this.base.position.lerp(t.posSmooth,t.posProgress)}else t.posSmooth.copy(this.base.position);if(t.lookAtProgress=U(t.lookAtProgress,t.lookAtActive?1:0,t.lookAtEase,5e-4),t.lookAtProgress>0){Ta.copy(this.base.quaternion),this.base.lookAt(t.lookAtTarget);const s=ft(1,t.lookAtEase,t.lookAtProgress);t.lookAtSmooth.slerp(this.base.quaternion,e?1:s),this.base.quaternion.slerpQuaternions(Ta,t.lookAtSmooth,t.lookAtProgress)}else t.lookAtSmooth.copy(this.base.quaternion)}function Da(t={}){const e=this.targetState;t.id&&e.currentID!==t.id||(e.currentID=null,e.posActive=e.lookAtActive=!1,t.instant&&(e.posProgress=e.lookAtProgress=0),t.positionEase&&(e.posEase=t.positionEase),t.posEase&&(e.posEase=t.posEase),t.lookAtEase&&(e.lookAtEase=t.lookAtEase),e.currentLockPlayer&&this.unlockPlayer(e.currentLockPlayer),this.isAction=!1)}function Ia(t={}){const e=this.targetState;t.id&&(e.currentID=t.id),void 0!==t.position&&(e.posActive=!!t.position,e.posActive&&e.posTarget.copy(t.position)),void 0!==t.lookAt&&(e.lookAtActive=!!t.lookAt,e.lookAtActive&&e.lookAtTarget.copy(t.lookAt)),t.instant&&(e.posProgress=e.posActive?1:0,e.lookAtProgress=e.lookAtActive?1:0,e.needsInstant=!0,this.updateTarget()),(t.positionEase||t.posEase)&&(e.posEase=t.positionEase||t.posEase),t.lookAtEase&&(e.lookAtEase=t.lookAtEase),e.currentLockPlayer&&(this.unlockPlayer(e.currentLockPlayer),e.currentLockPlayer=null),t.id&&t.lockPlayer&&(e.currentLockPlayer="camTarget_"+t.id,this.lockPlayer(e.currentLockPlayer)),t.id&&t.lockPlayer&&t.isAction&&(this.isAction=!0)}const ka=new O,Oa=new d,Ra=new d;class La extends xa{constructor(t){super(t),this.isIslandCamera=!0,this.playerCanMove=!0,this.playerCanInteract=!0,this.basePosition=new d,this.playerLockStack=new Set,this.isOnPhone=!1,this.phonePosProgress=0,this.phoneQtProgress=0,this.phoneTarget=0,this.phonePos=new d,this.phoneQt=new O}init(){super.init(),Promise.resolve().then((()=>!this.destroyed&&this.updateCameraOptions()))}resize(t){const e=t.x/t.y,s=st(gt(e,.45,1.5),0,1);this.cam.fov=ft(70,50,s),this.cam.aspect=e,this.cam.updateProjectionMatrix(),this.updateCameraOptions()}updateCameraOptions(){if(!this.scene.player)return;const t=this.scene.player.cameraOptions,e=st(gt(this.cam.fov,70,50),0,1);t.distance=ft(6.7,9,e),t.elevation=ft(3.55,3.7,e),this.scene.physics.setCameraOptions({distance:t.distance,elevation:t.elevation})}get mixins(){return[...super.mixins||[],_a,Aa]}afterInit(){super.afterInit(),Promise.resolve().then((()=>{this.destroyed||this.webgl.store.phoneVisible.watchImmediate(this.onPhoneVisible,this)}))}update(){this.basePosition.copy(this.base.position),this.updateTarget(),this.updatePhone(),this.updateShake()}onPhoneVisible(t){this.webgl.store.onPhone.set(!1),this.isOnPhone=t,this.phoneTarget=t?1:0;if(this.webgl.app.$stores.phone.isFullScreen)return this.webgl.store.onPhone.set(t),void(t||(this.scene.player.lookingAtPhone=!1));if(this.scene.player.lookingAtPhone=t,t){const t=this.scene.player,e=t.base.position,s=Oa.copy(e).sub(this.base.position).normalize(),i=Ra.set(-.2*s.x,2.2,-.2*s.z).add(e);this.phonePos.copy(i),ka.copy(this.base.quaternion);const o=Ra.set(1.5*s.x,-2.2,1.5*s.z).add(e);this.cam.lookAt(o),this.phoneQt.copy(this.base.quaternion),this.cam.quaternion.copy(ka),t.rotateAt(Ra.copy(e).add(s))}}updatePhone(){const t=this.webgl.time.dt,e=this.phoneTarget;this.phonePosProgress=X(this.phonePosProgress,e,.2,t,.001),this.phoneQtProgress=X(this.phoneQtProgress,e,.1,t,.001);this.webgl.app.$stores.phone.isFullScreen||(this.base.position.lerp(this.phonePos,this.phonePosProgress),this.base.quaternion.slerp(this.phoneQt,this.phoneQtProgress),this.webgl.store.onPhone.set(1===this.phonePosProgress&&1===this.phoneQtProgress))}lockPlayer(t){this.playerLockStack.add(t),this.playerLockStack.size>0&&(this.playerCanMove=!1)}unlockPlayer(t){this.playerLockStack.delete(t),this.playerLockStack.size<=0&&(this.playerCanMove=!0)}beforeDestroy(){this.destroying=!0,this.webgl.store.onPhone.set(!1),this.webgl.store.phoneVisible.unwatch(this.onPhoneVisible,this),super.beforeDestroy()}}const Ea=new O,Fa=new d;new d;let za=!0,Ba=0,Ua=[1e5,3e5,6e5];const ja=new d,Na=new d,Va=new d;class Wa extends go{init(){super.init(),this.playerCam=this.camera=this.add(La),this.player=this.add(aa),this.water=this.add(To.use()),this.canPausePhysics=!1,this.add(mo,{defaultAmbiance:"Main"}),this.fintechHalos=this.add(wa),this.watchSignal(this.webgl.store.isCustomizing,this.onCustomizing),this.initState()}afterInit(){super.afterInit(),this.fintechHalos.buildGeometry()}beforeEnter(){this.isEntered=!0}afterEnter(){this.props.bgm&&this.webgl.audio.bgm.play(this.props.bgm)}onCustomizing(t){if(!t)return void this.playerCam.removeTarget({id:"customizing"});this.playerCam.base.localToWorld(ja.set(-5,0,0)),this.player.rotateAt(ja);const e=this.player.base.position,s=this.playerCam.base.position,i=ja.copy(s).sub(e).normalize();i.x*=5.4,i.y=1.9,i.z*=5.4;const o=Na.copy(e).add(i),a=Va.copy(e);a.y+=1.15,ja.set(-.2,0,0).applyQuaternion(this.playerCam.base.quaternion),a.x+=ja.x,a.z+=ja.z,this.playerCam.setTarget({id:"customizing",lockPlayer:!0,position:o,lookAt:a,posEase:.08,lookAtEase:.07})}teleportPlayer(t){this.player&&this.player.teleportToPoint(t)}afterUpdate(){super.afterUpdate&&super.afterUpdate(),this.updateState()}}Wa.isMainIsland=!0,Wa.prepare=()=>({preloadAssets:["NPCPlaceholder"]}),function({prototype:t}){const e=t;e.initState=function(){this.isFirstIsland=za,za=!1,this.isTutoNeeded=!this.webgl.savestate.getVariable("isTutoCompleted"),this.STATES=this.webgl.app.$stores.sceneStates,this.state=0,this.stateTime=0,this.prevStateTime=0,this.setInitialState(),this.lastIdleHintAt=0,this.prevPlayingTime=-1,this.playingTime=0,this.introTicks=0,this.watchSignalImmediate(this.webgl.store.onPhone,(()=>{this.lastIdleHintAt=this.webgl.time.elapsed}))},e.setInitialState=function(){this.setState("Intro")},e.setState=function(t){this.state=this.STATES[t],this.prevPlayingTime=this.prevStateTime=-1,this.playingTime=this.stateTime=0,this.webgl.app.$stores.sceneState=this.state},e.stateReached=function(t){return this.stateTime>=t&&this.prevStateTime<t},e.playingTimeReached=function(t){return this.playingTime>=t&&this.prevPlayingTime<t},e.initIntroCam=function(){if(!this.isEntered||!this.webgl.store.isPreloaderHidden.value)return;const t=this.visitedFlagDone||this.alreadyVisited,e=this.isFirstIsland;this.introTicks++,this.introCamProgress=0;const s=this.playerCam.base;Fa.copy(s.position),Ea.copy(s.quaternion),this.player.base.updateMatrixWorld(),this.introCamPos=new d,this.introCamPos.set(e&&!t?-15:0,e?15:16,e?40:28).applyQuaternion(this.player.base.quaternion).add(this.player.base.position),s.updateMatrixWorld(),s.position.copy(this.introCamPos),s.rotateZ(e?.1:0),s.rotateX(e?.3:.1),this.introCamQt=new O,this.introCamQt.copy(s.quaternion),s.position.copy(Fa),s.quaternion.copy(Ea)},e.updateIntroCam=function(){if(this.introTicks<2||this.introCamProgress>=1)return;const t=this.playerCam.base;this.introCamProgress=ft(this.introCamProgress,1,this.isFirstIsland?.025:.05),this.introCamProgress>.9999&&(this.introCamProgress=1),t.position.lerp(this.introCamPos,1-this.introCamProgress),t.quaternion.slerp(this.introCamQt,1-this.introCamProgress)},e.updateIntro=function(){if(!this.isEntered||!this.player.isBodyReady)return;const t=this.isFirstIsland?.93:.9;if(this.introTicks<2)return this.initIntroCam();this.introCamProgress>=t&&(this.isTutoNeeded?this.setState("Tutorial"):this.setState("Playing"))},e.updateTutorial=function(){const t=this.player;if(this.stateReached(5)&&(this.tutoDistance||(this.tutoDistance=0),this.tutoPPos||(this.tutoPPos=t.base.position.clone())),!this.tutoPPos)return;const e=this.tutoPPos.distanceTo(t.base.position);this.tutoPPos.copy(t.base.position),e<.05||(this.tutoDistance+=e,this.tutoDistance>12&&(this.webgl.savestate.setVariable("isTutoCompleted",!0),this.setState("Playing")))},e.setFirstHint=function(){const t=this.webgl.savestate.game,e=this.webgl.app.$notifs;this.webgl.app.$quests;const s=t.vars.questsCompletedCount,i=t.vars.visitedIslandCount,o=this.webgl.app.$stores.isLoggedIn;this.isTutoNeeded?e.add("Hint",{hintType:"customize"}):this.isFirstIsland&&(s<=6||i<2)?e.add("Hint",{hintType:"map"}):this.isFirstIsland&&!o&&s>6&&e.displayHint("register")},e.updatePlaying=function(){const t=this.webgl.app.$notifs,e=this.webgl.app.$quests,s=this.webgl.app.$savestate.game;if(this.playingTimeReached(1500)?this.setFirstHint():this.isTutoNeeded&&this.playingTimeReached(8e3)&&(s.interests&&s.interests.length>0?this.webgl.app.$notifs.add("Hint",{hintType:"customPath"}):this.webgl.app.$notifs.add("Hint",{hintType:"fintech"})),this.playingTime>3e4&&Ba<Ua.length){const s=this.webgl.time.elapsed,i=Ua[Ba];!e.SupermainQuest.completed&&s-this.lastIdleHintAt>i&&s-t.lastNotificationAt>i&&(Ba++,this.lastIdleHintAt=s,this.webgl.app.$notifs.add("Hint",{hintType:"map"}))}},e.updateState=function(){const t=this.player,e=this.webgl.time.dt;t.isBodyReady&&(this.updateIntroCam(),this.state===this.STATES.Intro?this.updateIntro():this.state===this.STATES.Tutorial?this.updateTutorial():this.state===this.STATES.Playing&&(this.updatePlaying(),this.prevPlayingTime=this.playingTime,this.player.canMove&&(this.playingTime+=e)),this.prevStateTime=this.stateTime,this.stateTime+=e)}}(Wa);class qa extends Co{get mixins(){return["reactivity"]}init({sounds:t}){super.init(),this.webgl.store.miniGame.started.set(!1),this.joystick.autoForward=!0,this.joystick.lerp=.1,Object.assign(this,{sounds:t,hitGround:!1,hitProps:!1,wasOnGround:!0,crashSound:{allow:!0,active:!1},landSound:{allow:!0},startBegin:0,elapsedTime:0}),this.updateOptions({absoluteMove:!1},{mode:Pi}),this.watchSignal(this.webgl.audio.unlocked,this.initSounds,this,!0)}initSounds(t){this.engineSound&&this.engineSound.realstop(),this.driftSound&&this.driftSound.realstop(),this.engineSound=this.driftSound=null,t&&(this.sounds.engine&&(this.engineSound=this.webgl.audio.playSound(this.sounds.engine,{playbackRate:.5,loop:!0})),this.sounds.drift&&(this.driftSound=this.webgl.audio.playSound(this.sounds.drift,{volume:0,loop:!0})))}testCanMove(){return super.testCanMove()&&this.scene.state.isStarted}stop(){this.webgl.store.miniGame.started.set(!1),this.joystick.direction.set(0,0,0),this.joystick.directionTarget.set(0,0,0),this.scene.physics.movePlayer(this.joystick.directionTarget)}updateKeyboard(){const t=this.webgl.input.keyboard.pressedKeys,e=t.KeyA||t.ArrowLeft,s=t.KeyD||t.ArrowRight;this.joystick.directionTarget.setX(-e+s)}updateTouch(){const t=this.webgl.input.touch.value,e=Math.sign(t.normalizePos.x);this.joystick.directionTarget.setX(e)}updateImmobile(){this.joystick.directionTarget.setX(0)}updateControls(){this.canMove=this.testCanMove();const t=this.webgl.input,e=t.touch.value.pressed,s=t.keyboard.pressedCount>0;this.canMove?s?this.updateKeyboard():e?this.updateTouch():this.updateImmobile():this.updateImmobile(),this.joystick.directionTarget.setZ(this.canMove?-1:0),this.scene.physics.movePlayer(this.joystick.directionTarget)}updateSounds({engineVolume:t=1,enginePitch:e=1,driftVolume:s=0,driftPitch:i=1}){this.engineSound&&(this.engineSound.volume=t,this.engineSound.setPlaybackRate(e)),this.driftSound&&(this.driftSound.volume=t*s,this.driftSound.setPlaybackRate(i)),this.sounds.land&&this.landSound.allow&&this.hitGround&&(this.landSound.allow=!1,this.webgl.audio.playSound(this.sounds.land),setTimeout((()=>{this.landSound.allow=!0}),1e3)),this.sounds.crash&&this.crashSound.allow&&!this.crashSound.active&&this.hitProps?(this.crashSound.allow=!1,this.crashSound.active=!0,this.webgl.audio.playSound(this.sounds.crash),setTimeout((()=>{this.crashSound.active=!1}),1e3)):this.hitProps||(this.crashSound.allow=!0)}update(t){const e=this.scene.physics;if(!e.isReady)return;super.update(),this.updateControls(),this.hitProps=e.playerCollidingLayers.has("props");const s=e.playerDistanceFromFloor<1;this.hitGround=s&&!this.wasOnGround,this.wasOnGround=s,this.scene.state.isStarted||(this.hitGround=!1),e.curveProgress.complete&&this.scene.onFinishLineReached(),this.base.updateMatrixWorld(),this.updateSounds(t)}beforeDestroy(){super.beforeDestroy&&super.beforeDestroy(),this.engineSound&&this.engineSound.stop(),this.driftSound&&this.driftSound.stop()}}var Ha=w("#define PHONG\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <luma>\n#include <blend_modes>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\nuniform mat4 modelMatrix;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;uniform mat3 normalMatrix;uniform vec4 faceData;uniform vec3 faceColor;uniform float pixelRatio;uniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform float time;varying vec3 vData;uniform float waterProgress;const vec3 waterColor=WATER_COLOR;const vec3 waterTopColor=WATER_TOP_COLOR;varying vec2 vGradient;uniform sampler2D noise;uniform float effectMult;uniform float alpha;uniform float colorId;const vec3 cheeksColor=vec3(0.9,0.1,0.1);void main(){\n#include <depth_dither>\nvec4 diffuseColor=vec4(diffuse,1.);vec2 uv=vUv;float isFace=when_lt(vUv.x,0.7);float isCloth=1.-isFace;float isRightEye=when_lt(vUv.y,0.25)*isFace;float isLeftEye=when_lt(vUv.y,0.632-isRightEye)*isFace;float isMouth=when_gt(vUv.y,0.66)*isFace;uv.x+=faceData.x*0.125*isRightEye;uv.y+=-0.38461538*isLeftEye;uv.x+=faceData.y*0.125*isLeftEye;uv.y+=(0.25*step(4.,faceData.z)-0.25)*isMouth;uv.x+=mod(faceData.z,4.)*0.25*isMouth;uv.x+=colorId*0.00390625*isCloth;uv.y+=(isRightEye+isLeftEye)*isFace*faceData.a*0.25;vec3 diffuseTexel=texture2D(map,uv).rgb;diffuseColor.rgb=diffuseTexel*isCloth+faceColor*isFace-smoothstep(0.35,0.65,diffuseTexel.g)*isFace;\n#include <clouds>\n#include <normal_fragment_begin>\nvec3 rimColor=vec3(1.2,1.,0.6);float rimLightPower=1.6;float rimLightStrength=.19;float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=vec3(rightLight*rimLightStrength)*rimColor;rimLightPower=1.2;rimLightStrength=.29;rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=diffuseColor.rgb*vec3(rightLight*rimLightStrength)*rimColor;vec3 totalEmissiveRadiance=emissive;float specularStrength=1.0;ReflectedLight reflectedLight=ReflectedLight(vec3(.0),vec3(.0),vec3(.0),vec3(.0));\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 color=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;if(isFace>0.5){float cheeks=texture2D(map,vUv).r;color=mix(color,color*cheeksColor,cheeks);}gl_FragColor=vec4(color,opacity);\n#include <bg_fog>\n#include <water_depth_frag>\n}","fragmentShader");var Ga=w("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <world_pos_pars>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\nuniform float time;varying vec4 vBigShadowDirectionalCoords;uniform mat4 bigShadowMatrix;void main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <world_pos>\nvec4 worldPosition=vWorldPos;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\nvec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=worldPosition+vec4(bigShadowWorldNormal*0.05,0);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <fog_vertex>\n}","vertexShader");let Ya=null;class Xa extends x{constructor(){super();const t=v.resources.textures,e=this.uniforms=l(r(r(r(r({},I.merge([k.common,k.specularmap,k.fog,k.lights])),rs.water),rs.bigShadow),rs.global),{time:rs.time,pixelRatio:rs.pixelRatio,noise:{value:t.noise},map:{value:t.charDiffuseDef},diffuse:{value:new y(16777215)},emissive:{value:new y(0)},specular:{value:new y(1118481)},faceData:{value:new u(0,0,0,0)},colorId:{value:0},faceColor:{value:new y},shininess:{value:10},opacity:{value:1}});this.transparent=!0,this.forceOpaque=!0,this.opacity=1,this.defines=r({},ms()),this.map=e.map.value,Ha.use(this),Ga.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0,this.isCharacterMaterial=!0}}function Qa(t){const e=new Map,s=new Map,i=t.clone();return $a(t,i,(function(t,i){e.set(i,t),s.set(t,i)})),i.traverse((function(t){if(!t.isSkinnedMesh)return;const i=t,o=e.get(t),a=o.skeleton.bones;i.skeleton=o.skeleton.clone(),i.bindMatrix.copy(o.bindMatrix),i.skeleton.bones=a.map((function(t){return s.get(t)})),i.bind(i.skeleton,i.bindMatrix)})),i}function $a(t,e,s){s(t,e);for(let i=0;i<t.children.length;i++)$a(t.children[i],e.children[i],s)}Xa.use=function(){return Ya=Ya||new Xa,Ya},Xa.unuse=function(){};const Ka=new h;class Za extends qa{init(){super.init({sounds:{engine:"sfx_minigame_bike_loop",crash:"sfx_minigame_bike_impact",drift:"sfx_minigame_bike_drift",land:"sfx_minigame_bike_land"}});const t=Hs.use(),e=Xa.use(),s=this.webgl.resources.bikeCharacter;this.mesh=Qa(s.armature),this.mesh.traverse((s=>{if(s.isMesh){if("Chara_Low_RigBODY_01"===s.name){s.frustumCulled=!1,s.material=e,s.material.needsUpdate=!0;const t=this.webgl.savestate.game.player,i=this.webgl.app.$characters.colors,o=i[t.color]||i.character0;this.skeleton=s.skeleton,Object.assign(s,{faceColor:new y(o.faceColor),colorId:o.gradientID,opacity:1,faceData:new u})}else s.material=t,s.frustumCulled=!1;s.castShadow=!0}})),this.base.add(this.mesh),this.parts={body:this.mesh,frontWheel:this.mesh.getObjectByName("bikeFrontWheel"),rearWheel:this.mesh.getObjectByName("bikeBackWheel")},this.allParts=this.parts&&this.parts.body&&this.parts.frontWheel&&this.parts.rearWheel,this.allParts&&(this.parts.frontWheel.rotation.order="YXZ",this.parts.frontWheel.rotation.order="YXZ"),this.setAnimationMixer(this.mesh,s.animations),this.updateOptions({mass:500,speed:15,drift:!1,stearingSpeed:.2,alignOnNormal:!0})}setAnimationMixer(t,e){this.animationMixer=new _t(t),this.animations={};for(const s of e)this.animationMixer.clipAction(s).play();this.animationMixer.timeScale=.1}update(){const t=this.scene.physics;if(!t.isReady)return;const e=st(Math.pow(2,5*t.playerVelocity-5),0,1);this.animationMixer.timeScale=e*this.wasOnGround,this.animationMixer.update(this.webgl.time.stableDt/1e3);const{x:s}=this.joystick.direction,i=this.wasOnGround?e:2*e;if(super.update({engineVolume:i,enginePitch:i,driftVolume:Math.abs(s),driftPitch:1}),this.allParts){this.parts.body.rotation.z=Math.PI+s*Math.PI*.05,this.parts.body.rotation.y=-s*Math.PI*.1,this.parts.frontWheel.rotation.z+=e,this.parts.rearWheel.rotation.x+=e;const t=-s*Math.PI*.25;this.parts.frontWheel.rotation.x=t}}afterUpdate(){this.base.updateWorldMatrix(!0,!0);const t=this.speed=this.base.position.distanceTo(this.lastPos);this.easedSpeed=ft(this.easedSpeed,t,.1);const e=d.get().set(.9,-1,1.3),s=d.get().copy(this.base.position).sub(this.lastPos).normalize();this.easedDir.x=ft(this.easedDir.x,s.x,.3),this.easedDir.y=ft(this.easedDir.y,s.y,.3),this.easedDir.z=ft(this.easedDir.z,s.z,.3),Math.abs(this.joystick.direction.x)>.8&&t>.23&&this.wasOnGround&&(e.set(0,-100.5,2.1),this.webgl.particles.emit("bikeSmoke",{amount:T.randomInt(1,1),position:this.mesh.localToWorld(e),scale:Ka.set(3,3),duration:800,billboard:!0,rotation:this.base.rotation,depthTest:!0,opacity:.3,batcherID:"noDepth",sprite:"smoke2",speed:this.easedSpeed,dir:s})),Math.abs(this.joystick.direction.x)>.8&&this.webgl.time.frameNum%10==0&&t>.23&&this.wasOnGround&&(e.set(0,-.5,1.1),this.webgl.particles.emit("bikePebbles",{amount:T.randomInt(5,6),position:e,scale:Ka.set(1,1),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.base,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"})),t>.1&&this.wasOnGround&&(e.set(0,-.5,1.1),this.webgl.particles.emit("bikeConstantPebbles",{amount:T.randomInt(1,2),position:e,scale:Ka.set(1,1),duration:800,billboard:!0,opacity:.3,batcherID:"noDepth",speed:this.easedSpeed,parent:this.base,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"})),this.lastPos.copy(this.base.position),e.release(),s.release()}beforeDestroy(){this.mesh.traverse((t=>t.geometry&&t.geometry.dispose())),this.skeleton.dispose()}}const Ja=new N,tn=new O,en=new d,sn=new d,on=new d,an=new d,nn=new tt;class rn extends xa{init({distance:t=10,elevation:e=1,offsetY:s=0,effects:i=0,driftRotate:o=0,driftLerp:a=0,positionLerp:n=0,rotationLerp:r=0}={}){super.init(),this.shaking={allow:!0,active:!1};const l=st(window.innerWidth/window.innerHeight,.6,1.3);Object.assign(this,{distance:t,elevation:e,offsetY:s,effects:i,drift:0,driftRotate:o,driftLerp:a,positionLerp:n,rotationLerp:r,previousRotation:new O,actualRotation:new O,direction:new d,afterTarget:new d,behindDir:new d}),this.base.fov=mt(l,.1,1.3,100,45),this.base.updateProjectionMatrix(),this.circuitCurve=this.scene.getCurve("circuit"),this.points=this.circuitCurve.getSpacedPoints(500)}get mixins(){return[...super.mixins||[],_a]}updateCameraTarget(t){const e=this.scene.player.base,{position:s}=this.base,{position:i}=e,{beforePoint:o}=this.updateCurve(i);this.previousRotation.slerp(t.quaternion,ft(1,.5,this.rotationLerp)),this.direction.set(0,0,1).applyQuaternion(this.previousRotation).normalize(),s.copy(e.position),s.add(en.copy(this.direction).multiplyScalar(this.distance)),s.lerp(o,.06*this.positionLerp),this.base.translateY(this.elevation)}updateFX(){this.driftRotate=ft(this.driftRotate,this.drift,.18),this.base.rotateZ(-.06*this.driftRotate*this.effects),this.base.translateX(-.7*this.driftRotate*this.effects),this.base.translateZ(-Math.abs(.3*this.drift*this.effects))}updateCurve(t){let e=this.points.length-2,s=this.points[e-1],i=this.points[e],o=Infinity;for(let h=0,d=this.points.length;h<d;h++){const a=this.points[h],n=this.points[h+1];if(!n)continue;if(t.distanceToSquared(n)>5e3)continue;const r=nn.set(a,n);if(r.closestPointToPoint(t,!0,en),en.distanceToSquared(n)>.01){const l=sn.copy(t).distanceToSquared(r.getCenter(en));l<o&&(s=a,i=n,o=l,e=h)}}nn.set(s,i).closestPointToPoint(t,!0,en);const a=s.distanceTo(en)/s.distanceTo(i);let n=this.points[D(e+-20,this.points.length)],r=this.points[D(e+-19,this.points.length)];const l=on.lerpVectors(n,r,a);l.y=ft(l.y,t.y+3,.5),n=this.points[D(e+18,this.points.length)],r=this.points[D(e+19,this.points.length)];const c=an.lerpVectors(n,r,a);return c.y=ft(c.y,t.y+3,.5),this.afterTarget.lerp(c,.025),{beforePoint:l,furtherPoint:c}}updateDrift(t,e){this.driftLerp=ft(this.driftLerp,e?.001:.15,.001),this.drift=ft(this.drift,.5*-this.scene.physics.playerForce.x,this.driftLerp)}update(){const{player:t,physics:e}=this.scene;if(!e.isReady)return;t.base.updateMatrixWorld(),Ja.position.copy(t.base.position),Ja.updateMatrixWorld(),this.updateCameraTarget(Ja),t.base.localToWorld(en.set(0,0,1)),en.setY(t.base.position.y),Ja.lookAt(en),this.direction.copy(Ja.localToWorld(en.set(0,this.offsetY,-1))),tn.copy(this.base.quaternion),this.base.lookAt(this.direction),this.actualRotation.copy(this.base.quaternion),this.base.quaternion.slerpQuaternions(tn,this.actualRotation,ft(1,.9,this.rotationLerp)),this.updateShake(),this.shaking.allow&&!this.shaking.active&&(t.hitProps||t.hitGround)?(this.shaking.allow=!1,this.shaking.active=!0,this.shake(350,.5*e.playerVelocity,!0,!1),setTimeout((()=>{this.shaking.active=!1}),1e3)):t.hitProps||(this.shaking.allow=!0);const s=this.webgl.input,i=s.keyboard.pressedCount>0,o=s.touch.value.pressed&&s.touch.value.useTouch,a=i||o;this.updateDrift(a),this.updateFX()}}class ln extends rn{init(){super.init({distance:9,elevation:4.5,effects:5,offsetY:2})}}const cn={CircuitBike:{scale:7.7,y:2.5,bike:!0},CircuitCar:{scale:14,y:2.4,car:!0},CircuitBoat:{scale:11,y:2.2},Default:{scale:14,y:2}},hn=new d;class dn extends m{init(){this.uturnScale=5,this.preset=cn[this.scene.id]||cn.Default,this.sprite=new fi({batcher:"depthSDF",sprite:"bubble_turnback",scale:this.preset.scale,angle:0,billboard:!0,sortable:!0}),this.springAngle=ut({tension:.1,friction:.08}),this.springScale=ut({tension:.1,friction:.08}),this.aOffset=0,this.xOffset=0,this.sOffset=0,this.dirSmooth=0,this.hide()}show(){!0!==this.visible&&(this.visible=!0,this.springScale.setTarget(1),this.springScale.setTension(.07),this.springScale.setFriction(.1))}hide(){!1!==this.visible&&(this.visible=!1,this.springScale.setTarget(.001),this.springScale.setTension(.2),this.springScale.setFriction(.42))}update(){const t=this.webgl.time.dt,e=this.preset,s=this.scene.player,i=this.scene.state.status<this.scene.state.STATES.Started;s.mesh.updateMatrixWorld(),s.mesh.getWorldPosition(hn),hn.y+=e.y,this.sprite.position.lerp(hn,i?1:.4);const o=.2*s.joystick.directionTarget.x;if(this.dirSmooth=pt(this.dirSmooth,o,i?1:Math.abs(o)>.1?.05:.3,t),e.bike){const e=1.5*s.parts.body.rotation.y,o=this.xOffset;this.xOffset=pt(this.xOffset,e,i?1:.3,t),this.aOffset=.2*this.xOffset,this.springAngle.setTarget(-3*(this.xOffset-o))}else e.car?this.springAngle.setTarget(3.3*this.dirSmooth):(this.springAngle.setTarget(-4.3*this.dirSmooth),this.xOffset=0,this.aOffset=0);this.springAngle.update(t),i&&(this.springAngle.value=this.springAngle.target),this.sprite.angle=this.springAngle.value+this.aOffset;const a=hn.set(this.xOffset,0,0).applyQuaternion(s.bodyQuaternion);this.sprite.position.x-=a.x,this.sprite.position.z-=a.z,this.sOffset=.3*Math.cos(15*this.scene.time);const n=this.preset.scale+this.sOffset;this.springScale.update(t),i&&(this.springScale.value=this.springScale.target),this.sprite.scale.setScalar(n*this.springScale.value),this.sprite.visible=this.springScale.value>.005}beforeDestroy(){this.sprite&&this.sprite.destroy()}}const un=new O,pn=new d;class mn extends go{init(){super.init(),this.isCircuitScene=!0,this.webgl.store.joystickVisible.set(!1),this.state=this.webgl.app.$circuit,this.state.reset({scene:this.id}),this.turnBack=this.add(dn),this.reverseTime=0,this.introTicks=0,this.introCamProgress=0,this.introCamPos=new d,this.introCamQt=new O}beforeEnter(){this.isEntered=!0}initIntroCam(){if(!this.isEntered||!this.webgl.store.isPreloaderHidden.value)return;this.introTicks++,this.introCamProgress=0;const t=this.player.base,e=this.playerCam?this.playerCam.base:this.scene.getCurrentCamera().base;pn.copy(e.position),un.copy(e.quaternion),t.updateMatrixWorld(),this.introCamPos.set(0,60,-190).applyQuaternion(t.quaternion).add(t.position),e.updateMatrixWorld(),e.position.copy(this.introCamPos),e.rotateY(-.7),e.rotateX(-1.3),this.introCamQt.copy(e.quaternion),e.position.copy(pn),e.quaternion.copy(un)}updateIntroCam(){if(this.introTicks<2||this.introCamProgress>=1)return;const t=this.playerCam.base;this.introTick++,this.introCamProgress=ft(this.introCamProgress,1,.03),this.introCamProgress>.9999&&(this.introCamProgress=1),t.position.lerp(this.introCamPos,1-this.introCamProgress),t.quaternion.slerp(this.introCamQt,1-this.introCamProgress)}updateIntro(){if(!this.player.isBodyReady)return;this.webgl.audio.bgm.stop(this.props.bgm);const t=this.state;if(t.countdown=-2,this.introTicks<2)return this.initIntroCam();this.introCamProgress>=.985&&this.state.setStatus("Countdown"),t.hasReached(1500)&&this.webgl.audio.playSound("music_minigame_jingle")}updateCountdown(){this.webgl.audio.bgm.stop(this.props.bgm);const t=this.state,e=this.webgl.audio;for(let s=0;s<=5;s++)if(t.hasReached(1e3*s+1)){const i=t.countdown=4-s;0===i?e.playSound("sfx_minigame_countdown_go"):i>0&&i<=3&&e.playSound("sfx_minigame_countdown_number")}t.time>4250&&this.state.setStatus("Started")}updateStarted(t){const e=this.state;e.hasReached(700)&&(e.countdown=-1),e.hasReached(1200)&&(e.countdown=-2),e.rawGameTime+=t,e.hasReached(10)&&this.props.bgm&&this.webgl.audio.bgm.play(this.props.bgm);this.physics.curveProgress.reverse&&e.time>2e3?this.reverseTime+=t:this.reverseTime=st(this.reverseTime-t,0,800),this.reverseTime>1e3?this.turnBack.show():this.reverseTime<=0&&this.turnBack.hide()}updateFinished(){const t=this.state;t.countdown=-2,t.hasReached(10)&&(this.webgl.audio.playSound("sfx_minigame_finish"),this.webgl.audio.bgm.stop(this.props.bgm)),t.isMainQuest?t.hasReached(2e3)&&this.state.exit(1200):t.hasReached(2e3)&&this.state.setStatus("Outro")}updateOutro(){this.state.countdown=-2}update(){const t=this.state,e=this.webgl.time.dt;t.isIntro?this.updateIntro(e):t.isCountdown?this.updateCountdown(e):t.isStarted?this.updateStarted(e):t.isFinished?this.updateFinished(e):t.isOutro&&this.updateOutro(e),super.update(),this.player.isBodyReady&&this.isEntered&&this.webgl.store.isPreloaderHidden.value&&t.updateTime(e)}afterUpdate(){this.updateIntroCam()}onFinishLineReached(){this.state.isStarted&&(this.state.setStatus("Finished"),this.turnBack.hide())}respawn(){this.physics.respawnPlayer(!0,!0,!0)}beforeDestroy(){this.state=null,super.beforeDestroy&&super.beforeDestroy()}}function fn(){if(v.resources.bikeCharacter)return;const t=v.resources.bikeCharacter={},e=v.resources.basicMat;return Pt.load("./assets/Bike.4822c42fcb3d2aa0.glb",{character:!0,onLoad:s=>{s.scene.traverse((i=>{if(t.scene=s.scene,i.isMesh&&(i.material=e),"Armature"===i.name&&(t.armature=i),"SkinnedMesh"===i.type){i.skeleton&&i.skeleton.dispose(),i.updateMatrixWorld();const t=i.geometry.clone(),e=t.attributes.uv2,s=t.attributes.color,o=t.attributes.color_1,a=t.attributes.texcoord_2;e&&t.deleteAttribute&&t.deleteAttribute("uv2"),o&&t.deleteAttribute&&t.deleteAttribute("color_1"),s&&t.deleteAttribute&&t.deleteAttribute("color"),a&&t.deleteAttribute&&t.deleteAttribute("texcoord_2")}})),t.animations=s.animations}})}class gn extends rn{init(){super.init({distance:15,elevation:6,offsetY:3,effects:3})}}const bn=new h;class yn extends qa{init(){super.init({sounds:{engine:"sfx_minigame_car_loop",crash:"sfx_minigame_car_impact",drift:"sfx_minigame_car_tireSkid"}});const t=Hs.use();this.mesh=this.webgl.resources.assets.RaceCarRaw.mesh,this.mesh.traverse((e=>{e.isMesh&&(e.frustumCulled=!1,e.material=t,e.castShadow=!0)})),this.base.add(this.mesh),this.parts={body:this.mesh.getObjectByName("Body002"),frontLeftWheel:this.mesh.getObjectByName("FrontLeftWheel001"),frontRightWheel:this.mesh.getObjectByName("FrontRightWheel001"),rearLeftWheel:this.mesh.getObjectByName("RearLeftWheel001"),rearRightWheel:this.mesh.getObjectByName("RearRightWheel001")},this.allParts=this.parts&&this.parts.body&&this.parts.frontLeftWheel&&this.parts.frontRightWheel&&this.parts.rearLeftWheel&&this.parts.rearRightWheel,this.allParts&&(this.parts.frontLeftWheel.rotation.order="YXZ",this.parts.frontRightWheel.rotation.order="YXZ"),this.updateOptions({mass:1e3,speed:45,drift:!0,driftFactor:.05,stearingSpeed:.42})}update(){const t=this.scene.physics;if(!t.isReady)return;const{x:e}=this.joystick.direction;if(super.update({engineVolume:t.playerVelocity,enginePitch:t.playerVelocity,driftVolume:Math.abs(e),driftPitch:.35}),this.allParts){this.mesh.translateZ(-2),this.mesh.rotation.y=-e*Math.PI*.1,this.mesh.translateZ(2),this.parts.body.rotation.z=e*Math.PI*.1,this.parts.body.position.y=.15*Math.abs(e);const s=-t.playerVelocity;this.parts.frontLeftWheel.rotation.x+=s,this.parts.frontRightWheel.rotation.x+=s,this.parts.rearRightWheel.rotation.x+=s,this.parts.rearLeftWheel.rotation.x+=s;const i=-e*Math.PI*.25;this.parts.frontLeftWheel.rotation.y=i,this.parts.frontRightWheel.rotation.y=i}}afterUpdate(){this.base.updateWorldMatrix(!0,!0);const t=this.speed=this.base.position.distanceTo(this.lastPos);this.easedSpeed=ft(this.easedSpeed,t,.1);const e=d.get().set(.9,-.1,1.3),s=d.get().copy(this.base.position).sub(this.lastPos).normalize();this.easedDir.x=ft(this.easedDir.x,s.x,.3),this.easedDir.y=ft(this.easedDir.y,s.y,.3),this.easedDir.z=ft(this.easedDir.z,s.z,.3),Math.abs(this.joystick.direction.x)>.4&&(this.webgl.particles.emit("smokeWheels",{amount:T.randomInt(1,2),position:this.mesh.localToWorld(e),scale:bn.set(10,10),rotation:this.base.rotation,duration:800,billboard:!0,depthTest:!0,opacity:.3,batcherID:"noDepth",sprite:"smoke2",speed:this.easedSpeed,dir:s}),e.set(-.9,-.1,1.3),this.webgl.particles.emit("smokeWheels",{amount:T.randomInt(1,1),position:this.mesh.localToWorld(e),scale:bn.set(10,10),duration:800,billboard:!0,rotation:this.base.rotation,depthTest:!0,opacity:.3,batcherID:"noDepth",sprite:"smoke2",speed:this.easedSpeed,dir:s})),Math.abs(this.joystick.direction.x)>.8&&this.webgl.time.frameNum%10==0&&(e.set(.9,-.1,1.3),this.webgl.particles.emit("carPebbles",{amount:T.randomInt(3,4),position:e,scale:bn.set(3,3),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.mesh,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"}),e.set(.9,-.1,-1.3),this.webgl.particles.emit("carPebbles",{amount:T.randomInt(1,3),position:e,scale:bn.set(2,2),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.mesh,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"})),this.lastPos.copy(this.base.position),e.release(),s.release()}}class vn extends mn{init(){super.init(),this.player=this.add(yn),this.camera=this.playerCam=this.add(gn)}}vn.prepare=()=>({preloadAssets:["RaceCarRaw"]});const wn=new h;class xn extends qa{init(){super.init({sounds:{engine:"sfx_minigame_boat_loop",crash:"sfx_minigame_boat_impact",drift:"sfx_minigame_boat_drift"}});const t=Hs.use();this.mesh=this.webgl.resources.assets.RaceBoatRaw.mesh,this.mesh.traverse((e=>{e.isMesh&&(e.frustumCulled=!1,e.material=t,e.castShadow=!0)})),this.base.add(this.mesh),this.parts={body:this.mesh.getObjectByName("Boat001"),flag:this.mesh.getObjectByName("Flag002"),rudder:this.mesh.getObjectByName("Rudder001")},this.allParts=this.parts&&this.parts.body&&this.parts.flag&&this.parts.rudder,this.lerpedVelocity=0,this.updateOptions({radius:1.2,mass:1e3,speed:30,drift:!0,driftFactor:.01,stearingSpeed:.3,laps:2})}update(){const t=this.scene.physics;if(!t.isReady)return;const{x:e}=this.joystick.direction;if(super.update({engineVolume:t.playerVelocity,enginePitch:t.playerVelocity,driftVolume:e,driftPitch:1}),this.base.position.y=.35,this.allParts){this.lerpedVelocity+=(t.playerVelocity-this.lerpedVelocity)/10,this.parts.rudder.rotation.y=e*Math.PI*.3,this.parts.flag.rotation.y=ft(-this.base.rotation.y,0,this.lerpedVelocity),this.mesh.rotation.x=this.lerpedVelocity*Math.PI*.07,this.mesh.position.y=.5*this.lerpedVelocity,this.mesh.rotation.y=-e*Math.PI*.1,this.mesh.rotation.z=-e*Math.PI*.1;const s=Math.cos(.001*this.webgl.time.elapsed*Math.PI);this.mesh.position.y+=s*ft(.02,.05,this.lerpedVelocity);const i=Math.cos(5e-4*this.webgl.time.elapsed*Math.PI);this.mesh.rotation.x+=i*ft(.06,.01,this.lerpedVelocity),this.mesh.rotation.y+=i*ft(.015,.01,this.lerpedVelocity),this.mesh.rotation.z+=i*ft(.06,.01,this.lerpedVelocity)}}afterUpdate(){this.base.updateWorldMatrix(!0,!0);const t=this.speed=this.base.position.distanceTo(this.lastPos);this.easedSpeed=ft(this.easedSpeed,t,.1);const e=d.get().set(.9,-1,1.3),s=d.get().copy(this.base.position).sub(this.lastPos).normalize();this.easedDir.x=ft(this.easedDir.x,s.x,.3),this.easedDir.y=ft(this.easedDir.y,s.y,.3),this.easedDir.z=ft(this.easedDir.z,s.z,.3),Math.abs(this.joystick.direction.x)>.8&&t>.23&&this.wasOnGround&&e.set(0,-.34,2),Math.abs(this.joystick.direction.x)>.8&&this.webgl.time.frameNum%10==0&&t>0&&this.wasOnGround&&(e.set(0,-.34,2),this.webgl.particles.emit("waterSplash",{amount:T.randomInt(20,30),position:e,scale:wn.set(1,1),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.parts.body,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"})),t>.1&&this.wasOnGround&&(e.set(0,-.34,2.4),this.webgl.particles.emit("waterConstantSplash",{amount:T.randomInt(1,2),position:e,scale:wn.set(2,2),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.parts.body,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2"}),e.set(0,-.34,-3),this.webgl.particles.emit("waterConstantSplashFront",{amount:T.randomInt(1,2),position:e,scale:wn.set(2,2),duration:800,billboard:!0,opacity:.3,batcherID:"normal",speed:this.easedSpeed,parent:this.parts.body,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2",power:7}),this.webgl.time.frameNum%3==0&&(this.base.localToWorld(e.set(0,-.34,-2.3)),e.y=0,this.webgl.particles.emit("waterRipples",{amount:T.randomInt(1,1),position:e,scale:wn.set(2,2),duration:800,opacity:.3,batcherID:"normal",speed:this.easedSpeed,dir:this.joystick.direction.x<0?1:-1,sprite:"smoke2",power:2.3}))),this.lastPos.copy(this.base.position),e.release(),s.release()}}class Sn extends rn{init(){super.init({distance:14,elevation:5,offsetY:2,effects:5})}}class _n extends mn{init(){super.init(),this.player=this.add(xn),this.camera=this.playerCam=this.add(Sn),this.water=this.add(To.use()),this.add(mo,{defaultAmbiance:"Beach"})}}_n.prepare=()=>({preloadAssets:["RaceBoatRaw"]});const Pn=St();class Mn extends m{init(){const t=this.webgl.resources.assets.BoatYellow.geometry,e=this.scene.getPoint("BoatIntro");this.base=new S(t,Hs.use()),this.base.castShadow=!0,this.base.receiveShadow=!0,this.base.frustumCulled=!1,this.base.renderOrder=this.webgl.store.renderOrder.vehicles,this.base.position.copy(e.position),this.base.quaternion.copy(e.quaternion),this.basePos=this.base.position.clone(),this.baseQt=this.base.quaternion.clone(),this.npcPt=this.addObject3D(new N),this.npcPt.translateX(.85),this.npcPt.translateY(.92),this.npcPt.translateZ(.03),this.npcPt.rotateY(Math.PI),this.time=0}update(){const t=this.webgl.time.dt;this.time+=t,this.base.position.copy(this.basePos),this.base.quaternion.copy(this.baseQt),this.base.rotateY(.3*Math.PI),this.base.rotateX(-.02);const e=ft(1.1,.3,this.scene.introCam.smoothStarted),s=this.scene.water.uProgress.value,i=(s-.11)*e,o=1.2*s;this.base.translateY((o-.1)*i);const a=.06*Pn(50,3e-4*this.time)*.5*e,n=.05*Pn(-120,-2e-4*this.time)*.5*e;this.base.rotateX(a+.09*i),this.base.rotateZ(n+.14*i)}}const Tn={introFrom:{position:[-7.900966,76.942503,124.816482],quaternion:[-.17203494,-.38932646,-.07426799,.90183876]},introTo:{position:[-39.199139,39.079015,-39.791217],quaternion:[-.06789136,-.70262188,-.06765479,.70507878]},descentTo:{position:[-31.598772,1.10131,-91.917094],quaternion:[.05590659,-.72178826,.05870771,.68734967]},startedTo:{position:[-26.211491,2.876771,-91.172516],quaternion:[-.05053312,-.84864314,-.08246255,.52004918]},endTo:{position:[-26.092073,4.979981,-104.410833],quaternion:[.0965187,-.61305203,.07581644,.78045065]}};for(let Fm in Tn)Tn[Fm].position=(new d).fromArray(Tn[Fm].position),Tn[Fm].quaternion=(new O).fromArray(Tn[Fm].quaternion);var An=Tn;const Cn=St(),{introFrom:Dn,introTo:In,descentTo:kn,startedTo:On,endTo:Rn}=An,Ln=$([0,.285,.4,1]),En=$([.42,0,.58,1]),Fn=$([.44,.015,.04,1.005]),zn=$([.44,.015,.04,1.005]),Bn=$([.44,.015,.04,1.005]);class Un extends wt{init(){this.base=this.cam=new dt(55,1),this.base.position.copy(An.introFrom.position),this.base.quaternion.copy(An.introFrom.quaternion),this.descentFirst=!0,this.descentPrevPos=new d,this.descentVelocity=0,this.smoothDescent=0,this.pMouseX=0,this.pMouseY=0,this.mouseX=0,this.mouseY=0,this.velMouseX=0,this.smoothZoom=0,this.time=0,this.timeStarted=0,this.smoothStarted=0,this.smoothStartedQt=0,this.startedDone=!1,this.endStarted=!1,this.endTime=0,this.smoothEnd=0,this.endDone=!1,this.endChoices=null,this.store=this.webgl.store.intro,this.webgl.viewport.ratio.watchImmediate(this.onRatio,this)}onRatio(t){const e=st(gt(t,.5,1.2),0,1);this.cam.fov=ft(65,55,e),this.cam.updateProjectionMatrix()}finish(t){this.endChoices=t,this.endTime=0,this.endDone=!1,this.endStarted=!0,this.smoothEnd=0}resetTimers(){this.time=this.descentVelocity=this.timeStarted=this.smoothZoom=this.smoothDescent=this.smoothStarted=this.smoothStartedQt=0,this.descentFirst=!0}updateTraveling(){const t=this.base,e=t.position,s=t.quaternion;let i=this.time,o=st(gt(i,0,6e3),0,1);o=En(o),e.lerpVectors(Dn.position,In.position,o),s.slerpQuaternions(Dn.quaternion,In.quaternion,o)}updateZoom(){const t=this.base;let e=this.time,s=st(gt(e,0,4e3),0,1);t.translateZ(ft(50,0,Ln(s))),t.rotateX(ft(-.23,0,Ln(s))),t.rotateZ(ft(-.12,0,Ln(s)))}updateDescent(){const t=this.webgl.time.stableDt,e=this.base,s=e.position,i=e.quaternion;let o=this.time,a=st(gt(o,2700,6900),0,1);a=Fn(a),this.smoothDescent=pt(this.smoothDescent,a,.06,t),s.lerpVectors(s,kn.position,this.smoothDescent),i.slerpQuaternions(i,kn.quaternion,this.smoothDescent),this.updateZoom();let n=st(gt(o,2700,3700),0,1);const r=this.descentFirst?0:-.2*s.distanceTo(this.descentPrevPos);this.descentVelocity=ft(this.descentVelocity,r,(.008+.018*this.smoothStarted)*n),e.rotateZ(n*this.descentVelocity),this.descentFirst=!1,this.smoothDescent>.92&&this.store.startJourneyVisible.set(!0),this.smoothDescent>.994&&this.store.descentDone.set(!0)}updateStarted(){if(!this.store.journeyStarted.value)return;const t=this.webgl.time.stableDt,e=this.base,s=e.position,i=e.quaternion,o=this.timeStarted+=t;let a=st(gt(o,0,2e3),0,1);a=zn(a),this.smoothStarted=pt(this.smoothStarted,a,.09,t),this.smoothStartedQt=pt(this.smoothStartedQt,a,.14,t),s.lerp(On.position,this.smoothStarted),i.slerp(On.quaternion,this.smoothStartedQt),this.smoothStarted>.96&&!this.startedDone&&(this.startedDone=!0,this.scene.startIntroDialog&&this.scene.startIntroDialog())}updateNoise(){const t=this.webgl.time.elapsed,e=.2*Cn(3,1e-4*t),s=.2*Cn(-1e3,14e-5*t),i=.01*Cn(80,2e-4*t);this.base.translateY(e*(1-this.smoothStarted)),this.base.translateX(s*(1-this.smoothStarted)),this.base.rotateZ(i)}updateMouseHover(){const t=this.webgl.input.touch.value;if(t.useTouch)return;const e=this.webgl.time.stableDt,s=t.normalizePos;this.mouseX=pt(this.mouseX,s.x,.04,e),this.mouseY=pt(this.mouseY,s.y,.04,e),this.base.rotateY(.25*this.mouseX*.15),this.base.translateX(1.4*this.mouseX*.15),this.base.translateY(.1*this.mouseY);const i=this.mouseX-this.pMouseX;this.velMouseX=pt(this.velMouseX,.3*i,.1,e),this.base.rotateZ(this.velMouseX),this.pMouseX=this.mouseX}updateEnd(){if(!this.endStarted)return;const t=this.webgl.time.stableDt,e=this.base,s=e.position,i=e.quaternion,o=this.endTime+=t;let a=st(gt(o,0,3500),0,1);a=Bn(a),this.smoothEnd=pt(this.smoothEnd,a,.12,t),s.lerp(Rn.position,this.smoothEnd),i.slerp(Rn.quaternion,this.smoothEnd),this.smoothEnd>.65&&!this.endDone&&(this.endDone=!0,function(t,e){const s=v.app.$fintechs.customPath,i={fintechs:[],arrivalIsland:e.args?e.args.scene:"IslandWest",arrivalPoint:e.args?e.args.point:"PortSpawnB"},o=t.AnswerA,a=t.AnswerB,n=s[o]&&s[o][a]||i;v.app.$savestate.setVariable("isIntroCompleted",!0),v.app.$savestate.game.interests=[...new Set(n.fintechs)],v.scenes.teleportTo(n.arrivalIsland,{point:n.arrivalPoint,transition:"boat"})}(this.endChoices,this.scene.npcIntro))}update(){const t=this.webgl.time.stableDt;this.time+=t,this.updateTraveling(),this.updateDescent(),this.updateStarted(),this.descentPrevPos.copy(this.base.position),this.updateNoise(),this.updateMouseHover(),this.updateEnd()}beforeDestroy(){this.webgl.viewport.ratio.unwatch(this.onRatio,this),super.beforeDestroy&&super.beforeDestroy()}}St();class jn extends m{init(){this.geo=this.webgl.resources.assets.CoastalWorld.geometry;const t=this.scene.getPoint("BoatIntro");this.mat=new Mt({color:16777215,transparent:!0}),this.base=new S(this.geo,this.mat),this.base.frustumCulled=!1,this.base.renderOrder=this.webgl.store.renderOrder.vehicles,this.base.position.copy(t.position),this.base.position.x+=20,this.base.position.z-=1.6,this.base.position.y+=6.8,this.base.rotation.set(0,1.51,0),this.base.rotateX(-.25),this.base.scale.setScalar(7),this.basePos=this.base.position.clone(),this.baseQt=this.base.quaternion.clone(),this.webgl.viewport.ratio.watchImmediate(this.onRatio,this)}onRatio(t){const e=st(gt(t,.4,1.2),0,1);this.base.scale.setScalar(ft(5.5,7.5,e))}update(){this.base.position.copy(this.basePos),this.base.quaternion.copy(this.baseQt);const t=this.scene.introCam,e=st(gt(t.smoothStarted,.7,.15),0,1);this.mat.opacity=1*e}beforeDestroy(){this.webgl.viewport.ratio.unwatch(this.onRatio,this),this.mat.dispose(),this.geo.dispose()}}class Nn extends go{init(){super.init(),this.resetStore(),this.fog.near=40,this.fog.far=400,this.water=this.add(To.use()),this.introCam=this.camera=this.add(Un),this.logo=this.add(jn),this.boat=this.add(Mn),this.add(mo,{defaultAmbiance:"Beach"}),this.watchSignal(this.webgl.store.intro.resetTimers,this.resetTimers)}afterEnter(){this.props.bgm&&this.webgl.audio.bgm.play(this.props.bgm)}resetTimers(){this.introCam.resetTimers()}update(){const t=ft(380,220,this.introCam.smoothDescent),e=ft(44,41,this.introCam.smoothDescent);this.fog.far=t,this.fog.near=e,super.update()}afterUpdate(){const t=this.time>7;t!==this.canPausePhysics&&(this.canPausePhysics=t,this.physics.togglePause(t))}resetStore(){const t=this.webgl.store.intro;t.journeyStarted.set(!1),t.startJourneyVisible.set(!1),t.descentDone.set(!1)}startIntroDialog(){this.webgl.app.$dialogs.startDialog(this.npcIntro,"Intro",{onExit:this.onIntroDialogDone.bind(this),closable:!0})}onIntroDialogDone(t,e){this.introCam.finish(e)}beforeDestroy(){super.beforeDestroy()}}Nn.prepare=()=>({preloadAssets:["BoatYellow","CoastalWorld"]});const Vn={class:Wa,savePosition:!0,route:"Home"},Wn={class:Nn,route:"Intro"},qn={route:"MiniGame",bgm:"music_minigame_loop",transition:"games"},Hn={IslandWest:l(r({},Vn),{bgm:"music_island_west",pageview:{title:"Coastal World - Island West",path:"/island-west"}}),IslandNorth:l(r({},Vn),{bgm:"music_island_north",pageview:{title:"Coastal World - Island North",path:"/island-north"}}),IslandEast:l(r({},Vn),{bgm:"music_island_east",pageview:{title:"Coastal World - Island East",path:"/island-east"}}),EasterEgg:l(r({},Vn),{bgm:"music_secret",savePosition:!1}),IslandIntro:l(r({},Wn),{bgm:"music_intro",pageview:{title:"Coastal World - Intro",path:"/intro"}}),CircuitBike:l(r({},qn),{class:class extends mn{init(){super.init(),this.player=this.add(Za),this.camera=this.playerCam=this.add(ln),this.add(mo,{defaultAmbiance:"Forest"})}load(){return Promise.all([super.load(),fn()])}},questPrefix:"Brigit",exitPoint:{scene:"IslandWest",point:"BikeGame"},pageview:{title:"Coastal World - Bike Race",path:"/race-bike"}}),CircuitCar:l(r({},qn),{class:vn,questPrefix:"Coastal",exitPoint:{scene:"IslandEast",point:"CarGame"},pageview:{title:"Coastal World - Car Race",path:"/race-car"}}),CircuitBoat:l(r({},qn),{class:_n,questPrefix:"One",exitPoint:{scene:"IslandNorth",point:"BoatRace"},pageview:{title:"Coastal World - Boat Race",path:"/race-boat"}}),Test:r({},Vn)};var Gn=Object.keys(Hn).reduce(((t,e)=>{t[e]=Object.assign({},Hn[e]);const s=r({},t[e]);return delete s.class,t[e].props=Object.assign({},s,{id:e}),t}),{});const Yn={"./bg_fog.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"#ifdef USE_FOG\nfloat _fogNear=fogNear;float fogFactor=smoothstep(_fogNear*1.1,fogFar,vFogDepth);float fogFactor2=smoothstep(_fogNear*0.7,fogFar*0.9,vFogDepth);fogFactor2*=1.-fogFactor;const vec3 fogColor=vec3(0.616,0.949,0.941);const vec3 fogColor2=vec3(0.725,0.408,0.651);gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor2,clamp(fogFactor2*1.1,0.,1.));gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,clamp(fogFactor*0.7,0.,1.));\n#endif"},Symbol.toStringTag,{value:"Module"})),"./bg_fog_pars.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"uniform float fogNear;uniform float fogFar;varying float vFogDepth;"},Symbol.toStringTag,{value:"Module"})),"./big_shadow.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"vec3 bigShadowDist=(cameraPosition-vWorldPos.xyz)*bigShadowFalloff;float bigShadowLen=dot(bigShadowDist,bigShadowDist);float bigShadowWeight=clamp(bigShadowLen*bigShadowLen*bigShadowLen*bigShadowLen,.0,1.);directionalLight=directionalLights[0];getDirectionalLightInfo(directionalLight,geometry,directLight);directionalLightShadow=directionalLightShadows[0];float invBigShadowDynamicChunks=(1.-bigShadowDynamicChunks);float shadow=all(bvec3(directLight.visible,receiveShadow,bigShadowWeight<0.999))?getShadow(directionalShadowMap[0],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[0]):1.0;float shadowBig=bigShadowWeight>(0.001-invBigShadowDynamicChunks)?getShadow(bigShadowMap,bigShadow.mapSize,bigShadow.bias,bigShadow.radius,vBigShadowDirectionalCoords):1.;float shadowFade=1.-bigShadowWeight*invBigShadowDynamicChunks;shadow=1.-(1.-smoothstep(0.4,0.92,shadow))*shadowFade;shadowBig=1.-(1.-smoothstep(0.4,0.92,shadowBig))*1.;vec3 shadowColor=mix(vec3(0.,.1,.55),vec3(1.),shadow);vec3 shadowBigColor=mix(vec3(0.,.1,.55),vec3(1.),shadowBig);vec3 allDynColor=mix(shadowColor,shadowBigColor,bigShadowWeight);vec3 nonDynColor=min(shadowColor,shadowBigColor);directLight.color*=mix(nonDynColor,allDynColor,bigShadowDynamicChunks);RE_Direct(directLight,geometry,material,reflectedLight);"},Symbol.toStringTag,{value:"Module"})),"./big_shadow_pars.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"#define USE_BIG_SHADOWMAP\nstruct BigShadow{vec2 mapSize;float bias;float radius;};uniform BigShadow bigShadow;uniform float bigShadowFalloff;uniform float bigShadowDynamicChunks;uniform sampler2D bigShadowMap;varying vec4 vBigShadowDirectionalCoords;"},Symbol.toStringTag,{value:"Module"})),"./blend_modes.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"float blendOverlay(float base,float blend){return base<0.5?(2.0*base*blend):(1.0-2.0*(1.0-base)*(1.0-blend));}vec3 blendOverlay(vec3 base,vec3 blend){return vec3(blendOverlay(base.r,blend.r),blendOverlay(base.g,blend.g),blendOverlay(base.b,blend.b));}vec3 blendOverlay(vec3 base,vec3 blend,float opacity){return(blendOverlay(base,blend)*opacity+base*(1.0-opacity));}"},Symbol.toStringTag,{value:"Module"})),"./clouds.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"vec2 cT=vec2(-0.0012,0.)*time;\n#ifdef IS_MOBILE\nfloat cB=texture2D(noise,vWorldPos.xz*0.0012+cT).r;float clouds=smoothstep(0.45,0.34,cB);diffuseColor.rgb+=diffuseColor.rgb*clouds*-0.10*vec3(2.1,1.8,1.3);\n#else\nfloat cA=texture2D(noise,vWorldPos.xz*0.009+cT).r;float cB=texture2D(noise,vWorldPos.xz*0.001+cT+cA*0.005).r;float clouds=smoothstep(0.45,0.38,cB);diffuseColor.rgb+=diffuseColor.rgb*clouds*-0.11*vec3(2.1,1.8,1.3);\n#endif"},Symbol.toStringTag,{value:"Module"})),"./conditionals.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"float between(float x,vec2 hit){return min(1.,smoothstep(hit.x+0.25,hit.x-0.25,x)+smoothstep(hit.y-0.25,hit.y+0.25,x));}float when_gt(float x,float y){return max(sign(x-y),0.0);}float when_lt(float x,float y){return max(sign(y-x),0.0);}"},Symbol.toStringTag,{value:"Module"})),"./depth_dither.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"#ifndef HAS_WEBXR\nvec2 dpUV=(gl_FragCoord.xy*pixelRatio)*0.15;dpUV.x+=step(1.,mod(dpUV.y,2.))*0.5;dpUV=fract(dpUV);float dpLimit=smoothstep(0.3,0.999,gl_FragCoord.w);float dpMask=smoothstep(dpLimit-0.2,dpLimit,length(dpUV-vec2(0.5)));if(dpMask<0.5){discard;}\n#endif"},Symbol.toStringTag,{value:"Module"})),"./eases.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"#ifndef PI\n#define PI 3.141592653589793\n#endif\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\nfloat backInOut(const in float t){float f=t<.5?2.*t:1.-(2.*t-1.);float g=pow(f,3.)-f*sin(f*PI);return t<.5?.5*g:.5*(1.-g)+.5;}float backIn(float t){return pow(t,3.)-t*sin(t*PI);}float backOut(float t){float f=1.-t;return 1.-(pow(f,3.)-f*sin(f*PI));}float bounceOut(float t){const float a=4./11.;const float b=8./11.;const float c=9./10.;const float ca=4356./361.;const float cb=35442./1805.;const float cc=16061./1805.;float t2=t*t;return t<a?7.5625*t2:t<b?9.075*t2-9.9*t+3.4:t<c?ca*t2-cb*t+cc:10.8*t*t-20.52*t+10.72;}float bounceInOut(float t){return t<.5?.5*(1.-bounceOut(1.-t*2.)):.5*bounceOut(t*2.-1.)+.5;}float bounceIn(float t){return 1.-bounceOut(1.-t);}float circularIn(float t){return 1.-sqrt(1.-t*t);}float circularOut(float t){return sqrt((2.-t)*t);}float circularInOut(float t){return t<.5?.5*(1.-sqrt(1.-4.*t*t)):.5*(sqrt((3.-2.*t)*(2.*t-1.))+1.);}float cubicInOut(float t){return t<.5?4.*t*t*t:.5*pow(2.*t-2.0,3.)+1.;}float cubicIn(float t){return t*t*t;}float cubicOut(float t){float f=t-1.;return f*f*f+1.;}float elasticIn(float t){return sin(13.*t*HALF_PI)*pow(2.0,10.*(t-1.));}float elasticOut(float t){return sin(-13.*(t+1.)*HALF_PI)*pow(2.0,-10.*t)+1.;}float elasticInOut(float t){return t<.5?.5*sin(+13.*HALF_PI*2.*t)*pow(2.0,10.*(2.*t-1.)):.5*sin(-13.*HALF_PI*((2.*t-1.)+1.))*pow(2.0,-10.*(2.*t-1.))+1.;}float exponentialIn(float t){return t==.0?t:pow(2.0,10.*(t-1.));}float exponentialOut(float t){return t==1.?t:1.-pow(2.0,-10.*t);}float exponentialInOut(float t){return t==.0||t==1.?t:t<.5?+0.5*pow(2.0,(20.*t)-10.):-0.5*pow(2.0,10.-(t*20.))+1.;}float quadraticIn(float t){return t*t;}float quadraticOut(float t){return-t*(t-2.);}float quadraticInOut(float t){float p=2.*t*t;return t<.5?p:-p+(4.*t)-1.;}float quarticIn(float t){return pow(t,4.);}float quarticOut(float t){return pow(t-1.0,3.)*(1.-t)+1.;}float quarticInOut(float t){return t<.5?+8.*pow(t,4.):-8.*pow(t-1.0,4.)+1.;}float qinticIn(float t){return pow(t,5.);}float qinticOut(float t){return 1.-(pow(t-1.0,5.));}float qinticInOut(float t){return t<.5?+16.*pow(t,5.):-.5*pow(2.*t-2.0,5.)+1.;}float sineInOut(float t){return-0.5*(cos(PI*t)-1.);}float sineIn(float t){return sin((t-1.)*HALF_PI)+1.;}float sineOut(float t){return sin(t*HALF_PI);}float linear(float t){return t;}"},Symbol.toStringTag,{value:"Module"})),"./get_instance_matrix.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"mat4 getInstanceMatrix(vec3 p,vec4 q,vec3 s){mat4 m;float x=q.x;float y=q.y;float z=q.z;float w=q.w;float x2=x+x;float y2=y+y;float z2=z+z;float xx=x*x2;float xy=x*y2;float xz=x*z2;float yy=y*y2;float yz=y*z2;float zz=z*z2;float wx=w*x2;float wy=w*y2;float wz=w*z2;float sx=s.x;float sy=s.y;float sz=s.z;m[0][0]=(1.-(yy+zz))*sx;m[0][1]=(xy+wz)*sx;m[0][2]=(xz-wy)*sx;m[0][3]=0.;m[1][0]=(xy-wz)*sy;m[1][1]=(1.-(xx+zz))*sy;m[1][2]=(yz+wx)*sy;m[1][3]=0.;m[2][0]=(xz+wy)*sz;m[2][1]=(yz-wx)*sz;m[2][2]=(1.-(xx+yy))*sz;m[2][3]=0.;m[3][0]=p.x;m[3][1]=p.y;m[3][2]=p.z;m[3][3]=1.;return m;}"},Symbol.toStringTag,{value:"Module"})),"./lights_fragment_begin.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"GeometricContext geometry;geometry.position=-vViewPosition;geometry.normal=normal;geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(vViewPosition);\n#ifdef CLEARCOAT\ngeometry.clearcoatNormal=clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if (NUM_POINT_LIGHTS>0)&&defined(RE_Direct)\nPointLight pointLight;\n#if defined(USE_SHADOWMAP)&&NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){pointLight=pointLights[i];getPointLightInfo(pointLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_POINT_LIGHT_SHADOWS)\npointLightShadow=pointLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getPointShadow(pointShadowMap[i],pointLightShadow.shadowMapSize,pointLightShadow.shadowBias,pointLightShadow.shadowRadius,vPointShadowCoord[i],pointLightShadow.shadowCameraNear,pointLightShadow.shadowCameraFar):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_SPOT_LIGHTS>0)&&defined(RE_Direct)\nSpotLight spotLight;\n#if defined(USE_SHADOWMAP)&&NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){spotLight=spotLights[i];getSpotLightInfo(spotLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nspotLightShadow=spotLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(spotShadowMap[i],spotLightShadow.shadowMapSize,spotLightShadow.shadowBias,spotLightShadow.shadowRadius,vSpotShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_DIR_LIGHTS>0)&&defined(RE_Direct)\nDirectionalLight directionalLight;\n#if defined(USE_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLightShadow;\n#endif\n#if defined(USE_SHADOWMAP)&&defined(USE_BIG_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS==1\n#include <big_shadow>\n#elif \n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){}\n#pragma unroll_loop_end\n#endif\n#endif\n#if (NUM_RECT_AREA_LIGHTS>0)&&defined(RE_Direct_RectArea)\nRectAreaLight rectAreaLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_RECT_AREA_LIGHTS;i++){rectAreaLight=rectAreaLights[i];RE_Direct_RectArea(rectAreaLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if defined(RE_IndirectDiffuse)\nvec3 iblIrradiance=vec3(0.0);vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);\n#if (NUM_HEMI_LIGHTS>0)\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){irradiance+=getHemisphereLightIrradiance(hemisphereLights[i],geometry);}\n#pragma unroll_loop_end\n#endif\n#endif\n#if defined(RE_IndirectSpecular)\nvec3 radiance=vec3(0.0);vec3 clearcoatRadiance=vec3(0.0);\n#endif"},Symbol.toStringTag,{value:"Module"})),"./linear_step.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"float linearstep(float start,float end,float value){return(clamp(value,start,end)-start)/(end-start);}"},Symbol.toStringTag,{value:"Module"})),"./luma.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"float luma(vec3 color){return dot(color,vec3(0.299,0.587,0.114));}"},Symbol.toStringTag,{value:"Module"})),"./transition_mask.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"vec2 screenSpaceUv=vec2(gl_FragCoord.xy)/res.xy;vec2 ratio=vec2(clamp(0.,1.,res.x/res.y),clamp(0.,1.,res.y/res.x));screenSpaceUv.x*=ratio.x;screenSpaceUv.y*=ratio.y;screenSpaceUv.x+=(1.-ratio.x)/2.;screenSpaceUv.y+=(1.-ratio.y)/2.;float circle=distance(screenSpaceUv,vec2(0.5));circle=1.-step(circle,maskRadius);"},Symbol.toStringTag,{value:"Module"})),"./transition_mask_pars.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"uniform float road;uniform float sea;uniform float games;uniform float maskRadius;"},Symbol.toStringTag,{value:"Module"})),"./water_depth_frag.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"vec3 wColor=gl_FragColor.xyz;float wpy=vWorldPos.y;float waterDepth=1.-linearstep(WATER_MAX_DEPTH,WATER_BASE_LEVEL,wpy);float foamY=cos((vWorldPos.z+vWorldPos.x)*0.9+time*1.4)*0.015-0.0075;float waterLevel=WATER_BASE_LEVEL+waterProgress+foamY;float wetBaseLevel=WATER_BASE_LEVEL-waterLevel*0.1;float wet=max(0.2,sin(time-PI*0.5))*smoothstep(wetBaseLevel+0.43,wetBaseLevel+0.3,wpy)*when_gt(wpy,waterLevel);wColor-=wet*0.09;float hasFoam=when_gt(wpy,waterLevel)*when_lt(wpy,waterLevel+WATER_FOAM_HEIGHT);float hasWater=when_lt(wpy,waterLevel);vec3 underwaterColor=(wColor*waterTopColor)*0.8+0.4;wColor=mix(wColor,underwaterColor,hasWater*0.8);wColor=mix(wColor,waterColor,hasWater*waterDepth);wColor=mix(wColor,vec3(1.),hasFoam*1.);gl_FragColor.xyz=vec3(wColor);"},Symbol.toStringTag,{value:"Module"})),"./world_pos.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"vWorldPos=modelMatrix*vec4(transformed,1.);"},Symbol.toStringTag,{value:"Module"})),"./world_pos_pars.glsl":Object.freeze(Object.defineProperty({__proto__:null,default:"varying vec4 vWorldPos;"},Symbol.toStringTag,{value:"Module"}))};let Xn=null;const Qn={autostart:!0,selfdestruct:!1,standalone:!1};class $n extends xt{created(){Xn||(Xn=c());const t=this.base;t.timers=[],this.options.extendProto?(this.extendProto("wait",Kn),this.extendProto("timer",Zn),this.extendProto("clearTimers",Jn)):(t.wait=At(Kn,t,1),t.timer=At(Zn,t,2),t.clearTimers=At(Jn,t,0))}update(){const t=Xn.time.dt,e=this.base.timers;let s=e.length;for(;s--;)e[s].update(t),e[s]._stopped&&(e[s].dispose(),e.splice(s,1))}destroyed(){this.base.clearTimers()}}function Kn(t){return this.timer(t)}function Zn(t,e){if(!this.destroyed){if(e){const s=Ct(t,e,Qn);return this.timers.push(s),s}return new Promise((e=>{const s=Ct(t,e,Qn);this.timers.push(s)}))}}function Jn(){for(let t=0,e=this.timers.length;t<e;t++){const e=this.timers[t];e&&e.dispose()}this.timers.length=0}class tr extends xt{created(){const t=this.base;t.timers=[],t._disposablesSignals=[],t.store||(t.store={}),t.hooks||(t.hooks={}),this.options.extendProto?(this.extendProto("watchSignal",sr),this.extendProto("watchSignalImmediate",ir),this.extendProto("disposableSignal",er),this.extendProto("autoUnwatch",er)):(t.watchSignal=At(sr,t,4),t.watchSignalImmediate=At(ir,t,3),t.disposableSignal=At(er,t,1),t.autoUnwatch=t.disposableSignal)}destroyed(){const t=this.base;for(let e=0,s=t._disposablesSignals.length;e<s;e++){const s=t._disposablesSignals[e];if(s.unwatchAll)s.unwatchAll();else{const s=t._disposablesSignals[e].owner;s&&s.unwatch(t._disposablesSignals[e])}}for(let e in t.store){const s=t.store[e];s.unwatchAll&&s.unwatchAll()}for(let e in t.hooks){const s=t.hooks[e];s.unwatchAll&&s.unwatchAll()}t.store=t.hooks=null,t._disposablesSignals=null}}function er(t){if(Array.isArray(t))for(let e=0,s=t.length;e<s;e++)this._disposablesSignals.push(t[e]);else this._disposablesSignals.push(t);return t}function sr(t,e,s,i=!1){"string"==typeof e&&(e=this[e]),s||(s=this);const o=i?t.watchImmediate(e,s):t.watch(e,s);return this._disposablesSignals.push(o),o}function ir(t,e,s){return this.watchSignal(t,e,s,!0)}class or extends xt{created(){const t=this.base;this.extendProto("updateDynamicProps",rr),this.extendProto("initDynamicProps",nr),ar.call(t)}destroyed(){this.base}}function ar(){const t=this.props,e=t.sceneID,s=this.webgl.resources.scenes[e],i=this.dynamicProps=t.dynamicProps||{};this.dynamicPropsAlloc=s.dynamicPropsAllocs[t.uid],this.dynamicPropsVertices=s.dynamicPropsVertices[t.uid],this.dynamicPropsPhysicsLayers={},this.dynamicPropsState={},this.dynamicPropsStateUpdated=this.autoUnwatch(at());for(let o in i){const t=i[o];this.dynamicPropsState[o]=!!t.default,t.physicsLayer&&!this.dynamicPropsPhysicsLayers[t.physicsLayer]&&(this.dynamicPropsPhysicsLayers[t.physicsLayer]={collider:t.collider,previousVisibility:null,visible:null})}}function nr(){this.initDynamicPropsState&&this.initDynamicPropsState(this.dynamicPropsState);for(let t in this.dynamicProps)cr.call(this,t,this.dynamicPropsState[t]),this.scene.physics.isReady?lr.call(this):this.scene.physics.readyPromise.then((()=>{this.destroyed||lr.call(this)}))}function rr(t={},e=!1){const s=this.dynamicPropsState;let i=!1;for(let o in t)null!=s[o]&&(e||s[o]!=t[o])&&(s[o]=t[o],cr.call(this,o,t[o]),i=!0);i&&(lr.call(this),this.dynamicPropsStateUpdated.emit())}function lr(){const t=this.dynamicPropsPhysicsLayers;for(let e in t){const s=t[e];s.previousVisibility=s.visible,s.visible=!1}for(let e in this.dynamicProps){const s=this.dynamicProps[e];if(!s.physicsLayer)continue;const i=this.dynamicPropsState[e];t[s.physicsLayer].visible|=i}for(let e in t){const s=t[e];s.visible!==s.previousVisibility&&this.scene.physics.toggleLayer(e,s.visible)}}function cr(t,e){if(null==this.dynamicPropsState[t])return;const s=this.dynamicPropsVertices[t];if(s){const i=this.webgl.resources.scenes[this.props.sceneID].chunks,o=this.dynamicPropsAlloc[t],a=i[o.chunk].attributes.position,n=o.start,r=o.start+o.count;e?a.array.set(s,n):a.array.fill(1e7,n,r);const l=a.updateRange,c=Math.max(0,l.offset+l.count);l.offset=l.count<0?n:Math.min(l.offset,n);const h=Math.max(c,r);l.count=h-l.offset,a.needsUpdate=!0}}const hr=new d;new h;const dr=new p,ur=new nt,pr=new V;function mr(t,e,s){hr.copy(e).project(t);const i=hr.x,o=hr.y,a=1+s,n=-1-s;return i<a&&i>n&&o<a&&o>n}const fr=[],gr=new p;class br extends m{init(){this.prevCheck=0,this.forceUpdate=!0,this.broadphase=this.scene.add(uo,{onChange:()=>this.forceUpdate=!0}),this.prevVector=null,this.prevPosition=new d,this.currentEl=null,this.prevContainedPosition=new d,this.lastDateWithoutZone=0,this.frustum=new nt,this.muteDelay=0,this.webgl.store.interactionVisibles.watch(this.updateForce,this),setTimeout((()=>this.updateForce()),1500),this.updateForceDeffer=()=>{this.detroyed||(this.forceUpdate=!0,this.update())}}updateForce(){this.detroyed||(this.forceUpdate=!0,this.update(),clearTimeout(this.updateForceTimer),this.updateForceTimer=setTimeout(this.updateForceDeffer,200))}update(){const t=this.scene.getCurrentCamera();gr.multiplyMatrices(t.cam.projectionMatrix,t.cam.matrixWorldInverse),this.frustum.setFromProjectionMatrix(gr);const e=t.playerCanInteract?this.scene.player.base.position:t.cam.position;e!==this.prevVector&&(this.forceUpdate=!0),this.prevVector=e;const s=performance.now(),i=s-this.prevCheck,o=this.prevPosition.distanceToSquared(e),a=this.forceUpdate||o>.05;if(!a&&i<700)return;if(this.prevPosition.copy(e),!this.forceUpdate&&i<100)return;if(this.prevCheck=s,!this.scene.player.canMove)return;fr.length=0;let n=!1;const r=this.broadphase.getCell(e);for(let c=0,h=r.items.length;c<h;c++){const s=r.items[c].element;if(!a&&!s.isMoving&&s!==this.currentEl)continue;if(!s.boundingSphere.containsPoint(e))continue;let i=mr(t.cam,s.iconPosition,.1);if(i&&s===this.currentEl&&(n=!0),i=mr(t.cam,s.iconPosition,-.2),i)if(1!==s.spheres.length)for(let t=0,o=s.spheres.length;t<o;t++){if(s.spheres[t].containsPoint(e)){fr.push(s);break}}else fr.push(s)}let l;if(fr.length>1){this.prevContainedPosition.copy(e),this.lastDateWithoutZone=s;let t=Number.POSITIVE_INFINITY;for(let s=0,i=fr.length;s<i;s++){const i=fr[s],o=i.iconPosition.distanceToSquared(e);o>t||(t=o,l=i)}}else 1===fr.length?(l=fr[0],this.prevContainedPosition.copy(e),this.lastDateWithoutZone=s):0===fr.length&&n&&this.prevContainedPosition.distanceToSquared(e)<2?(l=this.currentEl,this.lastDateWithoutZone=0):l=0===fr.length&&this.currentEl&&!this.forceUpdate&&s-this.lastDateWithoutZone<20?this.currentEl:null;this.webgl.store.interactionVisibles.value||(l=null),this.muteDelay>0?this.muteDelay-=this.webgl.time.dt:(this.currentEl!==l&&(l&&l.onEnabled(),this.currentEl&&this.currentEl.onDisabled(),this.webgl.store.interactionButton.set(l&&l.buttonState)),fr.length=0,this.currentEl=l,this.forceUpdate=!1)}beforeDestroy(){this.webgl.store.interactionButton.set(null),this.webgl.store.interactionVisibles.unwatch(this.updateForce,this)}}new K(1,2);const yr=()=>{},vr=new d;class wr extends m{initInteractiveZonesController(){this.scene.interactiveZones||(this.scene.interactiveZones=this.scene.add(br))}init(){this.initInteractiveZonesController(),this.isMoving=this.props.isMoving,this.useCollapsedQuestMark=this.props.useCollapsedQuestMark;const t=this.props.icon||"bubble_talk",e="bubble_quest"===t?"bubble_collapsed_alt":"bubble_collapsed";this.audioEnabled=this.props.audioEnabled||"sfx_UI_notif_quest_object",this.icons={normal:t,locked:this.props.iconLocked||"bubble_lock",collapsed:this.props.iconCollapsed||e},this.props.locked&&(this.iconID=this.iconLockedID),this.timeOffset=this.props.timeOffset||0,this.progress=0,this.buttonState={icon:this.props.buttonIcon||"interactions-yes",mode:this.props.buttonMode||"click",onStart:this.props.onStart||yr,onProgress:t=>{this.progress=t,this.props.onProgress&&this.props.onProgress(t)},onStop:this.props.onStop||yr,locked:this.props.locked,onDone:this.bind("onDone",1)},"tap"===this.buttonState.mode&&(this.buttonState.onTap=()=>{this.scene.playerCam.shake(350,.035,!0,!0),this.props.onTap&&this.props.onTap()}),this.matrix=this.props.matrix||this.parent.props.transformMatrix,this.target=this.props.target||new d,this.iconPosition=this.props.iconPosition||new d,this.previousPosition=new d,this.boundingSphere=null,this.spheres=[],this.matrix&&this.previousPosition.applyMatrix4(this.matrix),this.matrix&&this.iconPosition.applyMatrix4(this.matrix);const s=this.props.zones||[];this.props.zone&&!s.length?s.push(this.props.zone):s.length||s.push({center:new d,radius:this.props.activationRadius||1});for(let o=0,a=s.length;o<a;o++){const t=s[o],e=new V(t.center,t.radius);this.spheres.push(e),this.matrix&&e.applyMatrix4(this.matrix),this.boundingSphere||(this.boundingSphere=e.clone()),this.boundingSphere.union(e)}const i=this.props.activationRadius;i&&this.boundingSphere.radius<i&&(this.boundingSphere.radius=i),this.ixItem=this.scene.interactiveZones.broadphase.add(this,{refreshDelay:(this.isMoving,200),position:this.boundingSphere.center,radius:this.boundingSphere.radius,debug:!1}),this.enabledScale=9.32,this.disabledScale=v.app.$device.type.mobile?8:6.8,this.sprite=new fi({batcher:"depthSDF",sprite:"bubble_quest",scale:this.disabledScale,angle:0,billboard:!0,position:this.iconPosition,sortable:!0}),this.spring=ut({initial:this.disabledScale}),this.visibilitySpring=ut({initial:1}),this.enabled=!0,this.onDisabled(),this.spring.setValue(.001),this.done=!1}get icon(){return this.icons.normal}set icon(t){t!==this.icons.normal&&(this.icons.normal=t,this.enabled&&this.refreshIcon())}get iconCollapsed(){return this.icons.collapsed}set iconCollapsed(t){t!==this.icons.collapsed&&(this.icons.collapsed=t,this.enabled||this.refreshIcon())}get iconLocked(){return this.icons.locked}set iconLocked(t){t!==this.icons.locked&&(this.icons.locked=t,this.locked&&this.refreshIcon())}get locked(){return this.buttonState.locked}set locked(t){if(t===this.buttonState.locked)return;this.buttonState.locked=t;const e=this.webgl.store.interactionButton;this.refreshIcon(),e.value===this.buttonState&&this.webgl.store.interactionButton.set(this.buttonState,!0)}refreshIcon(){if(this.destroyed)return;if(!this.sprite.sprite)return;const t=this.locked,e=!this.enabled,s=this.sprite.sprite;let i=this.icons.normal;if(t&&e?i="bubble_collapsed_locked":t?i=this.icons.locked:e&&(i=this.icons.collapsed),i===s)return;this.sprite.sprite.change({id:i});const o=e?this.disabledScale:this.enabledScale;this.spring.setTarget(o),this.spring.setValue(.001)}onDone(){this.done=!0,this.props.onDone&&this.props.onDone(),this.spring.setTarget(.001),this.scene.interactiveZones.muteDelay=800}onDisabled(){this.done||this.destroyed||this.sprite.sprite&&this.enabled&&(this.enabled=!1,this.refreshIcon(),this.spring.setValue(1.75*this.disabledScale))}onEnabled(){if(this.done)return;if(this.enabled)return;this.enabled=!0,this.refreshIcon();const t=this.webgl.audio;this.locked?t.playSound("sfx_quest_locked"):this.sprite&&"bubble_talked"===this.sprite.sprite.id?t.playSound("sfx_UI_dialog_next",{volume:.8}):t.playSound(this.audioEnabled),this.spring.setValue(.25*this.enabledScale)}update(){const t=this.scene.getCurrentCamera().cam;this.sprite.visible=function(t,e,s){return dr.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ur.setFromProjectionMatrix(dr),s&&(pr.center.copy(e),pr.radius=s),s?ur.intersectsSphere(pr):ur.containsPoint(e)}(t,this.sprite.position,1.5),this.sprite.visible&&(this.spring.update(this.webgl.time.dt),this.visibilitySpring.update(this.webgl.time.dt),this.sprite.scale.x=this.sprite.scale.y=Math.max(0,this.spring.value*this.visibilitySpring.value),this.sprite.angle=this.done?.4*this.spring.velocity:.7*this.spring.velocity,this.done&&this.spring.value<=.005?this.destroy():this.enabled||(this.sprite.position.y=this.iconPosition.y+.05*Math.sin(.01*this.webgl.time.elapsed+this.timeOffset)))}show(){const t=this.visibilitySpring;this.isHidden=!1,t.setTarget(1),t.setTension(.1),t.setFriction(.2),t.setMass(1)}hide(){const t=this.visibilitySpring;t.setTarget(0),t.setTension(.1),t.setFriction(.4),t.setMass(.7),this.isHidden=!0}updateOpacity(t){this.sprite.alpha=t}updatePosition(t){const e=vr.subVectors(t,this.previousPosition);this.previousPosition.copy(t),this.boundingSphere.translate(e),this.ixItem.update();for(let s=0,i=this.spheres.length;s<i;s++)this.spheres[s].translate(e);this.iconPosition.add(e),this.sprite.position.copy(this.iconPosition)}beforeDestroy(){this.sprite.destroy(),this.ixItem.destroy(),super.beforeDestroy&&super.beforeDestroy()}}const xr=()=>{},Sr=new d,_r=new d;class Pr extends xt{created(){this.extendProto("setupInteraction",Mr),this.extendProto("removeInteraction",Tr)}destroyed(){const t=this.base;t.unwatchLockCondition&&t.unwatchLockCondition(),t.removeInteraction&&t.removeInteraction()}}function Mr(t={}){this.removeInteraction();let e=!1;if(t.item){const s=v.app.$quests.getFromItem(t.item);if(s&&s.item){const i=s.item;t.unlockedWhen||(t.unlockedWhen=i.variable),t.buttonIcon||(t.buttonIcon="interactions-"+i.image),t.iconLocked||(t.iconLocked="bubble_"+i.image),t.icon||(t.icon="bubble_quest"),e=!0}}let s,i,o=!1,a=!1;if(t.unlockedWhen){const e=t.unlockedWhen;a=!this.webgl.savestate.getVariable(e),a&&(this.unwatchLockCondition=j((()=>this.webgl.savestate.game.vars[e]),(t=>{t&&this.interactionZone&&(this.unwatchLockCondition&&this.unwatchLockCondition(),this.interactionZone.locked=!1,this.unwatchLockCondition=null)})))}this.isBigInteraction="tap"===t.buttonMode||"hold"===t.buttonMode||"hold-infinite"===t.buttonMode,this.useCamera=this.isBigInteraction&&(t.cameraHeight||t.cameraTarget||t.cameraDistance);let n,r=null==t.skipCamAfterDone||t.skipCamAfterDone;if(this.useCamera){const e=t.cameraHeight||1,o=t.cameraDistance||1;n=t.cameraTarget||new d(0,1,0),n.applyMatrix4(this.props.transformMatrix);let a=!1;s=()=>{if(a)return;a=!0;const s=n,i=this.scene.playerCam,r=i.basePosition||i.base.position,l=_r.copy(r).sub(Sr.setScalar(0).applyMatrix4(this.props.transformMatrix)).normalize();Sr.x=r.x+l.x*o,Sr.z=r.z+l.z*o,Sr.y=r.y+e,i.setTarget({id:this.uid,lockPlayer:!0,position:Sr,lookAt:s,posEase:t.posEase||.09,lookAtEase:t.lookAtEase||.1,isAction:!0})},i=()=>{if(!a)return;a=!1;this.scene.playerCam.removeTarget({id:this.uid,posEase:t.posEase||.09,lookAtEase:t.lookAtEase||.1})}}const l=t.playerActionPreset||"Default",c=t.onStart,h=t.onProgress,u=t.onStop,p=t.onAnimStart,m=t.onAnimStop,f=t.onDone?()=>t.onDone():this.startPropsTransition?this.startPropsTransition:this.onInteractionDone||xr;let g,b=!1,y=0,w=0;const x=this.webgl.audio.list[t.sound],S=x&&x.id,_=x&&x.loop,P=S&&!_?()=>{if(!this.interactionZone)return;const t=Q(this.interactionZone.progress,0,1,.98,1.02);S&&!_&&this.webgl.audio.playSound(S,{playbackRate:t})}:void 0,M=()=>{b||(b=!0,this.interactionZone&&this.interactionZone.hide(),this.scene.player.actionStart(l),_&&!g&&(g=this.webgl.audio.playSound(S)),this.useCamera&&s(),p&&p())},T=t=>{if(g&&(g.stop(),g=null),!b)return;b=!1,!o&&this.interactionZone&&this.interactionZone.show(),this.scene.player.actionDone();const e=t||!o||!r;this.useCamera&&e&&i(),m&&m(t)};this.cancelAnim=()=>T(!0);this.interactionZone=this.add(wr,{isMoving:this.isMoving,debug:t.debug,icon:t.icon,iconLocked:t.iconLocked,iconCollapsed:t.iconCollapsed,iconPosition:t.iconPosition||new d,audioEnabled:t.audioEnabled,zone:t.zone||{center:new d(0,0,0),radius:6},zones:t.zones,matrix:t.matrix,locked:a||t.locked,buttonIcon:t.buttonIcon||"interactions-yes",buttonMode:t.buttonMode||"click",onTap:P,onStart:()=>{c&&c()},onProgress:t=>{if(h&&h(t),!o){if(t>.01&&t>y?(w=t,M()):w-t>.11&&T(),b){const t=this.scene.player;if(t.rotateAt){const e=this.interactionZone,s=n||e&&e.iconPosition;s&&t.rotateAt(s)}}y=t}},onStop:()=>{T(),u&&u()},onDone:()=>{o=!0,T(),this.webgl.store.debounceInteractionDone.emit(),f&&f()},timeOffset:this.seed?this.seed/100:3*Math.random()}),e&&this.setupMainQuestExclamation(t.item)}function Tr(){this.cancelAnim&&this.cancelAnim(!0),this.interactionZone&&(this.interactionZone.destroy(),this.interactionZone=null)}new h;const Ar=new WeakMap,Cr=new WeakMap;function Dr(t){Cr.has(t)||Cr.set(t,0);const e=Cr.get(t)-1;Cr.set(t,e),e>0||(Cr.set(t,0),clearTimeout(Ar.get(t)),Ar.set(t,setTimeout((()=>t.dispose()),1500)))}let Ir={geometries:!0,materials:!0,textures:!0},kr={};function Or(t){kr.geometries&&t.geometry&&Dr(t.geometry),t.material&&kr.materials&&Dr(t.material)}function Rr(t){kr.geometries&&t.geometry&&t.geometry.dispose(),t.material&&kr.materials&&t.material.dispose()}var Lr={use:function(t,e){return Cr.has(t)||Cr.set(t,0),Cr.set(t,Cr.get(t)+1),clearTimeout(Ar.get(t)),t.use&&t.use(e||{}),t},unuse:Dr,unuseAll:function(t,e){Object.assign(kr,Ir,e),t.traverse(Or)},disposeAll:function(t,e={}){Object.assign(kr,Ir,e),t.traverse(Rr)}};const Er=()=>{},Fr={Def:Er};class zr{constructor(t={}){let e=0;const s=this.states={},i=this.statesCbs=[];t.states||(t.states=Fr);for(let o in t.states){const a=e++;s[o]=a,i[a]=t.states[o]||Er}this.current=s[t.current]||Object.values(s)[0],this.currentCb=i[this.current],this.prevTime=0,this.time=0}update(){const t=v.time.dt;this.prevTime=this.time,this.time+=t,this.currentCb()}set(t){"string"==typeof t&&(t=this.states[t]),this.current=t,this.currentCb=this.statesCbs[t],this.prevTime=this.time=0}hasReached(t){return this.prevStateTime<t&&this.stateTime>=t}destroy(){this.states=null,this.statesCbs.length=0,this.currentCb=null,this.update=Er}}const Br={},Ur={},jr=()=>{},Nr={update(){},value:1,stopped:!0};Br.Bounce=function(){const t=this.transitionMesh;if(!t)return;const e=this.propsTransitionOpts.presetOpts;this.propsTransitionOpts.ogOnStart&&this.propsTransitionOpts.ogOnStart(),this.scene.playerCam.shake(740,.1,!1,!0,.75),this.tDelayAfter=e&&e.delayAfter||0,Hs.use().pauseEffects(this.uid),t.origScale=t.scale.clone(),t.origRotation=t.rotation.clone();const s=this.springY=ut();if(s.setValue(.2),s.setTarget(1),e&&e.bounceHorizontal){const t=this.springX=ut({friction:.14,tension:.12});t.setValue(e.bounceHorizontal),t.setTarget(1)}else this.springX=Nr},Ur.Bounce={Update:function(){const t=this.transitionMesh;if(!t)return;const e=this.propsTransitionOpts.presetOpts,s=this.webgl.time.dt;this.springY.update(s),this.springX.update(s),t.scale.set(t.origScale.x*this.springX.value,t.origScale.y*this.springY.value,t.origScale.z*this.springX.value),e&&(e.rotateX&&(t.rotation.x=t.origRotation.x+this.springY.velocity*e.rotateX),e.rotateZ&&(t.rotation.z=t.origRotation.z+this.springY.velocity*e.rotateZ)),this.springY.stopped&&this.springX.stopped&&(this.tDelayAfter-=s,this.tDelayAfter<=0&&this.endPropsTransition())}};const Vr=new Set(["scale","scaleY","positionY"]);Br.Tween=function(){const t=this.transitionMesh;if(!t)return;const e=this.propsTransitionOpts.presetOpts;this.propsTransitionOpts.ogOnStart&&this.propsTransitionOpts.ogOnStart(),this.scene.playerCam.shake(1400,.11,!0,!0,1),Hs.use().pauseEffects(this.uid),t.origScale=t.scale.clone(),t.origPosition=t.position.clone(),t.origRotation=t.rotation.clone(),this.tTweens=[],this.tTweensValues={},this.tDelayAfter=e.delayAfter||0;for(let s in e){if(!Vr.has(s))continue;const i=e[s];let o=jr;"scale"===s?o=(e,s)=>{t.scale.copy(t.origScale).multiplyScalar(s)}:"scaleY"===s?o=(e,s)=>{t.scale.copy(t.origScale),t.scale.y*=s}:"positionY"===s&&(o=(e,s)=>{t.position.copy(t.origPosition),t.position.y+=s}),this.tTweensValues[s]=null!=i.from?i.from:0,this.tTweens.push(Dt({target:this.tTweensValues,property:s,duration:i.duration||1e3,easing:i.easing||"outSwift",from:this.tTweensValues[s],to:null!=i.to?i.to:1,onProgress:o}))}},Ur.Tween={Update:function(){const t=this.transitionMesh;if(!t)return;const e=this.webgl.time.dt;let s=!0;for(let i=0,o=this.tTweens.length;i<o;i++){const t=this.tTweens[i];t.ended||t.destroyed||(s=!1,t.update(e))}s&&(t.visible=!1,this.tDelayAfter-=e,this.tDelayAfter<=0&&this.endPropsTransition())}};var Wr={starts:Br,updateStates:Ur};const qr=()=>{};class Hr extends xt{created(){const t=this.base,e=this;this.base.setupPropsTransition=(e={})=>{t.propsTransitionOpts=e;const s=e.preset;e.ogOnStart=e.onStart;let i=e.onStart||qr;Wr.starts[s]&&(i=Wr.starts[s].bind(t)),e.onStart=i;let o=e.updateStates||null;if(!e.updateStates&&Wr.updateStates[s]){o={};const e=Wr.updateStates[s];for(let s in e)o[s]=e[s].bind(t)}if(!e.stateBefore&&e.stateAfter){const s=e.stateBefore={};for(let e in t.dynamicProps)s[e]=!1}t.propsTransitionState=new zr({states:o}),Gr.call(t)},this.base.startPropsTransition=()=>{const s=t.propsTransitionOpts,i=t.propsTransitionState;e.update=i.update.bind(i),t.webgl.store.debounceInteractionDone.emit(2e3),t.transitionMesh&&t.scene.addObject3D(t.transitionMesh),s.stateBefore&&t.updateDynamicProps(s.stateBefore),s.onStart&&s.onStart()},this.base.endPropsTransition=()=>{const s=t.propsTransitionOpts;Hs.use().resumeEffects(this.uid);t.scene.playerCam.removeTarget({id:this.uid}),s.stateAfter&&t.updateDynamicProps(s.stateAfter),Yr.call(t),e.destroy(),t.webgl.store.debounceInteractionDone.emit(),s.onDone&&s.onDone.call(t)}}update(){}destroyed(){const t=this.base;Yr.call(t),Hs.use().resumeEffects(t.uid)}}function Gr(){const t=this.propsTransitionOpts,e=this.webgl.resources.assets[t.transitionAsset];if(!e)return;const s=Lr.use(e.geometry),i=Hs.use();this.transitionMesh=new S(s,i),this.transitionMesh.applyMatrix4(this.props.transformMatrix),this.transitionMesh.frustumCulled=!1,this.transitionMesh.castShadow=this.webgl.store.chunksCastShadow.value,this.transitionMesh.receiveShadow=!0;const o=this.scene;this.autoUnwatch(o.hooks.beforePrerender.watchOnce((()=>{o.addObject3D(this.transitionMesh)}))),this.autoUnwatch(o.hooks.afterPrerender.watchOnce((()=>{o.removeObject3D(this.transitionMesh)})))}function Yr(){this.transitionMesh&&(Lr.unuseAll(this.transitionMesh,{geometries:!0,material:!1,textures:!1}),this.scene&&(this.scene.removeObject3D(this.transitionMesh),this.transitionMesh=null))}class Xr extends m{init(){this.list=[],this.npcCount=0}addNPC(t){t.npcIndex=this.npcCount++,this.list.push(t)}removeNPC(t){let e=-1;for(let s=0,i=this.list.length;s<i;s++){const i=this.list[s];e>-1?i.npcIndex-=1:t===i&&(e=s)}e>-1&&this.list.splice(e,1)}beforeDestroy(){this.list.length=0,this.npcCount=0}update(){for(let t=0,e=this.list.length;t<e;t++){this.list[t].updateVisibility()}}}var Qr={computeTangents:function(t){const e=t.index,s=t.attributes;if(null===e||void 0===s.position||void 0===s.normal||void 0===s.uv)return;const i=e.array,o=s.position.array,a=s.normal.array,n=s.uv.array,r=o.length/3;void 0===s.tangent&&t.setAttribute("tangent",new M(new Float32Array(4*r),4));const l=s.tangent.array,c=[],u=[];for(var p=0;p<r;p++)c[p]=new d,u[p]=new d;const m=new d,f=new d,g=new d,b=new h,y=new h,v=new h,w=new d,x=new d;function S(t,e,s){m.fromArray(o,3*t),f.fromArray(o,3*e),g.fromArray(o,3*s),b.fromArray(n,2*t),y.fromArray(n,2*e),v.fromArray(n,2*s),f.sub(m),g.sub(m),y.sub(b),v.sub(b);const i=1/(y.x*v.y-v.x*y.y);isFinite(i)&&(w.copy(f).multiplyScalar(v.y).addScaledVector(g,-y.y).multiplyScalar(i),x.copy(g).multiplyScalar(y.x).addScaledVector(f,-v.x).multiplyScalar(i),c[t].add(w),c[e].add(w),c[s].add(w),u[t].add(x),u[e].add(x),u[s].add(x))}let _=t.groups;0===_.length&&(_=[{start:0,count:i.length}]);p=0;for(var P=_.length;p<P;++p)for(var T=z=(F=_[p]).start,A=z+F.count;T<A;T+=3)S(i[T+0],i[T+1],i[T+2]);const C=new d,D=new d,I=new d,k=new d;let O,R,L;function E(t){I.fromArray(a,3*t),k.copy(I),R=c[t],C.copy(R),C.sub(I.multiplyScalar(I.dot(R))).normalize(),D.crossVectors(k,R),L=D.dot(u[t]),O=L<0?-1:1,l[4*t]=C.x,l[4*t+1]=C.y,l[4*t+2]=C.z,l[4*t+3]=O}for(p=0,P=_.length;p<P;++p){var F,z;for(T=z=(F=_[p]).start,A=z+F.count;T<A;T+=3)E(i[T+0]),E(i[T+1]),E(i[T+2])}},mergeBufferGeometries:function(t,e){const s=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),o=new Set(Object.keys(t[0].morphAttributes)),a={},n={},r=t[0].morphTargetsRelative,l=new P;let c=0;for(var h=0;h<t.length;++h){const p=t[h];let m=0;if(s!==(null!==p.index))return null;for(var d in p.attributes){if(!i.has(d))return null;void 0===a[d]&&(a[d]=[]),a[d].push(p.attributes[d]),m++}if(m!==i.size)return null;if(r!==p.morphTargetsRelative)return null;for(var d in p.morphAttributes){if(!o.has(d))return null;void 0===n[d]&&(n[d]=[]),n[d].push(p.morphAttributes[d])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(p.userData),e){var u;if(s)u=p.index.count;else{if(void 0===p.attributes.position)return null;u=p.attributes.position.count}l.addGroup(c,u,h),c+=u}}if(s){let e=0;const s=[];for(h=0;h<t.length;++h){const i=t[h].index;for(var p=0;p<i.count;++p)s.push(i.getX(p)+e);e+=t[h].attributes.position.count}l.setIndex(s)}for(var d in a){const t=this.mergeBufferAttributes(a[d]);if(!t)return null;l.setAttribute(d,t)}for(var d in n){const t=n[d][0].length;if(0===t)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[d]=[];for(h=0;h<t;++h){const t=[];for(p=0;p<n[d].length;++p)t.push(n[d][p][h]);const e=this.mergeBufferAttributes(t);if(!e)return null;l.morphAttributes[d].push(e)}}return l},mergeBufferAttributes:function(t){let e,s,i,o=0;for(var a=0;a<t.length;++a){const n=t[a];if(n.isInterleavedBufferAttribute)return null;if(void 0===e&&(e=n.array.constructor),e!==n.array.constructor)return null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return null;if(void 0===i&&(i=n.normalized),i!==n.normalized)return null;o+=n.array.length}const n=new e(o);let r=0;for(a=0;a<t.length;++a)n.set(t[a].array,r),r+=t[a].array.length;return new M(n,s,i)},interleaveAttributes:function(t){let e,s=0,i=0;for(var o=0,a=t.length;o<a;++o){var n=t[o];if(void 0===e&&(e=n.array.constructor),e!==n.array.constructor)return null;s+=n.array.length,i+=n.itemSize}const r=new It(new e(s),i);let l=0;const c=[],h=["getX","getY","getZ","getW"],d=["setX","setY","setZ","setW"];var u=0;for(a=t.length;u<a;u++){const e=(n=t[u]).itemSize,s=n.count,i=new kt(r,e,l,n.normalized);c.push(i),l+=e;for(let t=0;t<s;t++)for(let s=0;s<e;s++)i[d[s]](t,n[h[s]](t))}return c},estimateBytesUsed:function(t){let e=0;for(const i in t.attributes){const s=t.getAttribute(i);e+=s.count*s.itemSize*s.array.BYTES_PER_ELEMENT}const s=t.getIndex();return e+=s?s.count*s.itemSize*s.array.BYTES_PER_ELEMENT:0,e},mergeVertices:function(t,e=1e-4){e=Math.max(e,Number.EPSILON);const s={},i=t.getIndex(),o=t.getAttribute("position"),a=i?i.count:o.count;let n=0;const r=Object.keys(t.attributes),l={},c={},h=[],d=["getX","getY","getZ","getW"];for(var u=0,p=r.length;u<p;u++){l[b=r[u]]=[],(x=t.morphAttributes[b])&&(c[b]=new Array(x.length).fill().map((()=>[])))}const m=Math.log10(1/e),f=Math.pow(10,m);for(u=0;u<a;u++){const e=i?i.getX(u):u;let o="";var g=0;for(p=r.length;g<p;g++)for(var b=r[g],y=(w=t.getAttribute(b)).itemSize,v=0;v<y;v++)o+=~~(w[d[v]](e)*f)+",";if(o in s)h.push(s[o]);else{for(g=0,p=r.length;g<p;g++){b=r[g];var w=t.getAttribute(b),x=t.morphAttributes[b];y=w.itemSize;const s=l[b],i=c[b];for(v=0;v<y;v++){const t=d[v];if(s.push(w[t](e)),x)for(let s=0,o=x.length;s<o;s++)i[s].push(x[s][t](e))}}s[o]=n,h.push(n),n++}}const S=t.clone();for(u=0,p=r.length;u<p;u++){b=r[u];const e=t.getAttribute(b);var _=new e.array.constructor(l[b]);w=new M(_,e.itemSize,e.normalized);if(S.setAttribute(b,w),b in c)for(g=0;g<c[b].length;g++){const e=t.morphAttributes[b][g];_=new e.array.constructor(c[b][g]);const s=new M(_,e.itemSize,e.normalized);S.morphAttributes[b][g]=s}}return S.setIndex(h),S},toTrianglesDrawMode:function(t,e){if(e===Ot)return t;if(e===Rt||e===Lt){let i=t.getIndex();if(null===i){const e=[],o=t.getAttribute("position");if(void 0===o)return t;for(var s=0;s<o.count;s++)e.push(s);t.setIndex(e),i=t.getIndex()}const o=i.count-2,a=[];if(e===Rt)for(s=1;s<=o;s++)a.push(i.getX(0)),a.push(i.getX(s)),a.push(i.getX(s+1));else for(s=0;s<o;s++)s%2==0?(a.push(i.getX(s)),a.push(i.getX(s+1)),a.push(i.getX(s+2))):(a.push(i.getX(s+2)),a.push(i.getX(s+1)),a.push(i.getX(s)));a.length;const n=t.clone();return n.setIndex(a),n.clearGroups(),n}return t}},$r={"T-Pose":[0,1],Walk:[3,27],Run:[33,57],Idle:[63,104],Sick:[259,434],Healed:[440,473],Idle2:[111,152],Idle3:[156,255],Jetpack:[482,511],Victory:[514,546],Gain:[552,584],Action:[591,642],Happy:[648,688],Sad:[694,735],Thinking:[742,782],Eloquant:[788,829],Fear:[836,876],Hello:[882,939],Dancing:[947,979],Seating:[984,1025],Towel:[1031,1072],Swimming:[1079,1107],JetpackAction:[1113,1142],Sport:[1149,1219]};const Kr=new p,Zr=new p,Jr=new d;new N;const tl=new O;class el extends xt{created(){const t=this.base,e=t.isNPC?t.uid:"Player";let s=0;for(let i=0,o=e.length;i<o;i++)s+=e.charCodeAt(i)*(1+i/30)+i*e.length+20*Math.cos(e.charCodeAt(i));if(t.seed=~~s+30*e.length,t.isNPC){const e=t.scene;e.npcs||(e.npcs=e.add(Xr)),t.npcController=e.npcs,t.npcController.addNPC(t)}this.timeToNextBlink=1200*Math.random()+800,this.timeToBlinkOeilD=0,this.timeToBlinkOeilR=0,this.isBlinking=!1,t.shoesOffset=0,this.options.extendProto?(this.extendProto("setOutfit",nl),this.extendProto("setAttributes",rl),this.extendProto("setGeometries",ol)):(t.setOutfit=At(nl,t,2),t.setAttributes=At(rl,t,1),t.setGeometries=At(ol,t,1),t.playEmote=At(sl,t,1)),t.isPlayer&&(v.store.updatePlayerOutfit.watch(this.base.setOutfit,this),v.store.updatePlayerAttributes.watch(this.base.setAttributes,this)),ol.call(t),nl.call(t),t.baseBoundingSphere=new V(new d(0,65,0),180),t.boundingSphere=t.baseBoundingSphere.clone(),t.base.updateMatrixWorld(),t.boundingSphere.applyMatrix4(t.base.matrixWorld),t.updateVisibility=il.bind(t)}async blink(){this.isBlinking=!0,await this.base.wait(100),this.isBlinking=!1,this.timeToNextBlink=1300*Math.random()+1e3,this.timeToBlinkOeilD=0}update(){if((this.base.isPlayerReady||!this.base.isPlayer)&&(!this.base.isNPC||this.base.shouldUpdateSkeleton())&&this.base.oeild&&this.base.charMesh){let t=this.base.oeild.position.x/100,e=this.base.oeilr.position.x/100,s=this.base.bouche.position.x/100;t=Math.round(t),e=Math.round(e),s=Math.round(s),0!==t||0!==e||this.isBlinking||(this.timeToBlinkOeilD+=this.base.webgl.time.stableDt),0===t&&0===e||(this.timeToBlinkOeilD=0),this.timeToBlinkOeilD>this.timeToNextBlink&&!this.isBlinking&&this.blink(),t=this.isBlinking?1:t,e=this.isBlinking?1:e,null!=this.base.overrideMouth&&(s=this.base.overrideMouth),this.base.charMesh.faceData.set(t,e,s,this.base.charMesh.faceType)}}destroyed(){const t=this.base;if(t.isNPC){const e=t.npcController;e&&e.removeNPC(t),t.npcController=null}t.charMesh.geometry.dispose(),t.charMesh.skeleton.dispose(),v.store.updatePlayerOutfit.unwatch(this.base.setOutfit,this),v.store.updatePlayerAttributes.unwatch(this.base.setAttributes,this)}}function sl(t){"Neutral"===t?this.setIdleAnimation():$r[t]?this.setAnimation(t,{loop:"Hello"==t||"Victory"==t||"Gain"==t?G:Et}):this.setIdleAnimation()}function il(){const t=this,e=t.charMesh,s=t.scene.getCurrentCamera().cam,i=t.base.position.distanceToSquared(s.position),o=t.scene.frustum;this.isMoving&&this.speed>.004&&this.base.updateWorldMatrix(!1,!1),t.boundingSphere.copy(t.baseBoundingSphere),t.boundingSphere.applyMatrix4(t.base.matrixWorld);const a=this.webgl.store.npcMinDistance.value,n=this.webgl.store.npcMaxDistance.value;e.opacity=st(1-gt(i,a,n),0,1),e.opacity<.001?e.visible=!1:e.visible=!0,e.visible&&(e.visible=o.intersectsSphere(t.boundingSphere)),t.interactionZone&&t.interactionZone.updateOpacity(e.opacity),this.webgl.state.prerendering&&(e.visible=!0)}function ol(){if(this.outfit={top:0,middle:0,bottom:0},this.armature=Qa(this.webgl.character.armature),this.base=this.armature,this.material=Xa.use(),this.charMesh=this.mesh=this.armature.children[1],this.charMesh.renderOrder=this.webgl.store.renderOrder.character,this.mesh.opacity=1,this.charMesh.rotation.x=this.base.rotation.x,this.base.rotation.x=0,this.charMesh.faceData=new u,this.mesh.material=this.material,this.mesh.castShadow=this.webgl.store.dynamicShadowSize.value>64,this.mesh.receiveShadow=!0,this.mesh.frustumCulled=!1,this.mesh.colorId=Math.floor(32*Math.random()),this.mesh.faceType=0,this.mesh.faceColor=new y(16761133),this.skeleton=this.mesh.skeleton,this.skeleton.update=al.bind(this.skeleton),this.skeleton.base=this,this.mesh.add(this.skeleton.bones[0]),this.oeild=this.addObject3D(this.webgl.character.oeild.clone()),this.oeilr=this.addObject3D(this.webgl.character.oeilr.clone()),this.bouche=this.addObject3D(this.webgl.character.bouche.clone()),Promise.resolve().then((()=>{this.destroyed||(this.oeild.removeFromParent(),this.oeilr.removeFromParent(),this.bouche.removeFromParent())})),!this.isNPC)for(let t=0;t<this.mesh.skeleton.bones.length;t++){const e=this.mesh.skeleton.bones[t];if("Chara_Low_RigGameSkeletonToes_R"==e.name||"Chara_Low_RigGameSkeletonToes_L"==e.name){this.mesh[e.name]=e;const t=new N;t.position.y-=30,this.mesh[e.name].add(t)}}this.mesh.scale.multiplyScalar(this.webgl.store.characterScale),this.props.transformMatrix&&(this.base.applyMatrix4(this.props.transformMatrix),this.keepUpright&&(this.base.updateMatrixWorld(),this.base.localToWorld(Jr.set(0,0,1)),Jr.y=this.base.position.y,this.base.quaternion.copy(tl),this.base.lookAt(Jr),this.base.updateMatrixWorld()))}function al(){if(this.base.isNPC){if(!this.base.charMesh)return;if(!this.base.shouldUpdateSkeleton())return}this.base.isNPC&&this.base.base.updateMatrixWorld(!0);const t=this.bones,e=this.boneInverses,s=this.boneMatrices,i=this.boneTexture;for(let o=0,a=t.length;o<a;o++){const i=t[o]?t[o].matrixWorld:Zr;Kr.multiplyMatrices(i,e[o]),Kr.toArray(s,16*o)}null!==i&&(i.needsUpdate=!0)}function nl(t,e){const{main:s,heads:i,bodies:o,bottoms:a}=v.character;if(this.mesh.geometry&&this.mesh.geometry.dispose(),!e)if(this.isNPC){const t=this.props.npcConfig,e=t.gradientID,s=t.face,i=t.faceColor,o=t.head,a=t.body,n=t.bottom;this.outfit.head=o,this.outfit.body=a,this.outfit.bottom=n,this.mesh.colorId=e,this.mesh.faceColor.set(i),this.mesh.visible=!0,this.mesh.faceType=s}else if(this.isPlayer){const t=this.webgl.savestate.game.player,e=this.webgl.app.$characters.colors,s=e[t.color]||e.character0,i=s.faceColor,o=s.gradientID,a=t.face,n=t.head,r=t.body,l=t.bottom;this.outfit.head=n,this.outfit.body=r,this.outfit.bottom=l,this.mesh.colorId=o,this.mesh.faceColor.set(i),this.mesh.visible=!0,this.mesh.faceType=a,this.onOutfitChanged&&this.onOutfitChanged()}const{head:n,body:r,bottom:l}=this.outfit,c=i[n],h=o[r],d=a[l];this.material.needsUpdate=!0;const u=[s];c&&u.push(c),h&&u.push(h),d&&u.push(d);const p=v.app.$items.bottom[l];this.shoesOffset=p&&p.shoesOffset||0,this.mesh.geometry=Qr.mergeBufferGeometries(u),"Player"===this.name&&(data.player.outfit.top=this.outfit.top,data.player.outfit.middle=this.outfit.middle,data.player.outfit.bottom=this.outfit.bottom)}function rl(){const t=v.savestate.game.player,e=v.app.$characters.colors,s=e[t.color]||e.character0,i=s.faceColor,o=s.gradientID,a=t.face;this.mesh.colorId=o,this.mesh.faceColor.set(i),this.mesh.visible=!0,this.mesh.faceType=a,this.onOutfitChanged&&this.onOutfitChanged()}async function ll(t){if(!(t=(t=>{try{return new URL(t)}catch(e){return null}})(t)))return;if(!(t.host.includes("youtu.be")||t.host.includes("youtube.com")))return;const e=t.searchParams.get("v")||t.pathname.split("/").pop();e&&(await function(t){const e=v.app.$stores;return e.currentFullscreenVideo=zt({id:t}),new Promise((t=>{const s=j((()=>e.currentFullscreenVideo),(e=>{e||(s(),t())}))}))}(e),await Y(500),await Ft())}const cl=new d,hl=new d,dl=new d,ul=new Set(["onStart","onCancel","onExit","onDone"]);class pl extends xt{created(){const t=this.base;t.dialogMethods={},t.registerDialogMethod=(e,s,i)=>{t.dialogMethods[e]=s.bind(i||t)},t.registerDialogMethod("WAIT",gl),t.registerDialogMethod("EMOTE",fl),t.registerDialogMethod("TELEPORT",bl),t.registerDialogMethod("OPENPHONE",ml),t.registerDialogMethod("VIDEO",ll),t.startDialog=(e,s={})=>{const i={};i.onStart=e=>{yl.call(t,e),s.onStart&&s.onStart(e)},i.onCancel=(e,i)=>{vl.call(t,e,i),s.onCancel&&s.onCancel(e,i)},i.onDone=(e,i)=>{wl.call(t,e,i),s.onDone&&s.onDone(e,i)},i.onExit=(e,i)=>{xl.call(t,e,i),s.onExit&&s.onExit(e,i)};for(let t in s)ul.has(t)||(i[t]=s[t]);v.app.$dialogs.startDialog(t,e,i)}}}async function ml(){v.app.$dialogs.exitDialog(!0),v.app.$webgl.store.frozenPlayerDelay=450,await gl(400),v.app.$router.push({name:"Phone"}),v.app.$stores.phone.tab.id="FintechDetails",v.app.$stores.phone.tab.props={fintech:this.args.fintech,isFromDialog:!0}}function fl(t){if(this.playEmote)return this.playEmote(t)}function gl(t){return Y(t)}function bl(t,e="Spawn"){"_GoBack_"===t?v.scenes.backToIsland({delay:400}):v.scenes.teleportTo(t,{point:e,delay:400})}function yl(t){this.onDialogStart&&this.onDialogStart(t);const e=this.scene.player.base.position,s=this.scene.playerCam,i=this.webgl.viewport.ratio.value,o=st(gt(i,.45,1.5),0,1),a=ft(3.1,3.9,o),n=cl.copy(e).sub(this.base.position).normalize();n.x*=a,n.y=2.15,n.z*=a;const r=hl.copy(this.base.position).add(n),l=dl.copy(this.base.position);l.y+=ft(1.62,1.6,o),v.store.inDialog.set(this.uid),this.isTalking=!0,this.webgl.audio.playSound("sfx_UI_Dialog_CameraMove_In"),s.setTarget({id:this.uid,lockPlayer:!0,position:r,lookAt:l,posEase:.2,lookAtEase:.2})}function vl(t,e){this.onDialogCancel&&this.onDialogCancel(t,e)}function wl(t,e){this.onDialogDone&&this.onDialogDone(t,e)}function xl(t,e){this.onDialogExit&&this.onDialogExit(t,e),this.scene.player.base.visible=!0,this.isTalking=!1,v.store.inDialog.value===this.uid&&v.store.inDialog.set(!1);const s=this.scene.playerCam;this.webgl.audio.playSound("sfx_UI_Dialog_CameraMove_Out"),s.removeTarget({id:this.uid,posEase:.08,lookAtEase:.1})}let Sl=null,_l=["Idle","Idle2","Idle3"],Pl=["Idle","Idle3"];class Ml extends xt{created(){Sl||(Sl=c());const t=this.base;t.timers=[],this.options.extendProto?(this.extendProto("fadeIn",Rl),this.extendProto("fadeOut",Ll),this.extendProto("crossFadeTo",kl),this.extendProto("setIdleAnimation",Ol),this.extendProto("forceIdle",Tl),this.extendProto("onAnimationFinished",Al),this.extendProto("setAnimation",Dl),this.extendProto("setAnimationFromSpeed",Il)):(t.fadeIn=At(Rl,t,3),t.fadeOut=At(Ll,t,3),t.crossFadeTo=At(kl,t,5),t.setIdleAnimation=At(Ol,t,5),t.forceIdle=At(Tl,t,5),t.setAnimation=At(Dl,t,5),t.onAnimationFinished=At(Al,t,5),t.setAnimationFromSpeed=At(Il,t,5)),Cl.call(t),Ol.call(t),t.animationMixer.addEventListener("finished",t.onAnimationFinished),t.speed=0,t.easedSpeed=0,t.lastDirection=new d,t.easedDirectionDelta=new d,t.currentAnimation=null,t.timeout=0,t.lastAnimation=null,t.frames=0,t.lastPos=(new d).copy(t.base.position),t.lastPosNeedsUpdate=!0}update(){const t=this.base,e=Sl.time.dt;if(!t.isPlayerReady&&t.isPlayer)return;t.isPlayer&&t.lastPosNeedsUpdate&&(t.lastPos.copy(t.base.position),t.lastPosNeedsUpdate=!1);let s=0;if(t.isPlayer||t.isMoving){const e=t.base.position,i=t.lastPos,o=t.firstUpdates>0;s=t.speed=e.equals(i)?0:e.distanceTo(i),!o&&t.canRun||(s=Math.min(s,.095)),t.easedSpeed=ft(t.easedSpeed,s,o?1:.1),i.copy(e)}if(t.isNPC&&!t.shouldUpdateSkeleton())return;t.animationMixer.update(e/1e3);let i=null;const o=t.mainEffect&&t.mainEffect.isFloating,a=t.canMove||t.isMoving;(t.isPlayer||t.isMoving)&&(t.timeout-=Sl.time.dt,t.timeout=st(t.timeout,0,300),i=a&&!o?t.setAnimationFromSpeed(s,t.easedSpeed):null);for(const h in t.animations){const s=t.animations[h];s&&s.weightTween&&s.weightTween.update(e);const o=i?0:1;s.scalarWeight=X(s.scalarWeight,o,.05,e,0);const a="JetpackAction"===h?1:1-t.jetpackAnim.weight;s.weight=s.currentWeight*s.scalarWeight*a}if(t.isPlayer||t.isMoving)for(const h in t.moveAnims){const s=t.moveAnims[h],a=h===i?1:0;s.scalarWeight=X(s.scalarWeight,a,.2,e,0);const n=o?0:1;s.weight=1*s.scalarWeight*n;s[t.moveAnims.Walk.weight<.01&&t.moveAnims.Run.weight<.01?"stop":"play"]()}let n=this.base.allAnims[this.base.allAnimsKeys[0]];for(let h=0;h<this.base.allAnimsKeys.length;h++){const t=this.base.allAnimsKeys[h],e=this.base.allAnims[t];e.weight>n.weight&&(n=e)}const r=n["Chara_Low_RigOeilD_ref.position"],l=n["Chara_Low_RigOeilR_ref.position"],c=n["Chara_Low_RigBouche_Ref.position"];if(r)for(let h=0;h<r.times.length;h++){if(!(r.times[h]<n.time)){this.base.oeild.position.x=r.values[3*h],this.base.oeilr.position.x=l.values[3*h],this.base.bouche.position.x=c.values[3*h];break}}}destroyed(){for(const t in this.base.animations){const e=this.base.animations[t];e&&e.weightTween&&e.weightTween.destroy()}this.base.animationMixer.removeEventListener("finished",this.base.onAnimationFinished)}}function Tl(t){this.forcedIdle=t,this.setIdleAnimation()}function Al(t){const e=t.action;e.onComplete&&e.onComplete(),e.onComplete=null,setTimeout((()=>{if(this.destroyed)return;const t=e===this.animation,s=e.loop===G;t&&s&&this.setIdleAnimation()}),100)}function Cl(){this.animationMixer=new _t(this.base),this.animations={},this.moveAnims={},this.allAnims={};for(const t in $r){const e=30,[s,i]=$r[t],o=Bt.subclip(this.webgl.character.animations[0],t,s,i,e),a=this.animationMixer.clipAction(o);a.setLoop(Et),a._fps=e,a._startFrame=s,a._endFrame=i,a.clampWhenFinished=!0,a.animationID=t,a.weight=0,a.currentWeight=0,a.scalarWeight=0,"Run"==t&&(a.timeScale=.9792),"Walk"==t&&(a.timeScale=.9792),"Victory"==t&&(a.timeScale=.8);for(let t=0;t<a._clip.tracks.length;t++){const e=a._clip.tracks[t];"Chara_Low_RigOeilD_ref.position"!==e.name&&"Chara_Low_RigOeilR_ref.position"!==e.name&&"Chara_Low_RigBouche_Ref.position"!==e.name||(a[e.name]=e)}this.allAnims[t]=a,"Walk"!==t&&"Run"!==t?"Jetpack"!==t?this.animations[t]=a:this.jetpackAnim=a:this.moveAnims[t]=a}this.allAnimsKeys=Object.keys(this.allAnims)}function Dl(t,e={}){const s=!!e.instant;let i=e.time||0;const o=void 0!==e.loop?e.loop:Et,a=this.animations[t];if(a){if(s){if(!a)return;return this.animation=a,this.crossFadeTo(a,0),a.setLoop(o),void setTimeout((()=>{this.destroyed||(a.time=i)}),0)}return e.timeScale&&(a.timeScale=e.timeScale),new Promise((t=>{this.animation=a,a.setLoop(o),a.onComplete=t,this.crossFadeTo(a,300),setTimeout((()=>{this.destroyed||(a.time=i)}),0)}))}}function Il(t,e){let s="Run";return t<.005?s=null:e<=.095&&(s="Walk"),"Run"===this.lastAnimation&&"Walk"===s&&(this.timeout=100),this.lastAnimation=s,this.currentAnimation=null===s?s:this.timeout?"Run":s,this.currentAnimation}function kl(t,e){for(const s in this.animations){const i=this.animations[s]===t;0===e&&t.weightTween&&t.weightTween.destroy(),i?(t.reset(),this.animation=t,this.fadeIn(t,e)):this.fadeOut(this.animations[s],e)}}function Ol(){if(this.isUserPose)return;const t=this.isMoving?Pl:_l,e=this.forcedIdle||t[this.isPlayer?2:Math.floor(Math.random()*t.length)];this.setAnimation(e)}function Rl(t,e,s=(()=>{})){if(t.reset(),t.play(),0===e)return t.currentWeight=1;t.weightTween&&t.weightTween.destroy(),t.weightTween=Dt({target:t,property:"currentWeight",duration:e,from:t.currentWeight,to:1,easing:"inOutQuart",onComplete:s})}function Ll(t,e=0,s=(()=>{})){if(0===e)return t.currentWeight=0;t.weightTween&&t.weightTween.destroy(),t.weightTween=Dt({target:t,property:"currentWeight",duration:e,from:t.currentWeight,to:0,easing:"inOutQuart",onComplete:s})}class El extends wt{constructor(t){super(t)}afterInit(){super.afterInit(),this.position=new d(-12,13,-10),this.base.position.copy(this.position),this.base.lookAt(new d(0,1,0)),this.scalar=1.4,this.scalarEased=this.scalar}update(){const t=d.get().copy(this.position);this.scalarEased=ft(this.scalarEased,this.scalar,.03),t.multiplyScalar(this.scalarEased),this.base.position.copy(t),t.release()}beforeDestroy(){this.destroying=!0,super.beforeDestroy()}}const Fl=new Float32Array([-2,0,0,-2,2,2]),zl=new P;zl.setAttribute("position",new M(Fl,2));var Bl=["precision highp float;","attribute vec2 position;","varying vec2 vUv;","void main() {","vUv = position;","gl_Position =  vec4(2.0 * position - 1.0, 0.,  1);","}"].join("");class Ul extends m{init(){const t=new Ut(Object.assign({},{vertexShader:Bl,fragmentShader:"\n\tprecision highp float;\n\n\tuniform float pixelRatio;\n\tuniform vec2 res;\n\t#include <transition_mask_pars>\n\n\tconst vec3 overlay = vec3(1.);\n\n\tvoid main() {\n\t\tvec3 color = BASE_TRANSITION_COLOR * (1. - (road + sea + games))\n\t\t\t+ ROAD_GROUND_COLOR * road\n\t\t\t+ (WATER_TOP_COLOR + 0.2) * sea * 0.95\n\t\t\t+ GAMES_TRANSITION_COLOR * games;\n\n\t\t#include <transition_mask>\n\n\t\tcolor = mix(overlay, color, circle);\n\t\t// float alpha = mix(1. - smoothstep(0., 0.75, maskRadius), 1., circle);\n\t\tfloat alpha = mix(1. - maskRadius, 1., circle);\n\n\t\tgl_FragColor = vec4(color, alpha);\n\n\t}\n",depthWrite:!1,uniforms:l(r(r({},rs.transitions),rs.global),{pixelRatio:rs.pixelRatio}),defines:r({},ms())}));t.transparent=!0,this.base=new S(zl,t),this.base.frustumCulled=!1,this.base.renderOrder=this.webgl.store.renderOrder.transitions.plane,this.base.matrixAutoUpdate=!1}}var jl=w("#define PHONG\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <luma>\n#include <blend_modes>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\n#include <transition_mask_pars>\nuniform float pixelRatio;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform float time;uniform vec2 res;uniform sampler2D matcaps;varying vec2 vData;uniform float waterProgress;const vec3 waterColor=WATER_COLOR;const vec3 waterTopColor=WATER_TOP_COLOR;varying vec2 vGradient;uniform sampler2D noise;uniform float effectMult;void main(){\n#include <transition_mask>\nif(circle<1.)discard;vec4 diffuseColor=vec4(1.);vec3 diffuseTexel=texture2D(map,vUv*vec2(0.5,1.)).rgb;diffuseColor.rgb*=diffuseTexel;\n#include <normal_fragment_begin>\nvec3 rimColor=(BASE_TRANSITION_COLOR*(1.-(road+sea+games))+ROAD_GROUND_COLOR*road+(WATER_TOP_COLOR+0.2)*sea+GAMES_TRANSITION_COLOR*games)*0.5;float rimLightPower=1.6;float rimLightStrength=.49;float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);vec3 rim=vec3(rightLight*rimLightStrength)*rimColor;diffuseColor.rgb+=vec3(rightLight*rimLightStrength)*rimColor;rimLightPower=1.;rimLightStrength=0.2;rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=diffuseColor.rgb*vec3(rightLight*rimLightStrength)*rimColor;ReflectedLight reflectedLight=ReflectedLight(vec3(.0),vec3(.0),vec3(.0),vec3(.0));vec3 color=diffuseColor.rgb;if(vData.r>0.1875){vec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 matcapUV=vec2(dot(x,normal),dot(y,normal))*0.499+0.5;matcapUV.y=1.-matcapUV.y;matcapUV.x=matcapUV.x*0.5+0.5;vec3 matcap=texture2D(map,matcapUV).rgb;vec3 lMatcapColor=matcap*smoothstep(0.,0.1,(luma(reflectedLight.directDiffuse)));vec3 shadeMatcapColor=mix(lMatcapColor,matcap,0.4+0.4*smoothstep(0.,0.4,luma(matcap)))+reflectedLight.directSpecular;color=mix(color,shadeMatcapColor,0.30);color+=(smoothstep(0.99,0.995,cos(vGradient.x))+smoothstep(0.8,0.81,cos(vGradient.x-1.1))+smoothstep(0.93,0.94,cos(vGradient.x+3.)))*vGradient.y*2.1*smoothstep(1.,0.7,matcap.r)*step(0.32,vData.r)*effectMult;}color=color+color*vNormal.y*0.2;vec4 outColor=vec4(color,1.);gl_FragColor=outColor;\n#include <water_depth_frag>\ngl_FragColor=mix(outColor,gl_FragColor,sea);}","fragmentShader");var Nl=w("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <world_pos_pars>\nuniform float time;uniform sampler2D data;varying vec2 vData;varying vec4 vBigShadowDirectionalCoords;uniform mat4 bigShadowMatrix;varying vec2 vGradient;uniform float effectMult;uniform float road;void main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\nvec3 dataTexel=texture2D(data,vUv).rgb;vData=dataTexel.rg;transformed.y+=smoothstep(.1,1.,position.y)*.17*(sin(time*18.)+1.)*0.5*road*step(0.2,position.y);\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <world_pos>\nvec4 worldPosition=vWorldPos;vec3 UP=vec3(0.,1.,0.);vec3 N=normal;vec3 T=normalize(cross(UP,normal));vec3 B=cross(normal,UP);mat3 tsb=mat3(normalize(T),normalize(B),normalize(N));vec4 t=vec4(10.,10.,10.,1.)*viewMatrix;vec3 absCam=abs(cameraPosition);float m=0.25;vGradient.x=(position*tsb).r+worldPosition.y+length(worldPosition.xyz-cameraPosition)*-0.2*m+(t.x+t.y+t.z)*0.2*m+(max(absCam.x,max(absCam.y,absCam.z)))*0.3*m;vGradient.y=smoothstep(40.,5.,length(worldPosition.xyz-cameraPosition))*0.06*vNormal.z;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\nvec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=worldPosition+vec4(bigShadowWorldNormal*0.05,0);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <fog_vertex>\n}","vertexShader");let Vl=null;class Wl extends x{constructor(){super();const t=v.resources.textures,e=this.uniforms=l(r(r(r(r(r({},I.merge([k.common,k.specularmap,k.fog,k.lights])),rs.water),rs.bigShadow),rs.global),rs.transitions),{time:{value:0},pixelRatio:rs.pixelRatio,effectMult:{value:1},map:{value:t.assetsGradients},data:{value:t.assetsData},matcaps:{value:t.matcaps},noise:{value:t.noise},noLight:{value:0},diffuse:{value:new y(16777215)},emissive:{value:new y(0)},specular:{value:new y(1118481)},shininess:{value:10}});this.defines=r({},ms()),this.map=e.map.value,jl.use(this),Nl.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0,this.isTransitionAssetMaterial=!0,this.transparent=!0,v.hooks.beforeUpdate.watch(this.udpate,this)}pauseEffects(t){this.pausedEffectID=t,this.uniforms.effectMult.value=0}resumeEffects(t){t&&t!==this.pausedEffectID||(this.pausedEffectID=null)}udpate(){if(!this.pausedEffectID){const t=this.uniforms.effectMult;t.value=U(t.value,1,.07,.001)}}}Wl.use=function(){return Vl=Vl||new Wl,Vl},Wl.unuse=function(){};let ql=null;class Hl extends Ut{constructor(){super(),this.uniforms=l(r(r({},rs.transitions),rs.global),{pixelRatio:rs.pixelRatio,opacity:{value:1}}),this.vertexShader="\nprecision highp float;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nattribute vec3 position;\nvoid main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",this.fragmentShader="\n\tprecision highp float;\n\t#include <transition_mask_pars>\n\tuniform float opacity;\n\tuniform float pixelRatio;\n\tuniform vec2 res;\n\tvoid main() {\n\t\t#include <transition_mask>\n\t\tif(circle < 1.) discard;\n\t\tgl_FragColor = vec4(0., 0., 0., opacity);\n\t}\n",this.transparent=!0,this.type="ShaderMaterial",this.isRawShaderMaterial=!0}}Hl.use=function(){return ql=ql||new Hl,ql},Hl.unuse=function(){};class Gl extends m{init(){const t=this.webgl.resources.assets.Taxi.geometry;this.base=new S(t,Wl.use()),this.base.position.y=1,this.base.renderOrder=this.webgl.store.renderOrder.transitions.plane+3,this.shadow=new S(this.webgl.resources.geometries.plane,Hl.use()),this.shadow.renderOrder=this.webgl.store.renderOrder.transitions.plane+2,this.shadow.rotateX(Math.PI/-2),this.shadow.scale.set(2.44,3.5,1),this.shadow.position.z-=.3,this.shadow.position.y+=.01,this.base.add(this.shadow)}update(){if(!this.base.visible)return;const t=this.scene.time;this.base.material.uniforms.time.value=t,this.shadow.material.uniforms.opacity.value=.16,this.base.position.x=1*Math.sin(1.57+t),this.base.rotation.y=.3*Math.sin(t)}}class Yl extends m{init(){this.base=new N,this.base.rotation.y=Math.PI/2;const t=this.webgl.resources.assets.BoatYellow.geometry;this.boat=new S(t,Wl.use()),this.boat.position.y=-.1,this.boat.renderOrder=this.webgl.store.renderOrder.transitions.plane+2,this.qt=new O,this.base.add(this.boat)}update(){if(!this.base.visible)return;const t=this.scene.time;this.boat.material.uniforms.time.value=t,this.base.position.x=1*Math.sin(1.57+t),this.base.position.y=.1*Math.cos(1*t+20)+.1,this.boat.quaternion.copy(this.qt),this.boat.rotation.x=.06*Math.sin(t+3.14),this.boat.rotateY(.2*Math.sin(t)),this.boat.rotateX(.03*Math.sin(1*t)),this.boat.rotateZ(.06*Math.cos(2*t+2)+.01)}}const Xl=(t,e)=>Math.floor(Math.random()*(e-t))+t;function Ql(t){return t[Xl(0,t.length)]}const $l=new h,Kl=[new h(1,0),new h(0,1),new h(-1,0),new h(0,-1)],Zl=new O;class Jl extends m{init(){this.baseJoystick=this.webgl.resources.assets.JoystickRaw.mesh.clone(),this.baseJoystick.traverse((t=>{t.isMesh&&(t.material=Wl.use(),t.renderOrder=this.webgl.store.renderOrder.transitions.plane+3)})),this.joystick="Base001"==this.baseJoystick.children[1].name?this.baseJoystick.children[0]:this.baseJoystick.children[1],this.baseJoystick.scale.set(1.5,1.5,1.5),this.baseJoystick.position.y=-.3,this.target=Kl[0],this.time=1e3;const t={initial:0,tension:.08,friction:.14};this.springX=ut(t),this.springY=ut(t),this.neutral=!0,this.shadow=new S(new jt(1.5,32).rotateX(-Math.PI/2),Hl.use()),this.shadow.position.y-=.7,this.shadow.renderOrder=this.webgl.store.renderOrder.transitions.plane+2,this.base=new N,this.base.add(this.baseJoystick),this.base.add(this.shadow)}update(){if(!this.base.visible)return;this.time+=this.scene.fixedDt,this.time>(this.neutral?.2:.5)&&(this.time=0,this.neutral=!this.neutral,this.neutral?(this.springX.setTarget($l.x),this.springY.setTarget($l.y),this.springX.setFriction(.25),this.springY.setFriction(.25),this.webgl.audio.playSound("sfx_phone_scroll_tic",{volume:.8,playbackRate:T.randomFloat(.9,1.1)})):(this.target=function(t,e){const s=t.length;if(s<2)return t[0];const i=t.indexOf(e),o=s-1;return-1===i?Ql(t):0===i?t[Xl(1,s)]:i===o?t[Xl(0,o)]:Math.random()<i/o?t[Xl(0,i)]:t[Xl(i+1,s)]}(Kl,this.target),this.springX.setTarget(this.target.x),this.springY.setTarget(this.target.y),this.springX.setFriction(.15),this.springY.setFriction(.15),this.webgl.audio.playSound("sfx_phone_scroll_tic",{volume:.8,playbackRate:T.randomFloat(.9,1.1)})));const t=1e3*this.scene.fixedDt;this.springX.update(t),this.springY.update(t);const e=this.springX.value,s=this.springY.value;this.joystick.rotation.x=.3*e,this.joystick.rotation.z=.3*s,this.baseJoystick.quaternion.copy(Zl),this.baseJoystick.rotation.x=.05*e,this.baseJoystick.rotation.z=.05*s,this.baseJoystick.position.y=.3*Math.cos(3*this.scene.time),this.baseJoystick.rotateY(.2*this.scene.time),this.shadow.scale.setScalar(.9+-.075*Math.cos(3*this.scene.time)),this.shadow.material.uniforms.opacity.value=.09+-.04*Math.cos(3*this.scene.time)}}var tc=w("varying vec2 vUv;uniform sampler2D noise;uniform vec2 res;uniform float time;uniform sampler2D clouds;const float lineWidth=.01;const float middleLineHalfWidth=.004;const float lineBottomBegin=.3;const float lineTopBegin=.68;const float lineMiddleBegin=.5;\n#include <transition_mask_pars>\nuniform float pixelRatio;const vec3 roadBackground=ROAD_GROUND_COLOR;const vec3 waterBackground=(WATER_TOP_COLOR+0.2)*0.95;void main(){\n#include <transition_mask>\nif(circle<1.)discard;vec2 centerLen=vUv-vec2(0.5);float dist=1.-dot(centerLen,centerLen)*4.;float lBottomBegin=lineBottomBegin+sin(vUv.y*3.14+time)*.1;float lTopBegin=lineTopBegin+sin(vUv.y*3.14+time)*.1;float lMiddleBegine=lineMiddleBegin+sin(vUv.y*3.14+time)*.1;float bottom=step(vUv.x,lTopBegin+lineWidth)*(1.-step(vUv.x,lTopBegin));float top=step(vUv.x,lBottomBegin+lineWidth)*(1.-step(vUv.x,lBottomBegin));float middle=step(vUv.x,lMiddleBegine+middleLineHalfWidth)*(1.-step(vUv.x,lMiddleBegine-middleLineHalfWidth));middle=mix(middle,0.,step(fract(vUv.y*3.+time*2.),.5));vec3 lineColor=roadBackground*.8;vec3 roadColor=mix(roadBackground,lineColor,bottom);roadColor=mix(roadColor,lineColor,top);roadColor=mix(roadColor,lineColor,middle);vec3 waterColor=vec3(0.);if(sea>0.){float tex=texture2D(noise,vUv*0.7+time*vec2(0.01,0.2)).r;float tex2=texture2D(noise,vUv*0.7+(time-100.)*vec2(0.012,0.18)).r;float tex3=texture2D(noise,vUv*0.8+(time+20.)*vec2(0.012,0.25)).r;float seaMiddle=lineMiddleBegin+sin(vUv.y*3.14+time)*.1;float amp=smoothstep(0.5,0.,vUv.y)*0.1;float wave=cos(vUv.y*70.+time*22.)*(-0.004+amp*0.4);float waves=step(vUv.x-0.0+wave-amp,seaMiddle)*(1.-step(vUv.x+0.1+wave+amp,seaMiddle))*step(vUv.y,0.5);float nowave=1.-waves;float ws=smoothstep(0.45,.5,tex*tex2);float ws2=smoothstep(0.45,.5,tex*tex3);waterColor=mix(waterBackground,vec3(1.),ws2*1.*nowave);waterColor=mix(waterColor,vec3(1.),ws*-0.8*nowave);waterColor+=waves*smoothstep(0.07,0.6,vUv.y)*0.8;}float fade=clamp(0.,1.,sin(vUv.y*3.14)*2.);fade=mix(fade,smoothstep(.5,.6,pow(1.-distance(vUv,vec2(.5)),1.)),sea);vec3 background=mix(roadBackground,waterBackground,sea);vec3 color=mix(roadColor,waterColor,sea);color=mix(background,color,fade);gl_FragColor=vec4(color,1.);}","fragmentShader");var ec=w("varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let sc=null;class ic extends x{constructor(){super({depthTest:!0,depthWrite:!1,defines:r({},ms())}),this.uniforms=r(r({noise:{value:v.resources.textures.noise},time:{value:0},pixelRatio:rs.pixelRatio},rs.transitions),rs.global),this.transparent=!0,tc.use(this),ec.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}ic.use=function(){return sc=sc||new ic,sc},ic.unuse=function(){};class oc extends m{init(){this.base=new S(this.webgl.resources.geometries.plane,ic.use()),this.base.scale.set(12,12,12),this.base.position.y+=1,this.base.frustumCulled=!1,this.base.rotation.x=-Math.PI/2,this.base.renderOrder=this.webgl.store.renderOrder.transitions.plane+1}update(){this.base.visible&&(this.base.material.uniforms.time.value=this.scene.time)}}class ac extends it{init(){this.camera=this.add(El),this.bg=this.add(Ul),this.ground=this.add(oc),this.taxi=this.add(Gl),this.boat=this.add(Yl),this.joystick=this.add(Jl),this.tween=null,this.fixedDt=.02,this.bind("reset"),this.reset(),this.soundLoop=null}get mixins(){return["timers"]}prerender(){this.bg.base.visible=!0,this.taxi.base.visible=!0,this.boat.base.visible=!0,this.joystick.base.visible=!0,this.triggerRender(!0),this.reset()}triggerRender(t){(t||this.webgl.store.isTransitionActive.value)&&(this.webgl.threeRenderer.clearDepth(),super.triggerRender())}triggerUpdate(){this.webgl.store.isTransitionActive.value&&super.triggerUpdate()}async loaderIn(t="road"){return this.tween&&this.tween.isOut&&(this.tween=this.tween.destroy()),this.tween&&!this.tween.destroyed||(this.clearSoundLoop(),this.clearTimers(),this.reset(),this.bg.base.visible=!0,rs.transitions[t]&&(rs.transitions[t].value=1,"road"===t?(this.taxi.base.visible=!0,this.ground.base.visible=!0,this.webgl.audio.playSound("sfx_travel_taxi_klaxon",{delay:500}),Y(500).then((()=>{this.tween.isOut||(this.soundLoop=this.webgl.audio.playSound("sfx_travel_taxi_loop",{volume:.7,fadein:500,fadeout:500}))}))):"sea"===t?(this.boat.base.visible=!0,this.ground.base.visible=!0,Y(500).then((()=>{this.tween.isOut||(this.soundLoop=this.webgl.audio.playSound("sfx_minigame_boat_loop",{volume:.6,fadein:500,fadeout:500}))}))):"games"===t&&(this.joystick.base.visible=!0)),t&&(this.webgl.app.$stores.isSpinnerVisible=!0),this.webgl.audio.playSound("sfx_UI_transition_open",{delay:400}),this.tween=Dt({target:rs.transitions.maskRadius,property:"value",duration:1100,from:1,to:0,selfDestruct:!0,easing:"inOutQuart"}),this.tween.isIn=!0,this.minTimeLoader=t?this.wait(2e3):this.wait(1e3),this.camera.scalarEased=.35,this.camera.scalar=1),this.tween.finished}async loaderOut(t=!0){return this.tween&&this.tween.isIn&&(this.tween=this.tween.destroy()),this.tween&&!this.tween.destroyed||(rs.transitions.maskRadius.value=0,await this.minTimeLoader,t&&(this.webgl.app.$stores.isSpinnerVisible=!1),this.clearSoundLoop(),this.webgl.audio.playSound("sfx_UI_transition_close",{delay:200}),this.camera.scalar=1.5,this.tween=Dt({target:rs.transitions.maskRadius,property:"value",duration:1100,from:0,to:1,easing:"inOutQuart",selfDestruct:!0,onComplete:this.reset}),this.tween.isOut=!0),this.tween.finished}clearSoundLoop(){this.soundLoop&&this.soundLoop.stop(),this.soundLoop=null}reset(){this.clearSoundLoop(),this.boat.base.visible=!1,this.taxi.base.visible=!1,this.bg.base.visible=!1,this.ground.base.visible=!1,this.joystick.base.visible=!1,this.time=0,rs.transitions.sea.value=0,rs.transitions.road.value=0,rs.transitions.games.value=0}update(){this.time+=this.fixedDt,this.tween&&this.tween.update(1e3*this.fixedDt)}}class nc extends xt{created(){const t={},e=(t=>{let e=new Set,s=t;do{Object.getOwnPropertyNames(s).map((t=>e.add(t)))}while(s=Object.getPrototypeOf(s));return[...e.keys()].filter((e=>"function"==typeof t[e]))})(this.base);for(let s=0,i=e.length;s<i;s++){const i=e[s];if("function"!=typeof this.base[i])continue;if(!i.startsWith("update"))continue;const o=i.slice(6),a=At(this.base[i],this.base);t[o]=a}this.base.stateMachine=new zr({states:t})}update(){this.base.stateMachine.update()}destroyed(){this.base.stateMachine.destroy()}}const rc=()=>{},lc=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((t,e)=>(t[e]=1,t)),{}),cc="ARROWUP",hc="ARROWDOWN",dc="ARROWLEFT",uc="ARROWRIGHT",pc=[null,cc,uc,hc,dc],mc=[cc,cc,hc,hc,dc,uc,dc,uc,"B","A"],fc={};let gc=0,bc=!1,yc=rc,vc=!1;let wc,xc,Sc,_c=null;function Pc(){Sc||(!function(){if(wc)return;const t={color:"black",background:"white",boxShadow:"0px 0px 0px 0px #fff, 0px 0px 0px 0px #fff",transform:"translateY(0px)"},e={color:"white",background:"transparent",boxShadow:"0px 3px 0px 0px #fff, 0px 6px 0px 0px #fff",transform:"translateY(-6px)"},s={width:"85px",height:"85px",appearance:"none",color:"white",border:"4px solid white",borderRadius:"50%",fontSize:"30px",fontWeight:"bold",margin:"0px 15px",fontFamily:"sans-serif",transition:"transform 230ms ease-out, box-shadow 230ms ease-out, background 100ms"};wc=document.createElement("div"),Object.assign(wc.style,{position:"fixed",zIndex:99999,top:0,left:0,right:0,bottom:0,display:"flex",flexFlow:"row nowrap",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.7)"});const i=[];function o(o,a){const n=document.createElement("button");Object.assign(n.style,s,e),wc.appendChild(n),n.textContent=a||o,n.dataset.bypassTouch=!0,n.onclick=e=>{e.preventDefault(),Object.assign(n.style,t),Ac(o)},i.push(n)}o("A","A"),o("B","B"),xc=()=>{i.forEach((t=>Object.assign(t.style,e)))}}(),Sc=!0,xc(),document.body.appendChild(wc))}function Mc(){Sc&&(Sc=!1,document.body.removeChild(wc),xc())}function Tc(){for(const t in fc)fc[t]=!1;gc=0}function Ac(t){if(t!==mc[gc])return gc=0,void Mc();gc++,gc>=mc.length?(gc=0,Sc&&setTimeout(Mc,600),yc()):!vc||"A"!==mc[gc]&&"B"!==mc[gc]?Mc():Pc()}function Cc(t){if(lc[t.tagName])return;vc=!1;const e=t.key.toUpperCase();fc[e]||Ac(e),fc[e]=!0}function Dc(t){const e=t.key.toUpperCase();fc[e]=!1}function Ic(t){vc=!0,Ac(pc[t])}var kc,Oc={start:function(t){!function(t,e="log",s="console"){window[s][e]("%c ▲  ▲  ▼  ▼  ◀  ▶  ◀  ▶  %cB  %cA ","font-size: 16px; background: black; color: #aaa;","font-size: 16px; background: black; color: #fd605b;","font-size: 16px; background: black; color: #32c850;")}(),bc||(Tc(),t.swipeSignal&&(_c=t.swipeSignal),_c&&_c.watch(Ic),window.addEventListener("keydown",Cc),window.addEventListener("keyup",Dc),document.addEventListener("visibilitychange",Tc),bc=!0)},stop:function(){bc&&(Tc(),Mc(),_c&&_c.unwatch(Ic),window.removeEventListener("keydown",Cc),window.removeEventListener("keyup",Dc),document.removeEventListener("visibilitychange",Tc),bc=!1)},reset:Tc,get callback(){return yc},set callback(t){yc=t||rc}};function Rc(t){const e=t.app.$preloader.createTask({weight:10});let s;function i(){t.threeRenderer;t.scenes.render(),t.app.$device.type.vr||s.triggerRender()}function o(e){const s=t.renderer,i=t.store;let o=t.app.$device.type.mobile,a=t.app.$device.type.phone;const n=o?.7:1;switch(e){case 5:s.setMaxPixelCount(a?"1080p":o?"1440p":"3k"),s.setMaxPixelRatio(2),s.setMinPixelRatio(1.2),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(o?1024:2048),i.chunksCastShadow.set(!o),i.npcMinDistance.set(o?4500:5400),i.npcMaxDistance.set(o?6300:6900),i.grass.radius=1,t.app.$stores.confettisCount=100*n;break;case 4:s.setMaxPixelCount(a?"1080p":"1440p"),s.setMaxPixelRatio(o?1.6:1.75),s.setMinPixelRatio(o?1:1.1),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(1024),i.chunksCastShadow.set(!o),i.npcMinDistance.set(o?4500:5400),i.npcMaxDistance.set(o?6300:6900),i.grass.radius=.8,t.app.$stores.confettisCount=80*n;break;case 3:s.setMaxPixelCount(a?"1080p":"1440p"),s.setMaxPixelRatio(o?1.25:1.5),s.setMinPixelRatio(1),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(512),i.chunksCastShadow.set(!1),i.npcMinDistance.set(o?3500:4500),i.npcMaxDistance.set(o?5500:6300),i.grass.radius=.6,t.app.$stores.confettisCount=70*n;break;case 2:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(o?1:1.15),s.setMinPixelRatio(1),i.windVisible.set(!1),i.waterVisible.set(!0),i.dynamicShadowSize.set(256),i.chunksCastShadow.set(!1),i.npcMinDistance.set(o?2700:3500),i.npcMaxDistance.set(o?4300:5500),i.grass.radius=.3,t.app.$stores.confettisCount=50*n;break;case 1:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(1),s.setMinPixelRatio(1),i.windVisible.set(!1),i.waterVisible.set(!0),i.dynamicShadowSize.set(256),i.chunksCastShadow.set(!1),i.npcMinDistance.set(2700),i.npcMaxDistance.set(4300),i.grass.radius=.2,t.app.$stores.confettisCount=25*n;break;default:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(.8),s.setMinPixelRatio(.8),i.windVisible.set(!1),i.waterVisible.set(!1),i.dynamicShadowSize.set(128),i.chunksCastShadow.set(!1),i.npcMinDistance.set(900),i.npcMaxDistance.set(1500),i.grass.radius=0,t.app.$stores.confettisCount=0*n}}!function(){for(const t in Yn){const e=t.split("/").pop().slice(0,-".glsl".length);Tt[e]=Yn[t].default}}(),Object.assign(t,{init:async function(){const e=t.app.$device.gpu.string;e&&e.includes("apple a10")?t.quality.limitQuality(3):e&&e.includes("apple a9")&&t.quality.limitQuality(2);t.savestate=t.app.$savestate;const s=t.renderer;s.options.alpha=!1;const i="safari"===t.app.$device.browser;s.forceWebGL1=!!i,s.init(),s.instance.setClearColor(0,1),s.instance.shadowMap.enabled=!0,s.instance.shadowMap.type=Nt,s.instance.autoClear=!1,t.time.clampTo60Fps=!0,rs.global.res=t.renderer.drawingBufferSize,t.store.chunksCastShadow.watchImmediate((t=>{rs.bigShadow.bigShadowDynamicChunks.value=t?1:0})),t.renderer.pixelRatio.watchImmediate((t=>{rs.pixelRatio.value=1/t})),t.noopRenderTarget=new Vt(1,1)},preload:async function(){await t.resources.prepare(),await t.resources.preload(),t.particles.init(),t.input.init(),await t.scenes.init(),e.finish()},start:async function(){let e;function a(){t.viewport.frame(),i()}t.renderer.resize(),t.time.init(),t.audio.init(),t.quality.current.watchImmediate(o),s=t.transitionScene=new ac,s.triggerInit(),t.store.renderStopped.watchImmediate((e=>e?t.time.stop():t.time.start())),j(t.app.$viewport,(()=>{t.store.renderStopped.value&&(clearTimeout(e),e=setTimeout(a,200))})),t.store.isStarted.set(!0);let n=!1;const r=j((()=>t.savestate.game.vars.isIntroCompleted),(e=>{e&&(Ft((()=>r())),n||(n=!0,Oc.start({swipeSignal:t.input.touch.swipe}),Oc.callback=()=>{"EasterEgg"===t.scenes.currentSceneID.value?t.scenes.backToIsland():t.scenes.teleportTo("EasterEgg")}))}),{immediate:!0})},update:function(){t.scenes.update(),t.particles.update(),s.triggerUpdate()},render:i,prerender:function(){s.prerender()}}),t.registerMixin("timers",$n,"reactivity",tr,"actorDynamicProps",or,"actorInteractive",Pr,"actorPropsTransition",Hr,"character",el,"dialog",pl,"characterAnimations",Ml,"rafStateMachine",nc)}(kc=N).prototype.updateMatrixWorld=function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].manualMatrixUpdate&&!t||e[s].updateMatrixWorld(t)},kc.prototype.updateWorldMatrix=function(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].manualMatrixUpdate||t[e].updateWorldMatrix(!1,!0)}};const Lc=Number.MAX_SAFE_INTEGER;const Ec={"720p":921600,"1080p":2073600,"1440p":3686400,"2k":3686400,"3k":4665600,"4k":8294400,"5k":14745600,"8k":33177600};function Fc({renderer:t,format:e,depth:s,stencil:i,width:o,height:a}){const n=h.get();o&&a?n.set(o,a):t.getDrawingBufferSize(n);const r=new Vt(n.x,n.y,{minFilter:Jt,magFilter:Jt,format:e||te,depthBuffer:!!s,stencilBuffer:null!==i?i:!!s});return n.release(),r.texture.generateMipmaps=!1,r}new ee(-1,1,1,-1,0,1).parent=!0;const zc=()=>{};function Bc(t,e){return new Promise((s=>{const i=new Image;i.onload=()=>{const o={node:i,url:t};e.onLoad&&e.onLoad(o),se.add(t,o),s(o)},i.decoding="async",i.setAttribute("decoding","async"),i.src=t}))}Bc.loader={name:"image",extensions:[".jpg",".png",".webp",".avif",".gif",".jpeg"],function:Bc};function Uc(){let t={};return{get:function(e){return t[e]},add:function(e,s){t[e]=s},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const jc={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Nc{constructor(t){this.parser=t,this.name=jc.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let s=0,i=e.length;s<i;s++){const i=e[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&t._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(t){const e=this.parser,s="light:"+t;let i=e.cache.get(s);if(i)return i;const o=e.json,a=((o.extensions&&o.extensions[this.name]||{}).lights||[])[t];let n;const r=new y(16777215);void 0!==a.color&&r.fromArray(a.color);const l=void 0!==a.range?a.range:0;switch(a.type){case"directional":n=new b(r),n.target.position.set(0,0,-1),n.add(n.target);break;case"point":n=new re(r),n.distance=l;break;case"spot":n=new ne(r),n.distance=l,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,n.angle=a.spot.outerConeAngle,n.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,n.target.position.set(0,0,-1),n.add(n.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return n.position.set(0,0,0),n.decay=2,void 0!==a.intensity&&(n.intensity=a.intensity),n.name=e.createUniqueName(a.name||"light_"+t),i=Promise.resolve(n),e.cache.add(s,i),i}createNodeAttachment(t){const e=this,s=this.parser,i=s.json.nodes[t],o=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===o?null:this._loadLight(o).then((function(t){return s._getNodeRef(e.cache,o,t)}))}}class Vc{constructor(){this.name=jc.KHR_MATERIALS_UNLIT}getMaterialType(){return Mt}extendParams(t,e,s){const i=[];t.color=new y(1,1,1),t.opacity=1;const o=e.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const e=o.baseColorFactor;t.color.fromArray(e),t.opacity=e[3]}void 0!==o.baseColorTexture&&i.push(s.assignTexture(t,"map",o.baseColorTexture))}return Promise.all(i)}}class Wc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser,i=s.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];if(void 0!==a.clearcoatFactor&&(e.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&o.push(s.assignTexture(e,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(e.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&o.push(s.assignTexture(e,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(o.push(s.assignTexture(e,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const t=a.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new h(t,t)}return Promise.all(o)}}class qc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser,i=s.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[];e.sheenColor=new y(0,0,0),e.sheenRoughness=0,e.sheen=1;const a=i.extensions[this.name];return void 0!==a.sheenColorFactor&&e.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(e.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&o.push(s.assignTexture(e,"sheenColorMap",a.sheenColorTexture)),void 0!==a.sheenRoughnessTexture&&o.push(s.assignTexture(e,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(o)}}class Hc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser,i=s.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];return void 0!==a.transmissionFactor&&(e.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&o.push(s.assignTexture(e,"transmissionMap",a.transmissionTexture)),Promise.all(o)}}class Gc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser,i=s.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];e.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&o.push(s.assignTexture(e,"thicknessMap",a.thicknessTexture)),e.attenuationDistance=a.attenuationDistance||0;const n=a.attenuationColor||[1,1,1];return e.attenuationColor=new y(n[0],n[1],n[2]),Promise.all(o)}}class Yc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser.json.materials[t];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return e.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class Xc{constructor(t){this.parser=t,this.name=jc.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?le:null}extendMaterialParams(t,e){const s=this.parser,i=s.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];e.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&o.push(s.assignTexture(e,"specularIntensityMap",a.specularTexture));const n=a.specularColorFactor||[1,1,1];return e.specularColor=new y(n[0],n[1],n[2]),void 0!==a.specularColorTexture&&o.push(s.assignTexture(e,"specularColorMap",a.specularColorTexture).then((function(t){t.encoding=ce}))),Promise.all(o)}}class Qc{constructor(t){this.parser=t,this.name=jc.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,s=e.json,i=s.textures[t];if(!i.extensions||!i.extensions[this.name])return null;const o=i.extensions[this.name],a=e.options.ktx2Loader;if(!a){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,o.source,a)}}class $c{constructor(t){this.parser=t,this.name=jc.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,s=this.parser,i=s.json,o=i.textures[t];if(!o.extensions||!o.extensions[e])return null;const a=o.extensions[e],n=i.images[a.source];let r=s.textureLoader;if(n.uri){const t=s.options.manager.getHandler(n.uri);null!==t&&(r=t)}return this.detectSupport().then((function(o){if(o)return s.loadTextureImage(t,n,r);if(i.extensionsRequired&&i.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class Kc{constructor(t){this.name=jc.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,s=e.bufferViews[t];if(s.extensions&&s.extensions[this.name]){const t=s.extensions[this.name],i=this.parser.getDependency("buffer",t.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,o.ready]).then((function(e){const s=t.byteOffset||0,i=t.byteLength||0,a=t.count,n=t.byteStride,r=new ArrayBuffer(a*n),l=new Uint8Array(e[0],s,i);return o.decodeGltfBuffer(new Uint8Array(r),a,n,l,t.mode,t.filter),r}))}return null}}const Zc="glTF",Jc=1313821514,th=5130562;class eh{constructor(t){this.name=jc.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12);if(this.header={magic:oe.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Zc)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,i=new DataView(t,12);let o=0;for(;o<s;){const e=i.getUint32(o,!0);o+=4;const s=i.getUint32(o,!0);if(o+=4,s===Jc){const s=new Uint8Array(t,12+o,e);this.content=oe.decodeText(s)}else if(s===th){const s=12+o;this.body=t.slice(s,s+e)}o+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class sh{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=jc.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const s=this.json,i=this.dracoLoader,o=t.extensions[this.name].bufferView,a=t.extensions[this.name].attributes,n={},r={},l={};for(const c in a){const t=xh[c]||c.toLowerCase();n[t]=a[c]}for(const c in t.attributes){const e=xh[c]||c.toLowerCase();if(void 0!==a[c]){const i=s.accessors[t.attributes[c]],o=bh[i.componentType];l[e]=o,r[e]=!0===i.normalized}}return e.getDependency("bufferView",o).then((function(t){return new Promise((function(e){i.decodeDracoFile(t,(function(t){for(const e in t.attributes){const s=t.attributes[e],i=r[e];void 0!==i&&(s.normalized=i)}e(t)}),n,l)}))}))}}class ih{constructor(){this.name=jc.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return e.texCoord,void 0===e.offset&&void 0===e.rotation&&void 0===e.scale||(t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class oh extends ve{constructor(t){super(),this.isGLTFSpecularGlossinessMaterial=!0;const e=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),n={specular:{value:(new y).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=n,this.onBeforeCompile=function(t){for(const e in n)t.uniforms[e]=n[e];t.fragmentShader=t.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",e).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return n.specular.value},set:function(t){n.specular.value=t}},specularMap:{get:function(){return n.specularMap.value},set:function(t){n.specularMap.value=t,t?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return n.glossiness.value},set:function(t){n.glossiness.value=t}},glossinessMap:{get:function(){return n.glossinessMap.value},set:function(t){n.glossinessMap.value=t,t?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}copy(t){return super.copy(t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class ah{constructor(){this.name=jc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return oh}extendParams(t,e,s){const i=e.extensions[this.name];t.color=new y(1,1,1),t.opacity=1;const o=[];if(Array.isArray(i.diffuseFactor)){const e=i.diffuseFactor;t.color.fromArray(e),t.opacity=e[3]}if(void 0!==i.diffuseTexture&&o.push(s.assignTexture(t,"map",i.diffuseTexture)),t.emissive=new y(0,0,0),t.glossiness=void 0!==i.glossinessFactor?i.glossinessFactor:1,t.specular=new y(1,1,1),Array.isArray(i.specularFactor)&&t.specular.fromArray(i.specularFactor),void 0!==i.specularGlossinessTexture){const e=i.specularGlossinessTexture;o.push(s.assignTexture(t,"glossinessMap",e)),o.push(s.assignTexture(t,"specularMap",e))}return Promise.all(o)}createMaterial(t){const e=new oh(t);return e.fog=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,e.normalMapType=he,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e}}class nh{constructor(){this.name=jc.KHR_MESH_QUANTIZATION}}class rh extends de{constructor(t,e,s,i){super(t,e,s,i)}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,i=this.valueSize,o=t*i*3+i;for(let a=0;a!==i;a++)e[a]=s[o+a];return e}}rh.prototype.beforeStart_=rh.prototype.copySampleValue_,rh.prototype.afterEnd_=rh.prototype.copySampleValue_,rh.prototype.interpolate_=function(t,e,s,i){const o=this.resultBuffer,a=this.sampleValues,n=this.valueSize,r=2*n,l=3*n,c=i-e,h=(s-e)/c,d=h*h,u=d*h,p=t*l,m=p-l,f=-2*u+3*d,g=u-d,b=1-f,y=g-d+h;for(let v=0;v!==n;v++){const t=a[m+v+n],e=a[m+v+r]*c,s=a[p+v+n],i=a[p+v]*c;o[v]=b*t+y*e+f*s+g*i}return o};const lh=new O;class ch extends rh{interpolate_(t,e,s,i){const o=super.interpolate_(t,e,s,i);return lh.fromArray(o).normalize().toArray(o),o}}const hh=0,dh=1,uh=2,ph=3,mh=4,fh=5,gh=6,bh={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},yh={9728:Le,9729:Jt,9984:Ee,9985:Fe,9986:ze,9987:me},vh={33071:Be,33648:Ue,10497:fe},wh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},xh={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Sh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},_h={CUBICSPLINE:void 0,LINEAR:Ie,STEP:je},Ph="OPAQUE",Mh="MASK",Th="BLEND";function Ah(t,e,s){for(const i in s.extensions)void 0===t[i]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=s.extensions[i])}function Ch(t,e){void 0!==e.extras&&"object"==typeof e.extras&&Object.assign(t.userData,e.extras)}function Dh(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let s=0,i=e.weights.length;s<i;s++)t.morphTargetInfluences[s]=e.weights[s];if(e.extras&&Array.isArray(e.extras.targetNames)){const s=e.extras.targetNames;if(t.morphTargetInfluences.length===s.length){t.morphTargetDictionary={};for(let e=0,i=s.length;e<i;e++)t.morphTargetDictionary[s[e]]=e}}}function Ih(t){const e=t.extensions&&t.extensions[jc.KHR_DRACO_MESH_COMPRESSION];let s;return s=e?"draco:"+e.bufferView+":"+e.indices+":"+kh(e.attributes):t.indices+":"+kh(t.attributes)+":"+t.mode,s}function kh(t){let e="";const s=Object.keys(t).sort();for(let i=0,o=s.length;i<o;i++)e+=s[i]+":"+t[s[i]]+";";return e}function Oh(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Rh{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new Uc,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox|^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new ue(this.options.manager):this.textureLoader=new pe(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ae(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const s=this,i=this.json,o=this.extensions;this.cache.removeAll(),this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(e){const a={scene:e[0][i.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:i.asset,parser:s,userData:{}};Ah(o,a,i),Ch(a,i),Promise.all(s._invokeAll((function(t){return t.afterRoot&&t.afterRoot(a)}))).then((function(){t(a)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],s=this.json.meshes||[];for(let i=0,o=e.length;i<o;i++){const s=e[i].joints;for(let e=0,i=s.length;e<i;e++)t[s[e]].isBone=!0}for(let i=0,o=t.length;i<o;i++){const e=t[i];void 0!==e.mesh&&(this._addNodeRef(this.meshCache,e.mesh),void 0!==e.skin&&(s[e.mesh].isSkinnedMesh=!0)),void 0!==e.camera&&this._addNodeRef(this.cameraCache,e.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,s){if(t.refs[e]<=1)return s;const i=s.clone(),o=(t,e)=>{const s=this.associations.get(t);null!=s&&this.associations.set(e,s);for(const[i,a]of t.children.entries())o(a,e.children[i])};return o(s,i),i.name+="_instance_"+t.uses[e]++,i}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let s=0;s<e.length;s++){const i=t(e[s]);if(i)return i}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const s=[];for(let i=0;i<e.length;i++){const o=t(e[i]);o&&s.push(o)}return s}getDependency(t,e){const s=t+":"+e;let i=this.cache.get(s);if(!i){switch(t){case"scene":i=this.loadScene(e);break;case"node":i=this.loadNode(e);break;case"mesh":i=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":i=this.loadAccessor(e);break;case"bufferView":i=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":i=this.loadBuffer(e);break;case"material":i=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":i=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":i=this.loadSkin(e);break;case"animation":i=this.loadAnimation(e);break;case"camera":i=this.loadCamera(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(s,i)}return i}getDependencies(t){let e=this.cache.get(t);if(!e){const s=this,i=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(i.map((function(e,i){return s.getDependency(t,i)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],s=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[jc.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(t,o){s.load(oe.resolveURL(e.uri,i.path),t,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const s=e.byteLength||0,i=e.byteOffset||0;return t.slice(i,i+s)}))}loadAccessor(t){const e=this,s=this.json,i=this.json.accessors[t];if(void 0===i.bufferView&&void 0===i.sparse)return Promise.resolve(null);const o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then((function(t){const o=t[0],a=wh[i.type],n=bh[i.componentType],r=n.BYTES_PER_ELEMENT,l=r*a,c=i.byteOffset||0,h=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;let u,p;if(h&&h!==l){const t=Math.floor(c/h),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+t+":"+i.count;let l=e.cache.get(s);l||(u=new n(o,t*h,i.count*h/r),l=new It(u,h/r),e.cache.add(s,l)),p=new kt(l,a,c%h/r,d)}else u=null===o?new n(i.count*a):new n(o,c,i.count*a),p=new M(u,a,d);if(void 0!==i.sparse){const e=wh.SCALAR,s=bh[i.sparse.indices.componentType],r=i.sparse.indices.byteOffset||0,l=i.sparse.values.byteOffset||0,c=new s(t[1],r,i.sparse.count*e),h=new n(t[2],l,i.sparse.count*a);null!==o&&(p=new M(p.array.slice(),p.itemSize,p.normalized));for(let t=0,i=c.length;t<i;t++){const e=c[t];if(p.setX(e,h[t*a]),a>=2&&p.setY(e,h[t*a+1]),a>=3&&p.setZ(e,h[t*a+2]),a>=4&&p.setW(e,h[t*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(t){const e=this.json,s=this.options,i=e.textures[t].source,o=e.images[i];let a=this.textureLoader;if(o.uri){const t=s.manager.getHandler(o.uri);null!==t&&(a=t)}return this.loadTextureImage(t,i,a)}loadTextureImage(t,e,s){const i=this,o=this.json,a=o.textures[t],n=o.images[e],r=(n.uri||n.bufferView)+":"+a.sampler;if(this.textureCache[r])return this.textureCache[r];const l=this.loadImageSource(e,s).then((function(e){e.flipY=!1,a.name&&(e.name=a.name);const s=(o.samplers||{})[a.sampler]||{};return e.magFilter=yh[s.magFilter]||Jt,e.minFilter=yh[s.minFilter]||me,e.wrapS=vh[s.wrapS]||fe,e.wrapT=vh[s.wrapT]||fe,i.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[r]=l,l}loadImageSource(t,e){const s=this,i=this.json,o=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((function(t){return t.clone()})).catch((function(t){throw t}));const a=i.images[t],n=self.URL||self.webkitURL;let r=a.uri||"",l=!1;if(void 0!==a.bufferView)r=s.getDependency("bufferView",a.bufferView).then((function(t){l=!0;const e=new Blob([t],{type:a.mimeType});return r=n.createObjectURL(e),r}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const c=Promise.resolve(r).then((function(t){return new Promise((function(s,i){let a=s;!0===e.isImageBitmapLoader&&(a=function(t){const e=new B(t);e.needsUpdate=!0,s(e)}),e.load(oe.resolveURL(t,o.path),a,void 0,i)}))})).then((function(t){var e;return!0===l&&n.revokeObjectURL(r),t.userData.mimeType=a.mimeType||((e=a.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw t}));return this.sourceCache[t]=c,c}assignTexture(t,e,s){const i=this;return this.getDependency("texture",s.index).then((function(o){if(void 0!==s.texCoord&&0!=s.texCoord&&("aoMap"!==e||s.texCoord),i.extensions[jc.KHR_TEXTURE_TRANSFORM]){const t=void 0!==s.extensions?s.extensions[jc.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=i.associations.get(o);o=i.extensions[jc.KHR_TEXTURE_TRANSFORM].extendTexture(o,t),i.associations.set(o,e)}}return t[e]=o,o}))}assignFinalMaterial(t){const e=t.geometry;let s=t.material;const i=void 0===e.attributes.tangent,o=void 0!==e.attributes.color,a=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+s.uuid;let e=this.cache.get(t);e||(e=new ge,be.prototype.copy.call(e,s),e.color.copy(s.color),e.map=s.map,e.sizeAttenuation=!1,this.cache.add(t,e)),s=e}else if(t.isLine){const t="LineBasicMaterial:"+s.uuid;let e=this.cache.get(t);e||(e=new ye,be.prototype.copy.call(e,s),e.color.copy(s.color),this.cache.add(t,e)),s=e}if(i||o||a){let t="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(t+="specular-glossiness:"),i&&(t+="derivative-tangents:"),o&&(t+="vertex-colors:"),a&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=s.clone(),o&&(e.vertexColors=!0),a&&(e.flatShading=!0),i&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(s))),s=e}s.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&e.setAttribute("uv2",e.attributes.uv),t.material=s}getMaterialType(){return ve}loadMaterial(t){const e=this,s=this.json,i=this.extensions,o=s.materials[t];let a;const n={},r=o.extensions||{},l=[];if(r[jc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const t=i[jc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=t.getMaterialType(),l.push(t.extendParams(n,o,e))}else if(r[jc.KHR_MATERIALS_UNLIT]){const t=i[jc.KHR_MATERIALS_UNLIT];a=t.getMaterialType(),l.push(t.extendParams(n,o,e))}else{const s=o.pbrMetallicRoughness||{};if(n.color=new y(1,1,1),n.opacity=1,Array.isArray(s.baseColorFactor)){const t=s.baseColorFactor;n.color.fromArray(t),n.opacity=t[3]}void 0!==s.baseColorTexture&&l.push(e.assignTexture(n,"map",s.baseColorTexture)),n.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,n.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(l.push(e.assignTexture(n,"metalnessMap",s.metallicRoughnessTexture)),l.push(e.assignTexture(n,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),l.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,n)}))))}!0===o.doubleSided&&(n.side=C);const c=o.alphaMode||Ph;if(c===Th?(n.transparent=!0,n.depthWrite=!1):(n.transparent=!1,c===Mh&&(n.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&a!==Mt&&(l.push(e.assignTexture(n,"normalMap",o.normalTexture)),n.normalScale=new h(1,1),void 0!==o.normalTexture.scale)){const t=o.normalTexture.scale;n.normalScale.set(t,t)}return void 0!==o.occlusionTexture&&a!==Mt&&(l.push(e.assignTexture(n,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(n.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&a!==Mt&&(n.emissive=(new y).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&a!==Mt&&l.push(e.assignTexture(n,"emissiveMap",o.emissiveTexture)),Promise.all(l).then((function(){let s;return s=a===oh?i[jc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(n):new a(n),o.name&&(s.name=o.name),s.map&&(s.map.encoding=ce),s.emissiveMap&&(s.emissiveMap.encoding=ce),s.sheenColorMap&&(s.sheenColorMap.encoding=ce),s.specularColorMap&&(s.specularColorMap.encoding=ce),s.specularMap&&(s.specularMap.encoding=ce),Ch(s,o),e.associations.set(s,{materials:t}),o.extensions&&Ah(i,s,o),s}))}createUniqueName(t){const e=we.sanitizeNodeName(t||"");let s=e;for(let i=1;this.nodeNamesUsed[s];++i)s=e+"_"+i;return this.nodeNamesUsed[s]=!0,s}loadGeometries(t){const e=this,s=this.extensions,i=this.primitiveCache;function o(t){return s[jc.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(s){return Eh(s,t,e)}))}const a=[];for(let n=0,r=t.length;n<r;n++){const s=t[n],r=Ih(s),l=i[r];if(l)a.push(l.promise);else{let t;t=s.extensions&&s.extensions[jc.KHR_DRACO_MESH_COMPRESSION]?o(s):Eh(new P,s,e),i[r]={primitive:s,promise:t},a.push(t)}}return Promise.all(a)}loadMesh(t){const e=this,s=this.json,i=this.extensions,o=s.meshes[t],a=o.primitives,n=[];for(let l=0,c=a.length;l<c;l++){const t=void 0===a[l].material?(void 0===(r=this.cache).DefaultMaterial&&(r.DefaultMaterial=new ve({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Ne})),r.DefaultMaterial):this.getDependency("material",a[l].material);n.push(t)}var r;return n.push(e.loadGeometries(a)),Promise.all(n).then((function(s){const n=s.slice(0,s.length-1),r=s[s.length-1],l=[];for(let h=0,d=r.length;h<d;h++){const s=r[h],c=a[h];let d;const u=n[h];if(c.mode===mh||c.mode===fh||c.mode===gh||void 0===c.mode)d=!0===o.isSkinnedMesh?new xe(s,u):new S(s,u),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),c.mode===fh?d.geometry=Fh(d.geometry,Lt):c.mode===gh&&(d.geometry=Fh(d.geometry,Rt));else if(c.mode===dh)d=new Se(s,u);else if(c.mode===ph)d=new _e(s,u);else if(c.mode===uh)d=new Pe(s,u);else{if(c.mode!==hh)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);d=new Me(s,u)}Object.keys(d.geometry.morphAttributes).length>0&&Dh(d,o),d.name=e.createUniqueName(o.name||"mesh_"+t),Ch(d,o),c.extensions&&Ah(i,d,c),e.assignFinalMaterial(d),l.push(d)}for(let i=0,o=l.length;i<o;i++)e.associations.set(l[i],{meshes:t,primitives:i});if(1===l.length)return l[0];const c=new f;e.associations.set(c,{meshes:t});for(let t=0,e=l.length;t<e;t++)c.add(l[t]);return c}))}loadCamera(t){let e;const s=this.json.cameras[t],i=s[s.type];if(i)return"perspective"===s.type?e=new dt(Te(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(e=new ee(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(e.name=this.createUniqueName(s.name)),Ch(e,s),Promise.resolve(e)}loadSkin(t){const e=this.json.skins[t],s={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",e.inverseBindMatrices).then((function(t){return s.inverseBindMatrices=t,s}))}loadAnimation(t){const e=this.json.animations[t],s=[],i=[],o=[],a=[],n=[];for(let r=0,l=e.channels.length;r<l;r++){const t=e.channels[r],l=e.samplers[t.sampler],c=t.target,h=void 0!==c.node?c.node:c.id,d=void 0!==e.parameters?e.parameters[l.input]:l.input,u=void 0!==e.parameters?e.parameters[l.output]:l.output;s.push(this.getDependency("node",h)),i.push(this.getDependency("accessor",d)),o.push(this.getDependency("accessor",u)),a.push(l),n.push(c)}return Promise.all([Promise.all(s),Promise.all(i),Promise.all(o),Promise.all(a),Promise.all(n)]).then((function(s){const i=s[0],o=s[1],a=s[2],n=s[3],r=s[4],l=[];for(let t=0,e=i.length;t<e;t++){const e=i[t],s=o[t],c=a[t],h=n[t],d=r[t];if(void 0===e)continue;let u;switch(e.updateMatrix(),e.matrixAutoUpdate=!0,Sh[d.path]){case Sh.weights:u=De;break;case Sh.rotation:u=Ce;break;default:u=Ae}const p=e.name?e.name:e.uuid,m=void 0!==h.interpolation?_h[h.interpolation]:Ie,f=[];Sh[d.path]===Sh.weights?e.traverse((function(t){t.morphTargetInfluences&&f.push(t.name?t.name:t.uuid)})):f.push(p);let g=c.array;if(c.normalized){const t=Oh(g.constructor),e=new Float32Array(g.length);for(let s=0,i=g.length;s<i;s++)e[s]=g[s]*t;g=e}for(let t=0,i=f.length;t<i;t++){const e=new u(f[t]+"."+Sh[d.path],s.array,g,m);"CUBICSPLINE"===h.interpolation&&(e.createInterpolant=function(t){return new(this instanceof Ce?ch:rh)(this.times,this.values,this.getValueSize()/3,t)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(e)}}const c=e.name?e.name:"animation_"+t;return new ke(c,void 0,l)}))}createNodeMesh(t){const e=this.json,s=this,i=e.nodes[t];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then((function(t){const e=s._getNodeRef(s.meshCache,i.mesh,t);return void 0!==i.weights&&e.traverse((function(t){if(t.isMesh)for(let e=0,s=i.weights.length;e<s;e++)t.morphTargetInfluences[e]=i.weights[e]})),e}))}loadNode(t){const e=this.json,s=this.extensions,i=this,o=e.nodes[t],a=o.name?i.createUniqueName(o.name):"";return function(){const e=[],s=i._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return s&&e.push(s),void 0!==o.camera&&e.push(i.getDependency("camera",o.camera).then((function(t){return i._getNodeRef(i.cameraCache,o.camera,t)}))),i._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){e.push(t)})),Promise.all(e)}().then((function(e){let n;if(n=!0===o.isBone?new Oe:e.length>1?new f:1===e.length?e[0]:new N,n!==e[0])for(let t=0,s=e.length;t<s;t++)n.add(e[t]);if(o.name&&(n.userData.name=o.name,n.name=a),Ch(n,o),o.extensions&&Ah(s,n,o),void 0!==o.matrix){const t=new p;t.fromArray(o.matrix),n.applyMatrix4(t)}else void 0!==o.translation&&n.position.fromArray(o.translation),void 0!==o.rotation&&n.quaternion.fromArray(o.rotation),void 0!==o.scale&&n.scale.fromArray(o.scale);return i.associations.has(n)||i.associations.set(n,{}),i.associations.get(n).nodes=t,n}))}loadScene(t){const e=this.json,s=this.extensions,i=this.json.scenes[t],o=this,a=new f;i.name&&(a.name=o.createUniqueName(i.name)),Ch(a,i),i.extensions&&Ah(s,a,i);const n=i.nodes||[],r=[];for(let l=0,c=n.length;l<c;l++)r.push(Lh(n[l],a,e,o));return Promise.all(r).then((function(){return o.associations=(t=>{const e=new Map;for(const[s,i]of o.associations)(s instanceof be||s instanceof B)&&e.set(s,i);return t.traverse((t=>{const s=o.associations.get(t);null!=s&&e.set(t,s)})),e})(a),a}))}}function Lh(t,e,s,i){const o=s.nodes[t];return i.getDependency("node",t).then((function(t){if(void 0===o.skin)return t;let e;return i.getDependency("skin",o.skin).then((function(t){e=t;const s=[];for(let o=0,a=e.joints.length;o<a;o++)s.push(i.getDependency("node",e.joints[o]));return Promise.all(s)})).then((function(s){return t.traverse((function(t){if(!t.isMesh)return;const i=[],o=[];for(let a=0,n=s.length;a<n;a++){const t=s[a];if(t){i.push(t);const s=new p;void 0!==e.inverseBindMatrices&&s.fromArray(e.inverseBindMatrices.array,16*a),o.push(s)}}t.bind(new Re(i,o),t.matrixWorld)})),t}))})).then((function(t){e.add(t);const a=[];if(o.children){const e=o.children;for(let o=0,n=e.length;o<n;o++){const n=e[o];a.push(Lh(n,t,s,i))}}return Promise.all(a)}))}function Eh(t,e,s){const i=e.attributes,o=[];function a(e,i){return s.getDependency("accessor",e).then((function(e){t.setAttribute(i,e)}))}for(const n in i){const e=xh[n]||n.toLowerCase();e in t.attributes||o.push(a(i[n],e))}if(void 0!==e.indices&&!t.index){const i=s.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));o.push(i)}return Ch(t,e),function(t,e,s){const i=e.attributes,o=new ot;if(void 0===i.POSITION)return;{const t=s.json.accessors[i.POSITION],e=t.min,a=t.max;if(void 0===e||void 0===a)return;if(o.set(new d(e[0],e[1],e[2]),new d(a[0],a[1],a[2])),t.normalized){const e=Oh(bh[t.componentType]);o.min.multiplyScalar(e),o.max.multiplyScalar(e)}}const a=e.targets;if(void 0!==a){const t=new d,e=new d;for(let i=0,o=a.length;i<o;i++){const o=a[i];if(void 0!==o.POSITION){const i=s.json.accessors[o.POSITION],a=i.min,n=i.max;if(void 0!==a&&void 0!==n){if(e.setX(Math.max(Math.abs(a[0]),Math.abs(n[0]))),e.setY(Math.max(Math.abs(a[1]),Math.abs(n[1]))),e.setZ(Math.max(Math.abs(a[2]),Math.abs(n[2]))),i.normalized){const t=Oh(bh[i.componentType]);e.multiplyScalar(t)}t.max(e)}}}o.expandByVector(t)}t.boundingBox=o;const n=new V;o.getCenter(n.center),n.radius=o.min.distanceTo(o.max)/2,t.boundingSphere=n}(t,e,s),Promise.all(o).then((function(){return void 0!==e.targets?function(t,e,s){let i=!1,o=!1,a=!1;for(let c=0,h=e.length;c<h;c++){const t=e[c];if(void 0!==t.POSITION&&(i=!0),void 0!==t.NORMAL&&(o=!0),void 0!==t.COLOR_0&&(a=!0),i&&o&&a)break}if(!i&&!o&&!a)return Promise.resolve(t);const n=[],r=[],l=[];for(let c=0,h=e.length;c<h;c++){const h=e[c];if(i){const e=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):t.attributes.position;n.push(e)}if(o){const e=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):t.attributes.normal;r.push(e)}if(a){const e=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):t.attributes.color;l.push(e)}}return Promise.all([Promise.all(n),Promise.all(r),Promise.all(l)]).then((function(e){const s=e[0],n=e[1],r=e[2];return i&&(t.morphAttributes.position=s),o&&(t.morphAttributes.normal=n),a&&(t.morphAttributes.color=r),t.morphTargetsRelative=!0,t}))}(t,e.targets,s):t}))}function Fh(t,e){let s=t.getIndex();if(null===s){const e=[],i=t.getAttribute("position");if(void 0===i)return t;for(let t=0;t<i.count;t++)e.push(t);t.setIndex(e),s=t.getIndex()}const i=s.count-2,o=[];if(e===Rt)for(let n=1;n<=i;n++)o.push(s.getX(0)),o.push(s.getX(n)),o.push(s.getX(n+1));else for(let n=0;n<i;n++)n%2==0?(o.push(s.getX(n)),o.push(s.getX(n+1)),o.push(s.getX(n+2))):(o.push(s.getX(n+2)),o.push(s.getX(n+1)),o.push(s.getX(n)));o.length;const a=t.clone();return a.setIndex(o),a}const zh=new WeakMap;function Bh(){let t,e;function s(t,e,s,i,o,a){const n=a.num_components(),r=s.num_points()*n,l=r*o.BYTES_PER_ELEMENT,c=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,o),h=t._malloc(l);e.GetAttributeDataArrayForAllPoints(s,a,c,l,h);const d=new o(t.HEAPF32.buffer,h,r).slice();return t._free(h),{name:i,array:d,itemSize:n}}onmessage=function(i){const o=i.data;switch(o.type){case"init":t=o.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const i=o.buffer,a=o.taskConfig;e.then((t=>{const e=t.draco,n=new e.Decoder,r=new e.DecoderBuffer;r.Init(new Int8Array(i),i.byteLength);try{const t=function(t,e,i,o){const a=o.attributeIDs,n=o.attributeTypes;let r,l;const c=e.GetEncodedGeometryType(i);if(c===t.TRIANGULAR_MESH)r=new t.Mesh,l=e.DecodeBufferToMesh(i,r);else{if(c!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");r=new t.PointCloud,l=e.DecodeBufferToPointCloud(i,r)}if(!l.ok()||0===r.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const h={index:null,attributes:[]};for(const d in a){const i=self[n[d]];let l,c;if(o.useUniqueIDs)c=a[d],l=e.GetAttributeByUniqueId(r,c);else{if(c=e.GetAttributeId(r,t[a[d]]),-1===c)continue;l=e.GetAttribute(r,c)}h.attributes.push(s(t,e,r,d,i,l))}c===t.TRIANGULAR_MESH&&(h.index=function(t,e,s){const i=3*s.num_faces(),o=4*i,a=t._malloc(o);e.GetTrianglesUInt32Array(s,o,a);const n=new Uint32Array(t.HEAPF32.buffer,a,i).slice();return t._free(a),{array:n,itemSize:1}}(t,e,r));return t.destroy(r),h}(e,n,r,a),i=t.attributes.map((t=>t.array.buffer));t.index&&i.push(t.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:t},i)}catch(l){self.postMessage({type:"error",id:o.id,error:l.message})}finally{e.destroy(r),e.destroy(n)}}))}}}const Uh=new Ve,jh=new class extends ie{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,s,i){const o=new ae(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(t=>{const s={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,s).then(e).catch(i)}),s,i)}decodeDracoFile(t,e,s,i){const o={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s};this.decodeGeometry(t,o).then(e)}decodeGeometry(t,e){for(const r in e.attributeTypes){const t=e.attributeTypes[r];void 0!==t.BYTES_PER_ELEMENT&&(e.attributeTypes[r]=t.name)}const s=JSON.stringify(e);if(zh.has(t)){const e=zh.get(t);if(e.key===s)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const o=this.workerNextTaskID++,a=t.byteLength,n=this._getWorker(o,a).then((s=>(i=s,new Promise(((s,a)=>{i._callbacks[o]={resolve:s,reject:a},i.postMessage({type:"decode",id:o,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return n.catch((()=>!0)).then((()=>{i&&o&&this._releaseTask(i,o)})),zh.set(t,{key:s,promise:n}),n}_createGeometry(t){const e=new P;t.index&&e.setIndex(new M(t.index.array,1));for(let s=0;s<t.attributes.length;s++){const i=t.attributes[s],o=i.name,a=i.array,n=i.itemSize;e.setAttribute(o,new M(a,n))}return e}_loadLibrary(t,e){const s=new ae(this.manager);return s.setPath(this.decoderPath),s.setResponseType(e),s.setWithCredentials(this.withCredentials),new Promise(((e,i)=>{s.load(t,e,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{const s=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const i=Bh.toString(),o=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([o]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const s=e.data;switch(s.type){case"decode":t._callbacks[s.id].resolve(s);break;case"error":t._callbacks[s.id].reject(s)}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[t]=e,s._taskLoad+=e,s}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}};jh.setDecoderPath("./vendors/draco/"),jh.preload(),jh.setWorkerLimit(4);const Nh=new class extends ie{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new Wc(t)})),this.register((function(t){return new Qc(t)})),this.register((function(t){return new $c(t)})),this.register((function(t){return new qc(t)})),this.register((function(t){return new Hc(t)})),this.register((function(t){return new Gc(t)})),this.register((function(t){return new Yc(t)})),this.register((function(t){return new Xc(t)})),this.register((function(t){return new Nc(t)})),this.register((function(t){return new Kc(t)}))}load(t,e,s,i){const o=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:oe.extractUrlBase(t),this.manager.itemStart(t);const n=function(e){i&&i(e),o.manager.itemError(t),o.manager.itemEnd(t)},r=new ae(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(t,(function(s){try{o.parse(s,a,(function(s){e(s),o.manager.itemEnd(t)}),n)}catch(i){n(i)}}),s,n)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,s,i){let o;const a={},n={};if("string"==typeof t)o=t;else{if(oe.decodeText(new Uint8Array(t,0,4))===Zc){try{a[jc.KHR_BINARY_GLTF]=new eh(t)}catch(c){return void(i&&i(c))}o=a[jc.KHR_BINARY_GLTF].content}else o=oe.decodeText(new Uint8Array(t))}const r=JSON.parse(o);if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Rh(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const t=this.pluginCallbacks[h](l);n[t.name]=t,a[t.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const t=r.extensionsUsed[h],e=r.extensionsRequired||[];switch(t){case jc.KHR_MATERIALS_UNLIT:a[t]=new Vc;break;case jc.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[t]=new ah;break;case jc.KHR_DRACO_MESH_COMPRESSION:a[t]=new sh(r,this.dracoLoader);break;case jc.KHR_TEXTURE_TRANSFORM:a[t]=new ih;break;case jc.KHR_MESH_QUANTIZATION:a[t]=new nh;break;default:e.indexOf(t)>=0&&n[t]}}l.setExtensions(a),l.setPlugins(n),l.parse(s,i)}parseAsync(t,e){const s=this;return new Promise((function(i,o){s.parse(t,e,i,o)}))}};async function Vh(t,e={}){const s=c().resources.supercache,i=await s.get(t+".scene.json");if(i&&!e.character&&!e.noCache){const t={scene:Uh.parse(i)};return e.onLoad&&e.onLoad(t),t}return new Promise(((i,o)=>{Nh.load(t,(o=>{o.scene.updateMatrixWorld(),o.scene.traverse((t=>{const e=t.userData.name;if(e&&(e.startsWith("Collider")||e.startsWith("SceneCollider"))){let e=t.geometry;delete e.attributes.normal,delete e.attributes.uv}})),e.character||s.add(t+".scene.json",o.scene.toJSON()),e.onLoad&&e.onLoad(o),i(o)}),(()=>{}),o)}))}async function Wh(t,e={}){const s=await fetch(t),i=await s.json();return se.add(t,i),e.onLoad&&e.onLoad(i),i}Nh.setDRACOLoader(jh),Vh.loader={name:"gltf",extensions:[".gltf",".glb"],function:Vh},Wh.loader={name:"json",extensions:[".json"],function:Wh};var qh=JSON.parse('{"frames":{"bubble_boat":{"frame":{"x":75,"y":739,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_collapsed":{"frame":{"x":2,"y":180,"w":88,"h":88},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":40,"y":32,"w":88,"h":88},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.728477}},"bubble_collapsed_alt":{"frame":{"x":94,"y":180,"w":88,"h":88},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":40,"y":32,"w":88,"h":88},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.728477}},"bubble_collapsed_boat":{"frame":{"x":893,"y":2,"w":122,"h":151},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":23,"y":0,"w":122,"h":151},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.993377}},"bubble_collapsed_exclam":{"frame":{"x":2,"y":430,"w":56,"h":151},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":56,"y":0,"w":56,"h":151},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":1}},"bubble_collapsed_locked":{"frame":{"x":347,"y":890,"w":88,"h":99},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":40,"y":26,"w":88,"h":99},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.76}},"bubble_collapsed_star":{"frame":{"x":231,"y":892,"w":112,"h":108},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":2,"w":112,"h":108},"sourceSize":{"w":126,"h":113},"pivot":{"x":0.5,"y":0.860265}},"bubble_collapsed_talked":{"frame":{"x":292,"y":180,"w":70,"h":70},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":49,"y":41,"w":70,"h":70},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.728477}},"bubble_compass":{"frame":{"x":161,"y":584,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_disk":{"frame":{"x":216,"y":429,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_eye":{"frame":{"x":233,"y":275,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_flag":{"frame":{"x":246,"y":737,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_hammer":{"frame":{"x":332,"y":582,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_lightbulb":{"frame":{"x":387,"y":428,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_lock":{"frame":{"x":404,"y":275,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_quest":{"frame":{"x":417,"y":735,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_scissor":{"frame":{"x":503,"y":581,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_screwdriver":{"frame":{"x":558,"y":428,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_shears":{"frame":{"x":575,"y":275,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_stethoscope":{"frame":{"x":746,"y":321,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_talk":{"frame":{"x":729,"y":474,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_talked":{"frame":{"x":588,"y":734,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_turnback":{"frame":{"x":759,"y":627,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"bubble_wateringcan":{"frame":{"x":759,"y":780,"w":167,"h":149},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":167,"h":149},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.92}},"eye":{"frame":{"x":186,"y":180,"w":102,"h":74},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":33,"y":38,"w":102,"h":74},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.73}},"halo":{"frame":{"x":62,"y":430,"w":150,"h":150},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":150,"h":150},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"leaf_a":{"frame":{"x":160,"y":275,"w":69,"h":150},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":49,"y":0,"w":69,"h":150},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"leaf_b":{"frame":{"x":2,"y":739,"w":69,"h":150},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":49,"y":0,"w":69,"h":150},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"lighthouse_halo":{"frame":{"x":2,"y":2,"w":887,"h":174},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":887,"h":174},"sourceSize":{"w":903,"h":174},"pivot":{"x":0,"y":0.5}},"Line":{"frame":{"x":1012,"y":157,"w":9,"h":50},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":9,"h":50},"sourceSize":{"w":20,"h":50},"pivot":{"x":0.5,"y":0.5}},"note_a":{"frame":{"x":439,"y":888,"w":78,"h":96},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":45,"y":27,"w":78,"h":96},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"note_b":{"frame":{"x":521,"y":888,"w":57,"h":94},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":56,"y":29,"w":57,"h":94},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.5}},"plus_a":{"frame":{"x":893,"y":157,"w":115,"h":114},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":27,"y":19,"w":115,"h":114},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.5}},"plus_b":{"frame":{"x":2,"y":275,"w":154,"h":151},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":154,"h":151},"sourceSize":{"w":168,"h":151},"pivot":{"x":0.5,"y":0.5}},"plus_c":{"frame":{"x":117,"y":892,"w":110,"h":110},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":29,"y":20,"w":110,"h":110},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"smoke":{"frame":{"x":366,"y":180,"w":64,"h":61},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":64,"h":61},"sourceSize":{"w":64,"h":64},"pivot":{"x":0.5,"y":0.5}},"smoke2":{"frame":{"x":434,"y":180,"w":61,"h":58},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":61,"h":58},"sourceSize":{"w":64,"h":64},"pivot":{"x":0.5,"y":0.5}},"water_a":{"frame":{"x":746,"y":180,"w":137,"h":137},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":6,"w":137,"h":137},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"water_b":{"frame":{"x":2,"y":585,"w":155,"h":150},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":0,"w":155,"h":150},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}},"water_c":{"frame":{"x":2,"y":893,"w":111,"h":111},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":28,"y":19,"w":111,"h":111},"sourceSize":{"w":168,"h":150},"pivot":{"x":0.5,"y":0.5}}},"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"sprites.png","format":"RGBA8888","size":{"w":1024,"h":1024},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:ec87db51b5dbf5d972a1188d00feca9f:d3f9d76e57973954c275c8711014ceab:1eabdf11f75e3a4fe3147baf7b5be24b$"}}');const Hh=We({"/src/assets/canvas/sprites/sprites.json":Object.freeze(Object.defineProperty({__proto__:null,default:qh},Symbol.toStringTag,{value:"Module"})),"/src/assets/canvas/sprites/sprites.png":Object.freeze(Object.defineProperty({__proto__:null,default:"./assets/sprites.5250df88cb3d2aa0.png"},Symbol.toStringTag,{value:"Module"}))}),Gh=(t,e,s,i)=>Yh[t]={default:e,webp:s,avif:i},Yh={};Gh("noise","./assets/noise_perlin.956753cfcb3d2aa0.png"),Gh("clouds","./assets/clouds.657c06bacb3d2aa0.png"),Gh("charDiffuseDef","./assets/character_texture.674c7337cb3d2aa0.png"),Yh.sprites=Hh,Yh.spritesData="./assets/sprites.a65ec791cb3d2aa0.json";var Xh=Yh;function Qh(t){const e=v.threeRenderer.capabilities.isWebGL2,s=new B(t.img);return void 0!==t.flipY&&(s.flipY=t.flipY),void 0!==t.mipmaps&&(s.generateMipmaps=!!t.mipmaps),t.red&&(t.format=e?qe:He),t.alpha&&(t.format=Ge),t.nearest&&(s.magFilter=s.minFilter=Le),t.magFilter&&(s.magFilter=t.magFilter),t.minFilter&&(s.minFilter=t.minFilter),t.encoding&&(s.encoding=t.encoding),t.mapping&&(s.mapping=t.mapping),t.premultiplyAlpha&&(s.premultiplyAlpha=!0),t.repeat?(s.wrapS=fe,s.wrapT=fe):(t.wrapS&&(s.wrapS=t.wrapS),t.wrapT&&(s.wrapT=t.wrapT)),t.format&&(s.format=t.format),t.type&&(s.type=t.type),s.needsUpdate=!0,s}function $h(t,e,s,i=0){const o=e.size,a=e.scale/Math.max(o.w,o.h),n={},r=t.anchor||t.pivot||{x:.5,y:.5};"hint"===s.split("_")[0]&&(r.x=0,r.y=0);const l=t.frame,c=t.sourceSize,h=t.spriteSourceSize;n.id=s;const d=s.split("/");n.sequence=d.pop(),n.group=d.join("/"),n.frameIndex=i,n.texCoords=new Float32Array([l.x/o.w,(o.h-l.y-l.h)/o.h,l.w/o.w,l.h/o.h]),n.meshCoords=new Float32Array([.5*h.w+h.x-c.w*r.x,-(.5*h.h+h.y-c.h*r.y),h.w,h.h]);for(let u=0,p=n.meshCoords.length;u<p;u++)n.meshCoords[u]*=a;return n.anchor=r,n.sourceSize=t.sourceSize,n.spriteSourceSize=t.spriteSourceSize,n.vertices=t.vertices,n.verticesUV=t.verticesUV,n.triangles=t.triangles,n}const Kh=Ye.select,Zh=Pt.load;Pt.load=(t,e)=>se.get(t)?Promise.resolve(se.get(t)):Zh(t,e);const Jh=new Mt({color:255});function td(t,e,s){s.log,Pt.registerLoader(Bc),Pt.registerLoader(Vh),Pt.registerLoader(Wh),e.basicMat=Jh;const i=e.textures=t.textures={},o=e.character=t.character={heads:{},bodies:{},bottoms:{}};t.assets={},e.preload=async function(){const e=t.app.$preloader.task,s=[];t.audio.preloadSound("sfx_UI_dialog_next"),t.preloadAssets=["Taxi","BoatYellow","JoystickRaw"],s.push(e(Pt.load(Xh.spritesData,{onLoad:e=>{t.atlas=function(t){const e={sprites:{},meta:t.meta},s=t.frames;t.animations||(t.animations={});for(const i in t.animations){const o=t.animations[i],a=e.sprites[i]=[];for(let e=0,n=o.length;e<n;e++){const n=s[o[e]];delete s[o[e]],a.push($h(n,t.meta,i,e))}}for(const i in s){const o=s[i],a=(o.filename?o.filename.toString():i).replace(/[^a-zA-Z0-9-_-]/g,"").replace("png",""),n=e.sprites[a]=[];delete s[i],n.push($h(o,t.meta,a))}return e}(e)}}))),s.push(...[[Kh(Xh.sprites),"sprites",{}],[Kh(Xh.charDiffuseDef),"charDiffuseDef",{}]].map((t=>e(Pt.load(t[0],{onLoad:({node:e})=>{i[t[1]]=Qh(r({img:e,flipY:!1,premultiplyAlpha:!0},t[2]))}}))))),s.push(e(Pt.load("./assets/perso28.df910e9acb3d2aa0.glb",{character:!0,onLoad:t=>{t.scene.traverse((e=>{if(o.scene=t.scene,e.isMesh&&(e.material=Jh),"Armature"===e.name&&(o.armature=e),"SkinnedMesh"===e.type){let t=e.name.split("Rig")[1];t=t.split("-"),t="BODY_01"!==t[0]?t[0]+"-"+t[1]:"Character",e.skeleton&&e.skeleton.dispose(),e.updateMatrixWorld();const s=e.geometry.clone(),i=s.attributes.uv2,a=s.attributes.color,n=s.attributes.color_1,r=s.attributes.texcoord_2;i&&s.deleteAttribute&&s.deleteAttribute("uv2"),n&&s.deleteAttribute&&s.deleteAttribute("color_1"),a&&s.deleteAttribute&&s.deleteAttribute("color"),r&&s.deleteAttribute&&s.deleteAttribute("texcoord_2");const l=t.split("-"),c=l[0];switch(l[1],c){case"Character":o.main=s;break;case"Head":o.heads[t]=s;break;case"Body":o.bodies[t]=s;break;case"Bottom":o.bottoms[t]=s}}}));for(let e=o.armature.children.length-1,s=0;e>=s;e--){const t=o.armature.children[e];t.name.match(/(BODY_01)/g)||t.type.match(/(Bone)/g)||(o.armature.remove(t),t.name.match(/(OeilD)/g)&&(o.oeild=new N,o.oeild.name=t.name),t.name.match(/(OeilR)/g)&&(o.oeilr=new N,o.oeilr.name=t.name),t.name.match(/(Bouche)/g)&&(o.bouche=new N,o.bouche.name=t.name))}o.animations=t.animations}}))),await Promise.all(s),t.atlas.meta.image=t.textures.sprites,t.atlas.texture=t.textures.sprites},e.load=Pt.load}function ed(t,e,s,i){const o=new Set,a=new Set;return{actorAssets:o,actorStaticAssets:a,prepareActor:function(s,n){if(!n.transformMatrix){const t=n.transforms;n.transformMatrix=t?(new p).compose({x:t[0],y:t[1],z:t[2]},{_x:t[6],_y:t[7],_z:t[8],_w:t[9]},{x:t[3],y:t[4],z:t[5]}):new p}if(!s.prepare)return;const c=s.prepare({actor:n,sceneID:e,savedata:t.savestate.getActorData(e,n.uid)})||{};s.isNPC?function(t,e){if(e.preloadAssets)for(let s=0,i=e.preloadAssets.length;s<i;s++)o.add(e.preloadAssets[s])}(0,c):function(t,e){if(e.staticProps)for(let s=0,o=e.staticProps.length;s<o;s++){const o=e.staticProps[s],n=o.asset,r=!!o.traversable,l=t.transforms;a.add(n);const c={asset:n,transforms:l,traversable:r};i.props||(i.props=[]),i.props.push(c)}if(e.staticColliders)for(let s=0,o=e.staticColliders.length;s<o;s++){const o=e.staticColliders[s].asset,n=t.transforms;a.add(o);const r={asset:o,transforms:n,colliderOnly:!0};i.props||(i.props=[]),i.props.push(r)}if(e.dynamicProps){t.dynamicProps={};for(let s in e.dynamicProps){const i=e.dynamicProps[s];i.asset?o.add(i.asset):i.asset=!1,i.collider?o.add(i.collider):i.collider=!1,t.dynamicProps[s]=l(r({},i),{id:s})}}if(e.preloadAssets)for(let s=0,i=e.preloadAssets.length;s<i;s++)o.add(e.preloadAssets[s])}(n,c)}}}const sd=Ye.select,id=t=>t;let od=!0;function ad(t,e,s){t.add(new J((new d).fromArray(e,0),(new d).fromArray(e,6),(new d).fromArray(s,3),(new d).fromArray(s,0)))}function nd(t,e,s){t.add(new Qe((new d).fromArray(e),(new d).fromArray(s)))}function rd(t,{closed:e=!1,curveType:s,tension:i}){const o=t.map((t=>(new d).fromArray(t)));return new A(o,e,s,i)}function ld(t,{closed:e=!1}){const s=new Z;for(let i=0,o=t.length-1;i<o;i++){ad(s,t[i],t[i+1])}if(e){ad(s,t[t.length-1],t[0]),s.isClosed=!0}return s}function cd(t,{closed:e=!1}){const s=new Z;for(let i=0,o=t.length-1;i<o;i++){nd(s,t[i],t[i+1])}if(e){nd(s,t[t.length-1],t[0]),s.isClosed=!0}return s}let hd=performance.now();const dd=t=>{const e=performance.now();if(t||!(e-hd<200))return hd=e,new Promise((t=>requestAnimationFrame(t)))};let ud=!0;new u,new u;const pd=new ot,md=new $e,fd=new dt,gd=new b(16777215,.5),bd=gd.shadow,yd=bd.camera;function vd(t,e,s,i,o){o.visible=!1}gd.castShadow=!0,gd.shadow.autoUpdate=!1,md.add(gd.target),md.add(gd),md.autoUpdate=!1;var wd=w("uniform vec2 bounds;uniform sampler2D splatting;varying float vYPos;varying vec2 vUv;\n#include <linear_step>\nvoid main(){float depth=linearstep(bounds.x-0.3,bounds.y,vYPos);vec4 text=texture2D(splatting,vUv);gl_FragColor=vec4(vec3(depth)*text.r,1.);}","fragmentShader");var xd=w("varying vec2 vUv;varying float vYPos;void main(){vUv=uv;vec4 mvPos=modelMatrix*vec4(position,1.);vYPos=mvPos.y;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let Sd=null;class _d extends x{constructor(){super({}),this.uniforms={bounds:{value:new h},splatting:{value:null}},wd.use(this),xd.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}_d.use=function(){return Sd=Sd||new _d,Sd},_d.unuse=function(){};const Pd=new ot,Md=new $e;Md.autoUpdate=!1;const Td=_d.use(),Ad=new ee(-100,100,100,-100,.1,1e3);Ad.rotation.x=-Math.PI/2;let Cd,Dd=!0;async function Id(t,e,s,i){const o=e.scenes[s.props.id],a=e.manifest.scenes[s.props.id],{material:n}=function({webgl:t,sceneResources:e,sceneManifest:s}){const i=t.threeRenderer,o=e.base,a=e.textures.grassSplatting,n=!!a;if(Pd.min.fromArray(s.bounds[0]),Pd.max.fromArray(s.bounds[1]),Pd.min.y=parseFloat(ms().WATER_BASE_LEVEL),Dd){const e=t.threeRenderer.capabilities.isWebGL2;t.app.$device.type.phone,Cd=Fc({name:"Island Depth",depth:!1,width:1024,height:1024,format:e?qe:te}),Dd=!1}let r;if(e.depthBounds=Pd,e.textures.sceneDepth=Cd.texture,n&&o&&(r=new S(o,Td),r.frustumCulled=!1,Md.add(r)),n){const t=Td.uniforms;t.bounds.value.set(Pd.min.y,Pd.max.y),t.splatting.value=a,t.splatting.value.needsUpdate=!0}Ad.position.y=Pd.max.y+1;const l=(Pd.min.x+Pd.max.x)/2,c=(Pd.min.z+Pd.max.z)/2,h=Math.abs(Pd.min.x-Pd.max.x),d=Math.abs(Pd.min.z-Pd.max.z);Ad.left=-h/2,Ad.right=h/2,Ad.bottom=-d/2,Ad.top=d/2,Ad.position.x=l,Ad.position.z=c,Ad.updateProjectionMatrix();let u=i.getRenderTarget(),p=i.autoClear,m=i.sortObjects;return i.sortObjects=!1,i.autoClear=!1,i.setRenderTarget(Cd),i.clear(),n?i.render(Md,Ad):i.clearColor(),i.setRenderTarget(u),i.sortObjects=m,i.autoClear=p,rs.bounds.min.value.set(Pd.min.x,Pd.min.y,Pd.min.z),rs.bounds.max.value.set(Pd.max.x,Pd.max.y,Pd.max.z),Cd.texture.needsUpdate=!0,rs.uIslandDepth.value=Cd.texture,r&&Md.remove(r),{material:Td,bounds:Pd}}({webgl:t,sceneResources:o,sceneManifest:a});await new Promise((t=>requestAnimationFrame(t))),function({webgl:t,sceneResources:e,sceneManifest:s,material:i,isRerender:o}){const a=e.base,n=e.chunks;pd.min.fromArray(s.bounds[0]),pd.max.fromArray(s.bounds[1]);let r=[];if(a){const t=new S(a,i);t.onBeforeRender=vd,t.receiveShadow=!0,t.frustumCulled=!1,r.push(t)}if(o||function(t,e){const s=t.actors,i=e.dynamicPropsAllocs,o=e.dynamicPropsVertices;for(let a in s){const t=s[a];for(let s in t.dynamicProps){const a=t.dynamicProps[s];if(!a.asset)continue;const n=!!a.castFarShadow,r=i[t.uid][s],l=o[t.uid][s],c=e.chunks[r.chunk].attributes.position,h=c.array,d=r.start,u=r.start+r.count;let p=!1;if(n)h[d]===l[0]&&h[d+1]===l[1]&&h[u-1]===l[l.length-1]||(h.set(l,d,u),p=!0);else{const t=1e7;h[d]===t&&h[d+1]===t&&h[u-1]===t||(h.fill(t,d,u),p=!0)}p&&(c.needsUpdate=!0)}}}(s,e),n.length)for(let d=0,P=n.length;d<P;d++){const t=n[d],e=new S(t,i);e.onBeforeRender=vd,e.castShadow=!0,e.receiveShadow=!0,e.frustumCulled=!1,r.push(e)}for(let d=0,S=r.length;d<S;d++)md.add(r[d]);pd[0],pd[1];const l=(pd.min.x+pd.max.x)/2,c=(pd.min.z+pd.max.z)/2,h=Math.abs(pd.min.x-pd.max.x),u=Math.abs(pd.min.z-pd.max.z),p=1.2;yd.left=-h/2*p,yd.right=h/2*p+30,yd.bottom=-u/2*p,yd.top=u/2*p,yd.far=200,yd.near=1,yd.fov=50,yd.updateProjectionMatrix();const m=t.store.islands.lights.directional.target;gd.target.position.set(l,0,c);const f=d.get().copy(m).multiplyScalar(60);gd.position.set(l,0,c).add(f),f.release(),g=4096,b=gd.shadow,b.mapSize.width!==g&&(b.mapSize.width=g,b.mapSize.height=g,b.map&&(b.map.dispose(),b.map=null));var g,b;const y=t.threeRenderer;gd.shadow.needsUpdate=!0,gd.updateMatrixWorld(),gd.target.updateMatrixWorld();let v=y.autoClear,w=y.sortObjects,x=i.visible;y.sortObjects=!1,y.autoClear=!1,i.visible=!0;let _=y.getRenderTarget();y.setRenderTarget(t.noopRenderTarget),y.render(md,fd),y.setRenderTarget(_),y.sortObjects=w,y.autoClear=v,i.visible=x;for(let d=0,S=r.length;d<S;d++)r[d].onBeforeRender=null,r[d].removeFromParent();e.bigShadowData={texture:bd.map.texture,matrix:bd.matrix,shadowBias:bd.bias,shadowSize:bd.mapSize,shadowRadius:bd.radius,light:gd},ud&&(ud=!1)}({webgl:t,sceneResources:o,sceneManifest:a,material:n})}const kd=[["index",1],["position",3],["uv",2],["normal",3]],Od=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64"].map((t=>t+"Array"));function Rd(t,e,s){"number"==typeof t&&(t=new Float32Array([t]));const i=t instanceof Uint8Array?t:new Uint8Array(t.buffer);return e.length+=i.length,s?e.list.unshift(i):e.list.push(i),e}function Ld(t,e){return Rd(function(t){return t?Od.indexOf(t.array.constructor.name)+1:0}(t),e),Rd(t.array.byteLength,e),Rd(t.array,e),e}function Ed(t,e){const s=t.buffer.slice(t.offset,t.offset+e);return t.offset+=e,s}function Fd(t,e){if(0===new Float32Array(Ed(t,4))[0])return;const s=new P,i=new Float32Array(Ed(t,24)),o=new Float32Array(Ed(t,16));s.boundingBox=new ot((new d).fromArray(i,0),(new d).fromArray(i,3)),s.boundingSphere=new V((new d).fromArray(o,0),o[3]);for(let n=0,r=e.length;n<r;n++){const i=e[n],o=i[0],r=i[1],l=new Float32Array(Ed(t,4))[0],c=new Float32Array(Ed(t,4))[0],h=!!(a=l)&&Od[a-1],d=new window[h](Ed(t,c));1===d.length&&-12345===d[0]||("index"===o?s.setIndex(new M(d,1,!1)):s.setAttribute(o,new M(d,r,!1)))}var a;return s}const zd=["base","horizon","propsCollider","groundCollider","chunks","dynamicPropsAllocs"];var Bd={save:async function(t,e,s,{log:i}){const o=s.props.id,a=e.scenes[o];if(!("safari"===t.app.$device.browser)&&!a.useMergeCache){a.useMergeCache=!0;const t={};for(let e=0,i=zd.length;e<i;e++)t[zd[e]]=a[zd[e]];const s=function(t,{attributes:e}={}){const s={length:0,list:[]},i={data:{}},o={};for(let c in t){const e=t[c];if(Array.isArray(e)||"object"!=typeof e||e.isBufferGeometry)if(Array.isArray(e)){const t=e;for(let e=0,s=t.length;e<s;e++)o["_AR|"+c+"|"+e]=t[e]}else o[c]=e;else i.data[c]=e}t=o;const a=i.keys=Object.keys(t);i.attrs=e=e||kd;const n=(new TextEncoder).encode(JSON.stringify(i));Rd(n.byteLength,s),Rd(n,s);for(let c=0,h=a.length;c<h;c++){const i=t[a[c]];if(!i){Rd(0,s);continue}const o={length:0,list:[]};let n=i.boundingBox;n=new Float32Array(n?[...n.min.toArray(),...n.max.toArray()]:[0,0,0,0,0,0]),Rd(n,o);let r=i.boundingSphere;r=new Float32Array(n?[...r.center.toArray(),r.radius]:[0,0,0,-1]),Rd(r,o);for(let t=0,s=e.length;t<s;t++){const s=e[t][0];let a="index"===s?i.index:i.attributes[s];a||(a={array:new Float32Array([-12345])}),Ld(a,o)}Rd(o.length,s),o.list.forEach((t=>Rd(t,s)))}let r=0;const l=new Uint8Array(s.length);for(let c=0,h=s.list.length;c<h;c++){const t=s.list[c];l.set(t,r),r+=t.byteLength}return l}(t);s&&e.supercache.add(o+".merge.dat",s)}},load:async function(t,e,s,i){const o=s.props.id,a=e.scenes[o];if(performance.now(),a.base||a.collider)return;let n=await e.supercache.get(o+".merge.dat");const r=n&&function(t){(t=t||new ArrayBuffer).buffer&&(t=t.buffer);const e={buffer:t,offset:0},s=new Float32Array(Ed(e,4))[0],i=Ed(e,s),o=(new TextDecoder).decode(i);let a;try{a=JSON.parse(o)}catch(c){return!1}const n=a.attrs,r=a.keys,l={};if(a.data)for(let h in a.data)l[h]=a.data[h];for(let h=0,d=r.length;h<d;h++){let t=r[h],s=l;if("_AR|"===t.slice(0,4)){const e=t.slice(4).split("|");t=e.pop();const i=e.join("|");l[i]||(l[i]=[]),s=l[i]}try{s[t]=Fd(e,n)}catch(c){return!1}}return l}(n);if(r){for(let t in r)r[t]&&(a[t]=r[t]);a.base&&(a.boundingBox=a.base.boundingBox,a.boundingSphere=a.base.boundingSphere),a.useMergeCache=!0}}};function Ud(t,e){const{log:s}=e,i=c(),o=i.resources,a=t.props.id;o.manifest.scenes[a]=o.manifest.scenes[a]||{},o.scenes[a]=o.scenes[a]||{};const n={log:s,timing:!1};return Promise.resolve().then((()=>Bd.load(i,o,t,n))).then((()=>async function(t,e,s,i){const o=od?t.app.$preloader.task:id;od=!1;const a=s.props.id,n=e.manifest,l=n.scenes[a],c=e.scenes[a];if(!l)return;performance.now();const h=c.base,u=[],p=n.textures;u.push(...[[sd(Xh.noise),"noise",{repeat:!0}],[sd(Xh.clouds),"clouds",{repeat:!0}],[sd(p.SplattingPatterns),"splattingPatterns",{repeat:!0}],[sd(p.Assets_Gradients),"assetsGradients",{}],[sd(p.Assets_Data),"assetsData",{nearest:!0}]].map((t=>{e.textures[t[1]]||o(e.load(t[0],{onLoad:({node:s})=>{e.textures[t[1]]=Qh(r({img:s,flipY:!1},t[2]))}}))}))),c.textures=c.textures||{},u.push(...[[sd(p["Scene_"+a+"_TerrainSplatting"]),"terrainSplatting",{}],[sd(p["Scene_"+a+"_GrassSplatting"]),"grassSplatting",{red:!0}]].map((t=>o(e.load(t[0]).then((({node:e})=>{c.textures[t[1]]||(c.textures[t[1]]=Qh(r({img:e,flipY:!1},t[2])))})))))),h||u.push(o(e.load(l.url,{onLoad:t=>{for(let e=0;e<t.scene.children.length;e++){const s=t.scene.children[e],i=s.userData.name.toLowerCase(),o=i.split(".")[0],a=s.geometry;if(o.endsWith("horizon"))c.horizon=a;else if(o.endsWith("groundcollider"))c.baseGroundCollider=a;else if(o.endsWith("collider"))c.baseCollider=a;else if(o.endsWith("base")){const t=l.bounds,e=t&&new ot((new d).fromArray(t[0]),(new d).fromArray(t[1]));c.base=a,a.boundingBox||(a.boundingBox=e),a.boundingBox||a.computeBoundingBox(),c.boundingBox=a.boundingBox,c.boundingSphere=a.boundingSphere}else if(o.endsWith("props")){const t=i.endsWith("traversableprops"),e=s.children;c.props||(c.props=[]);for(let s=0;s<e.length;s++){const i=e[s],o=i.scale,a=i.position,n=i.quaternion;c.props.push({asset:i.userData.asset,traversable:!!t,transforms:[a.x,a.y,a.z,o.x,o.y,o.z,n.x,n.y,n.z,n.w]})}}}}})));const m=c.dynamicAssets=new Set(t.preloadAssets),f=s.class,g=new Set;if(f.prepare){const t={id:s.props.id,props:s.props},e=f.prepare(t);if(e.preloadAssets)for(let s=0,i=e.preloadAssets.length;s<i;s++)g.add(e.preloadAssets[s]),m.add(e.preloadAssets[s]);e.preload&&u.push(o(e.preload(t)))}const{actorAssets:b,actorStaticAssets:y,prepareActor:v}=ed(t,a,0,c),w=t.app.$characters.npcs,x=t.app.$characters.colors.coastal;for(let r in l.actors){const t=l.actors[r];let s;if("NPC"===t.type){const e=t.params;let s=e&&e.subtype?e.subtype:"";if(s=s.replace(/\.[0-9]+$/,""),!w[s])continue;const i=w[s];null==i.faceColor&&(i.faceColor=x.faceColor),null==i.gradientID&&(i.gradientID=x.gradientID),t.npcConfig=i;const o=i.script;t.className="NPC"+o}else t.className=t.type;s=e.actors[t.className],s&&v(s,t)}b.forEach((t=>{m.add(t)}));const S=[...new Set([...t.preloadAssets,...h?[]:l.assets,...h?[]:y,...g,...b])];for(let r=0,_=S.length;r<_;r++){const t=S[r],s=n.assets[t];s&&!e.assets[t]&&u.push(o(e.load(s.url,{onLoad:s=>{const i=e.assets[t]={};let o=null;for(let t=0;t<s.scene.children.length;t++){const e=s.scene.children[t],a=e.userData.name.split("_");switch(a.shift().split(".")[0].toLowerCase()){case"collider":i.collider=e.geometry;break;case"mesh":i.isMesh=!0,i.mesh=e.clone(),i.geometry=e.geometry;break;case"rawmesh":i.isRawMesh=!0,i.mesh=e.clone();break;case"bounds":const t=a.shift().split("|").map((t=>parseFloat(t)));o=[t.slice(0,3),t.slice(3,6)]}}if(i.geometry){const e=i.geometry;e.boundingBox||(o?e.boundingBox=new ot((new d).fromArray(o[0]),(new d).fromArray(o[1])):e.computeBoundingBox()),e.name=t,i.boundingBox=e.boundingBox,i.boundingSphere=e.boundingSphere}}})))}await Promise.all(u),!c.base&&l.useBaseAsCollider&&(l.useBaseAsCollider=!1)}(i,o,t))).then((()=>new Promise((t=>requestAnimationFrame(t))))).then((()=>async function(t,e,s,i){const o=s.props.id,a=e.manifest,n=e.scenes[o],r=a.scenes[o];if(!r)return;if(performance.now(),!n.points){const t=n.points={};for(const e in r.points||{}){const s=r.points[e];t[e]={position:(new d).fromArray(s,0),scale:(new d).fromArray(s,3),quaternion:(new O).fromArray(s,6)}}}if(!n.curves){const t=n.curves={};for(const e in r.curves||{}){const s=r.curves[e];if(!s)continue;const{type:i,closed:o,points:a}=s;i&&("NURBS"===i?t[e]=rd(a,{closed:o}):"BEZIER"===i?t[e]=ld(a,{closed:o}):"POLY"===i&&(t[e]=cd(a,{closed:o})),t[e]&&(t[e].raw=s))}}if(!n.areas){const t=n.areas={};for(const e in r.areas||{}){const s=r.areas[e],i=(new d).fromArray(s.position),o=s.size;t[e]=new V(i,o)}}const l=!!r.useBaseAsCollider,c=ua({attributes:["position"]}),h=ua({attributes:["position"]});let u,p,m,f,g;const b=t.store.chunkDivisor;n.chunks||(u=n.boundingBox.getSize(new d),p=u.x/b,m=u.z/b,f=n.boundingBox.min.x,g=n.boundingBox.min.z);const y=[];function v(t,e){t-=f,e-=g;const s=st(Math.floor(t/p),0,b-1),i=st(Math.floor(e/m),0,b-1);return y[s][i]}for(let d=0;d<b;d++){const t=y[d]=[];for(let e=0;e<b;e++)t[e]=ua()}if(n.physicsInstancePromise=t.initPhysics(o),await dd(!0),!n.propsCollider){const t=[...r.props,...n.props];for(let s=0,i=t.length;s<i;s++){const i=t[s],o=e.assets[i.asset];if(!o||!o.isMesh)continue;const a=v(i.transforms[0],i.transforms[2]);o.geometry&&!i.colliderOnly&&a.add(o.geometry,i),!o.collider||i.traversable||i.traverse||c.add(o.collider,i),await dd()}}if(await dd(!0),!n.dynamicPropsAllocs){const t=r.actors,s=n.dynamicPropsAllocs={};for(let i in t){const o=t[i],a=o.dynamicProps;if(!a||!Object.keys(a).length)continue;const n=o.transforms,r=s[o.uid]={};for(let t in a){const s=a[t];if(!s.asset)continue;const i=n,o=v(i[0],i[2]),l=e.assets[s.asset].geometry,c=o.getPositionLength(),h=l.attributes.position.array.length;r[t]={chunk:o,start:c,count:h},o.add(l,{transforms:i}),await dd()}}}if(await dd(!0),n.groundCollider||(n.baseGroundCollider&&(h.add(n.baseGroundCollider),await dd()),l&&(h.add(n.base),await dd())),await dd(!0),n.propsCollider||n.baseCollider&&(c.add(n.baseCollider),await dd()),await dd(!0),n.groundCollider||(n.groundCollider=h.merge(),await dd()),await dd(!0),n.propsCollider||(n.propsCollider=c.merge(),await dd()),await dd(!0),!n.chunks){const t=new Map,e=n.chunks=[];for(let s=0;s<y.length;s++){const i=y[s];for(let o=0;o<i.length;o++){const i=y[s][o];let a=i.merge();0!==a.attributes.position.count&&(t.set(i,e.length),e.push(a),await dd())}}for(let s in n.dynamicPropsAllocs){const e=n.dynamicPropsAllocs[s];for(let s in e){const i=e[s];i.chunk=t.get(i.chunk)}}}await dd(!0);const w=n.chunks,x=n.dynamicPropsAllocs;if(!n.dynamicPropsVertices){const t=n.dynamicPropsVertices={};for(let e in x){const s=x[e],i=t[e]={};for(let t in s){const e=s[t],o=w[e.chunk].attributes.position.array,a=e.start+e.count;i[t]=o.slice(e.start,a),await dd()}}}const S=[];S.push([n.propsCollider,"props"]),S.push([n.groundCollider,"ground"]);for(let d in r.actors){const e=r.actors[d],s={};for(let i in e.dynamicProps){const o=e.dynamicProps[i],a=o.collider;if(!a)continue;const n=e.transformMatrix,r=a+n.elements.join("_");if(s[r]){o.physicsLayer=s[r];continue}const l=e.uid+"_"+i,c=t.resources.assets[a].collider;o.physicsLayer=s[r]=l,S.push([c,l,n])}}n.physicsBatchPromise=n.physicsInstancePromise.then((t=>t.addBatch(S))),await dd(!0);for(let d in t.resources.assets)n.dynamicAssets.has(d)||(t.resources.assets[d]=null)}(i,o,t))).then((()=>new Promise((t=>requestAnimationFrame(t))))).then((()=>Bd.save(i,o,t,n))).then((()=>new Promise((t=>requestAnimationFrame(t))))).then((()=>Id(i,o,t))).then((()=>new Promise((t=>requestAnimationFrame(t))))).catch((t=>{}))}function jd(){return new Worker("./assets/workerThread.dcadb976.js",{type:"module"})}const Nd=function(t){const e=new Array;return function t(e,s,i=null){s(e,i,e);for(let o in e){let a=e[o];a instanceof Object?t(a,s,o):s(a,i,e)}}(t,(t=>{(function(t){try{return t instanceof ArrayBuffer||t instanceof MessagePort||t instanceof ImageBitmap||t instanceof OffscreenCanvas}catch(e){return!1}})(t)&&e.push(t)})),e};class Vd{constructor(t){return Object.assign(this,{log:t,running:!1,animationFrame:null,messageID:0,events:new Array,_moveDirection:new d,_playerPosition:new d,_playerRotation:new z(0,0,0,"XZY"),_playerForce:new d(0,0,0,"XZY"),playerVelocity:0,playerSpeed:0,playerDistanceFromFloor:0,playerCollidingLayers:new Set,playerIsReverse:!1,_cameraPosition:new d,_cameraRotation:new z(0,0,0,"YXZ"),_curveProgress:{current:0,validated:0,furthest:0,reverse:!1},spheres:new Array}),this.synchronize=this.synchronize.bind(this),this.onMessage=this.onMessage.bind(this),this.updatePlayerMove=new Float32Array(4),this.updatePlayerMove[0]=0,this.generate()}async generate(){return this.thread=new jd,this.thread.addEventListener("message",this.onMessage),await this.send("setup"),this.log("ready"),this}get playerPosition(){return this._playerPosition.clone()}get playerRotation(){return this._playerRotation.clone()}get playerForce(){return this._playerForce.clone()}get cameraPosition(){return this._cameraPosition.clone()}get cameraRotation(){return this._cameraRotation.clone()}get curveProgress(){return this._curveProgress}getSpherePosition(t){return this.spheres[t].position}run(){this.running||(this.log("running"),this.running=!0,Wt.add(this.synchronize))}stop(){this.log("stop"),this.running=!1,Wt.remove(this.synchronize)}standby(){this.slowedDown||(this.log("slow down"),this.slowedDown=!0,Wt.remove(this.synchronize))}recover(){this.slowedDown&&(this.log("speed up"),this.slowedDown=!1,Wt.add(this.synchronize))}onMessage({data:t}){const{type:e,data:s}=t;"update"===e&&(this.physicsData=s,this.physicsData.canPause?this.standby():this.recover(),this.update())}synchronize(){45===this.updatePlayerMove[0]?(this.thread.postMessage(this.updatePlayerMove),this.updatePlayerMove[0]=0):this.thread.postMessage(12)}update(){const{physicsData:t}=this;if(t){this._playerRotation.setFromVector3(t.player.rotation),this._playerPosition.copy(t.player.position),this._playerForce.copy(t.player.force),this.playerVelocity=t.player.velocity,this.playerSpeed=t.player.speed,this.playerDistanceFromFloor=t.player.distanceFromFloor||0,this.playerCollidingLayers=t.player.collidingLayers,this._cameraPosition.copy(t.camera.position),this._cameraRotation.setFromVector3(t.camera.rotation),this._curveProgress.current=t.player.progress.current,this._curveProgress.validated=t.player.progress.validated,this._curveProgress.furthest=t.player.progress.furthest,this._curveProgress.complete=t.player.progress.complete,this._curveProgress.reverse=t.player.progress.reverse;for(let e=0,s=t.spheres.length;e<s;e++){const s=this.spheres[e],i=t.spheres[e];s.position.copy(i.position),i.isCollidingWithPlayer&&s.action&&s.action()}}}send(t,e=null,s=!1,i=!0){const o=i?Nd(e):void 0,a=this.messageID++;let n;return s||(n=new Promise((t=>{const e=({data:{data:s,messageID:i}})=>{i===a&&(this.off("message",e),t(s))};this.on("message",e)}))),this.thread.postMessage({type:t,data:e,messageID:a},o),n}addBatch(t){let e=new Map;const s=[];for(let o=0,a=t.length;o<a;o++){const i=t[o],a=i[0],n=i[1],r=i[2]||new p;let l;!a.index||e.has(a)?l=a:(l=a.toNonIndexed(),e.set(a,l));const{array:c,itemSize:h,normalized:d}=l.getAttribute("position");s.push({array:c,itemSize:h,normalized:d,layerID:n,matrix:r})}const i=this.send("add-batch",s);return e.forEach((t=>t.dispose())),i}add(t,e,s=new p){return Array.isArray(t)?this.addBatch(t):this.addBatch([[t,e,s]])}addCurve(t,e,s){return this.send("add-curve",{name:t,points:e,divisions:s})}stopSphere(t,e){return this.send("stop-sphere",{id:t,value:e},!0)}cullSphere(t,e){return this.send("cull-sphere",{id:t,value:e},!0)}addSphere({id:t="default",sphere:e,mode:s=0,moveToFloor:i=!1,move:o=null,action:a}={}){return this.spheres.push({position:e.center,action:a}),this.send("add-sphere",{id:t,position:e.center.toArray(),radius:e.radius,mode:s,move:o,moveToFloor:i})}toggleLayer(t,e=null){return this.send("toggle-layer",{layerID:t,force:e})}movePlayer(t){if(!this._moveDirection.equals(t)){const e=t.x,s=t.y,i=t.z;0===e&&0===s&&0===i||this.recover(),this._moveDirection.set(e,s,i),this.updatePlayerMove[0]=45,this.updatePlayerMove[1]=e,this.updatePlayerMove[2]=s,this.updatePlayerMove[3]=i}}setPlayerOptions(t){const e=r({},t);for(let s in e){const t=e[s];t instanceof d&&(e[s]={x:t.x,y:t.y,z:t.z})}return this.send("set-player-options",e,!0)}setCameraOptions(t){const e=r({},t);for(let s in e){const t=e[s];t instanceof d&&(e[s]={x:t.x,y:t.y,z:t.z})}return this.send("set-camera-options",e,!0)}respawnPlayer(t=!0,e=!0,s=!1){return this.recover(),this.send("respawn-player",{reset:t,resetForces:e,moveToFloor:s})}destroy(){this.thread.terminate(),this.stop(),this.off(),this.log("destroyed")}togglePause(t){return this.send("toggle-pause",!!t)}on(t,e,s=!1){if(t&&e){const i={type:t,action:i=>{e.call(this.thread,i),s&&s.once&&this.off(t,e,s)},originalAction:e,options:s};this.thread.addEventListener(i.type,i.action,i.options),this.events.push(i)}return this}off(t,e,s){for(let i=this.events.length-1;i>=0;i--){let o=this.events[i];t!==o.type&&void 0!==t||e!==o.originalAction&&void 0!==e||s!=o.options&&void 0!==s||(this.thread.removeEventListener instanceof Function&&this.thread.removeEventListener(o.type,o.action,o.options),this.events.splice(i,1))}return this}dispatch(t,e,s){const i=new CustomEvent(t,{detail:e});i.complete=s;for(let o of this.events)o.type===t&&o.action(i);return this}}const Wd=2*Math.PI;new y(1,1,1);const qd=new d;$(Je.outSine),new y(16777215);var Hd={beforeEmit:function(t={}){t.position||(t.position=qd),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Wd)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m}){const f=Wd/c,g=t.index*f+T.randomFloat(-Math.PI,Math.PI);let b=.2+T.randomFloat(.03,.15);t.billboard=h,t.angVelocity=0,t.spriteId=Math.random()>.6?"bubble_collapsed":r,t.velocity.x+=b/2*Math.cos(g),t.velocity.z+=b/2*Math.cos(g),t.velocity.y+=b,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.75),t.useVelocityDragMult=!0,t.gravity.y-=0,t.position.copy(s),t.position.x+=T.randomFloat(-.3,.3),t.position.y+=T.randomFloat(.1,.5),t.position.z+=T.randomFloat(-.3,.3),t.duration=T.randomFloat(a||800,n||900),t.delay=300*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(T.randomFloat(.8,1.2)),t.alphaFrom=1,t.alphaTo=1,t.colorFrom.copy(new y(16777215)).multiplyScalar(.15*Math.random()+.85),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},Gd=Object.freeze(Object.defineProperty({__proto__:null,default:Hd},Symbol.toStringTag,{value:"Module"}));const Yd=2*Math.PI;new y(1,1,1);const Xd=new d;$(Je.outSine),new y(16777215);var Qd={beforeEmit:function(t={}){t.position||(t.position=Xd),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Yd)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m}){const f=Yd/c,g=t.index*f+T.randomFloat(-Math.PI,Math.PI)+e;let b=0+T.randomFloat(.003,.007);t.billboard=h,t.angVelocity=0,t.spriteId=Math.random()>.4?"smoke":"smoke2",t.velocity.x+=b*Math.sin(g),t.velocity.z+=b*Math.sin(g),t.velocity.y+=b*Math.cos(g),t.rotation.x=Math.PI/-2,t.rotation.z=b*t.velocity.x*Math.cos(g),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||1e3,n||1200),t.scaleInOut=!0,t.scaleTo.copy(i).multiplyScalar(2.3),t.scaleFrom.copy(i).multiplyScalar(2.3),t.alphaFrom=1,t.alphaTo=0,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},$d=Object.freeze(Object.defineProperty({__proto__:null,default:Qd},Symbol.toStringTag,{value:"Module"}));const Kd=2*Math.PI;new y(1,1,1);const Zd=new d;$(Je.outSine),new y(16777215);var Jd={beforeEmit:function(t={}){t.position||(t.position=Zd),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Kd)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f}){t.index,T.randomFloat(-Math.PI,Math.PI);const g=Math.random()>.5?-1:1;t.billboard=h,t.angVelocity=0;const b=Math.random()>.8;t.spriteId=b?"leaf_a":"smoke2",t.velocity.x+=.04*Math.random()*g,t.velocity.y+=.05*Math.random()+.08,t.velocity.z=.05*Math.random()+.05,t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.02,t.position.copy(s),t.position.x*=g,t.duration=T.randomFloat(a||200,n||300),t.delay=100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(b?T.randomFloat(1.2,1.4):T.randomFloat(1.5,1.8)),t.alphaFrom=1,t.alphaTo=1;const v=.5*Math.random()+.5,w=4562255,x=5915980;t.colorFrom.copy(new y(b?w:x)).multiplyScalar(v),t.colorTo.copy(new y(b?w:x)).multiplyScalar(v)}},tu=Object.freeze(Object.defineProperty({__proto__:null,default:Jd},Symbol.toStringTag,{value:"Module"}));const eu=2*Math.PI;new y(1,1,1);const su=new d;$(Je.outSine),new y(16777215);var iu={beforeEmit:function(t={}){t.position||(t.position=su),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,eu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,dir:g}){t.index,T.randomFloat(-Math.PI,Math.PI),t.billboard=h,t.angVelocity=0;const b=Math.random()>.4;t.spriteId=b?"leaf_a":"bubble_collapsed",t.velocity.x+=.1*Math.random()*g,t.velocity.y+=.2*Math.random()+.3,t.velocity.z=.2*Math.random()+.2,t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.1,t.position.copy(s),t.position.x*=g,t.duration=T.randomFloat(a||200,n||300),t.delay=100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(b?T.randomFloat(1.4,2):T.randomFloat(.7,1.1)),t.alphaFrom=1,t.alphaTo=1;const v=.5*Math.random()+.5,w=4562255,x=5915980;t.colorFrom.copy(new y(b?w:x)).multiplyScalar(v),t.colorTo.copy(new y(b?w:x)).multiplyScalar(v)}},ou=Object.freeze(Object.defineProperty({__proto__:null,default:iu},Symbol.toStringTag,{value:"Module"}));const au=2*Math.PI;new y(1,1,1);const nu=new d;$(Je.outSine),new y(16777215);var ru={beforeEmit:function(t={}){t.position||(t.position=nu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,au)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,rotation:d,parent:u,velocity:p,opacity:m,gravity:f=0,speed:g,dir:b}){t.index,T.randomFloat(-.2,.2),t.billboard=h,t.angVelocity=0,t.spriteId=r,t.velocity.x+=3*b.x*Math.pow(g,2),t.velocity.y+=0,t.velocity.z+=3*b.z*Math.pow(g,2),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||200,n||300),t.scaleInOut=!0,t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(1),t.alphaFrom=1,t.alphaTo=1;const v=.5*Math.random()+.5;t.colorFrom.copy(new y(5915980)).multiplyScalar(v),t.colorTo.copy(new y(5915980)).multiplyScalar(v)}},lu=Object.freeze(Object.defineProperty({__proto__:null,default:ru},Symbol.toStringTag,{value:"Module"}));const cu=2*Math.PI;new y(1,1,1);const hu=new d,du=$(Je.outSine);new y(16777215);var uu={beforeEmit:function(t={}){t.position||(t.position=hu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,cu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m}){const f=cu/c,g=t.index*f+T.randomFloat(-.2,.2)+e;let b=(.007+T.randomFloat(.003,.007))*(1-10*Math.min(m,.1));t.billboard=h,t.angVelocity=0,t.spriteId=r,t.velocity.x+=b*Math.cos(g),t.velocity.z+=b*Math.cos(g),t.velocity.y+=4*-b,t.rotation.x=Math.PI/-2,t.rotation.z=b*t.velocity.x*Math.cos(g),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||200,n||300),t.scaleInOut=!0,t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(1),t.alpha=1,t.colorFrom.copy(new y(8244704)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1),t.colorEase=du}},pu=Object.freeze(Object.defineProperty({__proto__:null,default:uu},Symbol.toStringTag,{value:"Module"}));const mu=2*Math.PI;new y(1,1,1);const fu=new d;$(Je.outSine),new y(16777215);var gu={beforeEmit:function(t={}){t.position||(t.position=fu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,mu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m}){const f=mu/c,g=t.index*f+T.randomFloat(-.2,.2)+e;let b=(.007+T.randomFloat(.003,.007))*(1-10*Math.min(Math.pow(m,1),.1));t.billboard=h,t.angVelocity=0,t.spriteId=r,t.velocity.x+=b*Math.cos(g),t.velocity.z+=b*Math.cos(g),t.velocity.y+=2*b,t.rotation.x=Math.PI/-2,t.rotation.z=b*t.velocity.x*Math.cos(g),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||80,n||90),t.scaleInOut=!0,t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(1),t.alphaFrom=1,t.alphaTo=1,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(7327214)).multiplyScalar(1)}},bu=Object.freeze(Object.defineProperty({__proto__:null,default:gu},Symbol.toStringTag,{value:"Module"}));const yu=2*Math.PI;new y(1,1,1);const vu=new d,wu=$(Je.outQuint);const xu=new y(16777215);var Su={beforeEmit:function(t={}){t.position||(t.position=vu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,yu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0}){const m=yu/c,f=t.index*m+T.randomFloat(-.2,.2)+e;let g=.007+T.randomFloat(.003,.007);t.billboard=h,t.angVelocity=0,t.spriteId=r,t.velocity.x+=g*Math.cos(f),t.velocity.z+=g*Math.cos(f),t.velocity.y+=3*-g,t.rotation.x=Math.PI/-2,t.rotation.z=g*t.velocity.x*Math.cos(f),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.93),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||1500,n||2e3),t.scaleTo.copy(i).multiplyScalar(10),t.scaleFrom.setScalar(2),t.alphaFrom=.3,t.alphaTo=0,t.alphaEase=wu,t.colorFrom.copy(xu).multiplyScalar(1),t.colorTo.copy(xu).multiplyScalar(1),t.colorEase=wu}},_u=Object.freeze(Object.defineProperty({__proto__:null,default:Su},Symbol.toStringTag,{value:"Module"}));const Pu=2*Math.PI;new y(1,1,1);const Mu=new d;$(Je.outSine),new y(16777215);var Tu={beforeEmit:function(t={}){t.position||(t.position=Mu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Pu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,dir:g}){t.index,T.randomFloat(-Math.PI,Math.PI),t.billboard=h,t.angVelocity=0,t.spriteId="bubble_collapsed",t.velocity.x+=.1*Math.random()*g,t.velocity.y+=.2*Math.random()+.3,t.velocity.z=.2*Math.random()+.5,t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.1,t.position.copy(s),t.position.x*=g,t.duration=T.randomFloat(a||200,n||300),t.delay=100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(T.randomFloat(.7,1.1)),t.alphaFrom=1,t.alphaTo=1;const b=.5*Math.random()+.2;t.colorFrom.copy(new y(2766661)).multiplyScalar(b),t.colorTo.copy(new y(2766661)).multiplyScalar(b)}},Au=Object.freeze(Object.defineProperty({__proto__:null,default:Tu},Symbol.toStringTag,{value:"Module"}));const Cu=2*Math.PI;new y(1,1,1);const Du=new d;$(Je.outSine),new y(16777215);var Iu={beforeEmit:function(t={}){t.position||(t.position=Du),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Cu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,velocityY:p=0,gravity:m=0,power:f=1,baseRadius:g=0,speed:b}){const v=Cu/c,w=t.index*v;let x=(.5+T.randomFloat(.003,.007))*f;t.billboard=h,t.angVelocity=0,t.spriteId=Math.random()>.4?"smoke":"smoke2",t.velocity.x+=x*Math.sin(w),t.velocity.z+=x*Math.cos(w),t.velocity.y+=p*Math.random(),t.rotation.x=Math.PI/-2,t.rotation.z=x*t.velocity.x*Math.cos(w),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.93),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.position.x+=Math.sin(w)*g,t.position.y+=0,t.position.z+=Math.cos(w)*g,t.duration=T.randomFloat(a||1e3,n||1200),t.scaleInOut=!0,t.scaleTo.copy(i).multiplyScalar(1),t.scaleFrom.copy(i).multiplyScalar(2.3),t.alphaFrom=1,t.alphaTo=0,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},ku=Object.freeze(Object.defineProperty({__proto__:null,default:Iu},Symbol.toStringTag,{value:"Module"}));const Ou=2*Math.PI;new y(1,1,1);const Ru=new d;$(Je.outSine),new y(16777215);var Lu={beforeEmit:function(t={}){t.position||(t.position=Ru),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Ou)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m}){const f=Ou/c,g=t.index*f+T.randomFloat(-Math.PI,Math.PI)+e;let b=0+T.randomFloat(.003,.004);t.billboard=h,t.angVelocity=0,t.spriteId=Math.random()>0?"smoke":"smoke2",t.velocity.x+=b*Math.sin(g),t.velocity.z+=b*Math.sin(g),t.velocity.y+=b*Math.cos(g),t.rotation.x=Math.PI/-2,t.rotation.z=b*t.velocity.x*Math.cos(g),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||1e3,n||1200),t.scaleInOut=!0,t.scaleTo.copy(i).multiplyScalar(2.3),t.scaleFrom.copy(i).multiplyScalar(2.3),t.alphaFrom=1,t.alphaTo=0,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},Eu=Object.freeze(Object.defineProperty({__proto__:null,default:Lu},Symbol.toStringTag,{value:"Module"}));const Fu=new Map,zu=t=>t;function Bu(t){return t?(Fu.has(t)||Fu.set(t,ts(t[0],t[1],t[2],t[3])),Fu.get(t)):zu}const Uu=new y(1,1,1),ju=new y(0,0,0);new N;const Nu=new d,Vu=[0,.815,.145,1],Wu=[0,.485,.465,1];var qu={particleEmitted:function(t,{position:e,scale:s,sprite:i,duration:o,power:a=0}){t.billboard=!0,t.spriteId=i,t.position.copy(e||Nu),t.duration=o||1e3;const n=(s=s||1).x||s,r=s.y||s;t.scaleFrom.set(n,r),t.scaleTo.copy(t.scaleFrom).multiplyScalar(1.1),t.alphaEase=Bu(Wu),t.alphaFrom=1-(.3+.7*a),t.alphaTo=1,t.colorEase=Bu(Vu),t.colorFrom.lerpColors(ju,Uu,1),t.colorTo.copy(ju)}};var Hu=Object.freeze(Object.defineProperty({__proto__:null,default:qu},Symbol.toStringTag,{value:"Module"}));const Gu=2*Math.PI;new y(1,1,1);const Yu=new d;$(Je.outSine),new y(16777215);var Xu={beforeEmit:function(t={}){t.position||(t.position=Yu),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Gu)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,power:g=1,delay:b}){t.index,T.randomFloat(-Math.PI,Math.PI),t.billboard=h,t.angVelocity=0;const v=Math.random()>.3;t.spriteId="plus_b",t.velocity.y+=.01*Math.random()+.01,t.parent=f,t.velocityDrag.setScalar(o||.99),t.useVelocityDragMult=!0,t.position.copy(s),t.position.x+=T.randomFloat(-.4,.4),t.position.y+=T.randomFloat(-.1,.1),t.position.z+=T.randomFloat(-.4,.4),t.duration=T.randomFloat(a||900,n||1e3),t.delay=b||50*Math.random(),t.scaleInOut=!0,t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(v?T.randomFloat(1.2,1.4):T.randomFloat(1.5,1.8)),t.alphaFrom=1,t.alphaTo=1,t.colorFrom.copy(new y(16777215)),t.colorTo.copy(new y(16777215))}},Qu=Object.freeze(Object.defineProperty({__proto__:null,default:Xu},Symbol.toStringTag,{value:"Module"}));const $u=2*Math.PI;new y(1,1,1);const Ku=new d;$(Je.outSine),new y(16777215),new z;var Zu={beforeEmit:function(t={}){t.position||(t.position=Ku),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,$u)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,radius:f=0,parent:g}){const b=$u/c,v=t.index*b;let w=T.randomFloat(16,20)*(d||1);t.billboard=h,t.angVelocity=0,t.spriteId="Line",t.velocity.x=w*Math.cos(-v),t.velocity.z=w*Math.sin(-v),t.velocity.y=0,t.angle=v+Math.PI/2,t.parent=g,t.velocityDrag.setScalar(.8),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=Math.cos(-v)*f,t.position.y+=0,t.position.z+=Math.sin(-v)*f,t.duration=T.randomFloat(250,350)*Q(d,.8,1.3,.85,1.2),t.delay=T.randomFloat(0,30);const x=T.randomFloat(1.4,2.3);t.scaleFrom.copy(i).multiplyScalar(x),t.scaleTo.copy(i).multiplyScalar(0),t.scaleFrom.x*=2.3,t.scaleTo.y=0,t.alphaFrom=1,t.alphaTo=1,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},Ju=Object.freeze(Object.defineProperty({__proto__:null,default:Zu},Symbol.toStringTag,{value:"Module"}));const tp=2*Math.PI;new y(1,1,1);const ep=new d;$(Je.outSine),new y(16777215);var sp={beforeEmit:function(t={}){t.position||(t.position=ep),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,tp)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,rotation:d,parent:u,velocity:p,opacity:m,gravity:f=0,speed:g,dir:b}){t.index,T.randomFloat(-.2,.2),t.billboard=h,t.angVelocity=0,t.spriteId=r,t.velocity.x+=1*b.x*Math.pow(g,2),t.velocity.y+=0,t.velocity.z+=1*b.z*Math.pow(g,2),t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.98),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.position.x+=.1*Math.random()-.05,t.position.y+=.1*Math.random()-.05,t.position.z+=.1*Math.random()-.05,t.duration=T.randomFloat(a||400,n||500),t.scaleInOut=!0,t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(1),t.alphaFrom=1,t.alphaTo=-.5,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},ip=Object.freeze(Object.defineProperty({__proto__:null,default:sp},Symbol.toStringTag,{value:"Module"}));const op=2*Math.PI;new y(1,1,1);const ap=new d;$(Je.outSine),new y(16777215);var np={beforeEmit:function(t={}){t.position||(t.position=ap),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,op)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,power:m=1,baseRadius:f=0,transformMatrix:g,vel:b,speed:v}){t.index,t.billboard=h,t.angVelocity=0,t.spriteId=Math.random()>.5?"note_a":"note_b",t.velocity.x=0,t.velocity.z=0,t.velocity.y=0,t.velocity.copy(b),t.velocity.multiplyScalar(.2),t.angle=T.randomFloat(-.2,.2),t.velocityDrag.setScalar(o||.93),t.useVelocityDragMult=!0,t.gravity.y=0,t.position.copy(s),t.duration=T.randomFloat(a||1e3,n||1200),t.scaleInOut=!0,t.scaleTo.copy(i).multiplyScalar(1),t.scaleFrom.copy(i).multiplyScalar(2.3),t.alphaFrom=1,t.alphaTo=0,t.alphaInOut=!0,t.colorFrom.copy(new y(16777215)).multiplyScalar(1),t.colorTo.copy(new y(16777215)).multiplyScalar(1)}},rp=Object.freeze(Object.defineProperty({__proto__:null,default:np},Symbol.toStringTag,{value:"Module"}));const lp=2*Math.PI;new y(1,1,1);const cp=new d;var hp={beforeEmit:function(t={}){t.position||(t.position=cp),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,lp)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,delay:p,gravity:m=0}){const f=lp/c,g=t.index*f+T.randomFloat(-.2,.2)+e;let b=.005*Math.random()+.005;t.billboard=h,t.delay=T.randomFloat(0,70),t.angVelocity=0,t.spriteId=r,t.velocity.x+=b*Math.cos(g),t.velocity.z+=b*Math.cos(g),t.velocity.y+=0,t.rotation.x=Math.PI/-2,t.rotation.z=b*t.velocity.x*Math.cos(g),t.velocityDrag.setScalar(1),t.useVelocityDragMult=!0,t.gravity.y=.01,t.position.copy(s),t.position.x+=.2*Math.random()-.1,t.position.y+=.2*Math.random()-.1,t.position.z+=.2*Math.random()-.1,t.duration=T.randomFloat(a||300,n||400),t.scaleFrom.copy(i),t.scaleTo.setScalar(0),t.alpha=1}},dp=Object.freeze(Object.defineProperty({__proto__:null,default:hp},Symbol.toStringTag,{value:"Module"}));const up=2*Math.PI;new y(1,1,1);const pp=new d;$(Je.outSine),new y(16777215);var mp={beforeEmit:function(t={}){t.position||(t.position=pp),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,up)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,power:g=1,delay:b}){t.index,T.randomFloat(-Math.PI,Math.PI);const v=Math.random()>.5?-1:1;t.billboard=h,t.angVelocity=0;const w=Math.random()>.3;t.spriteId=w?"bubble_collapsed":"smoke2",t.velocity.x+=.04*Math.random()*v,t.velocity.y+=.05*Math.random()+.08,t.velocity.z=g>1?.05*-Math.random()+.05:.05*Math.random()+.05,t.velocity.multiplyScalar(g),t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.02*g,t.position.copy(s),f&&(t.position.x*=v),t.duration=T.randomFloat(a||200,n||300),t.delay=b||100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(w?T.randomFloat(1.2,1.4):T.randomFloat(1.5,1.8)),t.alphaFrom=1,t.alphaTo=1;const x=.5*Math.random()+1,S=12646389,_=12646389;t.colorFrom.copy(new y(w?S:_)).multiplyScalar(x),t.colorTo.copy(new y(w?S:_)).multiplyScalar(x)}},fp=Object.freeze(Object.defineProperty({__proto__:null,default:mp},Symbol.toStringTag,{value:"Module"}));const gp=2*Math.PI;new y(1,1,1);const bp=new d;$(Je.outSine),new y(16777215);var yp={beforeEmit:function(t={}){t.position||(t.position=bp),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,gp)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,power:g=1,delay:b}){t.index,T.randomFloat(-Math.PI,Math.PI);const v=Math.random()>.5?-1:1;t.billboard=h,t.angVelocity=0;const w=Math.random()>.3;t.spriteId=w?"bubble_collapsed":"smoke2",t.velocity.x+=(.03*Math.random()+.02)*v*g,t.velocity.y+=.2*Math.random()+.1,t.velocity.z=(g>1?.05*-Math.random():.05*Math.random()+.05)*g,t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.02*g,t.position.copy(s),t.position.x*=v,t.duration=T.randomFloat(a||400,n||500),t.delay=b||100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(w?T.randomFloat(1.2,1.4):T.randomFloat(1.5,1.8)),t.alphaFrom=1,t.alphaTo=1;const x=.5*Math.random()+1,S=12646389,_=12646389;t.colorFrom.copy(new y(w?S:_)).multiplyScalar(x),t.colorTo.copy(new y(w?S:_)).multiplyScalar(x)}},vp=Object.freeze(Object.defineProperty({__proto__:null,default:yp},Symbol.toStringTag,{value:"Module"}));const wp=2*Math.PI;new y(1,1,1);const xp=new d;$(Je.outSine),new y(16777215);var Sp={beforeEmit:function(t={}){t.position||(t.position=xp),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,wp)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,power:g=1,scaleTo:b}){t.index,T.randomFloat(-Math.PI,Math.PI),t.billboard=h,t.angVelocity=0;const v=Math.random()>.3;t.spriteId="water_c",t.rotation.x=Math.PI/-2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=0,t.position.copy(s),t.duration=T.randomFloat(a||600,n||800),t.scaleTo.setScalar(b||40),t.scaleFrom.copy(i).multiplyScalar(6),t.delay=200*Math.random()*t.index,t.alphaFrom=1,t.alphaTo=0;const w=.5*Math.random()+1,x=12646389,S=12646389;t.colorFrom.copy(new y(v?x:S)).multiplyScalar(w),t.colorTo.copy(new y(v?x:S)).multiplyScalar(w)}},_p=Object.freeze(Object.defineProperty({__proto__:null,default:Sp},Symbol.toStringTag,{value:"Module"}));const Pp=2*Math.PI;new y(1,1,1);const Mp=new d;$(Je.outSine),new y(16777215);var Tp={beforeEmit:function(t={}){t.position||(t.position=Mp),t.scale=t.scale||1,t.angOffset=T.randomFloat(0,Pp)},particleEmitted:function(t,{angOffset:e,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:d,opacity:u,gravity:p=0,speed:m,parent:f,dir:g}){t.index,T.randomFloat(-Math.PI,Math.PI),t.billboard=h,t.angVelocity=0;const b=Math.random()>.4;t.spriteId="bubble_collapsed",t.velocity.x+=.1*Math.random()*g,t.velocity.y+=.2*Math.random()+.3,t.velocity.z=.2*Math.random()+.2,t.parent=f,t.angle=Math.random()*Math.PI*2,t.velocityDrag.setScalar(o||.9),t.useVelocityDragMult=!0,t.gravity.y-=.1,t.position.copy(s),t.position.x*=g,t.duration=T.randomFloat(a||450,n||600),t.delay=100*Math.random(),t.scaleTo.setScalar(0),t.scaleFrom.copy(i).multiplyScalar(b?T.randomFloat(1.4,2):T.randomFloat(.7,1.1)),t.alphaFrom=1,t.alphaTo=1;const v=.5*Math.random()+1,w=12646389,x=12646389;t.colorFrom.copy(new y(b?w:x)).multiplyScalar(v),t.colorTo.copy(new y(b?w:x)).multiplyScalar(v)}},Ap=Object.freeze(Object.defineProperty({__proto__:null,default:Tp},Symbol.toStringTag,{value:"Module"}));const Cp=new O,Dp=1/Number.MAX_SAFE_INTEGER,Ip={};let kp;new N;class Op extends fi{constructor(t){t.useEuler=!0,super(t),kp||(kp=c()),this.batcher&&this.batcher.removeInstance(this),this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.rotation=new z,this.delay=0,this.duration=0,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onEnd=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity=new d,this.velocityDrag=new d,this.velocityDragMult=new d,this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.gravity=new d,this.scaleFrom=new h,this.scaleTo=new h,this.colorFrom=new y,this.colorTo=new y,this.alphaFrom=1,this.alphaTo=1,this.alive=!1,this.killable=!1,this.progressEase=Bu(),this.scaleEase=Bu(),this.alphaEase=Bu(),this.colorEase=Bu(),this.scaleVelEase=Bu([0,1,.5,1])}reset(){this.alive&&this.onRelease&&this.onRelease(),this.preset&&this.preset.particleReleased&&this.preset.particleReleased(this,this.presetOptions),this.parent=null,this.preset=Ip,this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.billboard=!1,this.angle=0,this.quaternion.copy(Cp),this.rotation.set(0,0,0),this.position.setScalar(0),this.scale.setScalar(1),this.delay=0,this.duration=1e3,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onRelease=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity.setScalar(0),this.velocityDrag.setScalar(0),this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.scaleInOut=!1,this.gravity.setScalar(0),this.scaleFrom.setScalar(1),this.scaleTo.setScalar(1),this.colorFrom.setRGB(255,255,255),this.colorTo.setRGB(255,255,255),this.alphaFrom=1,this.alphaTo=1,this.alphaInOut=!1,this.progressEase=Bu(),this.scaleEase=Bu(),this.alphaEase=Bu(),this.colorEase=Bu(),this.scaleVelEase=Bu([.7,.3,.2,.2])}emit(t,e,s,i){this.reset(),this.batcher=t,this.spriteId=this.killable=!1,this.alive=!0,this.index=i,this.billboard=s.billboard||!1,this.parent=s.parent,this.preset=e||Ip,this.presetOptions=s||Ip,this.preset.particleEmitted&&this.preset.particleEmitted(this,this.presetOptions),this.sprite.setAtlas(this.batcher.atlas),this.sprite.change({id:this.spriteId,frame:this.spriteFrame,frameDuration:this.spriteFrameDuration,loop:this.spriteLoop,autoplay:this.spriteAutoplay}),this.batcher.addInstance(this),this.sprite.update(1),this.update(0)}kill(){this.killable&&this.preset.particleKilled&&this.preset.particleKilled(this,this.presetOptions),this.killable&&this.onComplete&&this.onComplete(),this.batcher&&(this.batcher.removeInstance(this),this.batcher=null),this.reset(),this.progress=1,this.alive=!1,this.killable=!1}update(){if(!this.alive||this.killable)return;if(this.progress>=1)return this.killable=!0;let t=kp.time.stableDt;if(this.delay>0){if(this.delay-=t,this.delay>0)return this.alpha=0,void this.scale.setScalar(Dp);t=Math.max(0,t+this.delay)}super.update(t);const e=Math.max(Math.min(t/16.666666667,1.5),.5);if(this.age+=t,this.progress=this.progressEase(st(this.age/this.duration,0,1)),this.preset.particleUpdate)this.preset.particleUpdate(this,this.presetOptions);else{if(this.useVelocityDragMult)this.velocity.multiply(this.velocityDrag),this.velocity.lengthSq<1e-4&&this.velocity.setScalar(0);else{if(this.velocity.x){const t=Math.sign(this.velocity.x);this.velocity.x-=t*this.velocityDrag.x*e,Math.sign(this.velocity.x)!==t&&(this.velocity.x=0)}if(this.velocity.y){const t=Math.sign(this.velocity.y);this.velocity.y-=t*this.velocityDrag.y*e,Math.sign(this.velocity.y)!==t&&(this.velocity.y=0)}if(this.velocity.z){const t=Math.sign(this.velocity.z);this.velocity.z-=t*this.velocityDrag.z*e,Math.sign(this.velocity.z)!==t&&(this.velocity.z=0)}}if(this.angVelocity){const t=Math.sign(this.angVelocity);this.angVelocity-=t*this.angVelocityDrag*e,Math.sign(this.angVelocity)!==t&&(this.angVelocity=0)}this.position.x+=(this.velocity.x+this.gravity.x)*e,this.position.y+=(this.velocity.y+this.gravity.y)*e,this.position.z+=(this.velocity.z+this.gravity.z)*e,this.billboard?(this.angle+=this.angVelocity*e,this.angleTo&&(this.angle=ft(this.angleFrom,this.angleTo,this.progress))):this.rotation.z+=this.angVelocity*e,this.scaleWithVel?this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleVelEase(this.progress)):this.scaleInOut?this.scale.copy(this.scaleFrom).lerp(this.scaleTo,1-Math.sin(this.scaleEase(this.progress)*Math.PI)):this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleEase(this.progress)),this.color.copy(this.colorFrom).lerp(this.colorTo,this.colorEase(this.progress)),this.alphaInOut?this.alpha=ft(this.alphaFrom,this.alphaTo,1-Math.sin(this.progress*Math.PI)):this.alpha=ft(this.alphaFrom,this.alphaTo,this.alphaEase(this.progress))}this.preset.particleUpdated&&this.preset.particleUpdated(this,this.presetOptions),this.onProgress&&this.onProgress(this,this.progress)}}const Rp={};class Lp extends m{constructor(t){super(t),t.batcher&&(t.batchers={default:t.batcher}),this.count=t.count||150,this.dead=new Array(this.count).fill(0).map((()=>new Op({}))),this.alive=[],this.batchers=t.batchers||{}}emit(t,e={},s){"number"==typeof e&&(e={amount:e});const i=e.amount=e.amount||1,o=Rp[t];if(!o)return;if(o.beforeAlloc&&o.beforeAlloc(e),e.amount<=0)return;const a=this.batchers[s]||this.batchers.default,n=this.alloc(i);o.beforeEmit&&o.beforeEmit(e,n);for(let r=n.length-1;r>=0;r--)n[r].alive||0,this.alive.push(n[r]),n[r].emit(a,o,e,r)}update(t){const e=[];for(let s=this.alive.length-1;s>=0;s--){const i=this.alive[s];i.update(t),i.killable&&(e.push(i),this.alive.splice(s,1),this.dead.push(i))}for(let s=e.length-1;s>=0;s--)e[s].kill()}alloc(t){const e=this.dead,s=this.alive;let i=[],o=t;return e.length>0&&(i=e.splice(0,o)),o-=i.length,o>0&&(i=i.concat(s.splice(0,o))),i}killAll(){for(let t=this.alive.length-1;t>=0;t--)this.alive[t].kill(),this.dead.push(this.alive[t]),this.alive.splice(t,1)}registerPreset(t,e){!function(t,e){e||(e={}),Rp[t]=e}(t,e)}}let Ep=0;const Fp=new F,zp=new Map,Bp=new N,Up=new O,jp={default:yt,normal:yt,additive:is},Np={double:C,front:Ne,back:os};var Vp=class extends m{init(){this.needsUpdate=!0,this.atlas=this.props.atlas,this.count=this.props.count||200,this.geo=new R,this.geo.index=Fp.index,this.geo.attributes.position=Fp.attributes.position,this.geo.attributes.uv=Fp.attributes.uv,this.initAttributes(),this.instances=new Set,this.setDynamic(this.props.dynamic);const t=this.getMaterial(this.props);this.base=new S(this.geo,t),this.props.renderOrder&&(this.base.renderOrder=this.props.renderOrder),this.base.frustumCulled=!!this.props.frustumCulled,this.currentCount=0,this.updateAttributes=this.updateAttributes.bind(this)}setDynamic(t){this.dynamic=null==t||!!t,this.interleavedBuffer.setUsage(this.dynamic?es:StaticDrawUsage),this.interleavedBuffer.needsUpdate=!0,this.needsUpdate=!0}getMaterial(t){const e=t.material;if(!e)return;zp.has(e)||zp.set(e,{});const s=zp.get(e),i=t.atlas;if(!i)return;null==i.meta.atlasIndex&&(i.meta.atlasIndex=++Ep);const o=null==t.depthWrite||t.depthWrite,a=null==t.depthTest||t.depthTest,n=null!=t.blending?t.blending:"default",c=null!=t.transparent&&t.transparent,h=null!=t.alphaTest&&t.alphaTest,d=null!=t.side?t.side:"front",u=[i.meta.atlasIndex,d+"",o.toString(),a.toString(),n.toString(),c.toString(),h.toString()].join("_");if(s[u])return s[u];const p=r({},t);return delete p.material,s[u]=new e(l(r({},p),{atlas:i,side:Np[d],blending:"function"==typeof n?n:jp[n],depthWrite:!!o,depthTest:!!a,transparent:!!c,alphaTest:!!h}))}initAttributes(){this.stride=21,this.buffer=new Float32Array(this.count*this.stride);const t=this.geo,e=this.interleavedBuffer=new ss(this.buffer,this.stride);t.setAttribute("texCoords",new kt(e,4,0,!1)),t.setAttribute("meshCoords",new kt(e,4,4,!1)),t.setAttribute("spritePos",new kt(e,3,8,!1)),t.setAttribute("decorators",new kt(e,2,11,!1)),t.setAttribute("spriteQt",new kt(e,4,13,!1)),t.setAttribute("spriteColor",new kt(e,4,17,!1)),e.needsUpdate=!0}updateAttributes(t){if(!t||!t.visible)return;const e=this.currentCount++,s=this.buffer,i=this.stride,o=t.sprite.frame;let a=e*i;t.useEuler&&t.quaternion.setFromEuler(t.rotation);let n=t.position,r=t.quaternion,l=t.scale;if(t.parent){const e=t.parent;Bp.position.copy(n),Bp.quaternion.copy(t.billboard?Up:r),Bp.scale.set(l.x,l.y,1),Bp.applyMatrix4(e.matrixWorld),Bp.updateMatrixWorld(),n=Bp.position,r=Bp.quaternion,l=Bp.scale}const c=t.billboard?t.angle:r.x;s[a++]=o.texCoords[0],s[a++]=o.texCoords[1],s[a++]=o.texCoords[2],s[a++]=o.texCoords[3],s[a++]=o.meshCoords[0]*t.scale.x,s[a++]=o.meshCoords[1]*t.scale.y,s[a++]=o.meshCoords[2]*t.scale.x,s[a++]=o.meshCoords[3]*t.scale.y,s[a++]=n.x,s[a++]=n.y,s[a++]=n.z,s[a++]=t.billboard?1:0,s[a++]=t.textured?1:0,s[a++]=c,s[a++]=r.y,s[a++]=r.z,s[a++]=r.w,s[a++]=t.color.r,s[a++]=t.color.g,s[a++]=t.color.b,s[a++]=t.alpha}addInstance(t){this.instances.has(t)||this.instances.add(t)}removeInstance(t){this.instances.has(t)&&this.instances.delete(t)}update(){this.dynamic&&(this.currentCount=0,this.instances.forEach(this.updateAttributes),this.geo.instanceCount=this.currentCount,this.interleavedBuffer.needsUpdate=!0,this.base.visible=0!==this.currentCount)}clearInstances(){this.instances.clear()}destroy(){this.clearInstances(),this.geo.dispose(),super.destroy()}};class Wp extends x{constructor(t={}){const e=(t=r({},t)).useAlphaSDF,s=t.atlas;delete t.renderOrder,delete t.useAlphaSDF,delete t.count,delete t.atlas,delete t.renderOrder;const i="function"==typeof t.blending&&t.blending;i&&delete t.blending,super(t),this.uniforms=l(r(r({},I.merge([k.fog])),t.uniforms||{}),{atlas:{value:s.texture,type:"t"}});const o=this.defines={};t.blending===is&&(o.IS_ADDITIVE_BLENDING=!0),e&&(o.USE_ALPHA_SDF=!0),this.fog=!0,i&&i(this),this.vertexShader="precision highp float;attribute vec4 texCoords;attribute vec4 meshCoords;attribute vec3 spritePos;attribute vec4 spriteQt;attribute vec4 spriteColor;attribute vec2 decorators;varying vec2 vUv;varying vec4 vColor;\n#include <fog_pars_vertex>\n#include <get_instance_matrix>\nvoid main(){vColor=spriteColor;vUv=uv*texCoords.zw+texCoords.xy;vUv.y=1.-vUv.y;vec3 transformed=position;transformed.xy=transformed.xy*meshCoords.zw+(meshCoords.xy*0.5);transformed.xy+=meshCoords.xy*0.5;mat4 instanceMatrix=getInstanceMatrix(spritePos,spriteQt,vec3(1.));vec4 mvPosition=modelViewMatrix*instanceMatrix*vec4(transformed,1.);\n#include <fog_vertex>\nvec4 bbPosition=modelViewMatrix*instanceMatrix*vec4(0.0,0.0,0.0,1.0);bbPosition.x+=cos(spriteQt.x)*transformed.x-sin(spriteQt.x)*transformed.y;bbPosition.y+=sin(spriteQt.x)*transformed.x+cos(spriteQt.x)*transformed.y;mvPosition=mix(mvPosition,bbPosition,decorators.x);gl_Position=projectionMatrix*mvPosition;}",this.fragmentShader="precision highp float;uniform sampler2D atlas;varying vec2 vUv;varying vec4 vColor;\n#include <fog_pars_fragment>\nconst vec3 fogCol=vec3(0.9,1.0,1.0);void main(){vec2 uv=vUv;vec4 color=texture2D(atlas,uv);\n#ifndef IS_ADDITIVE_BLENDING\n#ifdef USE_ALPHA_SDF\ncolor.a=smoothstep(0.87,1.,color.a);color.rgb=mix(color.rgb,vec3(1.),step(color.a,0.95));if(color.a<0.001)discard;\n#else\nif(color.a<0.01)discard;color.rgb/=color.a;\n#endif\n#endif\nfloat alpha=color.a*vColor.a;gl_FragColor=vec4(vColor.rgb*color.rgb,alpha);\n#ifdef USE_FOG\n#ifndef IS_ADDITIVE_BLENDING\nfloat fogFactor=smoothstep(fogNear,fogFar,vFogDepth);gl_FragColor.rgb=mix(gl_FragColor.rgb,fogCol,clamp(fogFactor*0.65,0.,1.));\n#endif\n#endif\n}"}}const qp={"/webgl/particlePresets/actionPop.js":Gd,"/webgl/particlePresets/actionSmoke.js":$d,"/webgl/particlePresets/bikeConstantPebbles.js":tu,"/webgl/particlePresets/bikePebbles.js":ou,"/webgl/particlePresets/bikeSmoke.js":lu,"/webgl/particlePresets/burst.js":pu,"/webgl/particlePresets/burstShoes.js":bu,"/webgl/particlePresets/burstSmoke.js":_u,"/webgl/particlePresets/carPebbles.js":Au,"/webgl/particlePresets/circleSmoke.js":ku,"/webgl/particlePresets/customSmoke.js":Eu,"/webgl/particlePresets/flash.js":Hu,"/webgl/particlePresets/healing.js":Qu,"/webgl/particlePresets/linePop.js":Ju,"/webgl/particlePresets/smokeWheels.js":ip,"/webgl/particlePresets/speakers.js":rp,"/webgl/particlePresets/walk.js":dp,"/webgl/particlePresets/waterConstantSplash.js":fp,"/webgl/particlePresets/waterConstantSplashFront.js":vp,"/webgl/particlePresets/waterRipples.js":_p,"/webgl/particlePresets/waterSplash.js":Ap},Hp=Object.entries(qp).map((([t,e])=>({id:t.split("/").pop().split(".js").shift(),module:e.default})));function Gp(){}const Yp={},Xp={},Qp={};let $p=0;function Kp(t){try{return t.stop(),!1}catch(e){return!0}}function Zp(t){return Yp[t]||(Yp[t]=new Promise((e=>{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onload=async()=>{e(s.response)},s.send()}))),Yp[t]}function Jp(t,e){return t?Qp[e]?Promise.resolve(e):(Xp[e]||(Xp[e]=new Promise((s=>{Zp(e).then((i=>{t.decodeAudioData(i,(t=>{Qp[e]=t,s(e),Xp[e]=null}))}))}))),Xp[e]):Zp(e)}class tm{constructor(t){this.onEnded=this.onEnded.bind(this),this.onLoaded=this.onLoaded.bind(this),this.controller=t,this.context=t.getContext(),this.input=null,this.output=this.context.createGain()}reset(t={}){this.onStop=null,this.stop(),this.pausedProgress=0,this.fadein=t.fadein||0,this.fadeout=t.fadeout||0,this.fadeinTimer=0,this.fadeoutTimer=0,this.fadeinActive=!1,this.fadeoutActive=!1,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.hasEnded=!1,this.loaded=!1,this.stopped=!1,this.fixedTimeStep=0,this.id=t.id||null,this.clearBuffer(),this.source=null,this.buffer=null,this.loop=!!t.loop,this.autoplay=!!t.autoplay,this.playbackRate=t.playbackRate||1,this.volume=null!=t.volume?t.volume:1,this.realvolume=-1,this.loopStart=t.loopStart||0,this.loopEnd=t.loopEnd||0,this.onStop=t.onStop||Gp,this.baseOffset=t.start||t.baseOffset||0,this.duration=t.duration;const e=t.input||this.controller.getInput();e!==this.input&&(this.input&&this.output.disconnect(this.input),this.input=e,this.output.connect(this.input)),this.path=t.path;let s=this.requestID=++$p;Qp[this.path]?this.onLoaded(this.path):Jp(this.context,t.path).then((t=>{(this.requestID=s)&&this.onLoaded(t)})),this.autoplay&&this.play()}onLoaded(t){if(this.isStopping||this.stopped)return this.realstop();if(this.stopped)return this.realstop();const e=Qp[t];this.loaded=!0,this.buffer=e,this.needsPlay&&this.play()}onEnded(){this.loop||(this.hasEnded=!0,this.stop())}getOutput(){return this.output}update(t){if(!this.source)return;this.fixedTimeStep&&(t=this.fixedTimeStep);let e=this.volume;if(this.fadeinActive){this.fadeinTimer+=t;const s=st(this.fadeinTimer/this.fadein,0,1);e*=s,1===s&&(this.fadeinActive=!1)}if(this.fadeoutActive){this.fadeoutTimer+=t;const s=st(1-this.fadeoutTimer/this.fadeout,0,1);e*=s,0===s&&this.realstop()}e!==this.realvolume&&this.setVolume(e)}play(){if(this.source&&this.stop(),!this.loaded)return void(this.needsPlay=!0);const t=this.source=this.context.createBufferSource();if(t.buffer=this.buffer,t.onended=this.onEnded,this.startTime=this.context.currentTime,this.isPlaying=!0,this.needsPlay=!1,!t||!t.buffer)return this.stop();this.progressStart=this.startTime-this.offset,this.duration||(this.duration=t.buffer.duration);const e=Math.max(this.duration-this.offset,.01),s=function(t,e,s,i){try{return t.start(e,s,i),!1}catch(o){return!0}}(this.source,this.startTime,(this.baseOffset+this.offset)%t.buffer.duration,this.duration?e:void 0);s?requestAnimationFrame((()=>this.stop())):(this.fadein&&0===this.fadeinTimer?this.setVolume(0,!0):this.setVolume(this.volume,!0),this.fadein&&(this.fadeinActive=!0),this.setPlaybackRate(this.playbackRate),this.connect(),this.setLoop(this.loop))}getCurrentTime(){return this.getProgress()*this.duration}getProgress(){return this.isPlaying?(this.context.currentTime-this.progressStart)/this.duration:this.pausedProgress}connect(){this.source.connect(this.getOutput())}disconnect(){this.source.disconnect(this.getOutput())}clearBuffer(){this.context&&this.context.clearBufferSource?this.source&&this.context.clearBufferSource(this.source):this.source&&(this.source.disconnect(0),this.source.onended=null),this.source=null}pause(){this.pausedProgress=this.getProgress(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.needsPlay=!1,this.isPlaying=!1,this.source&&(Kp(this.source),this.clearBuffer())}realstop(){this.onStop&&this.onStop(this),this.onStop=null,this.offset=0,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.fadeinActive=!1,this.fadeoutActive=!1,this.stopped=!0,this.source&&(Kp(this.source),this.clearBuffer())}stop(t={}){if(!this.isStopping){if(this.isStopping=!0,!this.source||!this.loaded)return this.realstop();t.fadeout&&(this.fadeout=t.fadeout),this.fadeout?this.fadeoutActive=!0:this.realstop()}}getPlaybackRate(){return this.playbackRate}setPlaybackRate(t){this.playbackRate=t,this.isPlaying&&this.source&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01)}getLoop(){return this.loop}setLoop(t){this.loop=t,this.isPlaying&&this.source&&(this.source.loop=this.loop,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd)}getVolume(){return this.output.gain.value}setVolume(t,e,s=.01){this.realvolume=t,e&&(this.output.gain.value=this.realvolume),this.output.gain.setTargetAtTime(this.realvolume,this.context.currentTime,s)}release(){tm.release(this)}}tm.pool=[],tm.get=function(t,e){const s=tm.pool.shift()||new tm(t);return s.reset(e),s},tm.release=function(t){t.clearBuffer(),t.buffer=null,t.onStop=null,tm.pool.length<50&&tm.pool.push(t)};const em=window.performance||window.Date,sm=["click","touchstart","touchend","keydown"],im=window.AudioContext||window.webkitAudioContext;let om=null,am=!1;const nm={initialized:!1,unlocked:!1,unlockerListening:!0,lastStuckCheck:em.now(),stuckTimer:0,previousWebAudioTime:0},rm={onContextCreation:null,onUnlock:null,onStuck:null};let lm=window.navigator.vendor.includes("Apple");function cm(){nm.unlocked||(!function(){if(om)return;om=function(){try{return(new im).close(),new im}catch(t){return null}}();const t=om.scratchBuffer=om.createBuffer(1,1,22050);om.clearBufferSource=e=>{if(e&&(e.onended=null,e.disconnect(0),lm))try{e.buffer=t}catch(s){}},nm.initialized=!0,rm.onContextCreation&&rm.onContextCreation(om);dm()}(),om.suspend(),window.setTimeout((()=>om.resume()),10),function(){nm.unlockerListening=!1;for(const t of sm)document.removeEventListener(t,cm,{passive:!0})}(),nm.unlocked=!0,nm.stuckTimer=-800,nm.lastStuckCheck=em.now(),rm.onUnlock&&rm.onUnlock())}function hm(){nm.unlocked=!1,nm.unlockerListening=!0;for(const t of sm)document.addEventListener(t,cm,{passive:!0})}function dm(){window.requestAnimationFrame(dm);const t=em.now(),e=t-nm.lastStuckCheck;if(!nm.initialized||!om||e<400)return;const s=om.currentTime,i=s===nm.previousWebAudioTime;nm.stuckTimer=i?nm.stuckTimer+e:0,nm.previousWebAudioTime=s,nm.lastStuckCheck=t,nm.stuckTimer>400&&nm.unlocked&&!nm.unlockerListening&&(hm(),rm.onStuck&&rm.onStuck())}var um={init:function(){nm.initialized||(function(t){const e=new ArrayBuffer(10),s=new DataView(e);s.setUint32(0,t,!0),s.setUint32(4,t,!0),s.setUint16(8,1,!0),window.btoa(String.fromCharCode(...new Uint8Array(e))).slice(0,13)}(44100),hm(),async function(){await void 0&&cm()}())},getVolume:function(t){return t.gain.value},setVolume:function(t,e){t.gain.setValueAtTime(e,om.currentTime)},getContext:()=>om,isUnlocked:()=>nm.unlocked,set debug(t){am=t},set onContextCreation(t){rm.onContextCreation=t},set onUnlock(t){rm.onUnlock=t},set onStuck(t){rm.onStuck=t}};const pm={};JSON.parse('[["music_minigame_jingle",0,1.9355,1.9355],["sfx_UI_Dialog_CameraMove_In",2.0355,2.4533,0.4178],["sfx_UI_Dialog_CameraMove_Out",2.5533,2.8976,0.3443],["sfx_UI_coastalPoints",2.9976,4.3615,1.3639],["sfx_UI_customPlayer_changeAccessories_body",4.4615,4.571,0.1096],["sfx_UI_customPlayer_changeAccessories_bottom",4.671,4.7788,0.1078],["sfx_UI_customPlayer_changeAccessories_head",4.8788,4.9884,0.1096],["sfx_UI_customPlayer_changeColor",5.0884,5.1517,0.0633],["sfx_UI_customPlayer_changeFace",5.2517,5.4016,0.1499],["sfx_UI_customPlayer_open",5.5016,5.914,0.4124],["sfx_UI_customPlayer_shuffle",6.014,6.3996,0.3856],["sfx_UI_customPlayer_validate",6.4996,7.0085,0.5089],["sfx_UI_dialog_answer",[[7.1085,7.2848,0.1763]]],["sfx_UI_dialog_next",[[7.3848,7.4883,0.1035]]],["sfx_UI_dialog_opendialog",[[7.5883,7.7111,0.1228]]],["sfx_UI_notif_NPCcall",[[7.8111,8.1144,0.3033],[8.2144,8.5177,0.3033],[8.6177,8.921,0.3033]]],["sfx_UI_notif_quest_object",[[9.021,9.2419,0.2209]]],["sfx_UI_transition_close",[[9.3419,9.9492,0.6073]]],["sfx_UI_transition_open",[[10.0492,10.654,0.6049]]],["sfx_dialog_syllab",[[10.754,10.9083,0.1542],[12.0128,12.159,0.1463],[12.259,12.4225,0.1635],[12.5225,12.6964,0.1739],[12.7964,12.9626,0.1663],[13.0626,13.2184,0.1557],[13.3184,13.4665,0.1481],[13.5665,13.7201,0.1536],[13.8201,13.9703,0.1502],[11.0083,11.1581,0.1499],[11.2581,11.4015,0.1434],[11.5015,11.6575,0.156],[11.7575,11.9128,0.1553]]],["sfx_minigame_bike_drift",14.0703,19.3375,5.2672],["sfx_minigame_bike_impact",[[19.4375,20.1613,0.7237],[20.2613,20.985,0.7237],[21.085,21.7661,0.6811]]],["sfx_minigame_bike_land",21.8661,22.7811,0.915],["sfx_minigame_bike_loop",22.8811,27.8968,5.0156],["sfx_minigame_boat_drift",27.9968,32.7799,4.7831],["sfx_minigame_boat_impact",[[32.8799,34.5303,1.6504],[34.6303,36.0418,1.4115],[36.1418,37.5378,1.396]]],["sfx_minigame_boat_loop",37.6378,41.6378,4],["sfx_minigame_car_impact",[[41.7378,42.3593,0.6215],[42.4593,43.0809,0.6215],[43.1809,43.8024,0.6215]]],["sfx_minigame_car_loop",[[43.9024,47.2301,3.3277]]],["sfx_minigame_car_tireSkid",[[47.3301,48.903,1.5728]]],["sfx_minigame_countdown_go",49.003,50.503,1.5],["sfx_minigame_countdown_number",50.603,51.603,1],["sfx_minigame_finish",51.703,53.785,2.082],["sfx_minigame_result_lose",53.885,56.6947,2.8098],["sfx_minigame_result_win",56.7947,62.4142,5.6195],["sfx_phone_claim",62.5142,63.6096,1.0954],["sfx_phone_click_medium",63.7096,63.9622,0.2526],["sfx_phone_click_soft",64.0622,64.2104,0.1482],["sfx_phone_close",64.3104,64.7896,0.4792],["sfx_phone_open",64.8896,65.6161,0.7264],["sfx_phone_scroll_tic",65.7161,65.7327,0.0167],["sfx_phone_swipe",65.8327,66.2621,0.4294],["sfx_player_footsteps",[[66.3621,66.5177,0.1556],[66.6177,66.7733,0.1556],[66.8733,67.029,0.1556],[67.129,67.2846,0.1556],[67.3846,67.5402,0.1556],[67.6402,67.7958,0.1556],[67.8958,68.0515,0.1556],[68.1515,68.3071,0.1556],[68.4071,68.5627,0.1556]]],["sfx_player_footsteps_water",[[68.6627,69.1876,0.5249],[69.2876,69.8124,0.5249],[69.9124,70.4373,0.5249],[70.5373,71.0621,0.5249],[71.1621,71.687,0.5249],[71.787,72.3118,0.5249],[72.4118,72.9367,0.5249],[73.0367,73.5615,0.5249],[73.6615,74.1864,0.5249]]],["sfx_player_jetpack_loop",74.2864,78.2924,4.006],["sfx_quest_Skatepark_cleaned",[[78.3924,80.3836,1.9912]]],["sfx_quest_Skatepark_interact_loop",[[80.4836,81.1426,0.659]]],["sfx_quest_bridge_repair",[[81.2426,82.5699,1.3273]]],["sfx_quest_chest_lockpick_loop",[[82.6699,83.588,0.918]]],["sfx_quest_chest_open",[[83.688,84.7563,1.0683]]],["sfx_quest_compas_interact_loop",84.8563,85.9474,1.0912],["sfx_quest_completed_close",86.0474,86.5312,0.4838],["sfx_quest_completed_main",86.6312,87.8142,1.183],["sfx_quest_completed_side",87.9142,89.0972,1.183],["sfx_quest_completed_super",89.1972,94.5608,5.3636],["sfx_quest_getObject",94.6608,96.9211,2.2603],["sfx_quest_hammerImpact",[[97.0211,97.1324,0.1113],[97.438,97.5436,0.1056],[97.6436,97.7491,0.1056],[97.8491,97.9547,0.1056],[98.0547,98.1514,0.0968],[98.2514,98.357,0.1056],[98.457,98.5626,0.1056],[98.6626,98.7681,0.1056],[98.8681,98.9737,0.1056],[97.2324,97.338,0.1056]]],["sfx_quest_healing_done",99.0737,100.8895,1.8158],["sfx_quest_healing_interact_loop",100.9895,102.1895,1.2],["sfx_quest_house_build",[[102.2895,103.9208,1.6312]]],["sfx_quest_inauguration",[[104.0208,106.6081,2.5874]]],["sfx_quest_inauguration_interact_loop",[[106.7081,107.1881,0.48]]],["sfx_quest_lighthouse_build",[[107.2881,110.0016,2.7134]]],["sfx_quest_lighthouse_interact_loop",110.1016,111.4202,1.3186],["sfx_quest_locked",111.5202,111.8738,0.3536],["sfx_quest_plant_grow",[[111.9738,113.0265,1.0527]]],["sfx_quest_plant_interact_watering_loop",[[113.1265,113.8378,0.7113]]],["sfx_quest_progress",113.9378,114.9781,1.0403],["sfx_quest_scissors_interact",[[115.0781,115.1924,0.1142],[115.2924,115.3922,0.0998],[115.4922,115.6037,0.1115],[115.7037,115.818,0.1142],[115.918,116.0322,0.1142]]],["sfx_quest_screwdriver_interact_loop",116.1322,117.9128,1.7806],["sfx_quest_shop_open",118.0128,119.694,1.6812],["sfx_quest_sono_interact_loop",[[119.794,123.794,4]]],["sfx_quest_sono_loop",123.894,133.4954,9.6014],["sfx_quest_sono_turnedOn",[[133.5954,135.2262,1.6308]]],["sfx_secret_interact_tamtam_loop",135.3262,137.7262,2.4],["sfx_telescope_cameraMovement",137.8262,138.7416,0.9154],["sfx_travel_taxi_klaxon",138.8416,139.2134,0.3718],["sfx_travel_taxi_loop",139.3134,141.5226,2.2092]]').forEach((([t,e,s,i])=>{pm[t]=Array.isArray(e)?{id:t,path:"./assets/audiosprites.d3ec805ccb3d2aa0.m4a",variations:e.map((e=>({id:t,start:e[0],end:e[1],duration:e[2]})))}:{id:t,path:"./assets/audiosprites.d3ec805ccb3d2aa0.m4a",start:e,end:s,duration:i}})),pm.music_intro={path:"./assets/music_intro.71524a68cb3d2aa0.m4a",unique:!0},pm.music_island_east={path:"./assets/music_island_east.da464006cb3d2aa0.m4a",unique:!0},pm.music_island_north={path:"./assets/music_island_north.342575a9cb3d2aa0.m4a",unique:!0},pm.music_island_west={path:"./assets/music_island_west.b24d9f08cb3d2aa0.m4a",unique:!0},pm.music_minigame_loop={path:"./assets/music_minigame_loop.1817f3edcb3d2aa0.m4a",unique:!0},pm.music_secret={path:"./assets/music_secret.a01b550ccb3d2aa0.m4a",unique:!0},pm.sfx_amb_beach_loop={path:"./assets/sfx_amb_beach_loop.e7514880cb3d2aa0.m4a",unique:!0},pm.sfx_amb_forestBird_loop={path:"./assets/sfx_amb_forestBird_loop.e7bbbbd1cb3d2aa0.m4a",unique:!0},pm.sfx_amb_main_loop={path:"./assets/sfx_amb_main_loop.13f167accb3d2aa0.m4a",unique:!0};var mm=pm;const fm=.05*Math.log(10);const gm=t=>{return e=t+0,Math.exp(e*fm);var e},bm=(t,e)=>Object.assign(mm[t],e);bm("sfx_UI_notif_NPCcall",{volume:gm(-8)}),bm("sfx_player_jetpack_loop",{loop:!0,fadein:600,fadeout:500});const ym={loop:!0,fadein:200,fadeout:200};function vm(t,e){let s=0,i=null,o=null,a=null;let n=0,r=!1;return e.unlocked.watchImmediate((function(t){if(c(),!t)return;i&&h()})),Wt.add((function(s){if(!e.unlocked.value)return;const i=t.store.isOverlayVisible.value,a=t.store.inDialog.value,l=t.store.isDuckingBgm.value;let c=.43;c*=i||a||l?.29:1,c*=t.store.isMutingBgm.value?0:1,c*=$i.getMuteStrength(),r&&(c*=0);n=pt(n,c,.08,s),o&&(o.volume=n)})),{preload:l,play:async function(t){c();const a=++s;if(o&&i===t)return;if(await l(t),a!==s)return;i=t,e.unlocked.value&&h()},stop:c,suspend:t=>r=t};function l(t){return e.preloadSound(t)}function c(t){t&&t!==i||(o&&o.stop(),o=null)}function h(){a&&(a.realstop(),a=null),o=e.playSound(i,{volume:n,loop:!0}),a=o}}bm("sfx_quest_plant_interact_watering_loop",r({},ym)),bm("sfx_quest_chest_lockpick_loop",r({},ym)),bm("sfx_quest_Skatepark_interact_loop",r({},ym)),bm("sfx_quest_healing_interact_loop",r({},ym)),bm("sfx_quest_sono_interact_loop",r({},ym)),bm("sfx_quest_screwdriver_interact_loop",r({},ym)),bm("sfx_quest_compas_interact_loop",r({},ym)),bm("sfx_quest_lighthouse_interact_loop",r({},ym)),bm("sfx_quest_Skatepark_interact_loop",r({},ym)),bm("sfx_secret_interact_tamtam_loop",r({},ym)),bm("sfx_travel_taxi_loop",{loop:!0}),bm("sfx_minigame_boat_loop",{loop:!0}),bm("music_intro",{loop:!0,fadein:1e3,fadeout:1500}),bm("music_island_east",{loop:!0,fadein:1e3,fadeout:1500}),bm("music_island_west",{loop:!0,fadein:1e3,fadeout:1500}),bm("music_island_north",{loop:!0,fadein:1e3,fadeout:1500}),bm("music_minigame_loop",{loop:!0,fadein:100,fadeout:700}),bm("sfx_quest_sono_loop",{loop:!0,fadein:200,fadeout:400}),bm("music_minigame_jingle",{volume:gm(-2)}),bm("sfx_minigame_result_win",{volume:gm(-2)});const wm=(t,e)=>void 0!==t?t:e;const xm=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((t,e)=>(t[e]=1,t)),{}),Sm=void 0!==window.visualViewport&&void 0!==window.visualViewport.scale;function _m(t){return!!t&&(!t.target||!function(t){if(!t)return!1;const e=t.tagName;return!!(!v.app.$router.currentRoute.value.meta.playerCanMove||xm[e]||Sm&&1!==window.visualViewport.scale)||!!v.app.$stores.isDialogVisible||!(!t.dataset||null==t.dataset.bypassTouch)}(t.target))}let Pm,Mm,Tm=0;const Am=()=>Pm=!1;function Cm(){Pm=!0,clearTimeout(Mm),Mm=setTimeout(Am,200)}const Dm=["KeyS","KeyW","KeyD","KeyA","Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].reduce(((t,e)=>(t[e]=1,t)),{}),Im=["TEXTAREA"].reduce(((t,e)=>(t[e]=1,t)),{}),km=void 0!==window.visualViewport&&void 0!==window.visualViewport.scale;function Om(t){return!!t&&(!t.target||!function(t){if(!t)return!1;const e=t.tagName;return!!(!v.app.$router.currentRoute.value.meta.playerCanMove||Im[e]||km&&1!==window.visualViewport.scale)||!!v.app.$stores.isDialogVisible||!(!t.dataset||null==t.dataset.bypassKeyboard)}(t.target))}function Rm(t){const e=r({},Dm),s={pressedKeys:e,unpressAllKeys:a,pressedCount:0};a(),s.pressedCount=0;const i={passive:!1};return window.addEventListener("keydown",(function(t){if(!Dm[t.code])return;if(!Om(t))return;t.preventDefault(),function(t){if(e[t])return;e[t]=!0,s.pressedCount++}(t.code)}),i),window.addEventListener("keyup",(function(t){if(!Dm[t.code])return;o(t.code)}),i),window.addEventListener("mousedown",a,{passive:!0}),window.addEventListener("blur",a,!1),window.addEventListener("contextmenu",a,!1),j((()=>t.app.$stores.isDialogVisible),a),j((()=>t.app.$stores.isOverlayVisible),a),j((()=>t.app.$stores.isApiErrorVisible),a),j((()=>t.app.$stores.isTransitionActive),(t=>t&&a())),j((()=>t.app.$stores.isFormOpen),a),j((()=>t.app.$stores.isMenuOpen),a),s;function o(t){e[t]&&(e[t]=!1,s.pressedCount=Math.max(s.pressedCount-1,0))}function a(){for(let t in e)o(t)}}var Lm=[function(t){let e=16.67,s=!1,i=performance.now(),o=16.6667,a=0,n=0,r=0,l=0,c=0,h=0;t.hooks.afterInit.watchOnce((()=>{t.viewport&&t.viewport.visible.watch((()=>s=!0))})),t.hooks.afterFrame.watchOnce((()=>{s=!0}));const d=t.time={dt:0,limitedDt:0,clampedDt:0,stableDt:16.6667,elapsed:0,pausedElapsed:0,frameNum:0,isPaused:!0,isStarted:!0,init:function(){d.customLoop?d.customLoop(u):Wt.add(u);d.isStarted=!0,d.isPaused=!1},start:function(){d.isStarted=!0},stop:function(){d.isStarted=!1},resume:function(){d.isPaused=!1},pause:function(){d.isPaused=!0},clampTo60Fps:!0,customLoop:null};function u(u){const p=i;if(i=performance.now(),0===(u=i-p)&&(u=16.6667),s&&(u=16.6667,r=!0,n=0,a=0,s=!1,l=0,c=0),d.limitedDt=u,d.clampTo60Fps){l+=u,c++,h=c>1?(h+u)/2:u;if(!(l+.5*h>13)&&l<13)return;c>1&&(d.limitedDt=16.666667),u=l,l=0,c=0}n+=u,n>=1e3?(r=!1,o=1/a*1e3,n=0,a=0):a++,e=st(r?u:o,4,130),e>30.303030303030305&&e<37.03703703703704?e=33.3333334:e>15.873015873015872&&e<17.543859649122805?e=16.6666667:e>8&&e<9.09090909090909&&(e=8.3333334),d.stableDt=ft(d.stableDt,e,s?1:.08),d.clampedDt=st(void 0===u?16.6667:u,1,130),d.dt=u,d.frameNum=(d.frameNum+1)%Lc,d.elapsed+=u,d.isStarted&&(d.isPaused||(d.pausedElapsed+=u),t.frame())}},function(t){let e;const s=new y(16777215),i=qt(new h),o=qt(1);let a=1,n=2,r=Ec["3k"];const l={antialias:!1,alpha:!1,depth:!0,stencil:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"},c={beforeInit:at(),afterInit:at()},d=t.renderer={init:function(){l.canvas=t.options.canvas,c.beforeInit.emit();const o=d.forceWebGL1?Ht:Gt;e=new o(l),e.debug={checkShaderErrors:!1},t.renderer.instance=e,t.threeRenderer=e,d.isWebGL2=!!e.capabilities.isWebGL2,e.getDrawingBufferSize(i.value),m(),e.setClearColor(s,1),e.autoClear=!1,e.shadowMap.enabled=!1,e.shadowMap.type=Yt,e.info.autoReset=!1,t.hooks.beforeFrame.watch((()=>e.info.reset())),c.afterInit.emit(),t.viewport.changed.watch(m)},options:l,hooks:c,clearColor:s,resize:m,setMinPixelRatio:function(t){if(a===t)return;a=t,p()},setMaxPixelRatio:function(t){if(n===t)return;n=t,p()},setMaxPixelCount:function(t){if("string"==typeof t){if(!(t=Ec[t.toLowerCase()]))return}else null==t&&(t=0);r=t,p()},drawingBufferSize:i,pixelRatio:o,forceWebGL1:!1};let u=!1;function p(){u||(u=!0,t.hooks.beforeFrame.watchOnce(m))}function m(){u=!1;let s=st(t.viewport.pixelRatio.value,a,n);const l=t.viewport.size.value,c=h.get();let d=s*l.x*l.y;r>0&&d>r&&(s/=d/r),e.getSize(c),e.getPixelRatio()!==s&&e.setPixelRatio(s),c.equals(l)||e.setSize(l.x,l.y),function(){const t=i.value,s=h.get();e.getDrawingBufferSize(s),Qt(),s.equals(t)||i.set(t.copy(s),!0);o.set(e.getPixelRatio()),s.release(),Xt()}(),c.release()}},function(t){const e=t.app.$viewport,s=qt(new h(e.width,e.height)),i=qt(s.value.x/s.value.y),o=qt(e.pixelRatio),a=qt(e.visible),n=at();t.viewport={size:s,visible:a,ratio:i,pixelRatio:o,changed:n,frame:u};let r=0,l=0,c=0;const d=$t((()=>(r=e.width,l=e.height,void(c=e.pixelRatio))),150);function u(){const t=s.value,e=t.x!==r||t.y!==l,a=o.value!==c;(e||a)&&(Qt(),e&&(t.set(r,l),s.set(t,!0),i.set(t.x/t.y)),a&&o.set(c),n.emit(),Xt())}j([e],(()=>{t.options.canvas.style.width=e.width+"px",t.options.canvas.style.height=e.height+"px",d()}),{immediate:!0}),Kt((()=>{a.set(e.visible)})),t.hooks.beforeFrame.watch(u)},function(t){const e="webgl_quality",s=300;let i=58,o=52,a=30,n=s,r=s,l=0,c=0,h=!1,d=!1,u=5,p=5,m=10;const f=new Float64Array(3);let g=0;const b=new Float64Array([-1,-1,-1]);let y=0,v=0,w=!1;const x=qt(60),S=qt(60),_=qt(1);function P(t,e){h=!0,d=d||t,e&&(n=e)}function M(){if(m>0)return m--;const e=t.time.limitedDt;if(h&&(l=0,c=0,d&&(u=5,g=0,y=0,v=0),r=n||s,h=d=!1,n=s),r>0)return r-=e;l+=e,c++,l>=1e3&&function(){w||(f[g++]=c,g%=f.length+1);x.set(c),c=0,l%=1e3,w||g!=f.length||A()}()}function T(t){b[2]=b[1],b[1]=b[0],b[0]=t,_.set(t)}function A(t){let e=b[0];const s=Zt(f);t?e=t:s<=a?e-=2:s<o?e-=1:s>i&&(e+=1),e=st(e,0,Math.min(p,u)),e===b[0]?(y=Math.max(0,y-.2),v=Math.max(0,v-.2)):e!==b[0]&&e!==b[1]?y=0:e===b[1]&&(y+=1),e===b[2]&&e<b[0]&&v++,y>=2&&(u=Math.min(b[1],b[0],u,p),y=0),v>=2&&(u=Math.min(Zt(b),u,p),v=0),e=Math.min(e,u,p),e!==_.value&&T(e),S.set(s)}return t.hooks.afterInit.watchOnce((function(){const s=t.app.$device,i=s&&s.gpu?s.gpu.qualityIndex:3,o=function(){const t=localStorage.getItem(e);return null==t||isNaN(t)?null:0|t}(),a=null!=o?o:i;_.watch((t=>{s&&s.updateQuality(t),function(t){localStorage.setItem(e,t)}(t)})),T(a),t.hooks.beforeFrame.watch(M)})),t.hooks.beforeStart.watchOnce((async function(){t.viewport.visible.watch((()=>P()));const e=t.viewport.size.value;let i=e.x*e.y;t.viewport.changed.watch((()=>{const e=t.viewport.size.value,o=e.x*e.y;Math.abs(i-o)<2e5?P(!1,s):(i=o,P(!0,s))}))})),t.quality={get pingPongScore(){return y},get bigPingPongScore(){return v},fps:x,fpsAverage:S,quality:_,current:_,pause:function(){w=!0},resume:function(t=150){w=!1,P(!1,t)},reset:(t=300)=>P(!1,t),hardReset:(t=300)=>P(!0,t),updateQuality:A,limitQuality:t=>{p=st(t,0,5),A()},setThresholds:function(t={}){t.high&&(i=t.high);t.low&&(o=t.low);t.critical&&(a=t.critical)}}},function(t){const e={createBuffer:function(t){return Fc(t)},registerBuffer:zc,unregisterBuffer:zc};t.fbo=e},function(t,{log:e}){const s=t.resources={prepare:async function(){const e=t.app.$preloader.createTask({weigh:4}),i=s.manifest=t.app.$manifest.content;for(let t in Gn)i.scenes[t]||delete Gn[t];await s.supercache.init(),e.finish()},manifest:{},assets:{},scenes:{},actors:ao,textures:{},use:Lr.use,unuse:Lr.unuse,disposeAll:Lr.disposeAll,geometries:{plane:new F}};!function(t,e,{log:s}){const i="__cache__";let o="cb3d2aa0",a=null;Object.assign(e,{supercache:{init:async function(){if(!window.caches||!window.Cache)return;o+="_"+e.manifest.timestamp;const[t,i]=await Promise.all([caches.open(o),caches.keys()]);a=t,s("Use supercache "+o),await Promise.all(i.map((t=>{if(window.noSupercache||t!==o)return caches.delete(t)})))},add:async function(t,e){if(a)return!(t=i+t).endsWith(".json")||"object"!=typeof e||e instanceof Blob||(e=new Blob([JSON.stringify(e)],{type:"application/json;charset=UTF-8"})),!t.endsWith(".dat")||"object"!=typeof e||e instanceof Blob||(e=new Blob([e.buffer],{type:"application/octet-stream"})),e instanceof Response||(e=new Response(e,{status:200,statusText:"ok"})),a.put(t,e)},get:async function(t,{type:e}={}){if(a){t=i+t;try{const s=await a.match(t);if(!s)return!1;let i=!1;return i="blob"===e?await s.blob():"json"===e?await s.json():"text"===e?await s.text():t.endsWith(".dat")?await s.arrayBuffer():t.endsWith(".json")?await s.json():await s.arrayBuffer(),i}catch(s){return!1}}}}})}(0,s,{log:e}),td(t,s,{log:e})},function(t,{log:e}){const s=new d(.5,.5),i={value:new u(0,0,1,-1)},o={value:0},a={circleParams:i,circleProgress:o};t.transitions={uniforms:a,update:r,circleIn:function(t,e){n&&n.isOut&&(n=n.destroy());return n&&!n.destroyed||(c(t,e,!1),n=Dt({target:o,property:"value",duration:500,from:0,to:1,easing:"inOutQuart",onComplete:h}),n.isIn=!0),n.finished},circleOut:function(t,e){n&&n.isIn&&(n=n.destroy());return n&&!n.destroyed||(c(t,e,!0),n=Dt({target:o,property:"value",duration:800,from:0,to:1,easing:"inOutQuart",onComplete:h}),n.isOut=!0),n.finished}};let n=null;function r(){if(t.time.isPaused)return;const e=t.time.dt;n&&n.update(e)}function l(){const{x:e,y:o}=t.viewport.size.value,a=s,n=i.value,r=n.x=a.x*e,l=n.y=a.y*o;n.z=Math.max(Xe(r,l,0,0),Xe(r,l,e,0),Xe(r,l,e,o),Xe(r,l,0,o))}function c(e,o,a){const{x:n,y:r}=t.viewport.size.value;e=null==e?.5:e/n,o=null==o?.5:o/r,s.set(e,o),i.value.w=a?1:-1,l()}function h(){o.value=1.01}t.hooks.afterInit.watch((()=>{t.viewport.size.watchImmediate(l),t.hooks.beforeUpdate.watch(r)}))},function(t,{log:e}){e=()=>{};let s="IslandWest",i=null,o=qt(Object.keys(Gn)[0]),a=rt();t.scenes={list:Gn,currentSceneID:o,get current(){return i},init:async function(){const e=t.savestate.game.currentScene;Gn[e]&&o.set(e);t.savestate.getVariable("isIntroCompleted")||o.set("IslandIntro");o.watch((e=>{const i=Gn[e];i.savePosition&&(t.savestate.game.currentScene=e),i.savePosition&&(s=e)}));const i=t.app.$stores.overrideSpawnPoint;h(o.value,{point:i&&i.point,noAnimation:!0}),t.app.$stores.overrideSpawnPoint=null,await a},start:function(){},update:function(){if(!i)return;i.triggerUpdate()},render:function(){if(!i)return;i.triggerRender()},teleportTo:h,backToIsland:function(t={}){h(s,t)}};let n=0,l=0,c=null;async function h(s,h={}){const d=Gn[s];if(!d)return;const u=s+"_"+(h.point||"Spawn");if(performance.now()-l<5e3&&u===c)return;c=u,t.store.isTransitionActive.set(!0);const p=++n,m=!i||h.noAnimations;if(i&&i.isCircuitScene&&t.app.$circuit.setStatus("Exiting"),h.delay&&await Y(h.delay),p!==n)return;if(i&&i.props.id===s){if(m||await t.transitionScene.loaderIn("road"),p!==n)return;return i.teleportPlayer&&(await i.teleportPlayer(h.point),o.set(s)),m||await t.transitionScene.loaderOut(),void t.store.isTransitionActive.set(!1)}if(t.store.interactionButton.set(null),t.audio.bgm.stop(),!m){const e=Gn[o.value].props,s=d.props.transition||e.transition||"sea";await t.transitionScene.loaderIn(s)}if(d.props.bgm&&t.audio.bgm.preload(d.props.bgm),p!==n)return;if(m||await ct.promise(50),i&&(i.destroy(),i=null,await ct.promise(50),p!==n))return;if(await Ud(d,{log:e}),p!==n)return;const f=r({},d.props);h.point&&(f.spawnPoint=h.point),f.alreadyVisited=t.savestate.getVariable("hasVisited"+d.props.id);const g=new d.class(f);g.load&&await g.load(),p===n&&(d.props.pageview&&t.app.$analytics.pageview(d.props.pageview),d.props.route&&t.app.$router.push({name:d.props.route}),i=g,i.triggerInit(),o.set(s),m||await ct.promise(10),p===n&&(i.triggerUpdate(),m||await ct.promise(20),p===n&&(await i.triggerPrerender(),m||await ct.promise(50),i.beforeEnter&&i.beforeEnter(),m||await t.transitionScene.loaderOut(),i.afterEnter&&i.afterEnter(),l=performance.now(),t.store.isTransitionActive.set(!1),a.resolve())))}},function(t){const e=t.store={chunkDivisor:4,renderOrder:{islandBase:1,grass:2,islandChunks:t.app.$device.type.phone?1:10,vehicles:101,character:102,sprites:103,skybox:104,water:105,bubbles:106,fintechHalos:107,transitions:{plane:108}},islands:{lights:{directional:{target:new d(-1,2,.6)}}},npcMinDistance:qt(5400),npcMaxDistance:qt(6900),dynamicShadowSize:qt(2048),grass:{radius:1},characterScale:.89,interactionButton:qt(null),chunksCastShadow:qt(!0),windVisible:qt(!0),waterVisible:qt(!0),inDialog:qt(!1),joystickVisible:qt(!1),isTransitionActive:qt(!1),phoneVisible:qt(!1),isInCustomize:qt(!1),onPhone:qt(!1),cameraInsideSpatial:qt(!1),bgmVolumeScalar:qt(1),spatialMusicVolumeScalar:qt(0),miniGame:{countdown:qt(5),elapsedTime:qt(0),started:qt(!1),completed:qt(!1),replay:at()},circuitGame:{countdown:qt(5),elapsedTime:qt(0),started:qt(!1),completed:qt(!1),replay:at()},intro:{resetTimers:at(),ctaHover:at(),journeyStarted:qt(!1),startJourneyVisible:qt(!1),descentDone:qt(!1)},updatePlayerOutfit:at(),updatePlayerAttributes:at(),debounceInteractionDone:at(),isSoundUnlocked:qt(!1),playerPosition:new d,playerOrientation:0,isDuckingBgm:qt(!1),isMutingBgm:qt(!1),frozenPlayerDelay:0,outfitDebounce:50};e.isPreloaderHidden=qt(!1),Ke((()=>e.isPreloaderHidden.set(t.app.$preloader.hidden))),e.isMenuOpen=qt(),Ke((()=>e.isMenuOpen.set(t.app.$stores.isMenuOpen)));let s=null;const i=()=>t.app.$stores.isInteractionDone=!1;e.debounceInteractionDone.watch(((e=1500)=>{clearTimeout(s),t.app.$stores.isInteractionDone=!0,s=setTimeout(i,e)})),e.renderStopped=Ze([e.onPhone,e.isMenuOpen,e.isTransitionActive],((t,e,s)=>(t||e)&&!s)),e.renderPaused=Ze([],(t=>!!t)),e.routeName=qt(),Ke((()=>e.routeName.set(t.app.$route.name))),e.isCustomizing=qt(),e.isConfettisActive=qt(!1);let o=null,a=()=>e.isConfettisActive.set(!1);Ke((()=>{const s=t.app.$stores.isConfettisActive;clearTimeout(o),s?e.isConfettisActive.set(!0):o=setTimeout(a,2500)})),e.isNotifActive=qt(),Ke((()=>e.isNotifActive.set(t.app.$notifs.isNotifActive.value))),e.isStarted=qt(!1),e.qualityPaused=Ze([e.isStarted,e.inDialog,e.isTransitionActive,e.routeName,e.isConfettisActive,e.isNotifActive,e.phoneVisible],((t,e,s,i,o,a,n)=>o||!t||e||s||a||n||"Customize"===i||"Phone"===i));let n=!0;e.qualityPaused.watch((e=>{e?t.quality.pause():(t.quality.resume(n?400:1e3),n=!1)})),e.isOverlayVisible=qt(!1),Ke((()=>e.isOverlayVisible.set(t.app.$stores.isOverlayVisible)));const r=qt(),l=qt();Ke((()=>r.set(t.app.$notifs.isOverlayActive.value))),Ke((()=>l.set(t.app.$stores.sceneState>=t.app.$stores.sceneStates.Playing))),Ke((()=>{e.phoneVisible.set(!!t.app.$stores.phone.isReady)})),e.interactionVisibles=Ze([r,e.routeName,l,e.phoneVisible],((t,e,s,i)=>s&&!t&&"Home"==e&&!i)),Ke((()=>e.isInCustomize.set("Customize"===t.app.$route.name)));const c=()=>t.app.$stores.isTransitionActive=!1;e.isTransitionActive.watch((e=>{clearTimeout(null),e?t.app.$stores.isTransitionActive=!0:setTimeout(c,600)}))},function(t,{log:e}){t.initPhysics=async function(t=null){return await new Vd(e)}},function(t){let e,s,i=!1;const o={},a={init:function(){if(i)return;i=!0;const a={renderOrder:t.store.renderOrder.sprites,material:Wp,atlas:t.atlas,blending:"normal",transparent:!0,depthWrite:!1,depthTest:!1};Object.assign(o,{normal:new Vp(l(r({},a),{blending:"normal",depthTest:!0,depthWrite:!1,count:1e3})),emissive:new Vp(l(r({},a),{blending:"additive",depthTest:!0,depthWrite:!1,count:1e3})),noDepthEmissive:new Vp(l(r({},a),{blending:"additive"})),noDepth:new Vp(r({},a)),depthSDF:new Vp(l(r({},a),{useAlphaSDF:!0,depthTest:!0,depthWrite:!0,renderOrder:t.store.renderOrder.bubbles}))}),e=Object.values(o);for(let t in o)o[t].triggerInit(o[t].props);s=new Lp({batchers:o,count:3e3}),Hp.forEach((t=>s.registerPreset(t.id,t.module)))},emit:function(t,e={}){if(!s)return;const i=e.batcherID||"default";return s.emit(t,e,i)},update:function(){if(!i)return;for(let t=0,s=e.length;t<s;t++)e[t].update();s.update()},addTo:function(t){this.removeFromParent();for(let s=0,i=e.length;s<i;s++){const i=e[s].base;t.add(i),i.manualMatrixUpdate=!0,i.updateMatrixWorld()}},removeFromParent:function(){for(let t=0,s=e.length;t<s;t++){const s=e[t];s.base.parent&&s.base.parent.remove(s.base)}s.killAll()},batchers:o};t.particles=a},function(t){const e=qt(!1);let s,i,o,a=!1,n=!1;const r=t=>t.update(o),l={},c=new Set;let h=1;const d={main:1,fade:1,smoothMute:1,mute:1},u={muted:e,init:function(){if(a)return;a=!0,um.debug=!0,um.onUnlock=g,um.onContextCreation=m,um.onStuck=f,um.init(),Wt.add(y),Ke((()=>{const e=t.app.$stores.isAudioMuted||t.app.$stores.isVideoPlaying;u.muted.set(e)})),t.viewport.visible.watch(p),u.muted.watchImmediate(b)},unlocked:qt(!1),get masterVolume(){return h},getContext:()=>s,getInput:()=>i,list:mm,play:x,pause:S,stop:_,playSound:P,stopSound:function(t,e={}){const s=l[t];if(!s)return;s.forEach((t=>t.stop(e)))},preloadSound:function(t){const e=mm[t];if(!e)return;const i=e.path;return Jp(s,i)}};function p(t){s&&(t?(x(),d.fade=1):(S(),d.fade=0),w())}function m(t){s=t,i=t.createGain(),i.connect(t.destination);for(let e=0;e<20;e++){new tm(u).release()}}function f(){_(),u.unlocked.set(!1)}function g(){u.unlocked.set(!0),t.quality.reset(1e3)}function b(t){d.mute=t?0:1}function y(t){if(um.isUnlocked()){o=t;for(const e of c)e.timer-=t,e.timer<=0&&(c.delete(e),P(e.id,e.opts));if(w(),!n)for(const t in l)l[t].forEach(r)}}u.bgm=vm(t,u),t.audio=u;let v=-1;function w(){const t=d;t.smoothMute=U(t.smoothMute,t.mute,.1,.001),h=t.main*t.fade*t.smoothMute,h!==v&&(v=h,um.setVolume(i,h))}function x(){if(n){n=!1;for(const t in l)l[t].forEach((t=>{t.loop||t.play()}))}}function S(){if(!n){n=!0;for(const t in l)l[t].forEach((t=>{t.loop||t.pause()}))}}function _(){for(const t in l)l[t].forEach((t=>t.stop()))}function P(t,e={}){var s;if(e.delay,!um.isUnlocked())return;const i=mm[t];if(!i)return;if(e.delay){const s=e.delay;return delete e.delay,void c.add({id:t,opts:e,timer:s})}if(l[t]||(l[t]=new Set),i.unique&&l[t].size>0){const e=l[t].values().next().value;return e.play(),e}if(e.id=t,e.path=i.path,e.onStop=M,e.autoplay=null==(s=e.autoplay)||s,e.loop=wm(e.loop,!!i.loop),e.fadein=e.fadein||i.fadein,e.fadeout=e.fadeout||i.fadeout,i.variations){let t=e.variation&&i.variations[e.variation-1];t||(t=Ql(i.variations)),e.start=wm(e.start,t.start),e.duration=wm(e.duration,t.duration),e.loopStart=wm(e.loopStart,wm(t.loopStart,e.start)),e.loopEnd=wm(e.loopEnd,wm(t.loopEnd,e.start+e.duration))}else e.start=wm(e.start,i.start),e.duration=wm(e.duration,i.duration),e.loopStart=wm(e.loopStart,wm(i.loopStart,e.start)),e.loopEnd=wm(e.loopEnd,wm(i.loopEnd,e.start+e.duration));var o,a;e.volume=wm(e.volume,wm(i.volume,1)),e.playbackRate=i.randomRate?(o=i.randomRate[0],a=i.randomRate[1],Math.random()*(a-o)+o):null!=e.playbackRate?e.playbackRate:1;const n=tm.get(u,e);return l[t].add(n),n}function M(t){const e=l;t.release();const s=e[t.id];s&&s.delete(t)}},function(t){t.input={init(){this.touch=function(t){let e;const s=t.viewport,i=qt({pressed:!1,clickIn:!1,clickOut:!1,pos:new h,relativePos:new h,delta:new h,normalizePos:new h,normalizeRelativePos:new h,firstPos:new h});i.swipe=qt();const o={firstPos:new h,prevPos:new h,clickIn:!1,clickOut:!1,pressed:!1,pos:new h(0,0),relativePos:new h(0,0),delta:new h(0,0),interactive:!1,active:!1,useTouch:!1};function a(t){return t.changedTouches[0]}function n(t){const s=!!t.changedTouches;if(s)Cm();else if(Pm)return;if(!s&&0!==t.button)return;if(!_m(t))return;t.preventDefault(),Tm=performance.now();const i=s?a(t):t;o.useTouch=s||Pm,o.delta.set(0,0),o.firstPos.set(i.clientX||0,i.clientY||0),o.prevPos.copy(o.firstPos),o.pos.copy(o.firstPos),o.pressed=!0,o.clickIn=!0,o.clickOut=!1,e=!0,c()}function r(t){const s=!!t.changedTouches,i=s?a(t):t;o.useTouch=s||Pm,o.pos.set(i.clientX||0,i.clientY||0),o.pressed?o.relativePos.copy(o.pos).sub(o.firstPos):o.relativePos.set(0,0),e=!0}function l(t){const s=!!t.changedTouches;if(s)Cm();else if(Pm)return;if(!s&&0!==t.button)return;if(_m(t))t.preventDefault();else if(!o.pressed)return;if(s){let t=0;const e=3;if(performance.now()-Tm<220){const s=o.relativePos.x,i=o.relativePos.y,a=180*Math.atan2(i,s)/Math.PI+90;a>=-45+e&&a<45-e?t=1:a>=45+e&&a<135-e?t=2:a>=135+e&&a<225-e?t=3:(a>=225+e||a<-45-e)&&(t=4)}i.swipe.set(t,!0)}else i.swipe.set(0);const n=s?a(t):t;o.useTouch=s||Pm,o.pos.set(n.clientX||0,n.clientY||0),o.clickIn=!1,o.clickOut=o.pressed,e=!0,o.pressed=!1,c(),e=!0,o.relativePos.set(0,0)}function c(){const t=i.value;t.useTouch=o.useTouch,t.pressed=o.pressed,t.clickIn=o.clickIn,t.clickOut=o.clickOut,t.pos.copy(o.pos),t.relativePos.copy(o.relativePos),t.delta.copy(o.delta),t.firstPos.copy(o.firstPos);const e={x:s.size.value.x,y:s.size.value.y};t.normalizePos.set(mt(t.pos.x,0,e.x,-1,1),mt(t.pos.y,0,e.y,1,-1)),t.normalizeRelativePos.copy(t.relativePos).divide(e),i.set(t,!0)}Object.assign(i,{update:function(){(o.clickIn||o.clickOut)&&(e=!0),o.clickOut=o.clickIn=!1,o.delta.copy(o.pos).sub(o.prevPos),o.prevPos.copy(o.pos);const t=i.value.delta;e||(e=!o.delta.equals(t)||0!==o.delta),e&&c(),e=!1}});const d=window,u="addEventListener",p={passive:!1};return d[u]("touchstart",n,p),d[u]("touchmove",r,p),d[u]("touchend",l,p),d[u]("touchcancel",l,p),d[u]("mousedown",n,p),d[u]("mousemove",r,p),d[u]("mouseup",l,p),d[u]("gesturestart",(t=>t.preventDefault()),p),i}(t),this.keyboard=Rm(t),t.hooks.beforeFrame.watch((()=>{this.touch.update()}))}}},function(t){const e=t.cinematicCamera={init:function(){s=e.gui=t.gui.addFolder(Object.assign({title:"🎥 Cinematic Camera Tool",index:4})),(s.enabled=s.addInput(e,"Cinematic camera enabled",{index:0})).on("change",(t=>{e.enabled.set(t.value)})),(s.setFromButton=s.addButton({title:"Set from "})).on("click",(t=>{e.setFrom.emit(t)})),(s.setToButton=s.addButton({title:"Set to",index:2})).on("click",(t=>{e.setTo.emit(t)})),e.gui.controller_.view.buttonElement.style.backgroundColor="#5851b5",e.gui.controller_.view.containerElement.style.backgroundColor="#343068",(s.play=s.addButton({title:"‣ Play"})).on("click",(t=>{o=!o,o?(e.progress.value=0,s.play.title="▪ Stop"):(e.progress.value=0,s.play.title="‣ Play")})),(s.progress=s.addInput(e,"progress",{min:0,max:1})).on("change",(t=>{})),(s.easingsList=s.addInput(e,"easing",{options:r({},Je)})).on("change",(t=>function(t){e.ease.set(t.value),i=Bu(e.ease.value)}(t))),s.duration=s.addInput(e,"duration",{min:500,max:15e3}),e.setTo.watch(n),e.setFrom.watch(l),t.hooks.beforeRender.watch((()=>{!function(){if(!e.enabled.value)return;if(!t.scenes)return;if(!t.scenes.current)return;if(!t.scenes.current.getCurrentCamera())return;o&&(e.progress.value+=t.time.dt/e.duration.value);e.progress.value=D(e.progress.value,1),e.current.position.copy(e.from.position).lerp(e.to.position,i(e.progress.value)),e.current.rotation.copy(e.from.rotation).slerp(e.to.rotation,i(e.progress.value)),t.scenes.current.getCurrentCamera().base.position.copy(e.current.position),t.scenes.current.getCurrentCamera().base.quaternion.copy(e.current.rotation)}()}))},"Cinematic camera enabled":!1,enabled:qt(),playing:!1,setFrom:at(),setTo:at(),duration:qt(5e3),ease:qt(),progress:qt(0),easing:"linear",fakeProgress:0,from:{position:new d,rotation:new O},to:{position:new d,rotation:new O},current:{position:new d,rotation:new O}};let s,i=Bu(),o=e.playing;function a(s){if(!t.scenes)return;if(!t.scenes.current)return;if(!t.scenes.current.getCurrentCamera())return;const i=t.scenes.current.getCurrentCamera().base.position,o=t.scenes.current.getCurrentCamera().base.quaternion;"Set to"===s?(e.to.position.copy(i),e.to.rotation.copy(o)):(e.from.position.copy(i),e.from.rotation.copy(o))}function n(t){a(t.target.title)}function l(t){a(t.target.title)}return e}];function Em(t={}){return as(r({decorator:Rc,plugins:Lm},t))}export{Em as loadWebGL};
